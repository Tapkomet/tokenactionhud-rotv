    !function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";class Logger{static info(...t){console.log("Token Action HUD info |",...t)}static error(...t){console.error("Token Action HUD error |",...t)}static debug(...t){game.settings.get("token-action-hud-rotv","debug")&&Logger.info("debug:",...t)}}const t="tokenActionHud.settings.itemMacroReplace.showBoth",e="tokenActionHud.settings.itemMacroReplace.showItemMacro",i="tokenActionHud.settings.itemMacroReplace.showOriginal";function switchCSS(t){const e=[{setting:"compact",file:"tah-compact"},{setting:"foundryVTT",file:"token-action-hud-rotv"},{setting:"dorakoUI",file:"tah-dorako"}];for(const i of e){const e=["modules/token-action-hud-rotv/",`styles/${i.file}`];i.setting===t?Object.values(document.styleSheets).find((t=>t.href?.includes(e[0])&&t.href?.includes(e[1]))).disabled=!1:Object.values(document.styleSheets).find((t=>t.href?.includes(e[0])&&t.href?.includes(e[1]))).disabled=!0}}const updateFunc$1=t=>{Logger.debug("Settings updated. Refreshing HUD"),game.tokenActionHUD&&game.tokenActionHUD.updateSettings()};let s;const registerSettings=function(a,n,o){s=a,game.settings.register(s,"rollHandler",{name:game.i18n.localize("tokenActionHud.settings.rollHandler.name"),hint:game.i18n.localize("tokenActionHud.settings.rollHandler.hint"),scope:"world",config:!0,type:String,choices:o,default:"core",onChange:t=>{updateFunc$1()}}),game.settings.register(s,"style",{name:game.i18n.localize("tokenActionHud.settings.style.name"),hint:game.i18n.localize("tokenActionHud.settings.style.hint"),scope:"client",config:!0,type:String,default:"foundryVTT",choices:{compact:"Compact",foundryVTT:"Foundry VTT",dorakoUI:"Dorako UI"},onChange:t=>{switchCSS(t)}}),game.settings.register(s,"direction",{name:game.i18n.localize("tokenActionHud.settings.direction.name"),hint:game.i18n.localize("tokenActionHud.settings.direction.hint"),scope:"client",config:!0,type:String,default:"Down",choices:{up:game.i18n.localize("tokenActionHud.settings.direction.choices.up"),down:game.i18n.localize("tokenActionHud.settings.direction.choices.down")},onChange:t=>{updateFunc$1()}}),"false"===game.settings.storage.get("client").getItem("token-action-hud-rotv.dropdown")&&(set("direction","up"),game.settings.storage.get("client").removeItem("token-action-hud-rotv.dropdown")),"true"===game.settings.storage.get("client").getItem("token-action-hud-rotv.dropdown")&&game.settings.storage.get("client").removeItem("token-action-hud-rotv.dropdown"),game.settings.register(s,"scale",{name:game.i18n.localize("tokenActionHud.settings.scale.name"),hint:game.i18n.localize("tokenActionHud.settings.scale.hint"),scope:"client",config:!0,type:Number,range:{min:.5,max:2,step:.05},default:1,onChange:t=>{updateFunc$1()}}),game.settings.register(s,"drag",{name:game.i18n.localize("tokenActionHud.settings.drag.name"),hint:game.i18n.localize("tokenActionHud.settings.drag.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),function initColorSettings(t){let e=null;game.modules.get("lib-themer")?.active?e="lib-themer":game.modules.get("color-picker")?.active?e="color-picker":game.modules.get("colorsettings")?.active&&(e="colorsettings");switch(e){case"lib-themer":Hooks.once("lib-themer.Ready",(e=>{e.register({id:t,title:game.modules.get(t).title,"--tah-background":{name:"tokenActionHud.settings.background.name",hint:"tokenActionHud.settings.background.hint",type:"color",default:"#00000000"},"--tah-button":{name:"tokenActionHud.settings.buttonBackgroundColor.name",hint:"tokenActionHud.settings.buttonBackgroundColor.hint",type:"color",default:"#00000080",colors:{buttons:!0}}})}));break;case"color-picker":"object"==typeof ColorPicker?registerColorSettings(t,e):Hooks.once("colorPickerReady",(()=>{registerColorSettings(t,e)}));break;case"colorsettings":Hooks.once("ready",(()=>{try{window.Ardittristan.ColorSetting.tester,registerColorSettings(t,e)}catch{}}))}}(s),game.settings.register(s,"enabledForUser",{name:game.i18n.localize("tokenActionHud.settings.enabledForUser.name"),hint:game.i18n.localize("tokenActionHud.settings.enabledForUser.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(s,"playerPermission",{name:game.i18n.localize("tokenActionHud.settings.playerPermission.name"),hint:game.i18n.localize("tokenActionHud.settings.playerPermission.hint"),scope:"world",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(s,"alwaysShowHud",{name:game.i18n.localize("tokenActionHud.settings.alwaysShowHud.name"),hint:game.i18n.localize("tokenActionHud.settings.alwaysShowHud.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(s,"showHudTitle",{name:game.i18n.localize("tokenActionHud.settings.showHudTitle.name"),hint:game.i18n.localize("tokenActionHud.settings.showHudTitle.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(s,"showIcons",{name:game.i18n.localize("tokenActionHud.settings.showIcons.name"),hint:game.i18n.localize("tokenActionHud.settings.showIcons.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(s,"alwaysShowAdditionalCategories",{name:game.i18n.localize("tokenActionHud.settings.alwaysShowAdditionalCategories.name"),hint:game.i18n.localize("tokenActionHud.settings.alwaysShowAdditionalCategories.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(s,"clickOpenCategory",{name:game.i18n.localize("tokenActionHud.settings.clickOpenCategory.name"),hint:game.i18n.localize("tokenActionHud.settings.clickOpenCategory.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{updateFunc$1()}}),game.modules.get("itemacro")?.active&&game.settings.register(s,"itemMacroReplace",{name:game.i18n.localize("tokenActionHud.rotv.settings.itemMacroReplace.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.itemMacroReplace.hint"),scope:"client",config:!0,type:String,choices:{showBoth:game.i18n.localize(t),showItemMacro:game.i18n.localize(e),showOriginal:game.i18n.localize(i)},default:"showBoth",onChange:t=>{updateFunc$1()}}),game.settings.register(s,"renderItemOnRightClick",{name:game.i18n.localize("tokenActionHud.settings.renderItemOnRightClick.name"),hint:game.i18n.localize("tokenActionHud.settings.renderItemOnRightClick.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc$1()}}),game.settings.register(s,"activeCssAsText",{name:game.i18n.localize("tokenActionHud.settings.activeCssAsText.name"),hint:game.i18n.localize("tokenActionHud.settings.activeCssAsText.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{updateFunc$1()}}),game.settings.register(s,"onTokenHover",{name:game.i18n.localize("tokenActionHud.settings.onTokenHover.name"),hint:game.i18n.localize("tokenActionHud.settings.onTokenHover.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{updateFunc$1()}}),game.settings.register(s,"debug",{name:game.i18n.localize("tokenActionHud.settings.debug.name"),hint:game.i18n.localize("tokenActionHud.settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{updateFunc$1()}}),n.doRegisterSettings(s,updateFunc$1),Logger.debug("available rollHandlers: ",o)};function get(t){if(game.settings.settings.get(`${s}.${t}`))return game.settings.get(s,t)}function set(t,e){game.settings.set(s,t,e)}function registerColorSettings(t,e){const i={key:"background",name:game.i18n.localize("tokenActionHud.settings.background.name"),hint:game.i18n.localize("tokenActionHud.settings.background.hint"),scope:"client",restricted:!1,default:"#00000000",onChange:t=>{document.querySelector(":root").style.setProperty("--tah-background",t),updateFunc$1()}},s={key:"buttonBackgroundColor",name:game.i18n.localize("tokenActionHud.settings.buttonBackgroundColor.name"),hint:game.i18n.localize("tokenActionHud.settings.buttonBackgroundColor.hint"),scope:"client",restricted:!0,default:"#00000080",onChange:t=>{document.querySelector(":root").style.setProperty("--tah-button",t),updateFunc$1()}},a={key:"buttonBorderColor",name:game.i18n.localize("tokenActionHud.settings.buttonBorderColor.name"),hint:game.i18n.localize("tokenActionHud.settings.buttonBorderColor.hint"),scope:"client",restricted:!0,default:"#000000ff",onChange:t=>{document.querySelector(":root").style.setProperty("--tah-button-outline",t),updateFunc$1()}};if("color-picker"===e){const e={format:"hexa",alphaChannel:!0};ColorPicker.register(t,i.key,{name:i.name,hint:i.hint,scope:i.scope,restricted:i.restricted,default:i.default,onChange:i.onChange},e),ColorPicker.register(t,s.key,{name:s.name,hint:s.hint,scope:s.scope,restricted:s.restricted,default:s.default,onChange:s.onChange},e),ColorPicker.register(t,a.key,{name:a.name,hint:a.hint,scope:a.scope,restricted:a.restricted,default:a.default,onChange:a.onChange},e)}else"colorsettings"===e&&(new window.Ardittristan.ColorSetting(t,i.key,{name:i.name,hint:i.hint,scope:i.scope,restricted:i.restricted,defaultColor:i.default,onChange:i.onChange,insertAfter:`${t}.scale`}),new window.Ardittristan.ColorSetting(t,s.key,{name:s.name,hint:s.hint,scope:s.scope,restricted:s.restricted,defaultColor:s.default,onChange:s.onChange,insertAfter:`${t}.${i.key}`}),new window.Ardittristan.ColorSetting(t,a.key,{name:a.name,hint:a.hint,scope:a.scope,restricted:a.restricted,defaultColor:a.default,onChange:a.onChange,insertAfter:`${t}.${s.key}`}));Hooks.once("ready",(()=>{document.querySelector(":root").style.setProperty("--tah-background",game.settings.get(t,"background")??"#00000000"),document.querySelector(":root").style.setProperty("--tah-button",game.settings.get(t,"buttonBackgroundColor")??"#00000080"),document.querySelector(":root").style.setProperty("--tah-button-outline",game.settings.get(t,"buttonBorderColor")??"#000000ff")}))}class TagDialog extends Dialog{i18n=t=>game.i18n.localize(t);tagify=null;constructor(t,e){super(e),this.data=t}static showDialog(t,e,i,s,a,n){TagDialog._prepareHook(t,e,i);let o=Handlebars.compile("{{> modules/token-action-hud-rotv/templates/tagdialog.hbs}}")(a);new TagDialog({title:s,content:o,buttons:{accept:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("tokenActionHud.accept"),callback:async t=>{let e,i=TagDialog.tagify.value.map((t=>({id:t.id,value:t.value,type:t.type}))),s=t.find('select[id="token-action-hud-rotv-index"]');s.length>0&&(e=s[0]?.value),await n(i,e,t)}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("tokenActionHud.cancel")}},default:"accept"}).render(!0)}static _prepareHook(t,e,i){Hooks.once("renderTagDialog",((s,a,n)=>{a.css("height","auto");var o=a.find('select[id="token-action-hud-rotv-index"]');o.length>0&&(i&&o.val(i),o.css("background","#fff"),o.css("color","#000"));var r=a.find('input[class="token-action-hud-rotv-taginput"]');if(r.length>0){let i={delimiters:";",maxTags:"Infinity",dropdown:{maxItems:20,classname:"tags-look",enabled:0,closeOnSelect:!1}};t&&(i.whitelist=t),TagDialog.tagify=new Tagify(r[0],i);var l=$(document).find(".tagify");l.css("background","#fff"),l.css("color","#000"),e&&TagDialog.tagify.addTags(e);let s=a.find('button[class="tags--removeAllBtn"]');s.on("click",TagDialog.tagify.removeAllTags.bind(TagDialog.tagify)),s.css("float","right"),s.css("width","auto")}}))}_onKeyDown(t){if("Escape"===t.key&&!t.target.className.includes("tagify"))return t.preventDefault(),t.stopPropagation(),this.close();if("Enter"===t.key&&this.data.default&&!t.target.className.includes("tagify")){t.preventDefault(),t.stopPropagation();const e=this.data.buttons[this.data.default];return this.submit(e)}}}class CompendiumHelper{constructor(){}static getCompendiumChoicesAsTagifyEntries(){return("filter"in game.packs.entries?game.packs.entries:game.packs).filter((t=>["JournalEntry","Macro","RollTable","Playlist"].includes(t.documentName))).filter((t=>game.user.isGM||!t.private)).map((t=>({id:t.metadata.id??`${t.metadata.packageName}.${t.metadata.name}`,value:t.metadata.label,type:"comp"})))}static exists(t){return!!game.packs.get(t)}static async getEntriesForActions(t,e){let i=await CompendiumHelper.getCompendiumEntries(t),s=CompendiumHelper.getCompendiumMacroType(t);return i.map((i=>{let a=[s,t,i._id].join(e),n=CompendiumHelper.getImage(i);return{name:i.name,encodedValue:a,id:i._id,img:n}}))}static getCompendiumMacroType(t){let e=game?.packs?.get(t);if(!e)return"";switch(e.documentName){case"Macro":return"compendiumMacro";case"Playlist":return"compendiumPlaylist";default:return"compendiumEntry"}}static async getCompendiumEntriesForFilter(t){return(await CompendiumHelper.getCompendiumEntries(t)).map((t=>({value:t.name,id:t._id})))}static async getCompendiumEntries(t){let e=game.packs.get(t);if(!e)return[];let i=e.index.size>0?e.index:await e.getIndex();if("Playlist"===e.documentName){return await CompendiumHelper._getPlaylistEntries(e)}return i}static async _getPlaylistEntries(t){return(await t.getContent()).reduce(((t,e)=>(e.sounds.forEach((i=>{t.push({_id:`${e._id}>${i._id}`,name:i.name})})),t)),[])}static getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}}class TagDialogHelper{static showFilterDialog(t,e){TagDialogHelper._showFilterDialog(t,e)}static showSubcategoryDialogue(t,e,i){TagDialogHelper._showSubcategoryDialogue(t,e,i)}static showCategoryDialog(t){TagDialogHelper._showCategoryDialog(t)}static async submitCategories(t,e,i){await t.submitCategories(e,i),Hooks.callAll("forceUpdateTokenActionHUD")}static async submitSubcategories(t,e,i){await t.submitSubcategories(e,i),Hooks.callAll("forceUpdateTokenActionHUD")}static async submitFilter(t,e,i,s){await t.setFilteredElements(e,i,s),Hooks.callAll("forceUpdateTokenActionHUD")}static _showFilterDialog(t,e){let i=t.getSuggestions(e),s=t.getFilteredElements(e),a=t.isBlocklist(e)?1:0,n=game.i18n.localize("tokenActionHud.filterTitle"),o={topLabel:game.i18n.localize("tokenActionHud.filterTagExplanation"),placeholder:game.i18n.localize("tokenActionHud.filterPlaceholder"),clearButtonText:game.i18n.localize("tokenActionHud.clearButton"),indexExplanationLabel:game.i18n.localize("tokenActionHud.blockListLabel"),index:[{value:0,text:game.i18n.localize("tokenActionHud.allowlist")},{value:1,text:game.i18n.localize("tokenActionHud.blockList")}]};TagDialog.showDialog(i,s,a,n,o,(async(i,s)=>{let a=0!=parseInt(s);await TagDialogHelper.submitFilter(t,e,i,a)}))}static _showSubcategoryDialogue(t,e,i){let s=CompendiumHelper.getCompendiumChoicesAsTagifyEntries(),a=t.getCategorySubcategoriesAsTagifyEntries(e),n=game.i18n.localize("tokenActionHud.subcategoryTagTitle")+` (${i})`,o={topLabel:game.i18n.localize("tokenActionHud.subcategoryTagExplanation"),placeholder:game.i18n.localize("tokenActionHud.filterPlaceholder"),clearButtonText:game.i18n.localize("tokenActionHud.clearButton"),advancedCategoryOptions:game.user.getFlag("token-action-hud-rotv",`categories.${e}.advancedCategoryOptions`)};TagDialog.showDialog(s,a,null,n,o,(async(i,s,a)=>{let n=i.map((t=>({id:t.id,title:t.value,type:t.type})));await TagDialogHelper.submitSubcategories(t,e,n);const o={customWidth:parseInt(a.find('input[name="custom-width"]').val()),compactView:a.find('input[name="compact-view"]').prop("checked"),characterCount:parseInt(a.find('input[name="character-count"]').val())};await game.user.setFlag("token-action-hud-rotv",`categories.${e}.advancedCategoryOptions`,o)}))}static _showCategoryDialog(t){let e=t.getExistingCategories(),i=t.arePush()?1:0,s=game.i18n.localize("tokenActionHud.categoryTagTitle"),a={topLabel:game.i18n.localize("tokenActionHud.categoryTagExplanation"),placeholder:game.i18n.localize("tokenActionHud.filterPlaceholder"),clearButtonText:game.i18n.localize("tokenActionHud.clearButton"),indexExplanationLabel:game.i18n.localize("tokenActionHud.pushLabelExplanation"),index:[{value:0,text:game.i18n.localize("tokenActionHud.unshift")},{value:1,text:game.i18n.localize("tokenActionHud.push")}]};TagDialog.showDialog(null,e,i,s,a,(async(e,i)=>{let s=0!=parseInt(i);await TagDialogHelper.submitCategories(t,e,s)}))}}class CategoryResizer{static resizeHoveredCategory(t){let e=function jq(t){return"#"+t.replace(/(:|\.|\[|\]|,|=|@)/g,"\\$1")}(t),i=$(e);if(!i[0])return;let s=i.find(".tah-content"),a=i.hasClass("oneLine"),n=i.find(".tah-actions");if(0===n.length)return;const o=t.replace("tah-category-",""),r=game.user.getFlag("token-action-hud-rotv",`categories.${o}.advancedCategoryOptions.customWidth`);if(r)return CategoryResizer.resizeActions(n,r);CategoryResizer.resizeActions(n,300);const l=$(document).find("#hotbar").offset().top;let c=(0===l?window.innerHeight:l)-20;const d=$(document).find("#sidebar").offset().left;let u=(0===d?window.innerWidth:d)-20,h=CategoryResizer.calculateMaxRequiredWidth(n);for(;CategoryResizer.shouldIncreaseWidth(s,n,h,c,u,a);){let t=n[0].getBoundingClientRect().width,e=n.width();if(t>h)return;let i=e+30;CategoryResizer.resizeActions(n,i)}for(;CategoryResizer.shouldShrinkWidth(s,n,200,c,u,a);){let t=n[0].getBoundingClientRect().width,e=n.width();if(t<200)return;let i=e-30;CategoryResizer.resizeActions(n,i)}const g=s[0].getBoundingClientRect(),m=window.innerHeight-g.top-(window.innerHeight-c),y=m<100?100:m;s.css({"max-height":y+"px"})}static calculateMaxRequiredWidth(t){let e=0;return t.each((function(){let t=$(this);if(t.hasClass("excludeFromWidthCalculation"))return;let i=0;Array.from(t.children()).forEach((t=>{let e=$(t),s=e.width(),a=parseInt(e.css("marginLeft"))+parseInt(e.css("marginRight"));i+=s+a+5})),i-=5,i>e&&(e=i)})),e}static shouldIncreaseWidth(t,e,i,s,a,n){let o=t[0].getBoundingClientRect(),r=e[0].getBoundingClientRect();if(r.right>=a)return!1;if(r.width>=i)return!1;let l=Array.from(t.find(".tah-action")).sort(((t,e)=>$(t).offset().top-$(e).offset().top)),c=CategoryResizer.calculateRows(l),d=CategoryResizer.calculateMaxRowButtons(l);return!(o.bottom<=s&&d>=c&&!n)}static shouldShrinkWidth(t,e,i,s,a,n){let o=t[0].getBoundingClientRect(),r=e[0].getBoundingClientRect();if(o.bottom>=s)return!1;if(r.width<=i)return!1;let l=Array.from(t.find(".tah-action")).sort(((t,e)=>$(t).offset().top-$(e).offset().top)),c=CategoryResizer.calculateRows(l),d=CategoryResizer.calculateMaxRowButtons(l);return!(r.right<=a&&(c>=d-1||n))}static calculateRows(t){var e=0;let i=0;return t.forEach((t=>{let s=$(t).offset().top;Math.abs(i-s)>=5&&(e++,i=s)})),e}static calculateMaxRowButtons(t){if(t.length<2)return t.length;var e=[];let i=0,s=0;return t.forEach((a=>{let n=$(a).offset().top;Math.abs(i-n)>=5?(s>=1&&e.push(s),i=n,s=1):s++,s>=1&&t.indexOf(a)===t.length-1&&e.push(s)})),Math.max(...e)}static resizeActions(t,e){t.map((function(){$(this).css({width:e+"px","min-width":e+"px"})}))}}class TokenActionHUD extends Application{i18n=t=>game.i18n.localize(t);refresh_timeout=null;tokens=null;rendering=!1;categoryHovered="";defaultLeftPos=150;defaultTopPos=80;constructor(t){super(),this.systemManager=t}async init(t){this.actions=await this.systemManager.getActionHandler(t),this.rollHandler=this.systemManager.getRollHandler(),this.filterManager=this.systemManager.getFilterManager(),this.categoryManager=this.systemManager.getCategoryManager()}updateSettings(){this.updateRollHandler(),this.update()}updateRollHandler(){this.rollHandler=this.systemManager.getRollHandler()}setTokensReference(t){this.tokens=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:"/modules/token-action-hud-rotv/templates/template.hbs",id:"token-action-hud-rotv",classes:[],width:200,height:20,left:150,top:80,scale:1,background:"none",popOut:!1,minimizable:!1,resizable:!1,title:"token-action-hud-rotv",dragDrop:[],tabs:[],scrollY:[]})}getScale(){const t=parseFloat(get("scale"));return t<.5?.5:t>2?2:t}getSetting(t){return get(t)}getData(t={}){const e=super.getData();e.actions=this.targetActions,e.id="token-action-hud-rotv",e.hovering=get("onTokenHover"),e.scale=this.getScale(),e.background=this.getSetting("background")??"#00000000",Logger.debug("HUD data:",e);for(const i of e.actions.categories){const s=game.user.getFlag("token-action-hud-rotv",`categories.${i.id}.advancedCategoryOptions`);if(!s?.compactView)continue;const a=s.characterCount??2;function subcatRecursion(t){for(const e of t.subcategories){for(const t of e.actions)t.title=t.name,t.name.length<2||(t.name=0===a?"":t.name.split(" ").map((t=>t.slice(0,a))).join(" "));e.subcategories.length&&e.subcategories.forEach((t=>subcatRecursion(t)))}}subcatRecursion(i)}return e}activateListeners(t){const e="#tah-categories",i=".tah-category",s=".tah-title-button",a=".tah-action",handleClick=t=>{let e=t.target;"BUTTON"!==e.tagName&&(e=t.currentTarget.children[0]);let i=e.value;try{this.rollHandler.handleActionEvent(t,i),e.blur()}catch(e){Logger.error(t)}};function handlePossibleFilterSubtitleClick(t){let e=t.target;if(0===e.id.length)return;let i=e.id;TagDialogHelper.showFilterDialog(game.tokenActionHUD.filterManager,i)}function closeCategory(t){if(game.tokenActionHUD.rendering)return;let e=$(this)[0];$(e).removeClass("hover");let i=e.id;game.tokenActionHUD.clearHoveredCategory(i)}function openCategory(t){let e=$(this)[0];closeAllCategories(),$(e).addClass("hover");let i=e.id;game.tokenActionHUD.setHoveredCategory(i),CategoryResizer.resizeHoveredCategory(i)}function closeAllCategories(e){t.find(i).removeClass("hover")}function toggleCategory(t){let e,i=$(this.parentElement);$(i).hasClass("hover")?(e=closeCategory.bind(this.parentElement),e(t)):(e=openCategory.bind(this.parentElement),e(t))}t.find(s).on("click",(t=>{this.bringToTop()})),t.find(a).on("click",(t=>{t.preventDefault(),handleClick(t)})),t.find(a).contextmenu((t=>{handleClick(t)})),t.find(s).contextmenu("click",(t=>function handlePossibleFilterButtonClick(t){let e=t.target;if(0===e.value.length)return;let i=e.value,s=e.innerText??e.outerText;game.tokenActionHUD.categoryManager.isCompendiumCategory(i)?TagDialogHelper.showSubcategoryDialogue(game.tokenActionHUD.categoryManager,i,s):TagDialogHelper.showFilterDialog(game.tokenActionHUD.filterManager,i)}(t))),t.find(".tah-subtitle").click("click",(t=>handlePossibleFilterSubtitleClick(t))),t.find(".tah-subtitle").contextmenu("click",(t=>handlePossibleFilterSubtitleClick(t))),get("clickOpenCategory")?t.find(s).click("click",toggleCategory):(t.find(s).on("touchstart",toggleCategory),t.find(i).hover(openCategory,closeCategory)),t.find("#tah-edit-categories").mousedown((t=>{t.preventDefault(),t=t||window.event,TagDialogHelper._showCategoryDialog(this.categoryManager)}));const n="#tah-collapse-hud",o="#tah-expand-hud",r="#tah-buttons";game.user.getFlag("token-action-hud-rotv","isCollapsed")&&(t.find(n).addClass("tah-hidden"),t.find(o).removeClass("tah-hidden"),t.find(e).addClass("tah-hidden"),t.find(r).addClass("tah-hidden")),t.find(n).click((i=>{i.preventDefault(),i=i||window.event,game.user.getFlag("token-action-hud-rotv","isCollapsed")||($(i.target).addClass("tah-hidden"),t.find(o).removeClass("tah-hidden"),t.find(e).addClass("tah-hidden"),t.find(r).addClass("tah-hidden"),game.user.setFlag("token-action-hud-rotv","isCollapsed",!0))})),t.find(o).click((i=>{i.preventDefault(),i=i||window.event,$(i.target).addClass("tah-hidden"),t.find(n).removeClass("tah-hidden"),t.find(e).removeClass("tah-hidden"),t.find(r).removeClass("tah-hidden"),game.user.setFlag("token-action-hud-rotv","isCollapsed",!1)})),t.find(o).on("touchstart mousedown",(t=>{this.dragEvent(t)})),t.find(s).on("touchstart mousedown",(t=>{this.dragEvent(t)})),$(document).find(".tah-filterholder").parents(".tah-subcategory").css("cursor","pointer")}dragEvent(t){if(t=t||window.event,!get("drag"))return;const e=t.target.parentElement.closest("div#token-action-hud-rotv");document.onmousemove=mouseMoveEvent,document.onmouseup=mouseUpEvent,e.ontouchmove=mouseMoveEvent,e.ontouchend=mouseUpEvent;const i=t.clientX??t.changedTouches[0].clientX,s=t.clientY??t.changedTouches[0].clientY;let a=0,n=0,o=i,r=s,l=e.offsetTop,c=e.offsetLeft;function mouseMoveEvent(t){const i=(t=t||window.event).clientX??t.changedTouches[0].clientX,s=t.clientY??t.changedTouches[0].clientY;a=o-i,n=r-s,o=i,r=s,l=e.offsetTop-n,c=e.offsetLeft-a,e.style.top=l+"px",e.style.left=c+"px",e.style.position="fixed"}function mouseUpEvent(){document.onmousemove=null,document.onmouseup=null,e.ontouchmove=null,e.ontouchend=null,game.user.update({flags:{"token-action-hud-rotv":{hudPos:{top:l,left:c}}}}),Logger.info(`Setting position to x: ${l}px, y: ${c}px, and saving in user flags.`)}}applySettings(){"up"===get("direction")&&($(document).find(".tah-content").removeClass("expand-down"),$(document).find(".tah-content").addClass("expand-up"),$(document).find("#tah-character-name").addClass("tah-hidden"))}trySetPos(){if(!this.targetActions||!this.targetActions.tokenId)return;let t=$(document).find("#tah-character-name");t.length>0&&t.css("top",-t[0].getBoundingClientRect().height);let e=canvas?.tokens?.placeables.find((t=>t.id===this.targetActions?.tokenId));get("onTokenHover")&&e?this.setHoverPos(e):this.setUserPos(),this.restoreCategoryHoverState(),this.rendering=!1}setUserPos(){if(!game.user.flags["token-action-hud-rotv"]||!game.user.flags["token-action-hud-rotv"].hudPos)return;let t=game.user.flags["token-action-hud-rotv"].hudPos,e=this.defaultLeftPos,i=this.defaultTopPos;return new Promise((s=>{!function check(){let a=document.getElementById("token-action-hud-rotv");a?(a.style.bottom=null,a.style.top=t.top<5||t.top>window.innerHeight+5?i+"px":t.top+"px",a.style.left=t.left<5||t.left>window.innerWidth+5?e+"px":t.left+"px",a.style.position="fixed",s()):setTimeout(check,30)}()}))}setHoverPos(t){return new Promise((e=>{!function check(t){let i=$("#token-action-hud-rotv");i?(i.css("bottom",null),i.css("left",t.worldTransform.tx+(t.width*canvas.dimensions.size+55)*canvas.scene._viewPosition.scale+"px"),i.css("top",t.worldTransform.ty+0+"px"),i.css("position","fixed"),e()):setTimeout(check,30)}(t)}))}setHoveredCategory(t){this.categoryHovered=t}clearHoveredCategory(t){this.categoryHovered===t&&(this.categoryHovered="")}restoreCategoryHoverState(){if(""===this.categoryHovered)return;let t=`#${this.categoryHovered}`,e=$(t);if(e[0])if(get("clickOpenCategory")){e.find(".tah-title-button")[0].click()}else e.mouseenter()}async resetHud(){await this.resetFlags(),this.resetPosition()}resetPosition(){Logger.info("Resetting HUD position to x: 80px, y: 150px, and saving in user flags. \nIf HUD is still not visible, something else may be wrong.\nFeel free to contact Drental#7416 on Discord"),game.user.update({flags:{"token-action-hud-rotv":{hudPos:{top:80,left:150}}}}),this.update()}async resetFlags(){Logger.info("Resetting Token Action HUD filter and category flags"),await this.categoryManager.reset(),await this.filterManager.reset(),this.update()}update(){this.refresh_timeout&&clearTimeout(this.refresh_timeout),this.refresh_timeout=setTimeout(this.updateHud.bind(this),100)}async updateHud(){Logger.debug("Updating HUD");let t=this._getTargetToken(this.tokens?.controlled),e=this.tokens?.controlled.length>1&&!t;this.targetActions=await this.actions.buildActionList(t,e),this.showHudEnabled()?(ui.windows[this.appId]||(ui.windows[this.appId]=this),this.rendering=!0,this.render(!0)):this.close()}validTokenChange(t){return get("alwaysShowHud")?this.isRelevantToken(t)||t.actorId===game.user.character?.id:this.isRelevantToken(t)}isRelevantToken(t){let e=this.tokens?.controlled;return e?.some((e=>e.id===this.getTokenId(t)))||0===e?.length&&canvas?.tokens?.placeables?.some((t=>t.id===this.targetActions?.tokenId))}getTokenId(t){return t.id??t.id}validTokenHover(t,e){return e&&get("onTokenHover")&&t.id===this.targetActions?.tokenId}validActorOrItemUpdate(t){if(t)return Logger.debug("actor change, comparing actors"),Logger.debug(`actor.id: ${t.id}; this.targetActions.actorId: ${this.targetActions?.actorId}`),t?this.targetActions&&t.id===this.targetActions.actorId?(Logger.debug("Same actor IDs, should update HUD."),!0):(Logger.debug("Different actor, no need to update HUD."),!1):(Logger.debug("No actor, possibly deleted, should update HUD."),!0)}showHudEnabled(){return Logger.debug("showHudEnabled()",`isGM: ${game.user.isGM}`,`enabledForUser: ${get("enabledForUser")}`,`playerPermission: ${get("playerPermission")}`),!!get("enabledForUser")&&(get("playerPermission")||game.user.isGM)}isLinkedCompendium(t){return Logger.debug("Compendium hook triggered. Checking if compendium is linked."),this.categoryManager.isLinkedCompendium(t)}_getTargetToken(t=[]){if(t.length>1)return null;if(0===t.length&&canvas.tokens?.placeables&&game.user.character){if(!get("alwaysShowHud"))return null;let t=game.user.character,e=canvas?.tokens?.placeables.find((e=>e.actor?.id===t?.id));return e||null}let e=t[0];return e&&this._userHasPermission(e)?e:null}_userHasPermission(t=""){let e=t.actor,i=game.user;return game.user.isGM||e?.testUserPermission(i,"OWNER")}}class Filter{id="";isBlocklist=!1;filteredElements=[];possibleChoices=[];constructor(t){this.id=t}async setFilteredElements(t,e){Array.isArray(t)&&(this.filteredElements=t,this.isBlocklist=e),await this.updateFlag()}getSuggestions(){return this.possibleChoices}getFilteredElements(){return this.filteredElements}getFilteredNames(){return this.filteredElements.map((t=>t.value))}getFilteredIds(){return this.filteredElements.map((t=>t.id))}setSuggestions(t){Array.isArray(t)&&(this.possibleChoices=t)}async updateFlag(){let t={isBlocklist:this.isBlocklist,elements:this.filteredElements};await game.user.setFlag("token-action-hud-rotv",`filters.${this.id}`,t)}async clearFlag(){await game.user.setFlag("token-action-hud-rotv","filters",{[`-=${this.id}`]:null})}}class FilterManager{filters=[];user=null;constructor(t){this.user=t;let e=t.getFlag("token-action-hud-rotv","filters");e&&(Logger.debug("saved filters:",e),Object.entries(e).forEach((t=>{let e=new Filter(t[0]);e.setFilteredElements(t[1].elements,t[1].isBlocklist),this.filters.push(e)})))}async reset(){this.filters=[],await game.user.unsetFlag("token-action-hud-rotv","filters")}createOrGetFilter(t){if(this.filters.some((e=>e.id===t)))return this.filters.find((t=>t.id));let e=new Filter(t);return this.filters.push(e),e}getSuggestions(t){return this._getFilter(t).getSuggestions()}setSuggestions(t,e){this._getFilter(t).setSuggestions(e)}getFilteredElements(t){return this._getFilter(t).getFilteredElements()}getFilteredNames(t){return this._getFilter(t).getFilteredNames()}getFilteredIds(t){return this._getFilter(t).getFilteredIds()}async setFilteredElements(t,e,i){let s=this._getFilter(t);await s.setFilteredElements(e,i)}async clearFilter(t){let e=this.filters.find((e=>e.id===t));e&&(await e.clearFlag(),this.filters.splice(this.filters.indexOf(e),1))}isBlocklist(t){return this._getFilter(t).isBlocklist}_getFilter(t){return this.filters.find((e=>e.id===t))??this.createOrGetFilter(t)}}const a="macro",n="comp";class FilterSubcategory{constructor(t,e){this.filterManager=t,this.title=e}async updateFlag(t){let e=this.getFlagContents();await game.user.setFlag("token-action-hud-rotv",`categories.${t}.subcategories.${this.id}`,e)}async unsetFlag(t){t&&await game.user.setFlag("token-action-hud-rotv",`categories.${t}.subcategories`,{[`-=${this.id}`]:null})}createFilter(){this.filterManager.createOrGetFilter(this.id)}clearFilter(){this.filterManager.clearFilter(this.id)}async setFilteredElements(t,e){await this.filterManager.setFilteredElements(this.id,t,e)}asTagifyEntry(){return{id:this.id,value:this.title,type:this.type}}async addToCategory(t,e){let i=t.initializeEmptySubcategory(this.id);i.actions=await this._getActions(t.delimiter),i.canFilter=!0,t._combineSubcategoryWithCategory(e,this.title,i)}getFlagContents(){return{id:this.id,title:this.title,type:this.type}}async _getActions(){return[]}}class CompendiumSubcategory extends FilterSubcategory{constructor(t,e,i,s){super(t,s),this.id=`${e}_${i}`.slugify({replacement:"_",strict:!0}),this.compendiumId=i,this.type=n}async submitFilterSuggestions(){let t=await CompendiumHelper.getCompendiumEntriesForFilter(this.compendiumId);this.filterManager.setSuggestions(this.id,t)}async _getActions(t){let e=await CompendiumHelper.getEntriesForActions(this.compendiumId,t),i=this.filterManager.getFilteredIds(this.id),s=this.filterManager.isBlocklist(this.id),a=e;return i.length>0&&(a=e.filter((t=>i.includes(t.id)!==s))),a}getFlagContents(){return{id:this.compendiumId,title:this.title,type:this.type}}}class MacroHelper{constructor(){}static exists(t,e){if(e)return e.some((e=>e._id===t));return!!("some"in game.macros.entries?game.macros.entries:game.macros).some((e=>e._id===t))}static getEntriesForActions(t){let e="macro";return MacroHelper.getMacros().map((i=>{let s=[e,e,i._id].join(t),a=MacroHelper.getImage(i);return{name:i.name,encodedValue:s,id:i._id,img:a}}))}static getMacrosForFilter(){return MacroHelper.getMacros().map((t=>({id:t._id,value:t.name})))}static getMacros(){return("filter"in game.macros.entries?game.macros.entries:game.macros).filter((t=>{let e=t.ownership;return e[game.userId]?e[game.userId]>0:e.default>0}))}static getImage(t){let e="";return get("showIcons")&&(e=t.img),e?.includes("icons/svg/mystery-man.svg")?"":e}}class MacroSubcategory extends FilterSubcategory{constructor(t,e,i){super(t,i),this.id=`${e}_${i}`.slugify({replacement:"_",strict:!0}),this.type=a}submitFilterSuggestions(){let t=MacroHelper.getMacrosForFilter();this.filterManager.setSuggestions(this.id,t)}_getActions(t){let e=MacroHelper.getEntriesForActions(t),i=this.filterManager.getFilteredIds(this.id),s=this.filterManager.isBlocklist(this.id);return 0===i.length?[]:e.filter((t=>i.includes(t.id)!==s))}}class FilterCategory{subcategories=[];id="";key="";title="";push=!1;core=!1;constructor(t,e,i,s,a){this.filterManager=t,this.id=e,this.key=e.slugify({replacement:"_",strict:!0}),this.title=i,this.push=s,this.core=a??!1}async addToActionList(t,e){if(e.categories.some((t=>t.name===this.title))){let i=e.categories.find((t=>t.name===this.title));if(!i.subcategories.length)return;await this.addSubcategoriesToCategory(t,i)}else await this.doAddToActionList(t,e)}async doAddToActionList(t,e){if(this.core)return;let i=t.initializeEmptyCategory(this.id);i.core=this.core,await this.addSubcategoriesToCategory(t,i),t._combineCategoryWithList(e,this.title,i,this.push)}async addSubcategoriesToCategory(t,e){for(let i of this.subcategories)await i.addToCategory(t,e)}async selectSubcategories(t){for(let e of t)e.type===n?await this.addCompendiumSubcategory(e):this.addMacroSubcategory(e);if(0===this.subcategories.length)return;let e=t.map((t=>t.title));for(var i=this.subcategories.length-1;i>=0;i--){let t=this.subcategories[i];e.includes(t.title)||await this.removeSubcategory(i)}await this.updateFlag()}async addCompendiumSubcategory(t){if(this.subcategories.some((e=>e.compendiumId===t.id)))return;if(!CompendiumHelper.exists(t.id))return;let e=new CompendiumSubcategory(this.filterManager,this.key,t.id,t.title);e.createFilter(),await e.submitFilterSuggestions(),this.subcategories.push(e)}addMacroSubcategory(t){if(this.subcategories.some((e=>e.title===t.title)))return;let e=new MacroSubcategory(this.filterManager,this.key,t.title);e.createFilter(),e.submitFilterSuggestions(),this.subcategories.push(e)}async updateFlag(){let t={categories:{[this.key]:{title:this.title,id:this.id,push:this.push,core:this.core}}};await game.user.update({flags:{"token-action-hud-rotv":t}});for(let t of this.subcategories)await t.updateFlag(this.key)}async removeSubcategory(t){let e=this.subcategories[t];await e.clearFilter(),await e.unsetFlag(this.key),this.subcategories.splice(t,1)}async prepareForDelete(){await this.clearFilters(),await this.unsetFlag()}async clearFilters(){for(let t of this.subcategories)await t.clearFilter()}async unsetFlag(){await game.user.setFlag("token-action-hud-rotv","categories",{[`-=${this.key}`]:null})}asTagifyEntry(){return{id:this.id,value:this.title}}getSubcategoriesAsTagifyEntries(){return this.subcategories.map((t=>t.asTagifyEntry()))}}class CategoryManager{categories=[];user=null;constructor(t,e){this.user=t,this.filterManager=e}async reset(){this.categories=[],await game.user.unsetFlag("token-action-hud-rotv","categories")}async init(){let t=this.user.getFlag("token-action-hud-rotv","categories");if(t){Logger.debug("saved categories:",t);for(let e of Object.values(t)){let t=e.id,i=e.title,s=e.push??!1,a=e.core??!1;if(!t&&!i)continue;let n=new FilterCategory(this.filterManager,t,i,s,a),o=e.subcategories;o&&(o=Object.values(o),await n.selectSubcategories(o)),this.categories.push(n)}}}async addCategoriesToActionList(t,e){get("alwaysShowAdditionalCategories")&&(e.tokenId||(e.tokenId="categoryManager"),e.actorId||(e.actorId="categoryManager")),e.tokenId&&await this.doAddCategories(t,e)}async doAddCategories(t,e){for(let i of this.categories)await i.addToActionList(t,e)}async submitCategories(t,e){t=t.map((t=>({id:t.value.slugify({replacement:"_",strict:!0}),value:t.value})));for(let i of t){let t=this.categories.find((t=>t.id===i.id));t?await this._updateCategory(t,e):await this._createCategory(i,e)}let i=t.map((t=>t.id));if(0!==this.categories.length)for(var s=this.categories.length-1;s>=0;s--){let t=this.categories[s];i.includes(t.id)||t.core||await this.deleteCategory(s)}}async addCoreCategories(t){for(let e of t){let t=this.categories.find((t=>t.id===e.id));!t||t.core?t||await this._createCategory({id:e.id,value:e.name},!1,!0):(t.core=!0,await t.updateFlag())}}async _createCategory(t,e,i=!1){let s=new FilterCategory(this.filterManager,t.id,t.value,e,i);await s.updateFlag(),this.categories.push(s)}async _updateCategory(t,e){t.push=e,await t.updateFlag()}async deleteCategory(t){let e=this.categories[t];await e.prepareForDelete(),this.categories.splice(t,1)}async submitSubcategories(t,e){let i=this.categories.find((e=>e.id===t));i&&await i.selectSubcategories(e)}getExistingCategories(){return this.categories.filter((t=>!t.core)).map((t=>t.asTagifyEntry()))}isCompendiumCategory(t){return this.categories.some((e=>e.id===t))}isLinkedCompendium(t){return this.categories.some((e=>e.subcategories?.some((e=>e.compendiumId===t))))}arePush(){let t=this.categories.filter((t=>!t.core));return t.filter((t=>t.push)).length>=t.length/2}getCategorySubcategoriesAsTagifyEntries(t){let e=this.categories.find((e=>e.id===t));if(e)return e.getSubcategoriesAsTagifyEntries()}}class ActionList{constructor(){this.hudTitle="",this.tokenId="",this.actorId="",this.categories=[]}}class ActionCategory{constructor(){this.id="",this.name="",this.cssClass="",this.subcategories=[]}}class ActionSubcategory{constructor(){this.id="",this.name="",this.info1="",this.canFilter=!1,this.actions=[],this.subcategories=[]}}class ActionSet{constructor(){this.set=!0,this.actions=[],this.cssClass=""}}class Action{constructor(){this.id="",this.name="",this.encodedValue="",this.info1="",this.info2="",this.info3="",this.info4="",this.cssClass="",this.icon="",this.img=""}}class GenericActionHandler{baseHandler;constructor(t){this.baseHandler=t}addGenericCategories(t,e,i){this._addConditions(t,e,i),this._addUtilities(t,e,i)}_addConditions(t,e,i){}_addUtilities(t,e,i){if(!1===get("showUtilityCategory"))return;let s=e.categories.find((t=>"utility"===t.id));if(s||(s=this.baseHandler.initializeEmptyCategory("utility"),s.name=this.baseHandler.i18n("tokenActionHud.utility"),e.categories.push(s)),i){const t=canvas.tokens.controlled;this._addMultiUtilities(s,t)}else this._getUtilityList(s,t.id)}_getUtilityList(t,e){let i="utility",s=this.baseHandler.initializeEmptySubcategory();const a=canvas.tokens.placeables.find((t=>t.id===e)).inCombat?this.baseHandler.i18n("tokenActionHud.removeFromCombat"):this.baseHandler.i18n("tokenActionHud.addToCombat");let n={id:"toggleCombat",encodedValue:[i,e,"toggleCombat"].join(this.baseHandler.delimiter),name:a};if(s.actions.push(n),game.user.isGM){const t=canvas.tokens.placeables.find((t=>t.id===e)).document.hidden?this.baseHandler.i18n("tokenActionHud.makeVisible"):this.baseHandler.i18n("tokenActionHud.makeInvisible");let a={id:"toggleVisibility",encodedValue:[i,e,"toggleVisibility"].join(this.baseHandler.delimiter),name:t};s.actions.push(a)}const o=this.baseHandler.i18n("tokenActionHud.token");this.baseHandler._combineSubcategoryWithCategory(t,o,s)}_addMultiUtilities(t,e){let i="utility",s="multi",a=this.baseHandler.initializeEmptySubcategory();const n=e.every((t=>t.inCombat))?this.baseHandler.i18n("tokenActionHud.removeFromCombat"):this.baseHandler.i18n("tokenActionHud.addToCombat");let o={id:"toggleCombat",encodedValue:[i,s,"toggleCombat"].join(this.baseHandler.delimiter),name:n};if(a.actions.push(o),game.user.isGM){const t=e.every((t=>!t.document.hidden))?this.baseHandler.i18n("tokenActionHud.makeVisible"):this.baseHandler.i18n("tokenActionHud.makeInvisible");let n={id:"toggleVisibility",encodedValue:[i,s,"toggleVisibility"].join(this.baseHandler.delimiter),name:t};a.actions.push(n)}const r=this.baseHandler.i18n("tokenActionHud.token");this.baseHandler._combineSubcategoryWithCategory(t,r,a)}}class ActionHandler{i18n=t=>game.i18n.localize(t);linkedCompendiumsGm=[];linkedCompendiumsPlayer=[];furtherActionHandlers=[];delimiter="|";filterManager=null;constructor(t,e){this.filterManager=t,this.categoryManager=e,this.genericActionHandler=new GenericActionHandler(this)}async registerCoreCategories(t){await this.categoryManager.addCoreCategories(t)}async buildActionList(t,e){let i=await this.doBuildActionList(t,e);return this._addGenericCategories(t,i,e),this._doBuildFurtherActions(t,i,e),await this.registerCoreCategories(i.categories),await this.categoryManager.addCategoriesToActionList(this,i),i}doBuildActionList(t){}_addGenericCategories(t,e,i){(t||i)&&this.genericActionHandler.addGenericCategories(t,e,i)}_doBuildFurtherActions(t,e,i){this.furtherActionHandlers.forEach((t=>t.extendActionList(e,i)))}addFurtherActionHandler(t){Logger.debug(`Adding further action handler: ${t.constructor.name}`),this.furtherActionHandlers.push(t)}initializeEmptyActionList(){return new ActionList}initializeEmptyActionSet(){return new ActionSet}initializeEmptyAction(){return new Action}initializeEmptyCategory(t){let e=new ActionCategory;return e.id=t,e}initializeEmptySubcategory(t="",e=null){let i=new ActionSubcategory;return i.id=t,e&&(i.name=this.i18n(e)),i}_combineCategoryWithList(t,e,i,s=!0){i&&(0!==i.subcategories.length||!i.core&&void 0!==i.core)&&(e?.length>0&&(i.name=e),s?t.categories.push(i):t.categories.unshift(i))}_combineSubcategoryWithCategory(t,e,i){i&&(e?.length>0&&(i.name=e),i.subcategories.length>0||i.actions.length>0||i.canFilter?t.subcategories.push(i):Logger.debug("subcategory criteria not met, disposing of",e))}_foundrySort(t,e){return t?.sort||e?.sort?t.sort-e.sort:0}}class ActionListExtender extends ActionHandler{constructor(){super()}extendActionList(t,e){}}class ItemMacroActionListExtender extends ActionListExtender{constructor(){super()}static isModuleActive(t){let e=game.modules.get(t);return e&&e.active}extendActionList(t,e){if(e)return;let i=t.tokenId;if(!t.actorId)return;let s,a=this.getActor(i).items.filter((t=>t.hasMacro()));if(s=ItemMacroActionListExtender.isModuleActive("midi-qol")?a.filter(this.isUnsupportedByMidiQoL).map((t=>t.id)):a.map((t=>t.id)),!s)return;if(0===s.length)return;let n=get("itemMacroReplace");if("showOriginal"===n)return t;let o="showItemMacro"===n;return t.categories.forEach((t=>{t.subcategories.forEach((t=>{this.addSubcategoryActions(s,t,o)}))})),t}addSubcategoryActions(t,e,i){e.subcategories&&e.subcategories.length>0&&e.subcategories.forEach((e=>this.addSubcategoryActions(t,e,i)));let s=[];e.actions.forEach((e=>{if(!t.includes(e.id))return;let a=this.createItemMacroAction(e,i);i||s.push(a)})),this.addActionsToSubcategory(e,s)}createItemMacroAction(t,e){let i=e?t:{},s=t.encodedValue.substr(t.encodedValue.indexOf(this.delimiter));return i.encodedValue="itemMacro"+s,i.name=e?t.name:`(M) ${t.name}`,i.id=t.id,i.img=t.img,i.icon=t.icon,i.info1=t.info1,i.info2=t.info2,i.info3=t.info3,i.info4=t.info4,i}addActionsToSubcategory(t,e){e.forEach((e=>{let i=t.actions.findIndex((t=>t.id===e.id))+1;t.actions.splice(i,0,e)}))}isUnsupportedByMidiQoL(t){return!t.getFlag("midi-qol","onUseMacroName")}getActor(t){return canvas.tokens.placeables.find((e=>e.id===t))?.actor}}class RollHandler{preRollHandlers=[];constructor(){}i18n=t=>game.i18n.localize(t);getActor(t){return canvas.tokens.placeables.find((e=>e.id===t))?.actor}getItem(t,e){return t.items.get(e)}getToken(t){return canvas.tokens.placeables.find((e=>e.id===t))}throwInvalidValueErr(t){throw new Error("Error handling button click: unexpected button value/payload")}async handleActionEvent(t,e){Logger.debug(e),this.registerKeyPresses(t);let i=!1;this.preRollHandlers.forEach((s=>{i||(i=s.prehandleActionEvent(t,e))})),i||(this._isMultiGenericAction(e)?await this._doMultiGenericAction(e):this.doHandleActionEvent(t,e))}doHandleActionEvent(t,e){}addPreRollHandler(t){Logger.debug(`Adding pre-roll handler: ${t.constructor.name}`),this.preRollHandlers.push(t)}registerKeyPresses(t){this.rightClick=this.isRightClick(t),this.ctrl=this.isCtrl(t),this.alt=this.isAlt(t),this.shift=this.isShift(t)}doRenderItem(t,e){let i=this.getActor(t);this.getItem(i,e).sheet.render(!0)}isRenderItem(){return get("renderItemOnRightClick")&&this.rightClick&&!(this.alt||this.ctrl||this.shift)}isRightClick(t){return 2===t?.originalEvent?.button}isAlt(t){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT)}isCtrl(t){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL)}isShift(t){return game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT)}_isMultiGenericAction(t){let e=t.split("|"),i=e[0],s=e[2];return"utility"===i&&s.includes("toggle")}async _doMultiGenericAction(t){let e=t.split("|")[2];"toggleVisibility"===e&&await canvas.tokens.controlled[0].toggleVisibility(),"toggleCombat"===e&&await canvas.tokens.controlled[0].toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD")}}class PreRollHandler extends RollHandler{constructor(){super()}prehandleActionEvent(t,e){return!1}}class CompendiumMacroPreHandler extends PreRollHandler{constructor(){super()}prehandleActionEvent(t,e){let i=game.tokenActionHUD.actions.delimiter,s=e.split(i);if(3!=s.length)return!1;let a=s[0],n=s[1],o=s[2];if(!["compendiumEntry","compendiumMacro","compendiumPlaylist","macro"].includes(a))return!1;switch(a){case"compendiumEntry":this.handleCompendium(a,t,n,o);break;case"compendiumMacro":this.handleMacroCompendium(a,t,n,o);break;case"compendiumPlaylist":this.handlePlaylistCompendium(a,t,n,o);break;case"macro":this.handleMacro(a,t,n,o);break;default:return!1}return!0}handleCompendium(t,e,i,s){game.packs.get(i).getDocument(s).then((t=>t.sheet.render(!0)))}handleMacroCompendium(t,e,i,s){game.packs.get(i).getDocument(s).then((t=>t.execute()))}async handlePlaylistCompendium(t,e,i,s){let a=game.packs.get(i),n=s.split(">"),o=n[0],r=n[1],l=(await a.getDocument(o)).sounds.find((t=>t._id===r));AudioHelper.play({src:l.path},{})}handleMacro(t,e,i,s){game.macros.find((t=>t.id===s)).execute()}}class ItemMacroPreRollHandler extends PreRollHandler{constructor(){super()}prehandleActionEvent(t,e){this.registerKeyPresses(t);let i=e.split("|");if(3!=i.length)return!1;let s=i[0],a=i[1],n=i[2];return"itemMacro"==s&&(this.isRenderItem()?(this.doRenderItem(a,n),!0):this._tryExecuteItemMacro(t,a,n))}_tryExecuteItemMacro(t,e,i){let s=super.getActor(e),a=super.getItem(s,i);try{a.executeMacro()}catch(t){return Logger.error("ItemMacro error: ",t),!1}return!0}}class SystemManager{i18n=t=>game.i18n.localize(t);appName;constructor(t){this.appName=t}doGetActionHandler(){}doGetRollHandler(t){}getAvailableRollHandlers(){}doRegisterSettings(t,e){}async getActionHandler(t){this.filterManager=new FilterManager(t),this.categoryManager=new CategoryManager(t,this.filterManager),await this.categoryManager.init();let e=this.doGetActionHandler(this.filterManager,this.categoryManager);return this.addActionExtenders(e),e}doGetActionHandler(){}addActionExtenders(t){SystemManager.isModuleActive("itemacro")&&t.addFurtherActionHandler(new ItemMacroActionListExtender)}filterManager;getFilterManager(){return this.filterManager}categoryManager;getCategoryManager(){return this.categoryManager}getRollHandler(){let t=get("rollHandler");"core"===t||SystemManager.isModuleActive(t)||(Logger.error(t,this.i18n("tokenActionHud.handlerNotFound")),t="core",set("rollHandler",t));let e=this.doGetRollHandler(t);return this.addPreHandlers(e),e}doGetRollHandler(t){}addPreHandlers(t){t.addPreRollHandler(new CompendiumMacroPreHandler),SystemManager.isModuleActive("itemacro")&&t.addPreRollHandler(new ItemMacroPreRollHandler)}getAvailableRollHandlers(){}registerSettings(){let t=this.getAvailableRollHandlers();registerSettings(this.appName,this,t)}static addHandler(t,e){if(SystemManager.isModuleActive(e)){let i=SystemManager.getModuleTitle(e);mergeObject(t,{[e]:i})}}static isModuleActive(t){let e=game.modules.get(t);return e&&e.active}static getModuleTitle(t){return game.modules.get(t)?.title??""}}class ActionHandlerBitD extends ActionHandler{constructor(t,e){super(t,e),this.filterManager.createOrGetFilter("skills")}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;i.actorId=a.id;let n=this._getActions(a,s),o=this._getResistances(a,s);return this._combineCategoryWithList(i,this.i18n("tokenActionHud.actions"),n),this._combineCategoryWithList(i,this.i18n("tokenActionHud.bitd.resistance"),o),get("showHudTitle")&&(i.hudTitle=t.name),i}_getActions(t,e){let i=this.initializeEmptyCategory("actions");for(let s in t.system.attributes){let a=this.initializeEmptySubcategory();for(let i in t.system.attributes[s].skills){let n=t.system.attributes[s].skills[i],o=this.i18n(n.label),r=["action",e,i].join(this.delimiter);a.actions.push({name:o,encodedValue:r})}let n=this.i18n(t.system.attributes[s].label);this._combineSubcategoryWithCategory(i,n,a)}return i}_getResistances(t,e){let i=this.initializeEmptyCategory("actions"),s=this.initializeEmptySubcategory();for(let i in t.system.attributes){let a=this.i18n(t.system.attributes[i].label),n=["resistance",e,i].join(this.delimiter);s.actions.push({name:a,encodedValue:n})}let a=this.i18n("tokenActionHud.bitd.resistance");return this._combineSubcategoryWithCategory(i,a,s),i}}class RollHandlerBaseBitD extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr(),i[0];let s=i[1],a=i[2];super.getActor(s).rollAttributePopup(a)}rollItemMacro(t,e,i){e.item.find((t=>t.id===i)).roll(t)}}class BitDSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerBitD(t,e)}getAvailableRollHandlers(){return{core:"Core BitD"}}doGetRollHandler(t){return new RollHandlerBaseBitD}doRegisterSettings(t,e){}}class ActionHandler5e extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){return t?this._buildSingleTokenList(t):e?this._buildMultipleTokenList():this.initializeEmptyActionList()}async _buildSingleTokenList(t){const e=this.initializeEmptyActionList();if(e.tokenId=t?.id,e.actorId=t?.actor?.id,!e.tokenId||!e.actorId)return e;get("showHudTitle")&&(e.hudTitle=t.name);return(await this._buildCategories(t)).flat().filter((t=>t)).forEach((t=>{this._combineCategoryWithList(e,t.name,t)})),e}_buildCategories(t){const e=t.actor;return"character"===e.type||"npc"===e.type?[this._buildItemsCategory(t),this._buildSpellsCategory(t),this._buildFeaturesCategory(t),this._buildSkillsCategory(t),this._buildAbilitiesCategory(t),this._buildEffectsCategory(t),this._buildConditionsCategory(t),this._buildUtilityCategory(t)]:"vehicle"===e.type?[this._buildWeaponsCategory(t),this._buildFeaturesCategory(t),this._buildAbilitiesCategory(t),this._buildEffectsCategory(t),this._buildConditionsCategory(t)]:void 0}_buildAbilitiesCategory(t){if(!1===get("showAbilitiesCategory"))return;const e=t.actor.system.abilities;if(get("splitAbilities")){const i=this.i18n("tokenActionHud.rotv.saves"),s=this._getAbilityList(t.id,e,"saves",i,"abilitySave");s.name=i;const a=this.i18n("tokenActionHud.rotv.checks"),n=this._getAbilityList(t.id,e,"checks",this.i18n("tokenActionHud.rotv.checks"),"abilityCheck");return n.name=a,[s,n]}return this._getAbilityList(t.id,e,"abilities",this.i18n("tokenActionHud.rotv.abilities"),"ability")}_buildMultipleTokenList(){const t=this.initializeEmptyActionList();t.tokenId="multi",t.actorId="multi";const e=["npc","character"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.type)));const s=t.tokenId;if(this._addMultiSkills(t,s),get("splitAbilities")){let e=this.i18n("tokenActionHud.rotv.saves"),i=this.i18n("tokenActionHud.rotv.checks");this._addMultiAbilities(t,s,"saves",e,"abilitySave"),this._addMultiAbilities(t,s,"checks",i,"abilityCheck")}else{let e=this.i18n("tokenActionHud.rotv.abilities");this._addMultiAbilities(t,s,"abilities",e,"ability")}return get("showConditionsCategory")&&this._addMultiConditions(t,s),this._addMultiUtilities(t,s,i),t}_buildItemsCategory(t){if(!1===get("showInventoryCategory"))return;const e=t.actor,i=t.id;let s,a=this._filterLongerActions(e.items.filter((t=>t.system.quantity>0))),n=this._sortByItemSort(a),o="item";s="npc"===e.type&&get("showAllNpcItems")?n.filter((t=>"consumable"!==t.type&&"spell"!==t.type&&"feat"!==t.type)):n.filter((t=>"consumable"!==t.type&&t.system.equipped));let r=this._getActiveEquipment(s),l=r.filter((t=>"weapon"==t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),c=this.initializeEmptySubcategory();c.actions=l;let d=r.filter((t=>"equipment"==t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),u=this.initializeEmptySubcategory();u.actions=d;let h=r.filter((t=>"weapon"!=t.type&&"equipment"!=t.type&&"tool"!=t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),g=this.initializeEmptySubcategory();g.actions=h;let m=this._getActiveEquipment(n.filter((t=>"consumable"==t.type))),y=this._filterExpendedItems(m).map((t=>this._buildEquipmentItem(i,e,o,t))),p=this.initializeEmptySubcategory();p.actions=y;let b=a.filter((t=>"tool"===t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),f=this.initializeEmptySubcategory();f.actions=b;let k=this.i18n("tokenActionHud.weapons"),_=this.i18n("tokenActionHud.equipment"),C=this.i18n("tokenActionHud.other"),A=this.i18n("tokenActionHud.consumables"),S=this.i18n("tokenActionHud.tools"),H=this.initializeEmptyCategory("inventory");return H.name=this.i18n("tokenActionHud.inventory"),this._combineSubcategoryWithCategory(H,k,c),this._combineSubcategoryWithCategory(H,_,u),this._combineSubcategoryWithCategory(H,C,g),this._combineSubcategoryWithCategory(H,A,p),this._combineSubcategoryWithCategory(H,S,f),H}_buildWeaponsCategory(t){const e=t.actor,i=t.id;let s=this._filterLongerActions(e.items.filter((t=>"weapon"===t.type))),a=this._sortByItemSort(s),n=a.filter((t=>t.system.equipped)),o=this._getActiveEquipment(n).map((t=>this._buildEquipmentItem(i,e,"weapon",t))),r=this.initializeEmptySubcategory();r.actions=o;let l=this.i18n("tokenActionHud.weapons"),c=this.initializeEmptyCategory("weapons");return c.name=this.i18n("tokenActionHud.weapons"),this._combineSubcategoryWithCategory(c,l,r),c}_getActiveEquipment(t){let e=[];if(get("showItemsWithoutAction"))e=t;else{const i=Object.keys(game.rotv.config.abilityActivationTypes).filter((t=>"none"!==t));e=t.filter((t=>!!t.system.activation&&i.includes(t.system.activation.type)))}return e}_buildSpellsCategory(t){if(!1===get("showSpellsCategory"))return;const e=t.actor;if("vehicle"===e.type)return;let i=this._filterLongerActions(e.items.filter((t=>"spell"===t.type)));i=this._filterExpendedItems(i),"character"!==e.type&&get("showAllNpcItems")||(i=this._filterNonpreparedSpells(i));let s=this._sortSpellsByLevel(i);return this._categoriseSpells(e,t.id,s)}_sortSpellsByLevel(t){let e=Object.values(t);return e.sort(((t,e)=>t.system.level===e.system.level?t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}):t.system.level-e.system.level)),e}_categoriseSpells(t,e,i){const s=this.initializeEmptySubcategory(),a=this.initializeEmptySubcategory(),n=Object.entries(t.system.spells).sort(((t,e)=>e[0].toUpperCase().localeCompare(t[0].toUpperCase(),void 0,{sensitivity:"base"})));var o=n.find((t=>"pact"===t[0])),r=!1;n.filter((t=>"maxLevel"!==t[0])).forEach((t=>{t[0].startsWith("spell")?(!r&&t[1].max>0&&t[1].value>0&&(r=!0),r||t[0]!=="spell"+o[1]?.level||o[1].max>0&&o[1].value>0&&(r=!0),t[1].slotsAvailable=r):(t[1]||(t[1]={}),t[1].slotsAvailable=!t[1].max||t[1].value>0)}));let l=n.findIndex((t=>"pact"===t[0]));if(!n[l][1].slotsAvailable){var c=n.findIndex((t=>t[0]==="spell"+o[1].level));n[l][1].slotsAvailable=n[c][1].slotsAvailable}i.reduce(function(i,o){let r=o.system.preparation.mode;const l=game.rotv.config.spellPreparationModes[r];var c=o.system.level;let d="pact"===r||"atwill"===r||"innate"===r;var u,h,g,m,y;d?m=r:(m="spell"+c,g=c?`${this.i18n("tokenActionHud.level")} ${c}`:this.i18n("tokenActionHud.cantrips")),y=n.find((t=>t[0]===m))?.[1],h=y?.value,u=y?.max;let p=get("showEmptyItems");if(u&&!y?.slotsAvailable&&!p)return;let b,f=this._buildItem(e,t,"spell",o);return get("showSpellInfo")&&this._addSpellInfo(o,f),b=d?s.subcategories.find((t=>t.name===l)):a.subcategories.find((t=>t.name===g)),b||(b=this.initializeEmptySubcategory(),u>0&&(b.info1=`${h}/${u}`)),b.actions.push(f),d&&s.subcategories.indexOf(b)<0?this._combineSubcategoryWithCategory(s,l,b):!d&&a.subcategories.indexOf(b)<0&&this._combineSubcategoryWithCategory(a,g,b),i}.bind(this),{});let d=this.initializeEmptyCategory("spells");d.name=this.i18n("tokenActionHud.spells");let u=this.i18n("tokenActionHud.powers"),h=this.i18n("tokenActionHud.books");return this._combineSubcategoryWithCategory(d,u,s),this._combineSubcategoryWithCategory(d,h,a),d}_addSpellInfo(t,e){let i=t.system.components;e.info1="",e.info2="",e.info3="",i?.vocal&&(e.info1+=this.i18n("ROTV.ComponentVerbal").charAt(0).toUpperCase()),i?.somatic&&(e.info1+=this.i18n("ROTV.ComponentSomatic").charAt(0).toUpperCase()),i?.material&&(e.info1+=this.i18n("ROTV.ComponentMaterial").charAt(0).toUpperCase()),i?.concentration&&(e.info2+=this.i18n("ROTV.Concentration").charAt(0).toUpperCase()),i?.ritual&&(e.info3+=this.i18n("ROTV.Ritual").charAt(0).toUpperCase())}_buildFeaturesCategory(t){if(!1===get("showFeaturesCategory"))return;let e=this._filterLongerActions(t.actor.items.filter((t=>"feat"==t.type))),i=this._sortByItemSort(e);return this._categoriseFeats(t.id,t.actor,i)}_categoriseFeats(t,e,i){let s=this.initializeEmptySubcategory(),a=this.initializeEmptySubcategory(),n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory(),r=this.initializeEmptySubcategory(),l=this.initializeEmptySubcategory(),c=this.initializeEmptySubcategory();i.reduce(function(i,d){const u=d.system.activation.type;let h=this._buildEquipmentItem(t,e,"feat",d);return"vehicle"===e.type?u&&"none"!==u&&"reaction"!==u?void r.actions.push(h):u&&"none"!==u?"reaction"==u?void c.actions.push(h):void r.actions.push(h):void l.actions.push(h):"character"===e.type||"npc"===e.type?u&&""!==u?"lair"==u?void n.actions.push(h):"legendary"==u?void o.actions.push(h):void s.actions.push(h):void a.actions.push(h):void 0}.bind(this),{});let d=this.initializeEmptyCategory("feats");d.name=this.i18n("tokenActionHud.features");let u=this.i18n("tokenActionHud.active"),h=this.i18n("tokenActionHud.rotv.legendary"),g=this.i18n("tokenActionHud.rotv.lair"),m=this.i18n("tokenActionHud.actions"),y=this.i18n("tokenActionHud.features"),p=this.i18n("tokenActionHud.reactions");if(this._combineSubcategoryWithCategory(d,u,s),this._combineSubcategoryWithCategory(d,h,o),this._combineSubcategoryWithCategory(d,g,n),this._combineSubcategoryWithCategory(d,m,r),this._combineSubcategoryWithCategory(d,y,l),this._combineSubcategoryWithCategory(d,p,c),!get("ignorePassiveFeats")){let t=this.i18n("tokenActionHud.passive");this._combineSubcategoryWithCategory(d,t,a)}return d}_buildSkillsCategory(t){if(!1===get("showSkillsCategory"))return;const e=t.actor.system.skills;let i=this.initializeEmptyCategory("skills");i.name=this.i18n("tokenActionHud.rotv.skills");let s="skill",a=get("abbreviateSkills"),n=Object.entries(e).map((i=>{try{let n=i[0],o=a?n:game.rotv.config.skills[n].label;o=o.charAt(0).toUpperCase()+o.slice(1);let r=[s,t.id,i[0]].join(this.delimiter),l=this._getProficiencyIcon(e[n].value);return{name:o,id:i[0],encodedValue:r,icon:l}}catch(t){return Logger.error(i),null}})).filter((t=>!!t)),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenActionHud.rotv.skills");return this._combineSubcategoryWithCategory(i,r,o),i}_addMultiSkills(t,e){let i=this.initializeEmptyCategory("skills"),s="skill",a=get("abbreviateSkills"),n=Object.entries(game.rotv.config.skills).map((t=>{let i=a?t[0]:t[1].label;i=i.charAt(0).toUpperCase()+i.slice(1);let n=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:n}})),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenActionHud.rotv.skills");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i,!0)}_getAbilityList(t,e,i,s,a){let n=this.initializeEmptyCategory(i);n.name=s;let o=get("abbreviateSkills"),r=Object.entries(game.rotv.config.abilities).map((s=>{if(0===e[s[0]].value)return;let n=o?s[0]:s[1];n=n.charAt(0).toUpperCase()+n.slice(1);let r,l=[a,t,s[0]].join(this.delimiter);return r="checks"===i?"":this._getProficiencyIcon(e[s[0]].proficient),{name:n,id:s[0],encodedValue:l,icon:r}})),l=this.initializeEmptySubcategory();return l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,s,l),n}_addMultiAbilities(t,e,i,s,a){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(game.rotv.config.abilities).map((t=>{let i=o?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let s=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:s}})),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(n,s,l),this._combineCategoryWithList(t,s,n,!0)}_buildUtilityCategory(t){if(!1===get("showUtilityCategory"))return;const e=t.actor;let i=this.initializeEmptyCategory("utility");i.name=this.i18n("tokenActionHud.utility");let s="utility",a=this.initializeEmptySubcategory(),n=this.initializeEmptySubcategory();if(this._addCombatSubcategory(s,i,t.id),"character"===e.type){let i=[s,t.id,"shortRest"].join(this.delimiter);a.actions.push({id:"shortRest",encodedValue:i,name:this.i18n("tokenActionHud.shortRest")});let o=[s,t.id,"longRest"].join(this.delimiter);if(a.actions.push({id:"longRest",encodedValue:o,name:this.i18n("tokenActionHud.longRest")}),e.system.attributes.hp.value<=0){let e={id:"deathSave",encodedValue:[s,t.id,"deathSave"].join(this.delimiter),name:this.i18n("tokenActionHud.rotv.deathSave")};n.actions.push(e)}let r={id:"inspiration",encodedValue:[s,t.id,"inspiration"].join(this.delimiter),name:this.i18n("tokenActionHud.inspiration")};r.cssClass=e.system.attributes?.inspiration?"active":"",n.actions.push(r)}return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.rests"),a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.utility"),n),i}_buildEffectsCategory(t){if(!1===get("showEffectsCategory"))return;let e=this.initializeEmptyCategory("effects");return e.name=this.i18n("tokenActionHud.effects"),this._addEffectsSubcategories(t.actor,t.id,e),e}_buildConditionsCategory(t){if(!1===get("showConditionsCategory"))return;let e=this.initializeEmptyCategory("conditions");return e.name=this.i18n("tokenActionHud.conditions"),this._addConditionsSubcategory(t.actor,t.id,e),e}_addEffectsSubcategories(t,e,i){const s="effect",a="find"in t.effects.entries?t.effects.entries:t.effects;let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();a.forEach((t=>{const i=t.label,a=[s,e,t.id].join(this.delimiter),r=`toggle${t.disabled?"":" active"}`,l=t.icon;let c={name:i,id:t.id,encodedValue:a,img:l,cssClass:r};t.isTemporary?n.actions.push(c):o.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.temporary"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.passive"),o)}_addMultiConditions(t,e){const i=this.initializeEmptyCategory("conditions"),s="condition",a=CONFIG.statusEffects.filter((t=>""!==t.id)),n=canvas.tokens.controlled.filter((t=>!!t.actor)).map((t=>t.actor));if(!a)return;let o=this.initializeEmptySubcategory();a.forEach((t=>{const i=this.i18n(t.label),a=[s,e,t.id].join(this.delimiter),r=`toggle${n.every((e=>{("some"in e.effects.entries?e.effects.entries:e.effects).some((e=>e.flags.core?.statusId===t.id))}))?" active":""}`,l=t.icon,c={name:i,id:t.id,encodedValue:a,img:l,cssClass:r};o.actions.push(c)}));const r=this.i18n("tokenActionHud.conditions");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i)}_addConditionsSubcategory(t,e,i){const s="condition",a=CONFIG.statusEffects.filter((t=>""!==t.id));if(!a)return;let n=this.initializeEmptySubcategory();a.forEach((i=>{const a=this.i18n(i.label),o=[s,e,i.id].join(this.delimiter),r=`toggle${("some"in t.effects.entries?t.effects.entries:t.effects).some((t=>t.flags.core?.statusId===i.id))?" active":""}`,l=i.icon,c={name:a,id:i.id,encodedValue:o,img:l,cssClass:r};n.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.conditions"),n)}_addCombatSubcategory(t,e,i){let s=this.initializeEmptySubcategory();const a=game.combat;let n,o;a&&(n=a.combatants.find((t=>t.tokenId===i)),o=n?.initiative);let r={id:"rollInitiative",encodedValue:[t,i,"initiative"].join(this.delimiter),name:this.i18n("tokenActionHud.rollInitiative")};if(o&&(r.info1=o),r.cssClass=o?"active":"",s.actions.push(r),game.combat?.current?.tokenId===i){let e={id:"endTurn",encodedValue:[t,i,"endTurn"].join(this.delimiter),name:this.i18n("tokenActionHud.endTurn")};s.actions.push(e)}this._combineSubcategoryWithCategory(e,this.i18n("tokenActionHud.combat"),s)}_addMultiCombatSubcategory(t,e,i){let s=this.initializeEmptySubcategory();const a=game.combat;let n,o={id:"rollInitiative",encodedValue:[t,e,"initiative"].join(this.delimiter),name:this.i18n("tokenActionHud.rollInitiative")};if(a){n=canvas.tokens.controlled.map((t=>t.id)).map((t=>a.combatants.find((e=>e.tokenId===t)))).every((t=>!!t?.initiative))}o.cssClass=n?"active":"",s.actions.push(o),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.combat"),s)}_addMultiUtilities(t,e,i){let s=this.initializeEmptyCategory("utility"),a="utility";this._addMultiCombatSubcategory(a,e,s);let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();if(i.every((t=>"character"===t.type))){let t=[a,e,"shortRest"].join(this.delimiter);n.actions.push({id:"shortRest",encodedValue:t,name:this.i18n("tokenActionHud.shortRest")});let s=[a,e,"longRest"].join(this.delimiter);n.actions.push({id:"longRest",encodedValue:s,name:this.i18n("tokenActionHud.longRest")});let r={id:"inspiration",encodedValue:[a,e,"inspiration"].join(this.delimiter),name:this.i18n("tokenActionHud.inspiration")};r.cssClass=i.every((t=>t.system.attributes?.inspiration))?"active":"",o.actions.push(r)}this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.rests"),n),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.utility"),o),this._combineCategoryWithList(t,this.i18n("tokenActionHud.utility"),s)}_buildEquipmentItem(t,e,i,s){let a=this._buildItem(t,e,i,s);return this._addItemInfo(e,s,a),a}_buildItem(t,e,i,s){const a=s.id;let n=[i,t,a].join(this.delimiter),o=this._getImage(s),r=this._getActionIcon(s.system.activation?.type),l={name:s.name,id:a,encodedValue:n,img:o,icon:r};return s.system.recharge&&!s.system.recharge.charged&&s.system.recharge.value&&(l.name+=` (${this.i18n("tokenActionHud.recharge")})`),l}_addItemInfo(t,e,i){i.info1=this._getQuantityData(e),i.info2=this._getUsesData(e),i.info3=this._getConsumeData(e,t),i.info4=this._getRangeData(e)}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getQuantityData(t){let e="",i=t.system.quantity;return i>1&&(e=i),e}_getRangeData(t){let e="",i=t.system.range?.value;return i>1&&(e=i),e}_getUsesData(t){let e="",i=t.system.uses;return i?(e=0===i.value&&i.max?"0":i.value,i.max>0&&(e+=`/${i.max}`),e):e}_getConsumeData(t,e){let i="",s=t.system.consume?.type;if(s&&""!==s){let a=t.system.consume.target,n=a.substr(0,a.lastIndexOf("."));if("attribute"===s){let t=getProperty(e,`system.${n}`);t&&(i=t.value??0,t.max&&(i+=`/${t.max}`))}if("charges"===s){let s=t.system.consume.target,a=e.items.get(s)?.system.uses;a?.value&&(i=a.value,a.max&&(i+=`/${a.max}`))}if("attribute"!==s&&"charges"!==s){let s=t.system.consume.target,a=e.items.get(s)?.system.quantity;a&&(i=a)}}return i}_filterLongerActions(t){var e;return get("hideLongerActions")&&(e=t.filter((t=>!t.system.activation||!("minute"===t.system.activation.type||"hour"===t.system.activation.type||"day"===t.system.activation.type)))),e||t}_filterNonpreparedSpells(t){const e=Object.keys(game.rotv.config.spellPreparationModes).filter((t=>"prepared"!=t));let i=t;return i=get("showAllNonpreparableSpells")?t.filter((t=>t.system.preparation.prepared||e.includes(t.system.preparation.mode)||0===t.system.level)):t.filter((t=>t.system.preparation.prepared)),i}_filterExpendedItems(t){return get("showEmptyItems")?t:t.filter((t=>{let e=t.system.uses;return!e||!(e.max>0&&!e.value)}))}_sortByItemSort(t){let e=Object.values(t);return e.sort(((t,e)=>t.sort-e.sort)),e}_getProficiencyIcon(t){return{0:"",.5:'<i class="fas fa-adjust"></i>',1:'<i class="fas fa-check"></i>',2:'<i class="fas fa-check-double"></i>'}[t]}_getActionIcon(t){return{bonus:'<i class="fas fa-plus"></i>',crew:'<i class="fas fa-users"></i>',legendary:'<i class="fas fa-dragon"></i>',reaction:'<i class="fas fa-bolt"></i>',special:'<i class="fas fa-star"></i>',lair:'<i class="fas fa-home"></i>',minute:'<i class="fas fa-hourglass-start"></i>',hour:'<i class="fas fa-hourglass-half"></i>',day:'<i class="fas fa-hourglass-end"></i>'}[t]}}class ActionHandler5eGroupByType extends ActionHandler5e{async _buildCategories(t){const e=game.modules.get("character-actions-list-5e").api,i=await e.getActorActionsData(t.actor);return[this._buildActionCategory(t,"actions",i.action),this._buildActionCategory(t,"bonusActions",i.bonus),this._buildActionCategory(t,"reactions",i.reaction),this._buildActionCategory(t,"crewActions",i.crew),this._buildActionCategory(t,"legendaryActions",i.legendary),this._buildActionCategory(t,"lairActions",i.lair),this._buildActionCategory(t,"specialActions",i.other),this._buildSkillsCategory(t),this._buildAbilitiesCategory(t),this._buildEffectsCategory(t),this._buildConditionsCategory(t),this._buildUtilityCategory(t)]}_buildActionCategory(t,e,i){const s=this.initializeEmptyCategory(e);s.name=this.i18n(`tokenActionHud.rotv.${e}`);let a=[];for(const t of i)"spell"==t.type&&(a.push(t),i.delete(t));"character"!==t.actor.type&&get("showAllNpcItems")||(a=this._filterNonpreparedSpells(a)),a=this._sortSpellsByLevel(a),a=this._categoriseSpells(t.actor,t.id,a),this._subCategorizeEquipment(t,s,i,this.i18n("tokenActionHud.rotv.weapons"),(t=>"weapon"==t.type)),this._subCategorizeEquipment(t,s,i,this.i18n("tokenActionHud.rotv.equipment"),(t=>"equipment"==t.type)),this._subCategorizeEquipment(t,s,i,this.i18n("tokenActionHud.rotv.consumables"),(t=>"consumable"==t.type)),this._subCategorizeEquipment(t,s,i,this.i18n("tokenActionHud.rotv.tools"),(t=>"tool"==t.type)),this._subCategorizeEquipment(t,s,i,this.i18n("tokenActionHud.rotv.other"),(t=>!0));for(const t of a.subcategories)this._combineSubcategoryWithCategory(s,t.name,t);return s}_subCategorizeEquipment(t,e,i,s,a){const n=this.initializeEmptySubcategory(),o=new Set;for(const t of i)a(t)&&(o.add(t),i.delete(t));o.size>0&&(n.actions=[...o].map((e=>this._buildEquipmentItem(t.id,t.actor,"item",e))),this._combineSubcategoryWithCategory(e,s,n))}}class MagicItemsPreRollHandler$1 extends PreRollHandler{constructor(){super()}prehandleActionEvent(t,e){let i=e.split("|");if(3!=i.length)return!1;let s=i[0],a=i[1],n=i[2];return"magicItem"==s&&(this._magicItemMacro(t,a,n),!0)}_magicItemMacro(t,e,i){let s=super.getActor(e),a=i.split(">"),n=a[0],o=a[1];MagicItems.actor(s.id).roll(n,o),Hooks.callAll("forceUpdateTokenActionHUD")}}class MagicItemActionListExtender extends ActionListExtender{constructor(){super()}extendActionList(t,e){if(e)return;let i=t.tokenId,s=t.actorId;if(!s)return;let a=t.categories.find((t=>"inventory"===t.id)),n=MagicItems.actor(s);if(!n||!a)return;let o=n.items??[];if(0===o.length)return;let r=this.initializeEmptyCategory("magicItemsModule");r.name=this.i18n("tokenActionHud.magicItems");let l=o.map((t=>t.id));a.subcategories.forEach((t=>{t.actions.forEach((t=>{if(!l.includes(t.id))return;let e=o.find((e=>e.id===t.id));if(e.attuned&&!this._isItemAttuned(e))return;if(e.equipped&&!this._isItemEquipped(e))return;let s=this.initializeEmptySubcategory();s.info1=`${e.uses}/${e.charges}`,e.ownedEntries.forEach((e=>{let a=e.item,n=["magicItem",i,`${t.id}>${a.id}`].join("|"),o=this._getImage(a),r={name:a.name,id:a.id,encodedValue:n,img:o};r.info1=a.consumption,a.baseLevel&&(r.info2=`${this.i18n("tokenActionHud.levelAbbreviation")} ${a.baseLevel}`),s.actions.push(r)})),s.actions.unshift(t),this._combineSubcategoryWithCategory(r,t.name,s)}))})),this._combineCategoryWithList(t,r.name,r,!1)}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_isItemEquipped(t){return t.item.system.equipped}_isItemAttuned(t){var e=t.item.system;if(e.attunement){const t=CONFIG.ROTV.attunementTypes?.ATTUNED??2;return e.attunement===t}return!!e.attuned&&e.attuned}}class RollHandlerBase5e extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2];if("multi"===a)for(let e of canvas.tokens.controlled){let i=e.id;await this._handleMacros(t,s,i,n)}else await this._handleMacros(t,s,a,n)}async _handleMacros(t,e,i,s){switch(e){case"ability":this.rollAbilityMacro(t,i,s);break;case"skill":this.rollSkillMacro(t,i,s);break;case"abilitySave":this.rollAbilitySaveMacro(t,i,s);break;case"abilityCheck":this.rollAbilityCheckMacro(t,i,s);break;case"item":case"weapon":case"spell":case"feat":this.isRenderItem()?this.doRenderItem(i,s):this.rollItemMacro(t,i,s);break;case"utility":await this.performUtilityMacro(t,i,s);break;case"effect":await this.toggleEffect(t,i,s);break;case"condition":await this.toggleCondition(t,i,s)}}rollAbilityMacro(t,e,i){super.getActor(e).rollAbility(i,{event:t})}rollAbilityCheckMacro(t,e,i){super.getActor(e).rollAbilityTest(i,{event:t})}rollAbilitySaveMacro(t,e,i){super.getActor(e).rollAbilitySave(i,{event:t})}rollSkillMacro(t,e,i){super.getActor(e).rollSkill(i,{event:t})}rollItemMacro(t,e,i){let s=super.getActor(e),a=super.getItem(s,i);if(!this.needsRecharge(a))return a.use({event:t});a.rollRecharge()}needsRecharge(t){return t.system.recharge&&!t.system.recharge.charged&&t.system.recharge.value}async performUtilityMacro(t,e,i){let s=super.getActor(e),a=super.getToken(e);switch(i){case"shortRest":s.shortRest();break;case"longRest":s.longRest();break;case"inspiration":let i=!s.system.attributes.inspiration;s.update({"data.attributes.inspiration":i});break;case"toggleCombat":a.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"toggleVisibility":a.toggleVisibility();break;case"deathSave":s.rollDeathSave({event:t});break;case"initiative":await this.performInitiativeMacro(e);break;case"endTurn":game.combat?.current?.tokenId===e&&await(game.combat?.nextTurn())}}async performInitiativeMacro(t){let e=super.getActor(t);await e.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHUD")}async toggleEffect(t,e,i){const s=super.getActor(e),a=("find"in s.effects.entries?s.effects.entries:s.effects).find((t=>t.id===i));if(!a)return;const n=a.flags.core?.statusId;n?await this.toggleCondition(t,e,n,a):(await a.update({disabled:!a.disabled}),Hooks.callAll("forceUpdateTokenActionHUD"))}async toggleCondition(t,e,i,s=null){const a=super.getToken(e),n=this.isRightClick(t);if(game.dfreds&&s?.flags?.isConvenient){const t=s.label;game.dfreds.effectInterface.toggleEffect(t)}else{const t=this.findCondition(i);if(!t)return;n?await a.toggleEffect(t,{overlay:!0}):await a.toggleEffect(t)}Hooks.callAll("forceUpdateTokenActionHUD")}findCondition(t){return CONFIG.statusEffects.find((e=>e.id===t))}}class RollHandlerMinorQol5e extends RollHandlerBase5e{constructor(){super()}rollItemMacro(t,e,i){let s=super.getActor(e),a=s.items.get(i);var n;this.needsRecharge(a)?a.rollRecharge():this.rightClick&&this.ctrl?a.rollAttack():this.rightClick&&this.alt?a.rollDamage():(a.system.properties?.ver&&(n=this.rightClick),MinorQOL.doCombinedRoll({actor:s,item:a,event:t,versatile:n}))}}class RollHandlerObsidian extends RollHandlerBase5e{constructor(){super()}rollAbilityCheckMacro(t,e,i){let s=super.getActor(e);OBSIDIAN.Items.roll(s,{roll:"abl",abl:i})}rollAbilitySaveMacro(t,e,i){let s=super.getActor(e);OBSIDIAN.Items.roll(s,{roll:"save",save:i})}rollSkillMacro(t,e,i){let s=super.getActor(e);OBSIDIAN.Items.roll(s,{roll:"skl",skl:i})}rollItemMacro(t,e,i){let s=super.getActor(e);OBSIDIAN.Items.roll(s,{roll:"item",id:i})}}class RotVSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){let i;return i=SystemManager.isModuleActive("character-actions-list-5e")&&get("useActionList")?new ActionHandler5eGroupByType(t,e):new ActionHandler5e(t,e),SystemManager.isModuleActive("magicitems")&&i.addFurtherActionHandler(new MagicItemActionListExtender),i}getAvailableRollHandlers(){let t="Core D&D5e";SystemManager.isModuleActive("midi-qol")&&(t+=` [supports ${SystemManager.getModuleTitle("midi-qol")}]`);let e={core:t};return SystemManager.addHandler(e,"minor-qol"),SystemManager.addHandler(e,"obsidian"),e}doGetRollHandler(t){let e;switch(t){case"minor-qol":e=new RollHandlerMinorQol5e;break;case"obsidian":e=new RollHandlerObsidian;break;default:e=new RollHandlerBase5e}return SystemManager.isModuleActive("magicitems")&&e.addPreRollHandler(new MagicItemsPreRollHandler$1),e}doRegisterSettings(t,e){!function register$e(t,e){const i=["Inventory","Spells","Features","Skills","Abilities","Effects","Conditions","Utility"];for(const s of i)game.settings.register(t,`show${s}Category`,{name:game.i18n.localize(`tokenActionHud.settings.show${s}Category.name`),hint:game.i18n.localize(`tokenActionHud.settings.show${s}Category.hint`),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}});game.settings.register(t,"ignorePassiveFeats",{name:game.i18n.localize("tokenActionHud.rotv.settings.ignorePassiveFeats.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.ignorePassiveFeats.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showSpellInfo",{name:game.i18n.localize("tokenActionHud.rotv.settings.showSpellInfo.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showSpellInfo.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showAllNonpreparableSpells",{name:game.i18n.localize("tokenActionHud.rotv.settings.showAllNonpreparableSpells.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showAllNonpreparableSpells.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"hideLongerActions",{name:game.i18n.localize("tokenActionHud.rotv.settings.hideLongerActions.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.hideLongerActions.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenActionHud.rotv.settings.abbreviateSkills.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"splitAbilities",{name:game.i18n.localize("tokenActionHud.rotv.settings.splitAbilities.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.splitAbilities.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showAllNpcItems",{name:game.i18n.localize("tokenActionHud.rotv.settings.showAllNpcItems.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showAllNpcItems.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showEmptyItems",{name:game.i18n.localize("tokenActionHud.rotv.settings.showEmptyItems.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showEmptyItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showItemsWithoutAction",{name:game.i18n.localize("tokenActionHud.rotv.settings.showItemsWithoutAction.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showItemsWithoutAction.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.modules.get("character-actions-list-5e")?.active&&game.settings.register(t,"useActionList",{name:game.i18n.localize("tokenActionHud.settings.useActionList.name"),hint:game.i18n.localize("tokenActionHud.settings.useActionList.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerDemonlord extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(i),i;if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;i.actorId=a.id;let n=this._getAttributes(a,s),o=this._getItemsList(a,s),r=this._getTalents(a,s),l=this._getSpells(a,s),c=this._getUtilityList(a,s);return this._combineCategoryWithList(i,this.i18n("tokenActionHud.demonLord.challenge"),n),"character"===a.type?this._combineCategoryWithList(i,this.i18n("tokenActionHud.weapons"),o):this._combineCategoryWithList(i,this.i18n("tokenActionHud.demonLord.attackoptions"),o),"character"===a.type?this._combineCategoryWithList(i,this.i18n("tokenActionHud.talents"),r):this._combineCategoryWithList(i,this.i18n("tokenActionHud.demonLord.specialattacks"),r),this._combineCategoryWithList(i,this.i18n("tokenActionHud.spells"),l),this._combineCategoryWithList(i,this.i18n("tokenActionHud.utility"),c),this._setFilterSuggestions(a),get("showHudTitle")&&(i.hudTitle=t.name),i}_getItemsList(t,e){let i="weapon",s=this.initializeEmptyCategory("items"),a=this.initializeEmptySubcategory();return a.actions=this._produceMap(e,t.items.filter((t=>t.type==i)).map((t=>({name:t.name,encodedValue:[t.type,e,t.id].join(this.delimiter)}))),i),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.weapons"),a),s}_getAttributes(t,e){let i=this.initializeEmptyCategory("attributes"),s=this.initializeEmptySubcategory(),a="challenge",n=Object.entries(t.system.attributes).map((t=>({name:this.i18n("tokenActionHud.attribute."+t[0]),encodedValue:[a,e,t[0]].join(this.delimiter),id:t[0]})));return s.actions=this._produceMap(e,n,a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.demonLord.challenge"),s),i}_addMultiAttributes(t,e,i){let s=this.initializeEmptyCategory("attributes"),a=this.initializeEmptySubcategory(),n="challenge",o=null;i.every((t=>{let i=Object.entries(t.system.attributes);o=i.map((t=>({name:this.i18n("tokenActionHud.attribute."+t[0]),encodedValue:[n,e,t[0]].join(this.delimiter),id:t[0]})))})),null!=o&&(a.actions=this._produceMap(e,o,n),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.demonLord.challenge"),a),this._combineCategoryWithList(t,this.i18n("tokenActionHud.demonLord.challenge"),s))}_getTalents(t,e){let i="talent",s=this.initializeEmptyCategory("talents"),a=t.items.filter((t=>t.type==i));return[...new Set(a.map((t=>t.system.groupname)))].sort().forEach((t=>{if(null!=t){let n=this.initializeEmptySubcategory();n.name=t,s.subcategories.push(n);let o=this.initializeEmptySubcategory();a.forEach((s=>{if(s.system.groupname==t){let t=[i,e,s.id].join(this.delimiter),a={name:s.name,encodedValue:t,id:s.id};a.img=this._getImage(s),a.info2=this._getUsesData(s),o.actions.push(a)}})),this._combineSubcategoryWithCategory(n,t,o)}})),s}_getSpells(t,e){let i=this.initializeEmptyCategory("spells"),s=t.items.filter((t=>"spell"===t.type)),a=this._sortSpellsByRank(s),n=this._categoriseSpells(e,a);return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.spells"),n),i}_sortSpellsByRank(t){let e=Object.values(t);return e.sort(((t,e)=>t.system.rank===e.system.rank?t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}):t.system.rank-e.system.rank)),e}_categoriseSpells(t,e){const i="spell";let s=this.initializeEmptySubcategory();return[...new Set(e.map((t=>t.system.tradition)))].sort().forEach((a=>{if(null!=a){let n=this.initializeEmptySubcategory();n.name=a,s.subcategories.push(n);let o=this.initializeEmptySubcategory();e.forEach((e=>{if(e.system.tradition==a){let s=[i,t,e.id].join(this.delimiter),a={name:e.name,encodedValue:s,id:e.id};a.img=this._getImage(e),a.info2=this._getCastingsData(e),o.actions.push(a)}})),this._combineSubcategoryWithCategory(n,a,o)}})),s}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["creature","character"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.type)));this._addMultiAttributes(t,t.tokenId,i),this._addMultiUtilities(t,t.tokenId,i)}_getUtilityList(t,e){let i=this.initializeEmptyCategory("utility"),s="utility",a=this.initializeEmptySubcategory();if(game.combat?.current?.tokenId===e){let t={id:"endTurn",encodedValue:[s,e,"endTurn"].join(this.delimiter),name:this.i18n("tokenActionHud.endTurn")};a.actions.push(t)}this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.combat"),a);let n=this.initializeEmptySubcategory();if("character"===t.type){let t=[s,e,"rest"].join(this.delimiter);n.actions.push({id:"rest",encodedValue:t,name:this.i18n("tokenActionHud.demonLord.rest")})}return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.demonLord.rest"),n),i}_addMultiUtilities(t,e,i){let s=this.initializeEmptyCategory("utility"),a="utility",n=this.initializeEmptySubcategory();if(i.every((t=>"character"===t.type))){let t=[a,e,"rest",""].join(this.delimiter);n.actions.push({id:"rest",encodedValue:t,name:this.i18n("tokenActionHud.demonLord.rest")})}this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.demonLord.rest"),n),this._combineCategoryWithList(t,this.i18n("tokenActionHud.utility"),s)}_setFilterSuggestions(t,e){let i=e?.map((t=>({id:t.id,value:t.name})));i?.length>0&&this.filterManager.setSuggestions(t,i)}_filterElements(t,e){let i=this.filterManager.getFilteredNames(t),s=e.filter((t=>!!t));return i.length>0&&(s=this.filterManager.isBlocklist(t)?e.filter((t=>!i.includes(t.name))):e.filter((t=>i.includes(t.name)))),s}_produceMap(t,e,i){return e.map((t=>{let e=this._getImage(t),s={name:t.name,encodedValue:t.encodedValue,id:t.id,icon:e};return"talent"===i&&(s.info2=this._getUsesData(t)),s}))}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getUsesData(t){let e="",i=t.system.uses;return i&&(i.max||i.value)?(e=i.value??0,i.max>0&&(e+=`/${i.max}`),e):e}_getCastingsData(t){let e="",i=t.system.castings;return i&&(i.max||i.value)?(e=i.value??0,i.max>0&&(e+=`/${i.max}`),e):e}}class RollHandlerBaseDemonlord extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2];"multi"===a?canvas.tokens.controlled.forEach((e=>{let i=e.id;this._handleMacros(t,s,i,n)})):this._handleMacros(t,s,a,n)}_handleMacros(t,e,i,s){let a=super.getActor(i),n=null;switch(["weapon","specialaction","spell","talent"].includes(e)&&(n=a.items.get(s)),e){case"challenge":const e=a?a.system.attributes[s]:null;a.rollChallenge(e,s);break;case"weapon":a.rollWeaponAttack(n.id,null);break;case"talent":case"specialaction":a.rollTalent(n.id,null);break;case"spell":a.rollSpell(n.id,null);break;case"utility":this.performUtilityMacro(t,i,s)}}async performUtilityMacro(t,e,i){let s=super.getActor(e),a=super.getToken(e);switch(i){case"rest":s.restActor(a);break;case"toggleVisibility":a.toggleVisibility();break;case"toggleCombat":a.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"endTurn":game.combat?.current?.tokenId===e&&await(game.combat?.nextTurn())}}}class DemonlordSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerDemonlord(t,e)}getAvailableRollHandlers(){return{core:"Core Demonlord"}}doGetRollHandler(t){return new RollHandlerBaseDemonlord}doRegisterSettings(t,e){}}class ActionHandlerDw extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(get("showGmCompendiums")&&(i.tokenId="gm",i.actorId="gm",await this.addGmCompendiumsToList(i)),!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;i.actorId=a.id;let n=a.type;if("npc"===n){let t=this._getDamage(a,s),e=this._getTags(a,s),n=this._getSpecialQualities(a,s);this.moves=this._getMovesNpc(a,s),this._combineCategoryWithList(i,this.i18n("tokenActionHud.damage"),t),this._combineCategoryWithList(i,this.i18n("tokenActionHud.dungeonWorld.tags"),e),this._combineCategoryWithList(i,this.i18n("tokenActionHud.dungeonWorld.specialQualities"),n)}else if("character"===n){let t=this._getDamage(a,s),e=this._getMovesByType(a,s,"starting"),n=this._getMovesByType(a,s,"advanced"),o=this._getMovesByType(a,s,"basic"),r=this._getMovesByType(a,s,"special"),l=this._getMovesByType(a,s,""),c=this._getSpells(a,s,"spells",this.i18n("tokenActionHud.spells"),"spell"),d=this._getSubcategoryByType(a,s,"equipment",this.i18n("tokenActionHud.equipment"),"equipment"),u=this._getAbilities(a,s);this._combineCategoryWithList(i,this.i18n("tokenActionHud.damage"),t),this._combineCategoryWithList(i,this.i18n("tokenActionHud.dungeonWorld.starting"),e),this._combineCategoryWithList(i,this.i18n("tokenActionHud.advanced"),n),this._combineCategoryWithList(i,this.i18n("tokenActionHud.dungeonWorld.special"),r),this._combineCategoryWithList(i,this.i18n("tokenActionHud.dungeonWorld.basic"),o),this._combineCategoryWithList(i,this.i18n("tokenActionHud.other"),l),this._combineCategoryWithList(i,this.i18n("tokenActionHud.spells"),c),this._combineCategoryWithList(i,this.i18n("tokenActionHud.equipment"),d),this._combineCategoryWithList(i,this.i18n("tokenActionHud.abilities"),u)}return get("showHudTitle")&&(i.hudTitle=t.name),i}async addGmCompendiumsToList(t){let e=this.initializeEmptyCategory("gm"),i=this.initializeEmptySubcategory();i.actions=await CompendiumHelper.getEntriesForActions("dungeonworld.gm-movesprincipals",this.delimiter);let s=this.i18n("tokenActionHud.dungeonWorld.moves");this._combineSubcategoryWithCategory(e,s,i);let a=this.initializeEmptySubcategory();a.actions=await CompendiumHelper.getEntriesForActions("dungeonworld.charts",this.delimiter);let n=this.i18n("tokenActionHud.dungeonWorld.charts");this._combineSubcategoryWithCategory(e,n,a);let o=this.initializeEmptySubcategory();o.actions=await CompendiumHelper.getEntriesForActions("dungeonworld.rollable-tables",this.delimiter);let r=this.i18n("tokenActionHud.dungeonWorld.treasure");this._combineSubcategoryWithCategory(e,r,o);let l=this.i18n("tokenActionHud.dungeonWorld.gm");this._combineCategoryWithList(t,l,e)}_getDamage(t,e){let i=this.initializeEmptyCategory("damage"),s=this.initializeEmptySubcategory(),a=["damage",e,"damage"].join(this.delimiter);return s.actions.push({name:this.i18n("DW.Damage"),encodedValue:a,id:"damage"}),this._combineSubcategoryWithCategory(i,this.i18n("DW.Damage"),s),i}_getMovesByType(t,e,i){let s=t.itemTypes.move.filter((t=>t.system.moveType===i)),a=this.initializeEmptyCategory("moves"),n=this._getRollMoves(s,e),o=this._getBookMoves(s,e);return this._combineSubcategoryWithCategory(a,this.i18n("tokenActionHud.roll"),n),this._combineSubcategoryWithCategory(a,this.i18n("tokenActionHud.book"),o),a}_getRollMoves(t,e){let i=t.filter((t=>""!==t.system.rollType)),s=this._produceMap(e,i,"move"),a=this.initializeEmptySubcategory();return a.actions=s,a}_getBookMoves(t,e){let i=t.filter((t=>""===t.system.rollType)),s=this._produceMap(e,i,"move"),a=this.initializeEmptySubcategory();return a.actions=s,a}_getSubcategoryByType(t,e,i,s,a){let n=t.itemTypes[a],o=this.initializeEmptyCategory(i),r=this._produceMap(e,n,a),l=this.initializeEmptySubcategory();return l.actions=r,this._combineSubcategoryWithCategory(o,s,l),o}_getSpells(t,e,i,s,a){let n=t.itemTypes[a].filter((t=>t.system.prepared)).sort(((t,e)=>parseInt(t.system.spellLevel)-parseInt(e.system.spellLevel))).reduce(((t,i)=>{let s,n=i.system.spellLevel,o=0==n?"Rotes":`${this.i18n("tokenActionHud.level")} ${n}`;t.some((t=>t.name===o))?s=t.find((t=>t.name===o)):(s=this.initializeEmptySubcategory(),s.name=o,t.push(s));let r=this._produceMap(e,[i],a);return s.actions.push(...r),t}),[]),o=this.initializeEmptyCategory(i);return n.forEach((t=>{this._combineSubcategoryWithCategory(o,t.name,t)})),o}_getAbilities(t,e){let i=this.initializeEmptyCategory("abilities"),s=Object.entries(t.system.abilities).map((t=>({data:{_id:t[0]},name:t[1].label}))),a=this._produceMap(e,s,"ability"),n=this.initializeEmptySubcategory();return n.actions=a,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.abilities"),n),i}_getMovesNpc(t,e){let i=this.initializeEmptyCategory("moves"),s=t.system.details.biography,a=this.initializeEmptySubcategory(),n=new RegExp("<p(|s+[^>]*)>(Instinct:.*?)</ps*>","g"),o=Array.from(s.matchAll(n)).map((t=>{let e=t[2];return{data:{_id:encodeURIComponent(e)},name:e}})),r=this._produceMap(e,o,"instinct");a.actions=r;let l=this.initializeEmptySubcategory();var c=new RegExp("<li(|s+[^>]*)>(.*?)</lis*>","g"),d=Array.from(s.matchAll(c)).map((t=>{let e=t[2];return{data:{_id:encodeURIComponent(e)},name:e}}));let u=this._produceMap(e,d,"move");return l.actions=u,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.dungeonWorld.instinct"),a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.dungeonWorld.monsterMoves"),l),i}_getTags(t,e){let i=this.initializeEmptyCategory("tags"),s=t.system.tagsString.split(",").map((t=>{let e=t.trim();if(0!==e.length)return{data:{_id:encodeURIComponent(e)},name:e}})),a=this.initializeEmptySubcategory();return a.actions=this._produceMap(e,s,"tag"),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.dungeonWorld.tags"),a),i}_getSpecialQualities(t,e){let i=this.initializeEmptyCategory("qualities"),s=t.system.attributes.specialQualities.value.split(",").map((t=>{let e=t.trim();if(0!==e.length)return{data:{_id:encodeURIComponent(e)},name:e}})),a=this.initializeEmptySubcategory();return a.actions=this._produceMap(e,s,"quality"),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.dungeonWorld.specialQualities"),a),i}_produceMap(t,e,i){return e.filter((t=>!!t)).map((e=>{let s=[i,t,e.id].join(this.delimiter),a={name:e.name,encodedValue:s,id:e.id};return this._addItemInfo(e,a),a}))}_addItemInfo(t,e){let i=e.system?.uses;e.info1=i??"";let s=e.system?.quantity;e.info2=s>1?s:""}}class RollHandlerBaseDw extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a),r=o.type;if("character"===r)switch(s){case"damage":this._handleDamage(s,t,o,n);break;case"move":case"spell":case"equipment":this._handleMove(s,t,a,o,n);break;case"ability":this._handleAbility(s,t,o,n)}else if("npc"===r)switch(s){case"damage":this._handleDamage(s,t,o,n);break;case"move":this._handleMoveNpc(s,t,o,n);break;case"tag":case"quality":case"instinct":this._handleTextNpc(s,t,o,n)}}_handleDamage(t,e,i,s){let a=i.system.attributes.damage,n=`${a.value}`,o=a.misc.value>0?a.misc.value:0,r=a.piercing,l=o>0?`${n}+${o}`:n,c={title:this.i18n("tokenActionHud.damage"),flavor:`${r}`};i.rollMove(l,i,{},c)}_handleMove(t,e,i,s,a){let n=s.items.get(a);this.isRenderItem()?this.doRenderItem(i,a):n.roll()}_handleAbility(t,e,i,s){let a=i.system.abilities[s],n=`2d6+${a.mod}`,o={title:`${a.label} ${game.i18n.localize("tokenActionHud.roll")}`,flavor:`Made a move using ${a.label.toLowerCase()}!`};i.rollMove(n,i,{},o)}_handleTextNpc(t,e,i,s){let a=decodeURIComponent(s),n={title:t.charAt(0).toUpperCase()+t.slice(1),details:a};i.rollMove(null,i,{},n)}}class DungeonWorldSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerDw(t,e)}getAvailableRollHandlers(){return{core:"Core DungeonWorld"}}doGetRollHandler(t){return new RollHandlerBaseDw}doRegisterSettings(t,e){!function register$d(t,e){game.settings.register(t,"showGmCompendiums",{name:game.i18n.localize("tokenActionHud.dungeonWorld.settings.showGmCompendiums.name"),hint:game.i18n.localize("tokenActionHud.dungeonWorld.settings.showGmCompendiums.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerPf1 extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(i),i;if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;return a?(i.actorId=a.id,this._addAttacksList(i,a,s),this._addBuffsList(i,a,s),this._addItemsList(i,a,s),this._addSpellBooksList(i,a,s),this._addFeaturesList(i,a,s),this._addSkillsList(i,a,s),this._addSavesList(i,a,s),this._addChecksList(i,a,s),this._addConditionsList(i,a,s),this._addUtilityList(i,a,s),get("showHudTitle")&&(i.hudTitle=t.name),i):i}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["npc","character"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.type)));const s=t.tokenId;this._addMultiSkills(t,s);let a=this.i18n("tokenActionHud.saves"),n=this.i18n("tokenActionHud.checks");this._addMultiSaves(t,s,"saves",a,"abilitySave"),this._addMultiAbilities(t,s,"checks",n,"abilityCheck"),this._addMultiUtilities(t,s,i)}_addAttacksList(t,e,i){if(!1===get("showAttacksCategory"))return;let s=this._getAttacksList(e,i),a=this.i18n("tokenActionHud.attack");this._combineCategoryWithList(t,a,s)}_addBuffsList(t,e,i){if(!1===get("showBuffsCategory"))return;let s=this._getBuffsList(e,i),a=this.i18n("tokenActionHud.pf1.buffs");this._combineCategoryWithList(t,a,s)}_addConditionsList(t,e,i){if(!1===get("showConditionsCategory"))return;let s=this.i18n("tokenActionHud.conditions"),a=this._getConditionsList(i,e.system.attributes.conditions,"conditions",s,"condition");this._combineCategoryWithList(t,s,a)}_addItemsList(t,e,i){if(!1===get("showInventoryCategory"))return;let s=this._getItemList(e,i),a=this.i18n("tokenActionHud.inventory");this._combineCategoryWithList(t,a,s)}_addSpellBooksList(t,e,i){if(!1===get("showSpellsCategory"))return;this._getSpellsList(e,i).forEach((e=>{this._combineCategoryWithList(t,e.label,e.category)}))}_addFeaturesList(t,e,i){if(!1===get("showFeaturesCategory"))return;let s=this._getFeaturesList(e,i),a=this.i18n("tokenActionHud.features");this._combineCategoryWithList(t,a,s)}_addSkillsList(t,e,i){if(!1===get("showSkillsCategory"))return;let s=this._getSkillsList(e.system.skills,i),a=this.i18n("tokenActionHud.skills");this._combineCategoryWithList(t,a,s)}_addSavesList(t,e,i){if(!1===get("showSavesCategory"))return;let s=this.i18n("tokenActionHud.saves"),a=this._getSavesList(i,e,"saves",s,"abilitySave");this._combineCategoryWithList(t,s,a)}_addChecksList(t,e,i){if(!1===get("showChecksCategory"))return;let s=this.i18n("tokenActionHud.checks"),a=this._getAbilityList(i,e.system.abilities,"checks",s,"abilityCheck");this._combineCategoryWithList(t,s,a)}_addUtilityList(t,e,i){if(!1===get("showUtilityCategory"))return;let s=this._getUtilityList(e,i),a=this.i18n("tokenActionHud.utility");this._combineCategoryWithList(t,a,s)}_getAttacksList(t,e){let i=t.items.filter((t=>"attack"===t.type)),s=this._sortByItemSort(i),a=this.initializeEmptyCategory("attacks"),n="cmb",o={name:this.i18n("PF1.CMBAbbr"),encodedValue:[n,e,n].join(this.delimiter),id:n},r="bab",l={name:this.i18n("PF1.BABAbbr"),encodedValue:[r,e,r].join(this.delimiter),id:r},c=this.initializeEmptySubcategory();c.actions=Array.of(o,l),this._combineSubcategoryWithCategory(a,this.i18n("tokenActionHud.pf1.bonuses"),c);let d="melee",u={name:this.i18n("tokenActionHud.melee"),encodedValue:[d,e,d].join(this.delimiter),id:d},h="ranged",g={name:this.i18n("tokenActionHud.ranged"),encodedValue:[h,e,h].join(this.delimiter),id:h},m=s.map((i=>this._buildItem(e,t,"attack",i))),y=this.initializeEmptySubcategory();m.unshift(g),m.unshift(u),y.actions=m;let p=this.i18n("tokenActionHud.attack");return this._combineSubcategoryWithCategory(a,p,y),a}_getBuffsList(t,e){let i=t.items.filter((t=>"buff"===t.type)),s=this._sortByItemSort(i),a=s.map((i=>{var s=this._buildItem(e,t,"buff",i);return s.cssClass=i.isActive?"active":"",s})),n=this.initializeEmptySubcategory();n.actions=a;let o=this.i18n("tokenActionHud.pf1.buffs"),r=this.initializeEmptyCategory("buffs");return this._combineSubcategoryWithCategory(r,o,n),r}_getItemList(t,e){let i=t.items.filter((t=>t.system.quantity>0)),s=this._sortByItemSort(i),a="item",n=s.filter((t=>"consumable"!==t.type&&t.system.equipped)),o=n.filter((t=>"weapon"==t.type)).map((i=>this._buildItem(e,t,a,i))),r=this.initializeEmptySubcategory();r.actions=o;let l=n.filter((t=>"equipment"==t.type)).map((i=>this._buildItem(e,t,a,i))),c=this.initializeEmptySubcategory();c.actions=l;let d=n.filter((t=>"weapon"!=t.type&&"equipment"!=t.type)).map((i=>this._buildItem(e,t,a,i))),u=this.initializeEmptySubcategory();u.actions=d;let h=s.filter((t=>"consumable"==t.type)),g=this._filterExpendedItems(h).filter((t=>t.system.uses?.value&&t.system.uses?.value>=0||t.system.uses?.max&&t.system.uses?.max>=0)).map((i=>this._buildItem(e,t,a,i))),m=this.initializeEmptySubcategory();m.actions=g;let y=h.filter((t=>!(t.system.uses?.max||t.system.uses?.value)&&"ammo"!=t.system.consumableType)).map((i=>this._buildItem(e,t,a,i))),p=this.initializeEmptySubcategory();p.actions=y;let b=i.filter((t=>"tool"===t.type)).map((i=>this._buildItem(e,t,a,i))),f=this.initializeEmptySubcategory();f.actions=b;let k=this.i18n("tokenActionHud.weapons"),_=this.i18n("tokenActionHud.equipment"),C=this.i18n("tokenActionHud.other"),A=this.i18n("tokenActionHud.consumables"),S=this.i18n("tokenActionHud.pf1.inconsumables"),H=this.i18n("tokenActionHud.tools"),v=this.initializeEmptyCategory("inventory");return this._combineSubcategoryWithCategory(v,k,r),this._combineSubcategoryWithCategory(v,_,c),this._combineSubcategoryWithCategory(v,C,u),this._combineSubcategoryWithCategory(v,A,m),this._combineSubcategoryWithCategory(v,S,p),this._combineSubcategoryWithCategory(v,H,f),v}_getSpellsList(t,e){let i=t.items.filter((t=>"spell"===t.type));return i=this._filterExpendedItems(i),this._categoriseSpells(t,e,i)}_categoriseSpells(t,e,i){let s=[];const a="spell";return[...new Set(i.map((t=>t.system.spellbook)))].sort().forEach((n=>{const o=this.initializeEmptySubcategory(`spells-${n}`),r=this.initializeEmptySubcategory("concentration","tokenActionHud.checks"),l=t.system.attributes.spells.spellbooks[n],c=l.spontaneous,toUpperFirstChar=t=>t.charAt(0).toUpperCase()+t.slice(1);let d=l.altName||this.i18n(l.label)||toUpperFirstChar(l.class)||toUpperFirstChar(n);r.actions.push(this._createConcentrationAction(e,n,this.i18n("tokenActionHud.pf1.concentration"))),r.actions.push(this._createCasterlevelCheckAction(e,n,this.i18n("tokenActionHud.pf1.casterlevel")));const u=i.filter((t=>t.system.spellbook===n)).sort(((t,e)=>t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}))).sort(((t,e)=>t.system.level-e.system.level)).reduce(((t,e)=>(t.hasOwnProperty(e.system.level)||(t[e.system.level]=[]),t[e.system.level].push(e),t)),{});Object.entries(u).forEach((i=>{var s=this.initializeEmptySubcategory(),r=i[0]>0?`${this.i18n("tokenActionHud.level")} ${i[0]}`:this.i18n("tokenActionHud.cantrips"),l=t.system.attributes?.spells?.spellbooks[n].spells["spell"+i[0]];if(l&&l.max>0){var d=`${l.value}/${l.max}`;s.info1=d}i[1].forEach((i=>{if(!this._isSpellCastable(t,i))return;let n=i.name;n=n.charAt(0).toUpperCase()+n.slice(1);let o=i._id,r=[a,e,o].join(this.delimiter);var l={name:n,id:o,encodedValue:r,info2:""};l.img=this._getImage(i),this._addSpellInfo(i,c,l),s.actions.push(l)})),this._combineSubcategoryWithCategory(o,r,s)})),r.actions?.length>0&&o.subcategories.unshift(r),s.push({label:d,category:o})})),s}_addSpellInfo(t,e,i){let s=t.system.components;if(!e&&t.system.preparation){let e=t.system.preparation;e.maxAmount&&(i.info1=`${e.preparedAmount}/${e.maxAmount}`)}s?.verbal&&(i.info2+=this.i18n("PF1.SpellComponentVerbal").charAt(0).toUpperCase()),s?.somatic&&(i.info2+=this.i18n("PF1.SpellComponentSomatic").charAt(0).toUpperCase()),s?.material&&(i.info2+=this.i18n("PF1.SpellComponentMaterial").charAt(0).toUpperCase()),s?.focus&&(i.info3=this.i18n("PF1.SpellComponentFocus").charAt(0).toUpperCase())}_isSpellCastable(t,e){const i=e.system.spellbook,s=t.system.attributes.spells.spellbooks[i].spontaneous;return"character"!==t.type||(!!e.system.atWill||(s?!!e.system.preparation.spontaneousPrepared:0!==e.system.preparation.preparedAmount))}_createCasterlevelCheckAction(t,e,i){let s="casterLevel";return{name:i,encodedValue:[s,t,e.toLowerCase()].join(this.delimiter),id:s}}_createConcentrationAction(t,e,i){let s="concentration";return{name:i,encodedValue:[s,t,e.toLowerCase()].join(this.delimiter),id:s}}_getFeaturesList(t,e){let i=t.items.filter((t=>"feat"==t.type)),s=this._sortByItemSort(i);return this._categoriseFeatures(e,t,s)}_categoriseFeatures(t,e,i){let s=this.initializeEmptySubcategory(),a=this.initializeEmptySubcategory(),n=this.initializeEmptySubcategory();i.reduce(function(i,o){const r=o.system.activation?.type??o.system.actions[0]?.activation.type;let l=this._buildItem(t,e,"feat",o);o.isActive?r&&""!==r&&"passive"!==r?s.actions.push(l):a.actions.push(l):n.actions.push(l)}.bind(this),{});let o=this.initializeEmptyCategory("feats"),r=this.i18n("tokenActionHud.active");if(this._combineSubcategoryWithCategory(o,r,s),!get("ignorePassiveFeats")){let t=this.i18n("tokenActionHud.passive");this._combineSubcategoryWithCategory(o,t,a)}if(!get("ignoreDisabledFeats")){let t=this.i18n("tokenActionHud.pf1.disabled");this._combineSubcategoryWithCategory(o,t,n)}return o}_getSkillsList(t,e){let i=this.initializeEmptyCategory("skills"),s="skill",a=get("abbreviateSkills"),n=new Set;Object.entries(t).forEach((t=>{t[1].id=t[0],t[1].isSubSkill=!1,n.add(t),t[1].subSkills&&Object.entries(t[1].subSkills).forEach((e=>{e[1].id=`${t[0]}.subSkills.${e[0]}`,e[1].isSubSkill=!0,n.add(e)}))}));let o=[...n].map((t=>{let i=t[1].id,n=t[1];if(n.rt&&!n.rank)return null;let o=a?i:CONFIG.PF1.skills[i]??n.name??"?";o=o.charAt(0).toUpperCase()+o.slice(1);let r=[s,e,i].join(this.delimiter);return{name:o,id:i,encodedValue:r,info1:this._getSkillRankInfo(n.rank)}})).filter((t=>!!t)),r=this.initializeEmptySubcategory();r.actions=o;let l=this.i18n("tokenActionHud.skills");return this._combineSubcategoryWithCategory(i,l,r),i}_getSkillRankInfo(t){return t<=0?"":`R${t}`}_addMultiSkills(t,e){let i=this.initializeEmptyCategory("skills"),s="skill",a=get("abbreviateSkills"),n=Object.entries(CONFIG.PF1.skills).map((t=>{let i=a?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let n=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:n}})),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenActionHud.skills");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i,!0)}_getAbilityList(t,e,i,s,a){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(CONFIG.PF1.abilities).map((s=>{if(0===e[s[0]].value)return;let n=o?s[0]:s[1];n=n.charAt(0).toUpperCase()+n.slice(1);let r,l=[a,t,s[0]].join(this.delimiter);return r="checks"===i?"":this._getProficiencyIcon(e[s[0]].proficient),{name:n,id:s[0],encodedValue:l,icon:r}})),l=this.initializeEmptySubcategory();return l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,s,l),n}_getSavesList(t,e,i,s,a){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(CONFIG.PF1.savingThrows).map((e=>{let i=o?e[0]:e[1];i=i.charAt(0).toUpperCase()+i.slice(1);let s=[a,t,e[0]].join(this.delimiter);return{name:i,id:e[0],encodedValue:s}})),l=this.initializeEmptySubcategory();l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,s,l);let c=this.initializeEmptySubcategory(),d="defenses",u=[{name:this.i18n("tokenActionHud.defenses"),encodedValue:[d,t,d].join(this.delimiter),id:d}];return c.actions=u,this._combineSubcategoryWithCategory(n,this.i18n("tokenActionHud.defenses"),c),n}_getConditionsList(t,e,i,s,a){if(!e)return;let n=this.initializeEmptyCategory(i),o=this.initializeEmptySubcategory();return Object.entries(e).forEach((e=>{const i=e[0],s=e[1];let n,r=CONFIG.PF1.conditions[i];get("showIcons")&&(n=CONFIG.PF1.conditionTextures[i]);let l=[a,t,i].join(this.delimiter),c={name:r,id:i,encodedValue:l,img:n};c.cssClass=s?"active":"",o.actions.push(c)})),o.actions=o.actions.sort(((t,e)=>t.name<e.name?-1:t.name>e.name?1:0)),this._combineSubcategoryWithCategory(n,s,o),n}_addMultiAbilities(t,e,i,s,a){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(CONFIG.PF1.abilities).map((t=>{let i=o?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let s=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:s}})),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(n,s,l),this._combineCategoryWithList(t,s,n,!0)}_addMultiSaves(t,e,i,s,a){let n=this.initializeEmptyCategory(i),o=this.initializeEmptySubcategory(),r=get("abbreviateSkills"),l=Object.entries(CONFIG.PF1.savingThrows).map((t=>{let i=r?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let s=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:s}}));o.actions=l.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,s,o),this._combineCategoryWithList(t,s,n,!0)}_addCombatSubcategory(t,e,i){let s=this.initializeEmptySubcategory();const a=game.combat;let n,o;a&&(n=a.combatants.find((t=>t.tokenId===i)),o=n?.initiative);let r={id:"rollInitiative",encodedValue:[t,i,"initiative"].join(this.delimiter),name:this.i18n("tokenActionHud.rollInitiative")};if(o&&(r.info1=o),r.cssClass=o?"active":"",s.actions.push(r),game.combat?.current?.tokenId===i){let e={id:"endTurn",encodedValue:[t,i,"endTurn"].join(this.delimiter),name:this.i18n("tokenActionHud.endTurn")};s.actions.push(e)}this._combineSubcategoryWithCategory(e,this.i18n("tokenActionHud.combat"),s)}_addMultiCombatSubcategory(t,e,i){let s=this.initializeEmptySubcategory();const a=game.combat;let n,o={id:"rollInitiative",encodedValue:[t,e,"initiative"].join(this.delimiter),name:this.i18n("tokenActionHud.rollInitiative")};if(a){n=canvas.tokens.controlled.map((t=>t.id)).map((t=>a.combatants.find((e=>e.tokenId===t)))).every((t=>!!t?.initiative))}o.cssClass=n?"active":"",s.actions.push(o),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.combat"),s)}_getUtilityList(t,e){let i=this.initializeEmptyCategory("utility"),s="utility";this._addCombatSubcategory(s,i,e);let a=this.initializeEmptySubcategory();if("character"===t.type){let t=[s,e,"rest"].join(this.delimiter);a.actions.push({id:"rest",encodedValue:t,name:this.i18n("tokenActionHud.rest")})}return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.rests"),a),i}_addMultiUtilities(t,e,i){let s=this.initializeEmptyCategory("utility"),a="utility";this._addMultiCombatSubcategory(a,e,s);let n=this.initializeEmptySubcategory();if(i.every((t=>"character"===t.type))){let t=[a,e,"rest"].join(this.delimiter);n.actions.push({id:"rest",encodedValue:t,name:this.i18n("tokenActionHud.rest")})}this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.rests"),n),this._combineCategoryWithList(t,this.i18n("tokenActionHud.utility"),s)}_buildItem(t,e,i,s){let a=[i,t,s._id].join(this.delimiter),n=this._getImage(s),o=this._getActionIcon(s.system.activation?.type),r={name:this._getItemName(s),id:s._id,encodedValue:a,img:n,icon:o};return s.system.recharge&&!s.system.recharge.charged&&s.system.recharge.value&&(r.name+=` (${this.i18n("tokenActionHud.recharge")})`),r.info1=this._getQuantityData(s),r.info2=this._getUsesData(s),r.info3=this._getConsumeData(s,e),r}_getItemName(t){let e;return e=t.system.identified||game.user.isGM?t.system.identifiedName:t.system.unidentified?.name,e||(e=t.name),e}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getQuantityData(t){return t.system.quantity>1?t.system.quantity:""}_getUsesData(t){let e="",i=t.system.uses;return i&&(i.max||i.value)?(e=i.value??0,i.max>0&&(e+=`/${i.max}`),e):e}_getConsumeData(t,e){let i="",s=t.system.consume?.type;if(s&&""!==s){let a=t.system.consume.target,n=a.substr(0,a.lastIndexOf("."));if("attribute"===s){let t=getProperty(e,`system.${a}`);if(t){let s=getProperty(e,`system.${n}`);i=t,s.max&&(i+=`/${s.max}`)}}if("charges"===s){let s=t.system.consume.target,a=e.items.get(s)?.system.uses;a?.value&&(i=a.value,a.max&&(i+=`/${a.max}`))}if("attribute"!==s&&"charges"!==s){let s=t.system.consume.target,a=e.items.get(s)?.system.quantity;a&&(i=a)}}return i}_filterExpendedItems(t){return get("showEmptyItems")?t:t.filter((t=>{let e=t.system.uses;return!e||!(e.max>0&&!e.value)}))}_sortByItemSort(t){let e=Object.values(t);return e.sort(((t,e)=>t.sort-e.sort)),e}_getProficiencyIcon(t){return{0:"",.5:'<i class="fas fa-adjust"></i>',1:'<i class="fas fa-check"></i>',2:'<i class="fas fa-check-double"></i>'}[t]}_getActionIcon(t){return{immediate:'<i class="fas fa-bolt"></i>',reaction:'<i class="fas fa-bolt"></i>',free:'<i class="fas fa-plus"></i>',swift:'<i class="fas fa-plus"></i>',full:'<i class="far fa-circle"></i>',round:'<i class="fas fa-hourglass-start"></i>',minute:'<i class="fas fa-hourglass-half"></i>',hour:'<i class="fas fa-hourglass-end"></i>',special:'<i class="fas fa-star"></i>'}[t]}}class RollHandlerBasePf1 extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2];"multi"===a?canvas.tokens.controlled.forEach((e=>{let i=e.id;this._handleMacros(t,s,i,n)})):await this._handleMacros(t,s,a,n)}async _handleMacros(t,e,i,s){switch(e){case"ability":this.rollAbilityMacro(t,i,s);break;case"casterLevel":this.rollcasterLevelMacro(t,i,s);break;case"concentration":this.rollConcentrationMacro(t,i,s);break;case"cmb":this.rollCmbMacro(t,i,s);break;case"melee":this.rollMeleeAttackMacro(t,i,s);break;case"ranged":this.rollRangedAttackMacro(t,i,s);break;case"bab":this.rollBAB(t,i,s);break;case"skill":this.rollSkillMacro(t,i,s);break;case"abilitySave":this.rollAbilitySaveMacro(t,i,s);break;case"abilityCheck":this.rollAbilityCheckMacro(t,i,s);break;case"buff":await this.adjustBuff(t,i,s);break;case"condition":await this.adjustCondition(t,i,s);break;case"item":case"spell":case"feat":case"attack":this.isRenderItem()?this.doRenderItem(i,s):this.rollItemMacro(t,i,s);break;case"defenses":this.rollDefenses(t,i,s);break;case"utility":await this.performUtilityMacro(t,i,s)}}rollCmbMacro(t,e,i){super.getActor(e).rollCMB(t)}rollMeleeAttackMacro(t,e,i){super.getActor(e).rollAttack({event:t,melee:!0})}rollRangedAttackMacro(t,e,i){super.getActor(e).rollAttack({event:t,melee:!1})}rollBAB(t,e,i){super.getActor(e).rollBAB({event:t})}rollcasterLevelMacro(t,e,i){super.getActor(e).rollCL(i)}rollConcentrationMacro(t,e,i){super.getActor(e).rollConcentration(i)}rollAbilityMacro(t,e,i){super.getActor(e).rollAbility(i,{event:t})}rollAbilityCheckMacro(t,e,i){super.getActor(e).rollAbilityTest(i,{event:t})}rollAbilitySaveMacro(t,e,i){super.getActor(e).rollSavingThrow(i,{event:t})}rollSkillMacro(t,e,i){super.getActor(e).rollSkill(i,{event:t})}rollItemMacro(t,e,i){const s=super.getActor(e),a=super.getItem(s,i),n=!!game.settings.settings.get("pf1.skipActionDialogs")&&game.settings.get("pf1","skipActionDialogs"),o=t.shiftKey,r=n?!o:o;a.use({ev:t,skipDialog:r})}rollDefenses(t,e,i){super.getActor(e).rollDefenses()}async adjustBuff(t,e,i){let s=super.getActor(e),a=super.getItem(s,i),n={data:{active:!a.system.active}};await a.update(n)}async adjustCondition(t,e,i){let s=super.getActor(e);const a=s.system.attributes.conditions[i];let n={system:{attributes:{conditions:{}}}};n.system.attributes.conditions[i]=!a,await s.update(n)}async performUtilityMacro(t,e,i){let s=super.getActor(e),a=super.getToken(e);switch(i){case"rest":s.sheet._onRest(t);break;case"toggleCombat":a.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"toggleVisibility":a.toggleVisibility();break;case"initiative":await this.performInitiativeMacro(e);break;case"endTurn":game.combat?.current?.tokenId===e&&await(game.combat?.nextTurn())}}async performInitiativeMacro(t){let e=super.getActor(t);await e.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHUD")}}function register$c(t,e){const i=["Attacks","Buffs","Inventory","Spells","Features","Skills","Saves","Checks","Conditions","Utility"];for(const e of i)game.settings.register(t,`show${e}Category`,{name:game.i18n.localize(`tokenActionHud.settings.show${e}Category.name`),hint:game.i18n.localize(`tokenActionHud.settings.show${e}Category.hint`),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{updateFunc(t)}});game.settings.register(t,"ignorePassiveFeats",{name:game.i18n.localize("tokenActionHud.rotv.settings.ignorePassiveFeats.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.ignorePassiveFeats.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenActionHud.rotv.settings.abbreviateSkills.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showEmptyItems",{name:game.i18n.localize("tokenActionHud.rotv.settings.showEmptyItems.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showEmptyItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"ignoreDisabledFeats",{name:game.i18n.localize("tokenActionHud.pf1.settings.showDisabled.name"),hint:game.i18n.localize("tokenActionHud.pf1.settings.showDisabled.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}class Pf1SystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerPf1(t,e)}getAvailableRollHandlers(){return{core:"Core PF1"}}doGetRollHandler(t){return new RollHandlerBasePf1}doRegisterSettings(t,e){register$c(t,e)}}class ActionHandlerD35E extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(i),i;if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;return a?(i.actorId=a.id,this._addAttacksList(i,a,s),this._addBuffsList(i,a,s),this._addItemsList(i,a,s),this._addSpellsList(i,a,s),this._addFeatsList(i,a,s),this._addSkillsList(i,a,s),this._addSavesList(i,a,s),this._addChecksList(i,a,s),this._addUtilityList(i,a,s),get("showHudTitle")&&(i.hudTitle=t.name),i):i}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["npc","character"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.type)));const s=t.tokenId;this._addMultiSkills(t,s);let a=this.i18n("tokenActionHud.saves"),n=this.i18n("tokenActionHud.checks");this._addMultiSaves(t,s,"saves",a,"abilitySave"),this._addMultiAbilities(t,s,"checks",n,"abilityCheck"),this._addMultiUtilities(t,s,i)}_addAttacksList(t,e,i){let s=this._getAttacksList(e,i),a=this.i18n("tokenActionHud.attack");this._combineCategoryWithList(t,a,s)}_addBuffsList(t,e,i){let s=this._getBuffsList(e,i),a=this.i18n("tokenActionHud.d35e.buffs");this._combineCategoryWithList(t,a,s)}_addItemsList(t,e,i){let s=this._getItemList(e,i),a=this.i18n("tokenActionHud.inventory");this._combineCategoryWithList(t,a,s)}_addSpellsList(t,e,i){let s=this._getSpellsList(e,i),a=this.i18n("tokenActionHud.spells");this._combineCategoryWithList(t,a,s)}_addFeatsList(t,e,i){let s=this._getFeatsList(e,i),a=this.i18n("tokenActionHud.features");this._combineCategoryWithList(t,a,s)}_addSkillsList(t,e,i){let s=this._getSkillsList(e.system.skills,i),a=this.i18n("tokenActionHud.skills");this._combineCategoryWithList(t,a,s)}_addSavesList(t,e,i){let s=this.i18n("tokenActionHud.saves"),a=this._getSavesList(i,e,"saves",s,"abilitySave");this._combineCategoryWithList(t,s,a)}_addChecksList(t,e,i){let s=this.i18n("tokenActionHud.checks"),a=this._getAbilityList(i,e.system.abilities,"checks",s,"abilityCheck");this._combineCategoryWithList(t,s,a)}_addUtilityList(t,e,i){let s=this._getUtilityList(e,i),a=this.i18n("tokenActionHud.utility");this._combineCategoryWithList(t,a,s)}_getAttacksList(t,e){let i=t.items.filter((t=>"attack"===t.type)),s=this._sortByItemSort(i),a="attack",n=this.initializeEmptyCategory("attacks"),o=this.initializeEmptySubcategory(),r="cmb",l=[{name:this.i18n("tokenActionHud.d35e.grapple"),encodedValue:[r,e,r].join(this.delimiter),id:r}];o.actions=l,this._combineSubcategoryWithCategory(n,this.i18n("tokenActionHud.d35e.grapple"),o);let c=s.map((i=>this._buildItem(e,t,a,i))),d=this.initializeEmptySubcategory();d.actions=c;let u=this.i18n("tokenActionHud.attack");this._combineSubcategoryWithCategory(n,u,d);let h=t.items.filter((t=>"full-attack"===t.type)),g=this._sortByItemSort(h).map((i=>this._buildItem(e,t,a,i))),m=this.initializeEmptySubcategory();m.actions=g;let y=this.i18n("tokenActionHud.d35e.fullAttack");return this._combineSubcategoryWithCategory(n,y,m),n}_getBuffsList(t,e){let i=t.items.filter((t=>"buff"===t.type)),s=this._sortByItemSort(i),a=s.map((i=>{var s=this._buildItem(e,t,"buff",i);return s.cssClass=i.system.active?"active":"",s})),n=this.initializeEmptySubcategory();n.actions=a;let o=this.i18n("tokenActionHud.d35e.buffs"),r=this.initializeEmptyCategory("buffs");return this._combineSubcategoryWithCategory(r,o,n),r}_getItemList(t,e){let i=t.items.filter((t=>t.system.quantity>0)),s=this._sortByItemSort(i),a="item",n=s.filter((t=>"consumable"!==t.type&&t.system.equipped)),o=n.filter((t=>"weapon"==t.type)).map((i=>this._buildItem(e,t,a,i))),r=this.initializeEmptySubcategory();r.actions=o;let l=n.filter((t=>"equipment"==t.type)).map((i=>this._buildItem(e,t,a,i))),c=this.initializeEmptySubcategory();c.actions=l;let d=n.filter((t=>"weapon"!=t.type&&"equipment"!=t.type)).map((i=>this._buildItem(e,t,a,i))),u=this.initializeEmptySubcategory();u.actions=d;let h=s.filter((t=>"consumable"==t.type)),g=this._filterExpendedItems(h).filter((t=>t.system.uses?.value&&t.system.uses?.value>=0||t.system.uses?.max&&t.system.uses?.max>=0)).map((i=>this._buildItem(e,t,a,i))),m=this.initializeEmptySubcategory();m.actions=g;let y=h.filter((t=>!(t.system.uses?.max||t.system.uses?.value)&&"ammo"!=t.system.consumableType)).map((i=>this._buildItem(e,t,a,i))),p=this.initializeEmptySubcategory();p.actions=y;let b=i.filter((t=>"tool"===t.type)).map((i=>this._buildItem(e,t,a,i))),f=this.initializeEmptySubcategory();f.actions=b;let k=this.i18n("tokenActionHud.weapons"),_=this.i18n("tokenActionHud.equipment"),C=this.i18n("tokenActionHud.other"),A=this.i18n("tokenActionHud.consumables"),S=this.i18n("tokenActionHud.d35e.inconsumables"),H=this.i18n("tokenActionHud.tools"),v=this.initializeEmptyCategory("inventory");return this._combineSubcategoryWithCategory(v,k,r),this._combineSubcategoryWithCategory(v,_,c),this._combineSubcategoryWithCategory(v,C,u),this._combineSubcategoryWithCategory(v,A,m),this._combineSubcategoryWithCategory(v,S,p),this._combineSubcategoryWithCategory(v,H,f),v}_getSpellsList(t,e){let i=t.items.filter((t=>"spell"===t.type));return i=this._filterExpendedItems(i),this._categoriseSpells(t,e,i)}_categoriseSpells(t,e,i){const s="spell";let a=this.initializeEmptySubcategory("spells"),n=this.initializeEmptySubcategory("concentration");n.name=this.i18n("tokenActionHud.d35e.concentration");return[...new Set(i.map((t=>t.system.spellbook)))].sort().forEach((o=>{const r=t.system.attributes.spells.spellbooks[o].spontaneous;let l=o.charAt(0).toUpperCase()+o.slice(1);n.actions.push(this._createConcentrationAction(e,l));const c=i.filter((t=>t.system.spellbook===o)).sort(((t,e)=>t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}))).sort(((t,e)=>t.system.level-e.system.level)).reduce(((t,e)=>(t.hasOwnProperty(e.system.level)||(t[e.system.level]=[]),t[e.system.level].push(e),t)),{});var d=!0;Object.entries(c).forEach((i=>{var n=this.initializeEmptySubcategory(),c=i[0]>0?`${this.i18n("tokenActionHud.level")} ${i[0]}`:this.i18n("tokenActionHud.cantrips"),u=t.system.attributes?.spells?.spellbooks[o].spells["spell"+i[0]];if(u&&u.max>0){var h=`${u.value?u.value+"/":""}${u.max}`;n.info1=h}d&&(c=`${l} - ${c}`,d=!1),i[1].forEach((i=>{if(!this._isSpellCastable(t,i))return;let a=i.name;a=a.charAt(0).toUpperCase()+a.slice(1);let o=i.id,l=[s,e,o].join(this.delimiter);var c={name:a,id:o,encodedValue:l,info2:""};c.img=this._getImage(i),this._addSpellInfo(i,r,c),n.actions.push(c)})),this._combineSubcategoryWithCategory(a,c,n)}))})),n.actions?.length>0&&a.subcategories.unshift(n),a}_addSpellInfo(t,e,i){let s=t.system.components;if(!e&&t.system.preparation){let e=t.system.preparation;(e.maxAmount||e.preparedAmount)&&(i.info1=`${e.preparedAmount}/${e.maxAmount}`)}s?.verbal&&(i.info2+=this.i18n("D35E.SpellComponentVerbal").charAt(0).toUpperCase()),s?.somatic&&(i.info2+=this.i18n("D35E.SpellComponentSomatic").charAt(0).toUpperCase()),s?.material&&(i.info2+=this.i18n("D35E.SpellComponentMaterial").charAt(0).toUpperCase()),s?.focus&&(i.info3=this.i18n("D35E.SpellComponentFocus").charAt(0).toUpperCase())}_isSpellCastable(t,e){const i=e.system.spellbook,s=t.system.attributes.spells.spellbooks[i].spontaneous;return!!e.system.atWill||(!!e.system.isPower||(!!s||0!==e.system.preparation.preparedAmount))}_createConcentrationAction(t,e){let i="concentration";return{name:e,encodedValue:[i,t,e.toLowerCase()].join(this.delimiter),id:i}}_getFeatsList(t,e){let i=t.items.filter((t=>"feat"==t.type)),s=this._sortByItemSort(i);return this._categoriseFeats(e,t,s)}_categoriseFeats(t,e,i){let s=this.initializeEmptySubcategory(),a=this.initializeEmptySubcategory();i.reduce(function(i,n){const o=n.system.activation.type;let r=this._buildItem(t,e,"feat",n);o&&""!==o&&"passive"!==o?s.actions.push(r):a.actions.push(r)}.bind(this),{});let n=this.initializeEmptyCategory("feats"),o=this.i18n("tokenActionHud.active");if(this._combineSubcategoryWithCategory(n,o,s),!get("ignorePassiveFeats")){let t=this.i18n("tokenActionHud.passive");this._combineSubcategoryWithCategory(n,t,a)}return n}_getSkillsList(t,e){let i=this.initializeEmptyCategory("skills"),s="skill",a=get("abbreviateSkills"),n=new Set;Object.entries(t).forEach((t=>{let e=duplicate(t);e[0].startsWith("skill")&&(e[1].isCustomSkill=!0),(!e[1].rt||e[1].rank||e[1].subSkills)&&(e[1].subSkills||n.add(e),e[1].subSkills&&Object.entries(e[1].subSkills).forEach((t=>{t[1].rt&&!t[1].rank||(t[1].isCustomSkill=!0,t[1].mainSkill=e[0],t[1].name=`${CONFIG.D35E.skills[e[0]]} - ${t[1].name}`,n.add(t))})))}));let o=[...n].map((t=>{let i=t[0],n=t[1],o=a?i:CONFIG.D35E.skills[i];!n.isCustomSkill&&o||(o=n.name??"?",i=`${n.mainSkill}.subSkills.${i}`),o=o.charAt(0).toUpperCase()+o.slice(1);let r=[s,e,i].join(this.delimiter);return{name:o,id:i,encodedValue:r,info1:this._getSkillRankInfo(n.rank),info2:[n.rt?"RT":"",n.acp?"ACP":""].filter((t=>""!==t)).join(",")}})),r=this.initializeEmptySubcategory();r.actions=o.sort((function(t,e){return t.name>e.name?1:t.name<e.name?-1:0}));let l=this.i18n("tokenActionHud.skills");return this._combineSubcategoryWithCategory(i,l,r),i}_getSkillRankInfo(t){return t<=0?"":`R${t}`}_addMultiSkills(t,e){let i=this.initializeEmptyCategory("skills"),s="skill",a=get("abbreviateSkills"),n=Object.entries(CONFIG.D35E.skills).map((t=>{let i=a?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let n=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:n}})),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenActionHud.skills");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i,!0)}_getAbilityList(t,e,i,s,a){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(CONFIG.D35E.abilities).map((s=>{if(0===e[s[0]].value)return;let n=o?s[0]:s[1];n=n.charAt(0).toUpperCase()+n.slice(1);let r,l=[a,t,s[0]].join(this.delimiter);return r="checks"===i?"":this._getProficiencyIcon(e[s[0]].proficient),{name:n,id:s[0],encodedValue:l,icon:r}})),l=this.initializeEmptySubcategory();return l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,s,l),n}_getSavesList(t,e,i,s,a){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(CONFIG.D35E.savingThrows).map((e=>{let i=o?e[0]:e[1];i=i.charAt(0).toUpperCase()+i.slice(1);let s=[a,t,e[0]].join(this.delimiter);return{name:i,id:e[0],encodedValue:s}})),l=this.initializeEmptySubcategory();l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,s,l);let c=this.initializeEmptySubcategory(),d="defenses",u=[{name:this.i18n("tokenActionHud.defenses"),encodedValue:[d,t,d].join(this.delimiter),id:d}];return c.actions=u,this._combineSubcategoryWithCategory(n,this.i18n("tokenActionHud.defenses"),c),n}_addMultiAbilities(t,e,i,s,a){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(CONFIG.D35E.abilities).map((t=>{let i=o?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let s=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:s}})),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(n,s,l),this._combineCategoryWithList(t,s,n,!0)}_addMultiSaves(t,e,i,s,a){let n=this.initializeEmptyCategory(i),o=this.initializeEmptySubcategory(),r=get("abbreviateSkills"),l=Object.entries(CONFIG.D35E.savingThrows).map((t=>{let i=r?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let s=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:s}}));o.actions=l.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,s,o),this._combineCategoryWithList(t,s,n,!0)}_getUtilityList(t,e){let i=this.initializeEmptyCategory("utility"),s="utility",a=this.initializeEmptySubcategory();if("character"===t.type){let t=[s,e,"rest"].join(this.delimiter);a.actions.push({id:"rest",encodedValue:t,name:this.i18n("tokenActionHud.rest")})}return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.rests"),a),i}_addMultiUtilities(t,e,i){let s=this.initializeEmptyCategory("utility"),a="utility",n=this.initializeEmptySubcategory();if(i.every((t=>"character"===t.type))){let t=[a,e,"rest"].join(this.delimiter);n.actions.push({id:"rest",encodedValue:t,name:this.i18n("tokenActionHud.rest")})}this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.rests"),n)}_buildItem(t,e,i,s){let a=[i,t,s.id].join(this.delimiter),n=this._getImage(s),o=this._getActionIcon(s.data?.activation?.type),r={name:this._getItemName(s),id:s.id,encodedValue:a,img:n,icon:o};return s.system.recharge&&!s.system.recharge.charged&&s.system.recharge.value&&(r.name+=` (${this.i18n("tokenActionHud.recharge")})`),r.info1=this._getQuantityData(s),r.info2=this._getUsesData(s),r.info3=this._getConsumeData(s,e),r}_getItemName(t){let e;return e=t.system.identified||game.user.isGM?t.system.identifiedName:t.system.unidentified?.name,e||(e=t.name),e}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getQuantityData(t){let e="";return t.system.quantity>1&&(e=t.system.quantity),e}_getUsesData(t){let e="",i=t.system.uses;return i&&(i.max||i.value)?(e=i.value??0,i.max>0&&(e+=`/${i.max}`),e):e}_getConsumeData(t,e){let i="",s=t.system.consume?.type;if(s&&""!==s){let a=t.system.consume.target,n=a.substr(0,a.lastIndexOf("."));if("attribute"===s){let t=getProperty(e,`system.${a}`);if(t){let s=getProperty(e,`system.${n}`);i=t,s.max&&(i+=`/${s.max}`)}}if("charges"===s){let s=t.system.consume.target,a=e.items.get(s)?.system.uses;a?.value&&(i=a.value,a.max&&(i+=`/${a.max}`))}if("attribute"!==s&&"charges"!==s){let s=t.system.consume.target,a=e.items.get(s)?.system.quantity;a&&(i=a)}}return i}_filterExpendedItems(t){return get("showEmptyItems")?t:t.filter((t=>{let e=t.system.uses;return!e||!(e.max>0&&!e.value)}))}_sortByItemSort(t){let e=Object.values(t);return e.sort(((t,e)=>t.sort-e.sort)),e}_getProficiencyIcon(t){return{0:"",.5:'<i class="fas fa-adjust"></i>',1:'<i class="fas fa-check"></i>',2:'<i class="fas fa-check-double"></i>'}[t]}_getActionIcon(t){return{immediate:'<i class="fas fa-bolt"></i>',swift:'<i class="fas fa-plus"></i>',full:'<i class="far fa-circle"></i>',round:'<i class="fas fa-hourglass-start"></i>',minute:'<i class="fas fa-hourglass-half"></i>',hour:'<i class="fas fa-hourglass-end"></i>'}[t]}}class RollHandlerBaseD35E extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2];"multi"===a?canvas.tokens.controlled.forEach((e=>{let i=e.id;this._handleMacros(t,s,i,n)})):await this._handleMacros(t,s,a,n)}async _handleMacros(t,e,i,s){switch(e){case"ability":this.rollAbilityMacro(t,i,s);break;case"concentration":this.rollConcentrationMacro(t,i,s);break;case"cmb":this.rollCmbMacro(t,i,s);break;case"skill":this.rollSkillMacro(t,i,s);break;case"abilitySave":this.rollAbilitySaveMacro(t,i,s);break;case"abilityCheck":this.rollAbilityCheckMacro(t,i,s);break;case"buff":await this.adjustBuff(t,i,s);break;case"item":case"spell":case"feat":case"attack":this.isRenderItem()?this.doRenderItem(i,s):this.rollItemMacro(t,i,s);break;case"defenses":this.rollDefenses(t,i,s);break;case"utility":this.performUtilityMacro(t,i,s)}}rollCmbMacro(t,e,i){super.getActor(e).rollCMB(t)}rollConcentrationMacro(t,e,i){super.getActor(e).rollConcentration(i)}rollAbilityMacro(t,e,i){super.getActor(e).rollAbility(i,{event:t})}rollAbilityCheckMacro(t,e,i){super.getActor(e).rollAbilityTest(i,{event:t})}rollAbilitySaveMacro(t,e,i){super.getActor(e).rollSavingThrow(i,{event:t})}rollSkillMacro(t,e,i){super.getActor(e).rollSkill(i,{event:t})}rollItemMacro(t,e,i){const s=super.getActor(e);super.getItem(s,i).use({ev:t,skipDialog:!1})}rollDefenses(t,e,i){super.getActor(e).rollDefenses()}async adjustBuff(t,e,i){let s=super.getActor(e),a=super.getItem(s,i),n={"data.active":!a.system.active};await a.update(n)}performUtilityMacro(t,e,i){let s=super.getActor(e);if(super.getToken(e),"rest"===i)s.sheet._onRest(t)}}class D35ESystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerD35E(t,e)}getAvailableRollHandlers(){return{core:"Core D35E"}}doGetRollHandler(t){return new RollHandlerBaseD35E}doRegisterSettings(t,e){!function register$b(t,e){game.settings.register(t,"ignorePassiveFeats",{name:game.i18n.localize("tokenActionHud.rotv.settings.ignorePassiveFeats.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.ignorePassiveFeats.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenActionHud.rotv.settings.abbreviateSkills.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showEmptyItems",{name:game.i18n.localize("tokenActionHud.rotv.settings.showEmptyItems.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showEmptyItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}})}(t,e)}}class PcActionHandlerPf2e{i18n=t=>game.i18n.localize(t);constructor(t){this.baseHandler=t}async buildActionList(t,e,i){"familiar"===i.type?this._forFamiliar(t,e,i):await this._forCharacter(t,e,i)}_forFamiliar(t,e,i){let s=this._getFamiliarAttack(i,e),a=this.baseHandler._getItemsList(i,e),n=this.baseHandler._getSkillsList(i,e),o=this._getAttributeList(i,e),r=this.baseHandler._getSaveList(i,e),l=this.baseHandler._getEffectsList(i,e),c=this.baseHandler._getUtilityList(i,e);this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.attack"),s),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.inventory"),a),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.skills"),n),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.attributes"),o),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.saves"),r),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.effects"),l),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.utility"),c)}async _forCharacter(t,e,i){let s=this._getTogglesCategory(i,e),a=this._getStrikesList(i,e),n=this.baseHandler._getActionsList(i,e),o=this.baseHandler._getItemsList(i,e),r=await this.baseHandler._getSpellsList(i,e),l=this.baseHandler._getFeatsList(i,e),c=this.baseHandler._getSkillsList(i,e),d=this._getAttributeList(i,e),u=this.baseHandler._getSaveList(i,e),h=this.baseHandler._getEffectsList(i,e),g=this.baseHandler._getUtilityList(i,e);this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.toggles"),s),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.pf2e.strikes"),a),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.actions"),n),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.inventory"),o),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.spells"),r),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.features"),l),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.skills"),c),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.attributes"),d),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.saves"),u),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.utility"),g),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.effects"),h)}_getTogglesCategory(t,e){if(!get("separateTogglesCategory"))return;let i=this.baseHandler.initializeEmptyCategory("toggles");return this._addTogglesCategories(t,e,i),i}_getStrikesList(t,e){if(!1===get("showStrikesCategory"))return;let i=this.baseHandler.initializeEmptyCategory("strikes");return i.cssClass="oneLine",get("separateTogglesCategory")||this._addTogglesCategories(t,e,i),this.baseHandler._addStrikesCategories(t,e,i),i}_addTogglesCategories(t,e,i){const s="toggle",a=t.system.toggles;if(!a.length)return;let n=this.baseHandler.initializeEmptySubcategory();a.forEach((t=>{const i=[t.domain,t.option].join("."),{delimiter:a}=this.baseHandler,o=[s,e,JSON.stringify(t)].join(a),r=game.i18n.localize(t.label),l=`toggle${t.checked?" active":""}`;n.actions.push({id:i,encodedValue:o,name:r,cssClass:l})})),this.baseHandler._combineSubcategoryWithCategory(i,this.baseHandler.i18n("tokenActionHud.toggles"),n)}_getFamiliarAttack(t,e){let i="familiarAttack",s=this.baseHandler.initializeEmptyCategory("attack"),a=this.baseHandler.initializeEmptySubcategory();const n=t.system.attack;if(n){const t=n.totalModifier<0?n.totalModifier:`+${n.totalModifier}`;let s={name:n.slug.charAt(0).toUpperCase()+n.slug.slice(1),encodedValue:[i,e,n.label].join(this.baseHandler.delimiter),info1:t};a.actions=[s]}return this.baseHandler._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.attack"),a),s}_getAttributeList(t,e){if(!1===get("showAttributesCategory"))return;let i=this.baseHandler.initializeEmptyCategory("attributes"),s=this.baseHandler.initializeEmptySubcategory(),a=Object.entries(t.system.attributes).filter((t=>!!t[1]?.roll)).map((t=>{let e=t[0],i=t[1],s=i.label?i.label:e.charAt(0).toUpperCase()+e.slice(1);return{id:t[0],name:s}}));return s.actions=this.baseHandler._produceActionMap(e,a,"attribute"),this.baseHandler._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.attributes"),s),i}_foundrySort(t,e){return t?.sort||e?.sort?t.sort-e.sort:0}}class NpcActionHandlerPf2e{i18n=t=>game.i18n.localize(t);constructor(t){this.baseHandler=t}async buildActionList(t,e,i){let s=this._getStrikesListNpc(i,e),a=this.baseHandler._getActionsList(i,e),n=this.baseHandler._getItemsList(i,e),o=await this.baseHandler._getSpellsList(i,e),r=this.baseHandler._getFeatsList(i,e),l=this.baseHandler._getSkillsList(i,e),c=this._getAttributeListNpc(i,e),d=this.baseHandler._getSaveList(i,e),u=this.baseHandler._getEffectsList(i,e),h=this.baseHandler._getUtilityList(i,e);this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.pf2e.strikes"),s),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.actions"),a),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.effects"),u),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.inventory"),n),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.spells"),o),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.features"),r),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.skills"),l),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.saves"),d),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.attributes"),c),this.baseHandler._combineCategoryWithList(t,this.i18n("tokenActionHud.utility"),h)}_getStrikesListNpc(t,e){if(!1===get("showStrikesCategory"))return;let i=this.baseHandler.initializeEmptyCategory("strikes");return i.cssClass="oneLine",get("separateTogglesCategory")||this._addTogglesCategories(t,e,i),this.baseHandler._addStrikesCategories(t,e,i),i}_addTogglesCategories(t,e,i){const s="toggle",a=t.system.toggles;if(!a.length)return;let n=this.baseHandler.initializeEmptySubcategory();a.forEach((t=>{const i=[t.domain,t.option].join("."),{delimiter:a}=this.baseHandler,o=[s,e,JSON.stringify(t)].join(a),r=game.i18n.localize(t.label),l=`toggle${t.checked?" active":""}`;n.actions.push({id:i,encodedValue:o,name:r,cssClass:l})})),this.baseHandler._combineSubcategoryWithCategory(i,this.baseHandler.i18n("tokenActionHud.toggles"),n)}_getAttributeListNpc(t,e){if(!1===get("showAttributesCategory"))return;let i=this.baseHandler.initializeEmptyCategory("attributes"),s=this.baseHandler.initializeEmptySubcategory();return s.actions=this.baseHandler._produceActionMap(e,[{id:"perception",name:"Perception"},{id:"initiative",name:"Initiative"}],"attribute"),this.baseHandler._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.attributes"),s),i}_foundrySort(t,e){return t?.sort||e?.sort?t.sort-e.sort:0}}const o={acrobatics:"acr",arcana:"arc",athletics:"ath",crafting:"cra",deception:"dec",diplomacy:"dip",intimidation:"itm",medicine:"med",nature:"nat",occultism:"occ",performance:"prf",religion:"rel",society:"soc",stealth:"ste",survival:"sur",thievery:"thi"};class ActionHandlerPf2e extends ActionHandler{constructor(t,e){super(t,e),this.pcActionHandler=new PcActionHandlerPf2e(this),this.npcActionHandler=new NpcActionHandlerPf2e(this)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(i),i;if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;let n=a.type;return["character","npc","familiar"].includes(n)?(i.actorId=a.id,"character"!==n&&"familiar"!==n||await this.pcActionHandler.buildActionList(i,s,a),"npc"===n&&await this.npcActionHandler.buildActionList(i,s,a),get("showHudTitle")&&(i.hudTitle=t.name),i):i}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["npc","character","familiar"];let i=canvas.tokens.controlled.filter((t=>t.actor)).map((t=>t.actor)).filter((t=>e.includes(t.type)));if(0===i.length)return;const s=t.tokenId;this._addMultiSkills(t,s,i),this._addMultiSaves(t,s,i),this._addMultiAttributes(t,s,i),this._addMultiUtilities(t,s,i)}_addMultiSkills(t,e,i){const s="skill",a=this.initializeEmptyCategory(s),n=this.initializeEmptySubcategory(s),o=i.map((t=>Object.entries(t.system.skills).filter((t=>!!t[1].roll)))),r=Math.min(...o.map((t=>t.length))),l=o.find((t=>t.length===r)),c=l.filter((t=>o.every((e=>e.some((e=>e[0]===t[0]))))));c.forEach((t=>{const i=t[0],a=t[1];let o=CONFIG.PF2E.skills[i];o||(o=a.name);const r=[s,e,i].join(this.delimiter),l={name:game.i18n.localize(o),encodedValue:r,id:i};n.actions.push(l)}));const d=this.i18n("tokenActionHud.pf2e.commonSkills");this._combineSubcategoryWithCategory(a,d,n),this._combineCategoryWithList(t,d,a)}_addMultiSaves(t,e,i){const s="save",a=this.initializeEmptyCategory(s),n=this.initializeEmptySubcategory(s);Object.entries(CONFIG.PF2E.saves).forEach((t=>{const i=t[0],a=t[1],o=[s,e,i].join(this.delimiter),r={name:game.i18n.localize(a),encodedValue:o,id:i};n.actions.push(r)}));const o=this.i18n("tokenActionHud.saves");this._combineSubcategoryWithCategory(a,o,n),this._combineCategoryWithList(t,o,a)}_addMultiAttributes(t,e,i){let s=this.initializeEmptyCategory("attributes"),a=this.initializeEmptySubcategory();a.actions=this._produceActionMap(e,[{id:"perception",name:"Perception"},{id:"initiative",name:"Initiative"}],"attribute");const n=this.i18n("tokenActionHud.attributes");this._combineSubcategoryWithCategory(s,n,a),this._combineCategoryWithList(t,n,s)}_addMultiUtilities(t,e,i){if(!i.every((t=>"character"===t.type)))return;let s=this.initializeEmptyCategory("utility"),a=this.initializeEmptySubcategory(),n=[],o=["utility",e,"treatWounds"].join(this.delimiter),r={id:"treatWounds",name:this.i18n("tokenActionHud.pf2e.treatWounds"),encodedValue:o};n.push(r);let l=["utility",e,"longRest"].join(this.delimiter),c={id:"longRest",name:this.i18n("tokenActionHud.pf2e.restNight"),encodedValue:l};if(n.push(c),game.settings.get("pf2e","staminaVariant")){let t=["utility",e,"takeABreather"].join(this.delimiter),i={id:"takeABreather",name:this.i18n("tokenActionHud.pf2e.takeBreather"),encodedValue:t};n.push(i)}a.actions=n;const d=this.i18n("tokenActionHud.utility");this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.rests"),a),this._combineCategoryWithList(t,d,s)}_getItemsList(t,e){if(!1===get("showInventoryCategory"))return;let i="item",s=this.initializeEmptyCategory("items"),a=["weapon","equipment","consumable","armor","backpack"],n=(t.items??[]).filter((t=>["held","worn"].includes(t.system.equipped?.carryType)&&!t.system.containerId?.value?.length)).filter((t=>a.includes(t.type)&&t.system.quantity>0)).sort(this._foundrySort),o=n.filter((t=>"weapon"===t.type));"character"===t.type&&(o=o.filter((t=>["held","worn"].includes(t.system.equipped?.carryType))));let r=this._buildItemActions(e,i,o),l=this.initializeEmptySubcategory();l.actions=r;let c=n.filter((t=>"armor"===t.type));"character"===t.type&&(c=c.filter((t=>["held","worn"].includes(t.system.equipped?.carryType))));let d=this._buildItemActions(e,i,c),u=this.initializeEmptySubcategory();u.actions=d;let h=n.filter((t=>"equipment"===t.type||"backpack"===t.type)),g=this._buildItemActions(e,i,h),m=this.initializeEmptySubcategory();m.actions=g;let y=n.filter((t=>"consumable"===t.type)),p=this._buildItemActions(e,i,y),b=this.initializeEmptySubcategory();return b.actions=p,this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.weapons"),l),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.armour"),u),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.equipment"),m),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.consumables"),b),this._addContainerSubcategories(e,i,s,t,n),s}_addContainerSubcategories(t,e,i,s,a){const n=[...new Set(s.items.filter((t=>t.system.containerId?.value)).map((t=>t.system.containerId.value)))];(a??[]).filter((t=>n.includes(t.id))).forEach((a=>{const n=a.id,o=s.items.filter((t=>t.system.containerId?.value===n)).sort(this._foundrySort);if(0===o.length)return;const r=this.initializeEmptySubcategory(n);let l=this._buildItemActions(t,e,o);r.actions=l,r.info1=a.system.bulkCapacity.value,this._combineSubcategoryWithCategory(i,a.name,r)}))}_getEffectsList(t,e){if(!1===get("showEffectsCategory"))return;let i=this.initializeEmptyCategory("effects"),s=(t.items??[]).filter((t=>"effect"===t.type&&(!t.unidentified||game.user.isGM))).sort(this._foundrySort),a=this._buildItemActions(e,"item",s),n=this.initializeEmptySubcategory();return n.actions=a,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.effects"),n),i}_addStrikesCategories(t,e,i){let s=t.system.actions?.filter((e=>"strike"===e.type&&(e.item.system.quantity>0||"npc"===t.type)));s&&s.forEach((s=>{this._buildStrikeSubcategory(s,i,"",e,t)}))}_buildStrikeSubcategory(t,e,i,s,a){let n="strike",o=get("calculateAttackPenalty"),r=this.initializeEmptySubcategory(),l=t.glyph;"thrown"===i&&(r.icon='<img class="alt-usage-icon" src="systems/pf2e/icons/mdi/thrown.svg" title="Thrown Usage" style="\n      border: 0;\n      filter: invert(1) drop-shadow(1px 1px 1px rgba(0, 0, 0, 1));\n      left: 2px;\n      padding-top: 3px;\n      position: relative;\n      ">'),"melee"===i?r.icon='<img class="alt-usage-icon" src="systems/pf2e/icons/mdi/sword.svg" title="Melee Usage" style="\n      border: 0;\n      filter: invert(1) drop-shadow(1px 1px 1px rgba(0, 0, 0, 1));\n      left: 2px;\n      padding-top: 3px;\n      position: relative;\n      ">':"thrown"!==i&&l&&(r.icon=`<span style='font-family: "Pathfinder2eActions"'>${l}</span>`);const c=t.sourceId??t.slug??t.item.id,d=t.attackRollType?`${t.label} - ${this.i18n(t.attackRollType)}`:t.label;if(t.ready){let e=Math.abs(parseInt(t.variants[1].label.split(" ")[1])),l=t.totalModifier,d=0,u=l,h=o,g=t.variants.map(function(t){let s;return s=u===l||h?u>=0?`+${u}`:`${u}`:d>=0?`+${d}`:`${d}`,d-=e,u-=e,{id:encodeURIComponent(`${c}>${this.variants.indexOf(t)}>`+i),name:s}}.bind(t));g[0].img=t.imageUrl,r.actions=this._produceActionMap(s,g,n);let m=[n,s,encodeURIComponent(c+">damage>"+i)].join(this.delimiter),y=[n,s,encodeURIComponent(c+">critical>"+i)].join(this.delimiter);r.actions.push({name:this.i18n("tokenActionHud.damage"),encodedValue:m,id:encodeURIComponent(c+">damage>"+i)}),r.actions.push({name:this.i18n("tokenActionHud.critical"),encodedValue:y,id:encodeURIComponent(c+">critical>"+i)});let p=this._ammoInfo(s,a,t);p&&r.actions.push(p)}if(t.auxiliaryActions&&!i){const e=t.auxiliaryActions.map(function(t){return{id:encodeURIComponent(`${c}>${this.auxiliaryActions.indexOf(t)}>`+i),name:t.label}}.bind(t));!t.ready&&e[0]&&(e[0].img=t.imageUrl);this._produceActionMap(s,e,"auxAction").forEach((t=>{r.actions.push(t)}))}if(this._combineSubcategoryWithCategory(e,i||d,r),!i&&t.altUsages)for(const i of t.altUsages)this._buildStrikeSubcategory(i,e,i.item.isMelee?"melee":"thrown",s,a)}_ammoInfo(t,e,i){if(!i.selectedAmmoId||!i.ammunition)return;const s=e.items.get(i.selectedAmmoId);if(!s)return{name:this.i18n("tokenActionHud.pf2e.noAmmo"),encodedValue:"noAmmo",id:"noAmmo"};let a=["ammo",t,s.id].join(this.delimiter),n=this._getImage(s),o={name:s.label,encodedValue:a,id:s.id,img:n};return o.info1=s.system.quantity?.value,o}_getSkillsList(t,e){if(!1===get("showSkillsCategory"))return;let i=this.initializeEmptyCategory("skills"),s=get("abbreviateSkills"),a=Object.entries(t.skills).filter((t=>!!t[1].label&&t[1].label.length>1)),n=a.filter((t=>!t[1].lore)).map((t=>this.createSkillMap(e,"skill",t,s))),o=this.initializeEmptySubcategory();o.actions=n;let r=a.filter((t=>t[1].lore)).sort(this._foundrySort).map((t=>this.createSkillMap(e,"skill",t,s))),l=this.initializeEmptySubcategory();return l.actions=r,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.skills"),o),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.pf2e.lore"),l),i}_getActionsList(t,e){if(!1===get("showActionsCategory"))return;let i="action",s=this.initializeEmptyCategory("actions"),a=(t.items??[]).filter((t=>t.type===i||"feat"===t.type)).sort(this._foundrySort);get("ignorePassiveActions")&&(a=a.filter((t=>"passive"!==t.system.actionType.value)));let n=this.initializeEmptySubcategory();n.actions=this._produceActionMap(e,(a??[]).filter((t=>"action"===t.system.actionType?.value&&this._actionIsShort(t))),i);let o=this.initializeEmptySubcategory();o.actions=this._produceActionMap(e,(a??[]).filter((t=>"reaction"===t.system.actionType?.value&&this._actionIsShort(t))),i);let r=this.initializeEmptySubcategory();r.actions=this._produceActionMap(e,(a??[]).filter((t=>"free"===t.system.actionType?.value&&this._actionIsShort(t))),i);let l=this.initializeEmptySubcategory();l.actions=this._produceActionMap(e,(a??[]).filter((t=>"passive"===t.system.actionType?.value&&this._actionIsShort(t)&&"feat"!==t.type)),i);let c=this.initializeEmptySubcategory();c.actions=this._produceActionMap(e,(a??[]).filter((t=>t.system.traits?.value.includes("exploration"))),i);let d=this.initializeEmptySubcategory();return d.actions=this._produceActionMap(e,(a??[]).filter((t=>t.system.traits?.value.includes("downtime"))),i),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.actions"),n),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.reactions"),o),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.pf2e.free"),r),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.passive"),l),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.pf2e.exploration"),c),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.pf2e.downtime"),d),s}_actionIsShort(t){return!(t.system.traits?.value.includes("exploration")||t.system.traits?.value.includes("downtime"))}async _getSpellsList(t,e){if(!1===get("showSpellsCategory"))return;let i=this.initializeEmptyCategory("spells"),s=["spellcastingEntry"],a=(t.items??[]).filter((t=>s.includes(t.type)));const n="spell";let o=this.initializeEmptySubcategory();for(const i of a){const s=game.i18n.localize("tokenActionHud.spells"),a=`<div>${i.name.replace(" ","</div>&nbsp<div>")}</div>`.replace(` ${s}`,"");let r=this.initializeEmptySubcategory(a);r.name=a,o.subcategories.push(r);const l=await i.getSpellData(),c=l.levels.filter((t=>t.active.length>0));for(const[o,d]of Object.entries(c)){const c=0===Number(o);let u=String(game.i18n.localize(d.label)).replace(` ${s}`,""),h=this.initializeEmptySubcategory();this._setSpellSlotInfo(t,e,h,d,l,c),c&&(u=`${a}&nbsp<div>-</div>&nbsp<div>${u}</div>`,h.info2=this._getSpellDcInfo(i));const g=d.active.filter((t=>!t?.expended&&t));for(const{spell:t,uses:i}of g){let s=[n,e,`${l.id}>${d.level}>${t.id}`].join(this.delimiter);const a={name:t.name,encodedValue:s,id:t.id,img:this._getImage(t),icon:this._getActionIcon(t.system?.time?.value),spellLevel:d.level,info2:i?`${i.value}/${i.max}`:null};this._addSpellInfo(t,a),h.actions.push(a)}this._combineSubcategoryWithCategory(r,u,h)}}return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.spells"),o),i}_getSpellDcInfo(t){let e="";const i=t.statistic;let s="function"==typeof i.dc?i.dc().value:i.dc.value,a=i.check.mod;return e=`${a>=0?`${this.i18n("tokenActionHud.pf2e.atk")} +${a}`:`${this.i18n("tokenActionHud.pf2e.atk")} ${a}`} ${`${this.i18n("tokenActionHud.pf2e.dc")}${s}`}`,e}_setSpellSlotInfo(t,e,i,s,a,n){let o,r,l,c;if(n&&a.isFocusPool){let s=t.system.resources.focus;if(o=s.max,r=s.value,o>0){i.info1=`${r}/${o}`,l=`${a.id}>focus>slotIncrease`;let t=["spellSlot",e,l].join(this.delimiter);i.actions.unshift({id:l,name:"+",encodedValue:t,cssClass:"shrink"}),c=`${a.id}>focus>slotDecrease`;let s=["spellSlot",e,c].join(this.delimiter);i.actions.unshift({id:c,encodedValue:s,name:"-",cssClass:"shrink"})}}if(!0!==s.isCantrip&&s.uses?.max>0&&(!a.isPrepared||a.isFlexible)&&!a.isFocusPool){let t=s.uses,n=`slot${s.level}`;if(o=t.max,r=t.value,o>0){i.info1=`${r}/${o}`,l=`${a.id}>${n}>slotIncrease`;let t=["spellSlot",e,l].join(this.delimiter);i.actions.unshift({encodedValue:t,name:"+",id:l,cssClass:"shrink"}),c=`${a.id}>${n}>slotDecrease`;let s=["spellSlot",e,c].join(this.delimiter);i.actions.unshift({encodedValue:s,name:"-",id:l,cssClass:"shrink"})}}}_addSpellInfo(t,e){this._addComponentsInfo(t,e)}_addComponentsInfo(t,e){let i=t.components;i?e.info1=i.value:(i=t.system.components?.value.split(","),e.info1=i.map((t=>t.trim().charAt(0).toUpperCase())).join(""))}_getFeatsList(t,e){if(!1===get("showFeaturesCategory"))return;let i="feat",s=[{featType:"ancestryfeature",title:this.i18n("tokenActionHud.ancestryFeatures")},{featType:"classfeature",title:this.i18n("tokenActionHud.pf2e.classFeatures")},{featType:"ancestry",title:this.i18n("tokenActionHud.ancestryFeats")},{featType:"class",title:this.i18n("tokenActionHud.pf2e.classFeats")},{featType:"skill",title:this.i18n("tokenActionHud.skillFeats")},{featType:"general",title:this.i18n("tokenActionHud.pf2e.generalFeats")},{featType:"bonus",title:this.i18n("tokenActionHud.pf2e.bonusFeats")}],a=this.initializeEmptyCategory("feats"),n=[i],o=(t.items??[]).filter((t=>n.includes(t.type))).sort(this._foundrySort);for(const t of s){let s=this.initializeEmptySubcategory();s.actions=this._produceActionMap(e,(o??[]).filter((e=>e.featType===t.featType)),i),this._combineSubcategoryWithCategory(a,t.title,s)}return a}_getSaveList(t,e){if(!1===get("showSavesCategory"))return;let i=this.initializeEmptyCategory("saves"),s=Object.values(t.saves).map((t=>({id:t.slug,name:t.label}))),a=this.initializeEmptySubcategory();return a.actions=this._produceActionMap(e,s,"save"),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.saves"),a),i}createSkillMap(t,e,i,s){let a=i[0],n=i[1];const r=game.i18n.localize(n.label),l=s?o[n.slug]??r:r;let c=n.check.mod,d="";0!=c&&(d=c>0?`+${c}`:`${c}`);let u=this._produceActionMap(t,[{id:a,name:l}],e);return u[0].info1=d,u[0]}_getUtilityList(t,e){if(!1===get("showUtilityCategory"))return;let i=this.initializeEmptyCategory("utility"),s="utility",a=this.initializeEmptySubcategory();if(game.combat?.current?.tokenId===e){let t={id:"endTurn",encodedValue:[s,e,"endTurn"].join(this.delimiter),name:this.i18n("tokenActionHud.endTurn")};a.actions.push(t)}if(this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.combat"),a),"character"===t.type){let s=this.initializeEmptySubcategory(),a=[],n=t.system.resources?.heroPoints;n&&a.push(this._getAttributeAction(e,"heroPoint",this.i18n("tokenActionHud.pf2e.heroPoints"),n.value,n.max));let o=t.system.attributes?.doomed,r=t.system.attributes?.dying;if(r){let t=r.value,i=r.max;o&&(i-=o.value),a.push(this._getAttributeAction(e,"dying",this.i18n("tokenActionHud.pf2e.dying"),t,i))}if(r?.value>=1){let t={id:"recoveryCheck",encodedValue:["recoveryCheck",e,"recoveryCheck"].join(this.delimiter),name:this.i18n("tokenActionHud.pf2e.recoveryCheck")};a.push(t)}let l=t.system.attributes?.wounded;l&&a.push(this._getAttributeAction(e,"wounded",this.i18n("tokenActionHud.pf2e.wounded"),l.value,l.max)),o&&a.push(this._getAttributeAction(e,"doomed",this.i18n("tokenActionHud.pf2e.doomed"),o.value,o.max)),s.actions=a,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.attributes"),s);let c=this.initializeEmptySubcategory(),d=[],u=["utility",e,"treatWounds"].join(this.delimiter),h={id:"treatWounds",name:this.i18n("tokenActionHud.pf2e.treatWounds"),encodedValue:u};d.push(h);let g=["utility",e,"longRest"].join(this.delimiter),m={id:"longRest",name:this.i18n("tokenActionHud.pf2e.restNight"),encodedValue:g};if(d.push(m),game.settings.get("pf2e","staminaVariant")){let t=["utility",e,"takeABreather"].join(this.delimiter),i={id:"takeABreather",name:this.i18n("tokenActionHud.pf2e.takeBreather"),encodedValue:t};d.push(i)}c.actions=d,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.rests"),c)}return i}_getAttributeAction(t,e,i,s,a){let n=i.slugify({replacement:"_",strict:!0}),o={name:i,encodedValue:[e,t,n].join(this.delimiter),id:n};return o.info1=`${s}/${a}`,o}_buildItemActions(t,e,i,s=!1){let a=this._produceActionMap(t,i,e,s);return a.forEach((t=>this._addItemInfo(i.find((e=>e.id===t.id)),t))),a}_addItemInfo(t,e){e.info1=this._getQuantityData(t)}_getQuantityData(t){let e="",i=t.system.quantity?.value;return i>1&&(e=i),e}_produceActionMap(t,e,i,s=!1){return e.map((e=>this._produceAction(t,e,i,s)))}_produceAction(t,e,i,s=!1){let a,n=[i,t,e.id].join(this.delimiter),o=e.system?.actions,r=e.system?.actionType?.value;if(["free","reaction","passive"].includes(r))a=this._getActionIcon(r);else if(o&&!s){let t=parseInt((o||{}).value,10)||1;a=this._getActionIcon(t)}let l=this._getImage(e);return{name:e.name,encodedValue:n,id:e.id,img:l,icon:a}}_getActionIcon(t){return{1:"<span style='font-family: \"Pathfinder2eActions\"'>A</span>",2:"<span style='font-family: \"Pathfinder2eActions\"'>D</span>",3:"<span style='font-family: \"Pathfinder2eActions\"'>T</span>",free:"<span style='font-family: \"Pathfinder2eActions\"'>F</span>",reaction:"<span style='font-family: \"Pathfinder2eActions\"'>R</span>",passive:""}[t]}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}}class RollHandlerBasePf2e extends RollHandler{BLIND_ROLL_MODE="blindRoll";constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");Logger.debug(e),3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2];if(["item","feat","action","lore","ammo"].includes(s)&&this.isRenderItem())return this.doRenderItem(a,n);try{const e=["character","familiar","npc"];if("multi"===a){const i=canvas.tokens.controlled.filter((t=>e.includes(t.actor?.type)));for(let e of i){let i=e.id;await this._handleMacros(t,s,i,n)}}else await this._handleMacros(t,s,a,n)}catch(t){throw t}}async _handleMacros(t,e,i,s){let a,n=super.getActor(i);n&&(a=n.type);if(!["ability","spell","item","skill","lore","utility","toggle","strike"].includes(e))switch(a){case"npc":await this._handleUniqueActionsNpc(e,t,i,n,s);break;case"character":case"familiar":await this._handleUniqueActionsChar(e,t,i,n,s)}switch(e){case"ability":this._rollAbility(t,n,s);break;case"skill":await this._rollSkill(t,n,s);break;case"action":case"feat":case"item":this._rollItem(t,n,s);break;case"spell":await this._rollSpell(t,i,n,s);break;case"utility":this._performUtilityMacro(t,i,s);break;case"toggle":await this._performToggleMacro(t,i,s);break;case"strike":this._rollStrikeChar(t,i,n,s)}}async _handleUniqueActionsChar(t,e,i,s,a){switch(t){case"save":this._rollSave(e,s,a);break;case"attribute":this._rollAttributeChar(e,s,a);break;case"spellSlot":await this._adjustSpellSlot(e,s,a);break;case"heroPoint":await this._adjustResources(e,s,"heroPoints","value",a);break;case"doomed":case"wounded":case"dying":await this._adjustCondition(e,s,t);break;case"recoveryCheck":s.rollRecovery({event:e});break;case"familiarAttack":this._rollFamiliarAttack(e,s);break;case"auxAction":this._performAuxAction(e,i,s,a)}}async _handleUniqueActionsNpc(t,e,i,s,a){switch(t){case"save":this._rollSave(e,s,a);break;case"npcStrike":this._rollStrikeNpc(e,i,s,a);break;case"attribute":await this._rollAttributeNpc(e,i,s,a)}}_rollSkill(t,e,i){e.skills[i].check.roll({event:t})}_rollAbility(t,e,i){e.rollAbility(t,i)}_rollAttributeChar(t,e,i){let s=e.system.attributes[i];if(s){const i=e.getRollOptions(["all",s]);s.roll({event:t,options:i})}else e.rollAttribute(t,i)}async _rollAttributeNpc(t,e,i,s){"initiative"===s?await i.rollInitiative({createCombatants:!0}):i.rollAttribute(t,s)}async _adjustSpellSlot(t,e,i){let s,a,n,o=decodeURIComponent(i).split(">"),r=o[0],l=o[1],c=o[2],d=e.items.get(r);if("focus"===l)s=e.system.resources.focus.value,a=e.system.resources.focus.max;else{let t=d.system.slots;s=t[l].value,a=t[l].max}switch(c){case"slotIncrease":if(s>=a)break;s++;break;case"slotDecrease":if(s<=0)break;s--}"focus"===l?e.update({"data.resources.focus.value":s}):(n=[{_id:d.id,data:{slots:{[l]:{value:s}}}}],await Item.updateDocuments(n,{parent:e})),Hooks.callAll("forceUpdateTokenActionHUD")}_rollSave(t,e,i){e.saves[i].check.roll({event:t})}async _updateRollMode(t){await game.settings.set("core","rollMode",t)}_rollStrikeChar(t,e,i,s){let a=decodeURIComponent(s).split(">"),n=a[0],o=a[1],r=a[2]?a[2]:null,l=i.system.actions.filter((t=>"strike"===t.type)).find((t=>(t.sourceId??t.slug??t.item.id)===n));if(this.isRenderItem()){let t=i.system.actions.filter((t=>"strike"===t.type)).find((t=>(t.sourceId??t.slug??t.item.id)===n)).item;if(t)return this.doRenderItem(e,t.id)}switch(null!==r&&("melee"===r&&(l=l.altUsages.find((t=>t.item.isMelee))),"thrown"===r&&(l=l.altUsages.find((t=>t.item.isThrown)))),o){case"damage":l.damage({event:t});break;case"critical":l.critical({event:t});break;default:l.variants[o]?.roll({event:t,altUsage:r})}}_performAuxAction(t,e,i,s){let a=decodeURIComponent(s).split(">"),n=a[0],o=a[1],r=a[2],l=i.system.actions.filter((t=>"strike"===t.type)).find((t=>(t.sourceId??t.slug)===n));if(this.isRenderItem()){let t=i.system.actions.filter((t=>"strike"===t.type)).find((t=>(t.sourceId??t.slug)===n)).origin;if(t)return this.doRenderItem(e,t.id)}""!==r&&(l=l[r]),l.auxiliaryActions[o]?.execute()}_rollStrikeNpc(t,e,i,s){let a=decodeURIComponent(s).split(">"),n=a[0],o=a[1];if("plus"===n){let t=i.items.find((t=>0===o.toUpperCase().localeCompare(t.name.toUpperCase(),void 0,{sensitivity:"base"})));return this.isRenderItem()?this.doRenderItem(e,t.id):void t.toChat()}if(this.isRenderItem())return this.doRenderItem(e,n);let r=i.items.get(n);switch(o){case"damage":r.rollNPCDamage(t);break;case"critical":r.rollNPCDamage(t,!0);break;case"0":r.rollNPCAttack(t);break;case"1":r.rollNPCAttack(t,2);break;case"2":r.rollNPCAttack(t,3)}}_rollItem(t,e,i){e.items.get(i).toChat()}_rollFamiliarAttack(t,e){const i=e.getRollOptions(["all","attack"]);e.system.attack.roll(t,i)}async _rollSpell(t,e,i,s){let a=decodeURIComponent(s).split(">"),[n,o,r,l]=a;if(this.isRenderItem())return this.doRenderItem(e,r);const c=i.items.get(n),d=i.items.get(r);c&&d&&(await c.cast(d,{message:!l,consume:!0,level:Number(o)}),Hooks.callAll("forceUpdateTokenActionHUD"))}async _performUtilityMacro(t,e,i){super.getActor(e);let s=super.getToken(e);switch(i){case"treatWounds":this._executeMacroById("6duZj0Ygiqv712rq");break;case"longRest":this._executeMacroById("0GU2sdy3r2MeC56x");break;case"takeABreather":this._executeMacroById("aS6F7PSUlS9JM5jr");break;case"toggleCombat":s.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"toggleVisibility":s.toggleVisibility();break;case"endTurn":game.combat?.current?.tokenId===e&&await(game.combat?.nextTurn())}}async _executeMacroById(t){game.packs.get("pf2e.pf2e-macros").getDocument(t).then((t=>t.execute()))}async _adjustResources(t,e,i,s,a){let n=e.system.resources[i][s],o=e.system.resources[i].max;if(this.rightClick){if(n<=0)return;n--}else{if(n>=o)return;n++}let r=[{_id:e.id,data:{resources:{[i]:{[s]:n}}}}];await Actor.updateDocuments(r),Hooks.callAll("forceUpdateTokenActionHUD")}async _adjustCondition(t,e,i){let s=e.system.attributes[i].max;this.rightClick?await e.decreaseCondition(i):await e.increaseCondition(i,{max:s}),Hooks.callAll("forceUpdateTokenActionHUD")}async _performToggleMacro(t,e,i){const s=super.getActor(e),a=JSON.parse(i);a.domain&&a.option&&await s.toggleRollOption(a.domain,a.option,a.itemId)}}class Pf2eSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerPf2e(t,e)}getAvailableRollHandlers(){return{core:"Core PF2E"}}doGetRollHandler(t){return new RollHandlerBasePf2e}doRegisterSettings(t,e){!function register$a(t,e){const i=["Strikes","Actions","Inventory","Spells","Features","Skills","Attributes","Saves","Effects","Utility"];for(const s of i)game.settings.register(t,`show${s}Category`,{name:game.i18n.localize(`tokenActionHud.settings.show${s}Category.name`),hint:game.i18n.localize(`tokenActionHud.settings.show${s}Category.hint`),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}});game.settings.register(t,"ignorePassiveActions",{name:game.i18n.localize("tokenActionHud.pf2e.settings.ignorePassiveActions.name"),hint:game.i18n.localize("tokenActionHud.pf2e.settings.ignorePassiveActions.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"separateTogglesCategory",{name:game.i18n.localize("tokenActionHud.pf2e.settings.separateTogglesCategory.name"),hint:game.i18n.localize("tokenActionHud.pf2e.settings.separateTogglesCategory.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"calculateAttackPenalty",{name:game.i18n.localize("tokenActionHud.pf2e.settings.calculateAttackPenalty.name"),hint:game.i18n.localize("tokenActionHud.pf2e.settings.calculateAttackPenalty.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenActionHud.pf2e.settings.abbreviateSkills.name"),hint:game.i18n.localize("tokenActionHud.pf2e.settings.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerSfrpg extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;return a?(i.actorId=a.id,"starship"!==a.type?(this._buildItemCategory(t,i),this._buildSpellsCategory(t,i),this._buildFeatsCategory(t,i),this._buildSkillCategory(t,a,i),this._buildAbilitiesCategory(t,i),this._buildSavesCategory(t,i)):(this._addStarshipWeapons(t,a,i),await this._addCrewActions(t,a,i),this._addShields(t,a,i)),this._buildUtilityCategory(t,i),Logger.debug("SFRPG ActionList:",i),get("showHudTitle")&&(i.hudTitle=t.name),i):i}_buildItemCategory(t,e){var i=t.actor.items;let s=t.id;var a=this.i18n("tokenActionHud.equipment"),n="item";let o=this.initializeEmptyCategory("equipment");o=this._addSubcategoryByType(this.i18n("tokenActionHud.weapons"),"weapon",n,i,s,o),o=this._addSubcategoryByType(this.i18n("tokenActionHud.consumables"),"consumable",n,i,s,o),this._combineCategoryWithList(e,a,o)}_buildFeatsCategory(t,e){var i=t.actor.items.filter((t=>"feat"==t.type));let s=t.id;var a=this.i18n("tokenActionHud.features"),n="feat";let o=this.initializeEmptyCategory(a);if(this._addSubcategoryByActionType(this.i18n("tokenActionHud.sfrpg.mwa"),"mwak",n,i,s,o),this._addSubcategoryByActionType(this.i18n("tokenActionHud.sfrpg.rwa"),"rwak",n,i,s,o),this._addSubcategoryByActionType(this.i18n("tokenActionHud.sfrpg.msa"),"msak",n,i,s,o),this._addSubcategoryByActionType(this.i18n("tokenActionHud.sfrpg.rsa"),"rsak",n,i,s,o),this._addSubcategoryByActionType(this.i18n("tokenActionHud.healing"),"heal",n,i,s,o),get("showMiscFeats")){const t=i.filter((t=>!["mwak","rwak","msak","rsak","heal"].includes(t.system.actionType))),e=t.filter((t=>""!==t.system.activation.type));this._addSubcategoryByItemList(this.i18n("tokenActionHud.sfrpg.activeFeats"),n,e,s,o);const a=t.filter((t=>""===t.system.activation.type));this._addSubcategoryByItemList(this.i18n("tokenActionHud.sfrpg.passiveFeats"),n,a,s,o)}this._combineCategoryWithList(e,a,o)}_buildSpellsCategory(t,e){var i=t.actor.items.filter((t=>"spell"==t.type));let s=t.id;var a=this.i18n("tokenActionHud.sfrpg.spellbook");let n=this.initializeEmptyCategory(a);for(let t=0;t<6;t++)n=this._addSubcategoryByLevel(`${this.i18n("tokenActionHud.level")} `+t,t,"spell",i,s,n);this._combineCategoryWithList(e,a,n)}_buildSkillCategory(t,e,i){if(!e.system.skills)return i;let s=this.initializeEmptyCategory("skills"),a="skill";const n=Object.entries(e.system.skills),o=CONFIG.SFRPG.skills;let r=n.map((e=>{let i,s=e[0],n=e[1];s.startsWith("pro")?(i=o.pro,n.subname&&(i+=` (${n.subname})`)):i=o[s];let r=[a,t.id,s].join(this.delimiter);return{name:i,id:s,encodedValue:r,icon:this._getClassSkillIcon(n.value)}})).sort(((t,e)=>t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}))),l=this.initializeEmptySubcategory();l.actions=r;let c=this.i18n("tokenActionHud.skills");this._combineSubcategoryWithCategory(s,c,l),this._combineCategoryWithList(i,c,s)}_buildAbilitiesCategory(t,e){let i=this.initializeEmptyCategory("abilities"),s="ability",a=Object.entries(CONFIG.SFRPG.abilities).map((e=>{let i=e[1],a=[s,t.id,e[0]].join(this.delimiter);return{name:i,id:e[0],encodedValue:a}})),n=this.initializeEmptySubcategory();n.actions=a;let o=this.i18n("tokenActionHud.abilities");this._combineSubcategoryWithCategory(i,o,n),this._combineCategoryWithList(e,o,i)}_buildSavesCategory(t,e){let i=this.initializeEmptyCategory("saves"),s="save",a=Object.entries(CONFIG.SFRPG.saves).map((e=>{let i=e[1],a=[s,t.id,e[0]].join(this.delimiter);return{name:i,id:e[0],encodedValue:a}})),n=this.initializeEmptySubcategory();n.actions=a;let o=this.i18n("tokenActionHud.saves");this._combineSubcategoryWithCategory(i,o,n),this._combineCategoryWithList(e,o,i)}_buildUtilityCategory(t,e){let i=this.initializeEmptyCategory("utility"),s="utility";const a=this.i18n("tokenActionHud.utility"),n=t.id;let o=this.initializeEmptySubcategory();if(game.combat?.current?.tokenId===n){let t={id:"endTurn",encodedValue:[s,n,"endTurn"].join(this.delimiter),name:this.i18n("tokenActionHud.endTurn")};o.actions.push(t)}const r=this.i18n("tokenActionHud.combat");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(e,a,i)}_addSubcategoryByActionType(t,e,i,s,a,n){let o=this.initializeEmptySubcategory(),r=s.filter((t=>t.system.actionType==e));return o.actions=r.map((t=>this._buildItemAction(a,i,t))),this._combineSubcategoryWithCategory(n,t,o),n}_addSubcategoryByItemList(t,e,i,s,a){let n=this.initializeEmptySubcategory();return n.actions=i.map((t=>this._buildItemAction(s,e,t))),this._combineSubcategoryWithCategory(a,t,n),a}_addSubcategoryByType(t,e,i,s,a,n){let o=this.initializeEmptySubcategory(),r=s.filter((t=>t.type==e));return o.actions=r.map((t=>this._buildItemAction(a,i,t))),this._combineSubcategoryWithCategory(n,t,o),n}_addSubcategoryByLevel(t,e,i,s,a,n){let o=this.initializeEmptySubcategory(),r=s.filter((t=>t.system.level===e));return o.actions=r.map((t=>{let e=this._buildItemAction(a,i,t);return get("showSpellInfo")&&this._addSpellInfo(t,e),e})),this._combineSubcategoryWithCategory(n,t,o),n}_addSpellInfo(t,e){let i=t.system;if(i?.sr&&(e.info2+="Sr"),i?.dismissible&&(e.info2+="D"),i?.concentration&&(e.info2+="C"),i?.save?.type){let t=i.save.type;e.info3+=t?.charAt(0).toUpperCase()+t?.slice(1)}}_buildItemAction(t,e,i){let s=[e,t,i.id].join(this.delimiter),a=this._getImage(i),n=this._getActionIcon(i.system.activation?.type),o={name:i.name,id:i.id,encodedValue:s,img:a,icon:n};return o.info1=this._getQuantityData(i),o.info2=this._getUsesOrUsageData(i),o.info3=this._getCapacityData(i),o}_getQuantityData(t){let e="";return t.system.quantity>1&&(e=t.system.quantity),e}_getUsesOrUsageData(t){let e="",i=t.system.uses;if(i?.max||i?.value)return e=i.value??"",i.max>0&&(e+=`/${i.max}`),e;let s=t.system.usage;return s?.value?(e=s.value??"",s.value>0&&(e+=`/${s.per}`),e):e}_getCapacityData(t){let e="",i=t.system.capacity;return i?(e=i.value??"",i.max&&(e+=`/${i.max}`),e):e}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getClassSkillIcon(t){return{3:'<i class="fas fa-check"></i>'}[t]}_getActionIcon(t){return{move:'<i class="fas fa-shoe-prints"></i>',swift:'<i class="fas fa-bolt"></i>',full:'<i class="fas fa-circle"></i>',other:'<i class="far fa-circle"></i>',reaction:'<i class="fas fa-undo-alt"></i>',special:'<i class="fas fa-atom"></i>',min:'<i class="fas fa-hourglass-start"></i>',hour:'<i class="fas fa-hourglass-half"></i>',day:'<i class="fas fa-hourglass-end"></i>'}[t]}_addStarshipWeapons(t,e,i){const s="starshipWeapon",a=e.items.filter((t=>t.type===s));if(0===a.length)return;const n=this.initializeEmptyCategory(s),o=a.reduce(((t,e)=>{const i=e.system.mount.arc;return t.hasOwnProperty(i)||(t[i]=[]),t[i].push(e),t}),{}),r="item";["forward","starboard","port","aft","turret"].forEach((e=>{const i=o[e];if(!i)return;const s=this.initializeEmptySubcategory(e);i.forEach((e=>{const i={name:e.name,encodedValue:[r,t.id,e.id].join(this.delimiter),id:e.id,img:this._getImage(e)};i.info1=e.system.pcu??"",s.actions.push(i)}));const a=e.charAt(0).toUpperCase()+e.slice(1),l=this.i18n("SFRPG.ShipSystems.StarshipArcs."+a);this._combineSubcategoryWithCategory(n,l,s)}));var l=this.i18n("tokenActionHud.weapons");this._combineCategoryWithList(i,l,n)}async _addCrewActions(t,e,i){if(!e.useStarshipAction)return;const s="crewAction",a=this.initializeEmptyCategory(s),n=(await game.packs.get("sfrpg.starship-actions").getDocuments()).reduce(((t,e)=>{const i=e.system.role;return t.hasOwnProperty(i)||(t[i]=[]),t[i].push(e),t}),{});["captain","pilot","gunner","engineer","scienceOfficer","chiefMate","magicOfficer","openCrew","minorCrew"].forEach((i=>{const o=e.system.crew,r=o[i],l=o.npcData[i];if(!this._shouldShowCrewOptions(o,r,l))return;const c=n[i],d=this.initializeEmptySubcategory(i);c.forEach((e=>{const i={name:e.name,encodedValue:[s,t.id,e.id].join(this.delimiter),id:e.id,img:this._getImage(e)};i.info1=e.system.resolvePointCost??"",d.actions.push(i)})),r&&(o.useNPCCrew?d.info1=o.npcData[i].numberOfUses:d.info1=r.limit>0?`${r.actorIds.length}/${r.limit}`:r.actorIds.length);const u=i.charAt(0).toUpperCase()+i.slice(1),h=this.i18n("SFRPG.StarshipSheet.Role."+u);this._combineSubcategoryWithCategory(a,h,d)}));const o=this.i18n("tokenActionHud.sfrpg.crewActions");this._combineCategoryWithList(i,o,a)}_shouldShowCrewOptions(t,e,i){return!e||(e.actorIds?.length>0&&!t.useNPCCrew||!!(t.useNPCCrew&&i?.numberOfUses>0))}_addShields(t,e,i){const s="shields",a=this.initializeEmptySubcategory(s),n=e.system.attributes?.shields;if(!n)return i;a.info1=`${n.value}/${n.max}`;const o=[{name:"-10",value:"-10"},{name:"-5",value:"-5"},{name:"-1",value:"-1"},{name:"+1",value:"+1"},{name:"+5",value:"+5"},{name:"+10",value:"+10"}],r=e.system.quadrants;["forward","starboard","aft","port"].forEach((e=>{const i=r[e].shields;if(!i)return;const l=this.initializeEmptySubcategory(e);l.info1=`${i.value}/${n.limit}`,o.forEach((i=>{const a=[s,t.id,`${e}.${i.value}`].join(this.delimiter),n={name:i.name,encodedValue:a,id:i.value,cssClass:"shrink"};l.actions.push(n)}));const c=e.charAt(0).toUpperCase()+e.slice(1),d=this.i18n("SFRPG.StarshipSheet.Sides."+c);this._combineSubcategoryWithCategory(a,d,l)}));const l=this.i18n("tokenActionHud.sfrpg.shields");this._combineCategoryWithList(i,l,a)}}class RollHandlerBaseSfrpg extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2];switch(s){case"ability":this.rollAbilityMacro(t,a,n);break;case"skill":this.rollSkillMacro(t,a,n);break;case"save":this.rollSaveMacro(t,a,n);break;case"abilitySave":this.rollAbilitySaveMacro(t,a,n);break;case"abilityCheck":this.rollAbilityCheckMacro(t,a,n);break;case"item":case"spell":case"feat":case"starshipWeapon":this.isRenderItem()?this.doRenderItem(a,n):this.rollItemMacro(t,a,n);break;case"shields":this._handleShields(t,a,n);break;case"crewAction":this._handleCrewAction(t,a,n);case"utility":"endTurn"===n&&game.combat?.current?.tokenId===a&&await(game.combat?.nextTurn())}}rollAbilityMacro(t,e,i){super.getActor(e).rollAbility(i,{event:t})}rollAbilityCheckMacro(t,e,i){super.getActor(e).rollAbilityTest(i,{event:t})}rollAbilitySaveMacro(t,e,i){super.getActor(e).rollAbilitySave(i,{event:t})}rollSaveMacro(t,e,i){super.getActor(e).rollSave(i,{event:t})}rollSkillMacro(t,e,i){super.getActor(e).rollSkill(i,{event:t})}rollItemMacro(t,e,i){const s=super.getActor(e),a=s.items.get(i),n=t.shiftKey,o=t.ctrlKey;if(!this.needsRecharge(a))return n&&"weapon"===a.type?a.rollAttack():!o||"weapon"!==a.type&&"spell"!==a.type?"spell"===a.type?s.useSpell(a,{configureDialog:!t.shiftKey}):a.roll():a.rollDamage();a.rollRecharge()}needsRecharge(t){return t.system.recharge&&!t.system.recharge.charged&&t.system.recharge.value}async _handleShields(t,e,i){const s=super.getActor(e);let a=i.split(".");const n=a[0];let o=parseInt(a[1]);if(NaN===o)return;const r=s.system.attributes.shields,l=s.system.quadrants[n].shields;let c;if(c=o<0?Math.clamped(l.value+o,0,r.max):this._calcPossibleIncrease(r,l,o),c===l.value)return;const d={system:{quadrants:{}}};d.system.quadrants[n]={shields:{value:c}},await s.update(d)}_calcPossibleIncrease(t,e,i){const s=t.max-t.value>=0?t.max-t.value:0,a=t.limit-e.value>=0?t.limit-e.value:0;let n=i;return i>s&&(n=s),i>a&&(n=a),e.value+n}_handleCrewAction(t,e,i){super.getActor(e).useStarshipAction(i)}}class SfrpgSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerSfrpg(t,e)}getAvailableRollHandlers(){return{core:"Core Starfinder"}}doGetRollHandler(t){return new RollHandlerBaseSfrpg}doRegisterSettings(t,e){!function register$9(t,e){game.settings.register(t,"showSpellInfo",{name:game.i18n.localize("tokenActionHud.sfrpg.settings.showSpellInfo.name"),hint:game.i18n.localize("tokenActionHud.sfrpg.settings.showSpellInfo.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showMiscFeats",{name:game.i18n.localize("tokenActionHud.sfrpg.settings.showMiscFeats.name"),hint:game.i18n.localize("tokenActionHud.sfrpg.settings.showMiscFeats.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerSW5e extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){return t?this._buildSingleTokenList(t):e?this._buildMultipleTokenList():this.initializeEmptyActionList()}async _buildSingleTokenList(t){const e=this.initializeEmptyActionList();if(e.tokenId=t?.id,e.actorId=t?.actor?.id,!e.tokenId||!e.actorId)return e;get("showHudTitle")&&(e.hudTitle=t.name);return(await this._buildCategories(t)).flat().filter((t=>t)).forEach((t=>{this._combineCategoryWithList(e,t.name,t)})),e}_buildCategories(t){const e=t.actor;return["character","npc","starship"].includes(e.type)?[this._buildItemsCategory(t),this._buildPowersCategory(t),this._buildFeaturesCategory(t),this._buildSkillsCategory(t),this._buildAbilitiesCategory(t),this._buildEffectsCategory(t),this._buildConditionsCategory(t),this._buildUtilityCategory(t)]:"vehicle"===e.type?[this._buildWeaponsCategory(t),this._buildFeaturesCategory(t),this._buildAbilitiesCategory(t),this._buildEffectsCategory(t),this._buildConditionsCategory(t)]:void 0}_buildAbilitiesCategory(t){if(!1===get("showAbilitiesCategory"))return;const e=t.actor.system.abilities;if(get("splitAbilities")){const i=this.i18n("tokenActionHud.sw5e.saves"),s=this._getAbilityList(t.id,e,"saves",i,"abilitySave");s.name=i;const a=this.i18n("tokenActionHud.sw5e.checks"),n=this._getAbilityList(t.id,e,"checks",a,"abilityCheck");return n.name=a,[s,n]}return this._getAbilityList(t.id,e,"abilities",this.i18n("tokenActionHud.sw5e.abilities"),"ability")}_buildMultipleTokenList(){const t=this.initializeEmptyActionList();t.tokenId="multi",t.actorId="multi";const e=canvas.tokens.controlled.every((t=>"starship"===t.actor.type))?["starship"]:["npc","character"],i="starship"===e[0];let s=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.type)));const a=t.tokenId;if(i?this._addMultiStarshipSkills(t,a):this._addMultiSkills(t,a),get("splitAbilities")){let e=this.i18n("tokenActionHud.sw5e.saves"),i=this.i18n("tokenActionHud.sw5e.checks");this._addMultiAbilities(t,a,"saves",e,"abilitySave"),this._addMultiAbilities(t,a,"checks",i,"abilityCheck")}else{let e=this.i18n("tokenActionHud.sw5e.abilities");this._addMultiAbilities(t,a,"abilities",e,"ability")}return get("showConditionsCategory")&&this._addMultiConditions(t,a),this._addMultiUtilities(t,a,s),t}_buildItemsCategory(t){if(!1===get("showInventoryCategory"))return;const e=t.actor,i=t.id;let s,a=this._filterLongerActions(e.items.filter((t=>t.system.quantity>0))),n=this._sortByItemSort(a),o="item";s="npc"===e.type&&get("showAllNpcItems")?n.filter((t=>"consumable"!==t.type&&"power"!==t.type&&"feat"!==t.type)):n.filter((t=>"consumable"!==t.type&&t.system.equipped));let r=this._getActiveEquipment(s),l=r.filter((t=>"weapon"==t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),c=this.initializeEmptySubcategory();c.actions=l;let d=r.filter((t=>"equipment"==t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),u=this.initializeEmptySubcategory();u.actions=d;let h=r.filter((t=>"weapon"!=t.type&&"equipment"!=t.type&&"tool"!=t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),g=this.initializeEmptySubcategory();g.actions=h;let m=this._getActiveEquipment(n.filter((t=>"consumable"==t.type))),y=this._filterExpendedItems(m).map((t=>this._buildEquipmentItem(i,e,o,t))),p=this.initializeEmptySubcategory();p.actions=y;let b=a.filter((t=>"tool"===t.type)).map((t=>this._buildEquipmentItem(i,e,o,t))),f=this.initializeEmptySubcategory();f.actions=b;let k=this.i18n("tokenActionHud.weapons"),_=this.i18n("tokenActionHud.equipment"),C=this.i18n("tokenActionHud.other"),A=this.i18n("tokenActionHud.consumables"),S=this.i18n("tokenActionHud.tools"),H=this.initializeEmptyCategory("inventory");return H.name=this.i18n("tokenActionHud.inventory"),this._combineSubcategoryWithCategory(H,k,c),this._combineSubcategoryWithCategory(H,_,u),this._combineSubcategoryWithCategory(H,C,g),this._combineSubcategoryWithCategory(H,A,p),this._combineSubcategoryWithCategory(H,S,f),H}_buildWeaponsCategory(t){const e=t.actor,i=t.id;let s=this._filterLongerActions(e.items.filter((t=>"weapon"===t.type))),a=this._sortByItemSort(s),n=a.filter((t=>t.system.equipped)),o=this._getActiveEquipment(n).map((t=>this._buildEquipmentItem(i,e,"weapon",t))),r=this.initializeEmptySubcategory();r.actions=o;let l=this.i18n("tokenActionHud.weapons"),c=this.initializeEmptyCategory("weapons");return c.name=this.i18n("tokenActionHud.weapons"),this._combineSubcategoryWithCategory(c,l,r),c}_getActiveEquipment(t){let e=[];if(get("showItemsWithoutAction"))e=t;else{const i=Object.keys(game.sw5e.config.abilityActivationTypes).filter((t=>"none"!==t));e=t.filter((t=>!!t.system.activation&&i.includes(t.system.activation.type)))}return e}_buildPowersCategory(t){if(!1===get("showSpellsCategory"))return;const e=t.actor;if(["vehicle","starship"].includes(e.type))return;let i=this._filterLongerActions(e.items.filter((t=>"power"===t.type)));i=this._filterExpendedItems(i),"character"!==e.type&&get("showAllNpcItems")||(i=this._filterNonpreparedPowers(i));let s=this._sortPowersByLevel(i);return this._categorisePowers(e,t.id,s)}_sortPowersByLevel(t){let e=Object.values(t);return e.sort(((t,e)=>t.system.level===e.system.level?t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}):t.system.level-e.system.level)),e}_categorisePowers(t,e,i){const s=this.initializeEmptySubcategory(),a=this.initializeEmptySubcategory(),n=Object.entries(t.system.powers).sort(((t,e)=>e[0].toUpperCase().localeCompare(t[0].toUpperCase(),void 0,{sensitivity:"base"})));var o=!1;n.forEach((t=>{t[0].startsWith("power")?(!o&&t[1].max>0&&t[1].value>0&&(o=!0),o||"power"!==t[0]||(o=!0),t[1].slotsAvailable=o):(t[1]||(t[1]={}),t[1].slotsAvailable=!t[1].max||t[1].value>0)})),i.reduce(function(i,o){let r=o.system.preparation.mode;const l=game.sw5e.config.powerPreparationModes[r];var c=o.system.level;let d="atwill"===r||"innate"===r;var u,h,g,m,y;d?m=r:(m="power"+c,g=c?`${this.i18n("tokenActionHud.level")} ${c}`:this.i18n("tokenActionHud.at-will")),y=n.find((t=>t[0]===m))?.[1],h=y?.value,u=y?.max;let p=get("showEmptyItems");if(u&&!y?.slotsAvailable&&!p)return;let b,f=this._buildItem(e,t,"power",o);return get("showPowerInfo")&&this._addPowerInfo(o,f),b=d?s.subcategories.find((t=>t.name===l)):a.subcategories.find((t=>t.name===g)),b||(b=this.initializeEmptySubcategory(),u>0&&(b.info1=`${h}/${u}`)),b.actions.push(f),d&&s.subcategories.indexOf(b)<0?this._combineSubcategoryWithCategory(s,l,b):!d&&a.subcategories.indexOf(b)<0&&this._combineSubcategoryWithCategory(a,g,b),i}.bind(this),{});let r=this.initializeEmptyCategory("powers");r.name=this.i18n("tokenActionHud.powers");let l=this.i18n("tokenActionHud.sw5e.naturalPowers"),c=this.i18n("tokenActionHud.books");return this._combineSubcategoryWithCategory(r,l,s),this._combineSubcategoryWithCategory(r,c,a),r}_addPowerInfo(t,e){let i=t.components;e.info1="",e.info2="",e.info3="",i?.vocal&&(spell.info1+=this.i18n("SW5E.ComponentVerbal").charAt(0).toUpperCase()),i?.somatic&&(spell.info1+=this.i18n("SW5E.ComponentSomatic").charAt(0).toUpperCase()),i?.material&&(spell.info1+=this.i18n("SW5E.ComponentMaterial").charAt(0).toUpperCase()),i?.concentration&&(e.info2+=this.i18n("SW5E.Concentration").charAt(0).toUpperCase()),i?.ritual&&(e.info3+=this.i18n("SW5E.Ritual").charAt(0).toUpperCase())}_buildFeaturesCategory(t){if(!1===get("showFeaturesCategory"))return;let e=this._filterLongerActions(t.actor.items.filter((t=>["feat","classfeature","deploymentfeature","maneuver","starshipfeature"].includes(t.type)))),i=this._sortByItemSort(e);return this._categoriseFeats(t.id,t.actor,i)}_categoriseFeats(t,e,i){let s=this.initializeEmptySubcategory(),a=this.initializeEmptySubcategory(),n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory(),r=this.initializeEmptySubcategory(),l=this.initializeEmptySubcategory(),c=this.initializeEmptySubcategory();i.reduce(function(i,d){const u=d.system.activation.type;let h=this._buildEquipmentItem(t,e,"feat",d);return"vehicle"===e.type?u&&"none"!==u&&"reaction"!==u?void r.actions.push(h):u&&"none"!==u?"reaction"==u?void c.actions.push(h):void r.actions.push(h):void l.actions.push(h):"character"===e.type||"npc"===e.type?u&&""!==u?"lair"==u?void n.actions.push(h):"legendary"==u?void o.actions.push(h):void s.actions.push(h):void a.actions.push(h):void 0}.bind(this),{});let d=this.initializeEmptyCategory("feats");d.name=this.i18n("tokenActionHud.features");let u=this.i18n("tokenActionHud.active"),h=this.i18n("tokenActionHud.sw5e.legendary"),g=this.i18n("tokenActionHud.sw5e.lair"),m=this.i18n("tokenActionHud.actions"),y=this.i18n("tokenActionHud.features"),p=this.i18n("tokenActionHud.reactions");if(this._combineSubcategoryWithCategory(d,u,s),this._combineSubcategoryWithCategory(d,h,o),this._combineSubcategoryWithCategory(d,g,n),this._combineSubcategoryWithCategory(d,m,r),this._combineSubcategoryWithCategory(d,y,l),this._combineSubcategoryWithCategory(d,p,c),!get("ignorePassiveFeats")){let t=this.i18n("tokenActionHud.passive");this._combineSubcategoryWithCategory(d,t,a)}return d}_buildSkillsCategory(t){if(!1===get("showSkillsCategory"))return;const e=t.actor,i=e.system.skills;let s=this.initializeEmptyCategory("skills");s.name=this.i18n("tokenActionHud.skills");let a="skill",n=get("abbreviateSkills"),o=Object.entries(i).map((s=>{try{let o=s[0];const r="starship"!==e.type?game.sw5e.config.skills:game.sw5e.config.starshipSkills;let l=n?o:r[o].label;l=l.charAt(0).toUpperCase()+l.slice(1);let c=[a,t.id,s[0]].join(this.delimiter),d=this._getProficiencyIcon(i[o].value);return{name:l,id:s[0],encodedValue:c,icon:d}}catch(t){return Logger.error(s),null}})).filter((t=>!!t)),r=this.initializeEmptySubcategory();r.actions=o;let l=this.i18n("tokenActionHud.sw5e.skills");return this._combineSubcategoryWithCategory(s,l,r),s}_addMultiSkills(t,e){let i=this.initializeEmptyCategory("skills"),s="skill",a=get("abbreviateSkills"),n=Object.entries(game.sw5e.config.skills).map((t=>{let i=a?t[0]:t[1].label;i=i.charAt(0).toUpperCase()+i.slice(1);let n=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:n}})),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenActionHud.sw5e.skills");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i,!0)}_addMultiStarshipSkills(t,e){let i=this.initializeEmptyCategory("skills"),s="skill",a=get("abbreviateSkills"),n=Object.entries(game.sw5e.config.starshipSkills).map((t=>{let i=a?t[0]:t[1].label;i=i.charAt(0).toUpperCase()+i.slice(1);let n=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:n}})),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenActionHud.sw5e.skills");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i,!0)}_getAbilityList(t,e,i,s,a){let n=this.initializeEmptyCategory(i);n.name=s;let o=get("abbreviateSkills"),r=Object.entries(game.sw5e.config.abilities).map((s=>{if(0===e[s[0]].value)return;let n=o?s[0]:s[1];n=n.charAt(0).toUpperCase()+n.slice(1);let r,l=[a,t,s[0]].join(this.delimiter);return r="checks"===i?"":this._getProficiencyIcon(e[s[0]].proficient),{name:n,id:s[0],encodedValue:l,icon:r}})),l=this.initializeEmptySubcategory();return l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,s,l),n}_addMultiAbilities(t,e,i,s,a){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(game.sw5e.config.abilities).map((t=>{let i=o?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let s=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:s}})),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(n,s,l),this._combineCategoryWithList(t,s,n,!0)}_buildUtilityCategory(t){if(!1===get("showUtilityCategory"))return;const e=t.actor;let i=this.initializeEmptyCategory("utility");i.name=this.i18n("tokenActionHud.utility");let s="utility",a=this.initializeEmptySubcategory(),n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();if(this._addCombatSubcategory(s,i,t.id),"character"===e.type){let i=[s,t.id,"shortRest"].join(this.delimiter);a.actions.push({id:"shortRest",encodedValue:i,name:this.i18n("tokenActionHud.shortRest")});let n=[s,t.id,"longRest"].join(this.delimiter);if(a.actions.push({id:"longRest",encodedValue:n,name:this.i18n("tokenActionHud.longRest")}),e.system.attributes.hp.value<=0){let e={id:"deathSave",encodedValue:[s,t.id,"deathSave"].join(this.delimiter),name:this.i18n("tokenActionHud.sw5e.deathSave")};o.actions.push(e)}let r={id:"inspiration",encodedValue:[s,t.id,"inspiration"].join(this.delimiter),name:this.i18n("tokenActionHud.inspiration")};r.cssClass=e.system.attributes?.inspiration?"active":"",o.actions.push(r)}if("starship"===e.type){let i=[s,t.id,"rechargeRepair"].join(this.delimiter);n.actions.push({id:"rechargeRepair",encodedValue:i,name:this.i18n("tokenActionHud.rechargeRepair")});let a=[s,t.id,"refittingRepair"].join(this.delimiter);n.actions.push({id:"refittingRepair",encodedValue:a,name:this.i18n("tokenActionHud.refittingRepair")});let r=[s,t.id,"regenRepair"].join(this.delimiter);if(n.actions.push({id:"regenRepair",encodedValue:r,name:this.i18n("tokenActionHud.regenRepair")}),e.system.attributes.hp.value<=0){let e={id:"destructionSave",encodedValue:[s,t.id,"destructionSave"].join(this.delimiter),name:this.i18n("tokenActionHud.sw5e.destructionSave")};o.actions.push(e)}}return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.rests"),a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.repairs"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.utility"),o),i}_buildEffectsCategory(t){if(!1===get("showEffectsCategory"))return;let e=this.initializeEmptyCategory("effects");return e.name=this.i18n("tokenActionHud.effects"),this._addEffectsSubcategories(t.actor,t.id,e),e}_buildConditionsCategory(t){if(!1===get("showConditionsCategory"))return;let e=this.initializeEmptyCategory("conditions");return e.name=this.i18n("tokenActionHud.conditions"),this._addConditionsSubcategory(t.actor,t.id,e),e}_addEffectsSubcategories(t,e,i){const s="effect",a="find"in t.effects.entries?t.effects.entries:t.effects;let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();a.forEach((t=>{const i=t.label,a=[s,e,t.id].join(this.delimiter),r=`toggle${t.disabled?"":" active"}`,l=t.icon;let c={name:i,id:t.id,encodedValue:a,img:l,cssClass:r};t.isTemporary?n.actions.push(c):o.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.temporary"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.passive"),o)}_addMultiConditions(t,e){const i=this.initializeEmptyCategory("conditions"),s="condition",a=CONFIG.statusEffects.filter((t=>""!==t.id)),n=canvas.tokens.controlled.filter((t=>!!t.actor)).map((t=>t.actor));if(!a)return;let o=this.initializeEmptySubcategory();a.forEach((t=>{const i=this.i18n(t.label),a=[s,e,t.id].join(this.delimiter),r=`toggle${n.every((e=>{("some"in e.effects.entries?e.effects.entries:e.effects).some((e=>e.flags.core?.statusId===t.id))}))?" active":""}`,l=t.icon,c={name:i,id:t.id,encodedValue:a,img:l,cssClass:r};o.actions.push(c)}));const r=this.i18n("tokenActionHud.conditions");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i)}_addConditionsSubcategory(t,e,i){const s="condition",a=CONFIG.statusEffects.filter((t=>""!==t.id));if(!a)return;let n=this.initializeEmptySubcategory();a.forEach((i=>{const a=this.i18n(i.label),o=[s,e,i.id].join(this.delimiter),r=`toggle${("some"in t.effects.entries?t.effects.entries:t.effects).some((t=>t.flags.core?.statusId===i.id))?" active":""}`,l=i.icon,c={name:a,id:i.id,encodedValue:o,img:l,cssClass:r};n.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.conditions"),n)}_addCombatSubcategory(t,e,i){let s=this.initializeEmptySubcategory();const a=game.combat;let n,o;a&&(n=a.combatants.find((t=>t.tokenId===i)),o=n?.initiative);let r={id:"rollInitiative",encodedValue:[t,i,"initiative"].join(this.delimiter),name:this.i18n("tokenActionHud.rollInitiative")};if(o&&(r.info1=o),r.cssClass=o?"active":"",s.actions.push(r),game.combat?.current?.tokenId===i){let e={id:"endTurn",encodedValue:[t,i,"endTurn"].join(this.delimiter),name:this.i18n("tokenActionHud.endTurn")};s.actions.push(e)}this._combineSubcategoryWithCategory(e,this.i18n("tokenActionHud.combat"),s)}_addMultiCombatSubcategory(t,e,i){let s=this.initializeEmptySubcategory();const a=game.combat;let n,o={id:"rollInitiative",encodedValue:[t,e,"initiative"].join(this.delimiter),name:this.i18n("tokenActionHud.rollInitiative")};if(a){n=canvas.tokens.controlled.map((t=>t.id)).map((t=>a.combatants.find((e=>e.tokenId===t)))).every((t=>!!t?.initiative))}o.cssClass=n?"active":"",s.actions.push(o),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.combat"),s)}_addMultiUtilities(t,e,i){let s=this.initializeEmptyCategory("utility"),a="utility";this._addMultiCombatSubcategory(a,e,s);let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory(),r=this.initializeEmptySubcategory();if(i.every((t=>"character"===t.type))){let t=[a,e,"shortRest"].join(this.delimiter);n.actions.push({id:"shortRest",encodedValue:t,name:this.i18n("tokenActionHud.shortRest")});let s=[a,e,"longRest"].join(this.delimiter);n.actions.push({id:"longRest",encodedValue:s,name:this.i18n("tokenActionHud.longRest")});let o={id:"inspiration",encodedValue:[a,e,"inspiration"].join(this.delimiter),name:this.i18n("tokenActionHud.inspiration")};o.cssClass=i.every((t=>t.system.attributes?.inspiration))?"active":"",r.actions.push(o)}if(i.every((t=>"starship"===t.type))){let t=[a,e,"rechargeRepair"].join(this.delimiter);o.actions.push({id:"rechargeRepair",encodedValue:t,name:this.i18n("tokenActionHud.rechargeRepair")});let i=[a,e,"refittingRepair"].join(this.delimiter);o.actions.push({id:"refittingRepair",encodedValue:i,name:this.i18n("tokenActionHud.refittingRepair")});let s=[a,e,"regenRepair"].join(this.delimiter);o.actions.push({id:"regenRepair",encodedValue:s,name:this.i18n("tokenActionHud.regenRepair")})}this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.rests"),n),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.repairs"),o),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.utility"),r),this._combineCategoryWithList(t,this.i18n("tokenActionHud.utility"),s)}_buildEquipmentItem(t,e,i,s){let a=this._buildItem(t,e,i,s);return this._addItemInfo(e,s,a),a}_buildItem(t,e,i,s){const a=s.id;let n=[i,t,a].join(this.delimiter),o=this._getImage(s),r=this._getActionIcon(s.system.activation?.type),l={name:s.name,id:a,encodedValue:n,img:o,icon:r};return s.system.recharge&&!s.system.recharge.charged&&s.system.recharge.value&&(l.name+=` (${this.i18n("tokenActionHud.recharge")})`),l}_addItemInfo(t,e,i){i.info1=this._getQuantityData(e),i.info2=this._getUsesData(e),i.info3=this._getConsumeData(e,t)}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getQuantityData(t){let e="",i=t.system.quantity;return i>1&&(e=i),e}_getUsesData(t){let e="",i=t.system.uses;return i?(e=0===i.value&&i.max?"0":i.value,i.max>0&&(e+=`/${i.max}`),e):e}_getConsumeData(t,e){let i="",s=t.system.consume?.type;if(s&&""!==s){let a=t.system.consume.target,n=a.substr(0,a.lastIndexOf("."));if("attribute"===s){let t=getProperty(e,`system.${n}`);t&&(i=t.value??0,t.max&&(i+=`/${t.max}`))}if("charges"===s){let s=t.system.consume.target,a=e.items.get(s)?.system.uses;a?.value&&(i=a.value,a.max&&(i+=`/${a.max}`))}if("attribute"!==s&&"charges"!==s){let s=t.system.consume.target,a=e.items.get(s)?.system.quantity;a&&(i=a)}}return i}_filterLongerActions(t){var e;return get("hideLongerActions")&&(e=t.filter((t=>!t.system.activation||!("minute"===t.system.activation.type||"hour"===t.system.activation.type||"day"===t.system.activation.type)))),e||t}_filterNonpreparedPowers(t){const e=Object.keys(game.sw5e.config.powerPreparationModes).filter((t=>"prepared"!=t));let i=t;return i=get("showAllNonpreparablePowers")?t.filter((t=>t.system.preparation.prepared||e.includes(t.system.preparation.mode)||0===t.system.level)):t.filter((t=>this.system.preparation.prepared)),i}_filterExpendedItems(t){return get("showEmptyItems")?t:t.filter((t=>{let e=t.system.uses;return!e||!(e.max>0&&!e.value)}))}_sortByItemSort(t){let e=Object.values(t);return e.sort(((t,e)=>t.sort-e.sort)),e}_getProficiencyIcon(t){return{0:"",.5:'<i class="fas fa-adjust"></i>',1:'<i class="fas fa-check"></i>',2:'<i class="fas fa-check-double"></i>'}[t]}_getActionIcon(t){return{bonus:'<i class="fas fa-plus"></i>',crew:'<i class="fas fa-users"></i>',legendary:'<i class="fas fa-dragon"></i>',reaction:'<i class="fas fa-bolt"></i>',special:'<i class="fas fa-star"></i>',lair:'<i class="fas fa-home"></i>',minute:'<i class="fas fa-hourglass-start"></i>',hour:'<i class="fas fa-hourglass-half"></i>',day:'<i class="fas fa-hourglass-end"></i>'}[t]}}class ActionHandlerSW5eGroupByType extends ActionHandlerSW5e{async _buildCategories(t){const e=game.modules.get("character-actions-list-5e").api,i=await e.getActorActionsData(t.actor);return[this._buildActionCategory(t,"actions",i.action),this._buildActionCategory(t,"bonusActions",i.bonus),this._buildActionCategory(t,"reactions",i.reaction),this._buildActionCategory(t,"crewActions",i.crew),this._buildActionCategory(t,"legendaryActions",i.legendary),this._buildActionCategory(t,"lairActions",i.lair),this._buildActionCategory(t,"specialActions",i.other),this._buildSkillsCategory(t),this._buildAbilitiesCategory(t),this._buildEffectsCategory(t),this._buildConditionsCategory(t),this._buildUtilityCategory(t)]}_buildActionCategory(t,e,i){const s=this.initializeEmptyCategory(e);s.name=this.i18n(`tokenActionHud.sw5e.${e}`);let a=[];for(const t of i)"power"==t.type&&(a.push(t),i.delete(t));"character"!==t.actor.type&&get("showAllNpcItems")||(a=this._filterNonpreparedPowers(a)),a=this._sortPowersByLevel(a),a=this._categorisePowers(t.actor,t.id,a),this._subCategorizeEquipment(t,s,i,this.i18n("tokenActionHud.sw5e.weapons"),(t=>"weapon"==t.type)),this._subCategorizeEquipment(t,s,i,this.i18n("tokenActionHud.sw5e.equipment"),(t=>"equipment"==t.type)),this._subCategorizeEquipment(t,s,i,this.i18n("tokenActionHud.sw5e.consumables"),(t=>"consumable"==t.type)),this._subCategorizeEquipment(t,s,i,this.i18n("tokenActionHud.sw5e.tools"),(t=>"tool"==t.type)),this._subCategorizeEquipment(t,s,i,this.i18n("tokenActionHud.sw5e.other"),(t=>!0));for(const t of a.subcategories)this._combineSubcategoryWithCategory(s,t.name,t);return s}_subCategorizeEquipment(t,e,i,s,a){const n=this.initializeEmptySubcategory(),o=new Set;for(const t of i)a(t)&&(o.add(t),i.delete(t));o.size>0&&(n.actions=[...o].map((e=>this._buildEquipmentItem(t.id,t.actor,"item",e))),this._combineSubcategoryWithCategory(e,s,n))}}class MagicItemsPreRollHandler extends PreRollHandler{constructor(){super()}prehandleActionEvent(t,e){let i=e.split("|");if(3!=i.length)return!1;let s=i[0],a=i[1],n=i[2];return"magicItem"==s&&(this._magicItemMacro(t,a,n),!0)}_magicItemMacro(t,e,i){let s=super.getActor(e),a=i.split(">"),n=a[0],o=a[1];MagicItems.actor(s.id).roll(n,o),Hooks.callAll("forceUpdateTokenActionHUD")}}class RollHandlerBaseSW5e extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2];if("multi"===a)for(let e of canvas.tokens.controlled){let i=e.id;await this._handleMacros(t,s,i,n)}else await this._handleMacros(t,s,a,n)}async _handleMacros(t,e,i,s){switch(e){case"ability":this.rollAbilityMacro(t,i,s);break;case"skill":this.rollSkillMacro(t,i,s);break;case"abilitySave":this.rollAbilitySaveMacro(t,i,s);break;case"abilityCheck":this.rollAbilityCheckMacro(t,i,s);break;case"item":case"weapon":case"power":case"feat":this.isRenderItem()?this.doRenderItem(i,s):this.rollItemMacro(t,i,s);break;case"utility":await this.performUtilityMacro(t,i,s);break;case"effect":await this.toggleEffect(t,i,s);break;case"condition":await this.toggleCondition(t,i,s)}}rollAbilityMacro(t,e,i){super.getActor(e).rollAbility(i,{event:t})}rollAbilityCheckMacro(t,e,i){super.getActor(e).rollAbilityTest(i,{event:t})}rollAbilitySaveMacro(t,e,i){super.getActor(e).rollAbilitySave(i,{event:t})}rollSkillMacro(t,e,i){super.getActor(e).rollSkill(i,{event:t})}rollItemMacro(t,e,i){let s=super.getActor(e),a=super.getItem(s,i);if(!this.needsRecharge(a))return"power"===a.type?s.usePower(a):a.use({event:t});a.rollRecharge()}needsRecharge(t){return t.system.recharge&&!t.system.recharge.charged&&t.system.recharge.value}async performUtilityMacro(t,e,i){let s=super.getActor(e),a=super.getToken(e);switch(i){case"shortRest":s.shortRest();break;case"longRest":s.longRest();break;case"inspiration":let i=!s.system.attributes.inspiration;s.update({"data.attributes.inspiration":i});break;case"toggleCombat":a.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"toggleVisibility":a.toggleVisibility();break;case"deathSave":s.rollDeathSave({event:t});break;case"rechargeRepair":s.rechargeRepair();break;case"refittingRepair":s.refittingRepair();break;case"regenRepair":s.regenRepair();break;case"destructionSave":s.rollDestructionSave({event:t});break;case"initiative":await this.performInitiativeMacro(e);break;case"endTurn":game.combat?.current?.tokenId===e&&await(game.combat?.nextTurn())}}async performInitiativeMacro(t){let e=super.getActor(t);await e.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHUD")}async toggleEffect(t,e,i){const s=super.getActor(e),a=("find"in s.effects.entries?s.effects.entries:s.effects).find((t=>t.id===i));if(!a)return;const n=a.flags.core?.statusId;n?await this.toggleCondition(t,e,n,a):(await a.update({disabled:!a.disabled}),Hooks.callAll("forceUpdateTokenActionHUD"))}async toggleCondition(t,e,i,s=null){const a=super.getToken(e),n=this.isRightClick(t);if(i.includes("combat-utility-belt.")&&game.cub&&!n){const t=this.findCondition(i)?.label;if(!t)return;game.cub.hasCondition(t,a)?await game.cub.removeCondition(t,a):await game.cub.addCondition(t,a)}else{const t=this.findCondition(i);if(!t)return;n?await a.toggleEffect(t,{overlay:!0}):await a.toggleEffect(t)}Hooks.callAll("forceUpdateTokenActionHUD")}findCondition(t){return CONFIG.statusEffects.find((e=>e.id===t))}}class RollHandlerMidiQolSW5e extends RollHandlerBaseSW5e{constructor(){super()}rollItemMacro(t,e,i){let s=super.getActor(e),a=s.items.get(i);var n;this.needsRecharge(a)?a.rollRecharge():this.rightClick&&this.ctrl?a.rollAttack():this.rightClick&&this.alt?a.rollDamage():(a.system.properties?.ver&&(n=this.rightClick),MidiQOL.doCombinedRoll({actor:s,item:a,event:t,versatile:n}))}}class RollHandlerObsidianSW5e extends RollHandlerBaseSW5e{constructor(){super()}rollAbilityCheckMacro(t,e,i){let s=super.getActor(e);OBSIDIAN.Items.roll(s,{roll:"abl",abl:i})}rollAbilitySaveMacro(t,e,i){let s=super.getActor(e);OBSIDIAN.Items.roll(s,{roll:"save",save:i})}rollSkillMacro(t,e,i){let s=super.getActor(e);OBSIDIAN.Items.roll(s,{roll:"skl",skl:i})}rollItemMacro(t,e,i){let s=super.getActor(e);OBSIDIAN.Items.roll(s,{roll:"item",id:i})}}class SW5eSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){let i;return i=SystemManager.isModuleActive("character-actions-list-5e")&&get("useActionList")?new ActionHandlerSW5eGroupByType(t,e):new ActionHandlerSW5e(t,e),SystemManager.isModuleActive("magicitems")&&i.addFurtherActionHandler(new MagicItemActionListExtender),i}getAvailableRollHandlers(){let t="Core SW5e";SystemManager.isModuleActive("midi-qol")&&(t+=` [supports ${SystemManager.getModuleTitle("midi-qol")}]`);let e={core:t};return SystemManager.addHandler(e,"midi-qol"),SystemManager.addHandler(e,"obsidian"),e}doGetRollHandler(t){let e;switch(t){case"midi-qol":e=new RollHandlerMidiQolSW5e;break;case"obsidian":e=new RollHandlerObsidianSW5e;break;default:e=new RollHandlerBaseSW5e}return SystemManager.isModuleActive("magicitems")&&e.addPreRollHandler(new MagicItemsPreRollHandler),e}doRegisterSettings(t,e){!function register$8(t,e){const i=["Inventory","Powers","Features","Skills","Abilities","Effects","Conditions","Utility"];for(const s of i)game.settings.register(t,`show${s}Category`,{name:game.i18n.localize(`tokenActionHud.settings.show${s}Category.name`),hint:game.i18n.localize(`tokenActionHud.settings.show${s}Category.hint`),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}});game.settings.register(t,"ignorePassiveFeats",{name:game.i18n.localize("tokenActionHud.sw5e.settings.ignorePassiveFeats.name"),hint:game.i18n.localize("tokenActionHud.sw5e.settings.ignorePassiveFeats.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showPowerInfo",{name:game.i18n.localize("tokenActionHud.sw5e.settings.showPowerInfo.name"),hint:game.i18n.localize("tokenActionHud.sw5e.settings.showPowerInfo.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showAllNonpreparablePowers",{name:game.i18n.localize("tokenActionHud.sw5e.settings.showAllNonpreparablePowers.name"),hint:game.i18n.localize("tokenActionHud.sw5e.settings.showAllNonpreparablePowers.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"hideLongerActions",{name:game.i18n.localize("tokenActionHud.sw5e.settings.hideLongerActions.name"),hint:game.i18n.localize("tokenActionHud.sw5e.settings.hideLongerActions.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenActionHud.sw5e.settings.abbreviateSkills.name"),hint:game.i18n.localize("tokenActionHud.sw5e.settings.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"splitAbilities",{name:game.i18n.localize("tokenActionHud.sw5e.settings.splitAbilities.name"),hint:game.i18n.localize("tokenActionHud.sw5e.settings.splitAbilities.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showAllNpcItems",{name:game.i18n.localize("tokenActionHud.sw5e.settings.showAllNpcItems.name"),hint:game.i18n.localize("tokenActionHud.sw5e.settings.showAllNpcItems.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showEmptyItems",{name:game.i18n.localize("tokenActionHud.sw5e.settings.showEmptyItems.name"),hint:game.i18n.localize("tokenActionHud.sw5e.settings.showEmptyItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showConditionsCategory",{name:game.i18n.localize("tokenActionHud.sw5e.settings.showConditionsCategory.name"),hint:game.i18n.localize("tokenActionHud.sw5e.settings.showConditionsCategory.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showItemsWithoutAction",{name:game.i18n.localize("tokenActionHud.sw5e.settings.showItemsWithoutAction.name"),hint:game.i18n.localize("tokenActionHud.sw5e.settings.showItemsWithoutAction.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.modules.get("character-actions-list-5e")?.active&&game.settings.register(t,"useActionList",{name:game.i18n.localize("tokenActionHud.settings.useActionList.name"),hint:game.i18n.localize("tokenActionHud.settings.useActionList.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerWfrp extends ActionHandler{constructor(t,e){super(t,e),this.filterManager.createOrGetFilter("skills")}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;i.actorId=a.id;let n=this._getCharacteristics(a,s),o=this._getSkills(a,s),r=this._getTalents(a,s),l=this._getItemsList(a,s,"weapon"),c=this._getSpells(a,s),d=this._getPrayers(a,s),u=this._getTraits(a,s),h=this._getUtility(s);return this._combineCategoryWithList(i,this.i18n("tokenActionHud.characteristics"),n),this._combineCategoryWithList(i,this.i18n("tokenActionHud.skills"),o),this._combineCategoryWithList(i,this.i18n("tokenActionHud.talents"),r),this._combineCategoryWithList(i,this.i18n("tokenActionHud.weapons"),l),this._combineCategoryWithList(i,this.i18n("tokenActionHud.magic"),c),this._combineCategoryWithList(i,this.i18n("tokenActionHud.wfrp.religion"),d),this._combineCategoryWithList(i,this.i18n("tokenActionHud.traits"),u),this._combineCategoryWithList(i,this.i18n("tokenActionHud.utility"),h),this._setFilterSuggestions(a),get("showHudTitle")&&(i.hudTitle=t.name),i}_getItemsList(t,e,i){if(!1===get("showWeaponsCategory"))return;let s=i+"s",a=this.initializeEmptyCategory("items"),n=this._getBasicActions(t,e);this._combineSubcategoryWithCategory(a,this.i18n("tokenActionHud.wfrp.basic"),n);let o=this.initializeEmptySubcategory(),r=t.getItemTypes(i),l="character"===t.type?r.filter((t=>t.system.equipped)):r;return o.actions=this._produceMap(e,l,i),this._combineSubcategoryWithCategory(a,s,o),a}_getBasicActions(t,e){let i=this.initializeEmptySubcategory(),s=["unarmed",e,"unarmed"].join(this.delimiter);const a={id:"unarmed",name:this.i18n("tokenActionHud.wfrp.unarmed"),encodedValue:s};i.actions.push(a);let n=["stomp",e,"stomp"].join(this.delimiter);const o={id:"stomp",name:this.i18n("tokenActionHud.wfrp.stomp"),encodedValue:n};i.actions.push(o);let r=["improvise",e,"improvise"].join(this.delimiter);const l={id:"improvise",name:this.i18n("tokenActionHud.wfrp.improvisedWeapon"),encodedValue:r};i.actions.push(l);let c=["dodge",e,"dodge"].join(this.delimiter);const d={id:"dodge",name:this.i18n("tokenActionHud.wfrp.dodge"),encodedValue:c};return i.actions.push(d),i}_getCharacteristics(t,e){if(!1===get("showCharacteristicsCategory"))return;let i=this.initializeEmptyCategory("characteristics"),s="characteristic",a=Object.entries(t.characteristics),n=this.initializeEmptySubcategory();return n.actions=a.map((t=>{let i=[s,e,t[0]].join(this.delimiter);return{name:this.i18n(t[1].abrev),encodedValue:i,id:t[0]}})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.characteristics"),n),i}_getSkills(t,e){if(!1===get("showSkillsCategory"))return;let i="skills",s="skill",a=this.initializeEmptyCategory(i),n=t.getItemTypes("skill").filter((t=>t.id));a.choices=n.length;let o=game.i18n.localize("tokenActionHud.wfrp.melee"),r=game.i18n.localize("tokenActionHud.wfrp.ranged"),l=n.filter((t=>t.name.startsWith(o))),c="skills_melee";this._setFilterSuggestions(c,l);let d=this.initializeEmptySubcategory(c);d.canFilter=l.length>0;let u=this._filterElements(c,l);d.actions=this._produceMap(e,u,s);let h=n.filter((t=>t.name.startsWith(r))),g="skills_ranged";this._setFilterSuggestions(g,h);let m=this.initializeEmptySubcategory(g);m.canFilter=h.length>0;let y=this._filterElements(g,h);m.actions=this._produceMap(e,y,s);let p=n.filter((t=>!(t.name.startsWith(o)||t.name.startsWith(r))&&"adv"!==t.system.advanced.value)),b="skills_basic";this._setFilterSuggestions(b,p);let f=this.initializeEmptySubcategory(b),k=this._filterElements(b,p);f.canFilter=p.length>0,f.actions=this._produceMap(e,k,s);let _=n.filter((t=>!(t.name.startsWith(o)||t.name.startsWith(r))&&"adv"===t.system.advanced.value)),C="skills_advanced";this._setFilterSuggestions(C,_);let A=this.initializeEmptySubcategory(C);A.canFilter=_.length>0;let S=this._filterElements(C,_);return A.actions=this._produceMap(e,S,s),this._combineSubcategoryWithCategory(a,this.i18n("tokenActionHud.melee"),d),this._combineSubcategoryWithCategory(a,this.i18n("tokenActionHud.ranged"),m),this._combineSubcategoryWithCategory(a,this.i18n("tokenActionHud.wfrp.basic"),f),this._combineSubcategoryWithCategory(a,this.i18n("tokenActionHud.advanced"),A),a}_setFilterSuggestions(t,e){let i=e?.map((t=>({id:t.id,value:t.name})));i?.length>0&&this.filterManager.setSuggestions(t,i)}_filterElements(t,e){let i=this.filterManager.getFilteredNames(t),s=e.filter((t=>!!t));return i.length>0&&(s=this.filterManager.isBlocklist(t)?e.filter((t=>!i.includes(t.name))):e.filter((t=>i.includes(t.name)))),s}_getSpells(t,e){if(!1===get("showMagicCategory"))return;let i="spell",s=this.initializeEmptyCategory("spells"),a=t.getItemTypes("spell"),n=a.filter((t=>"petty"===t.system.lore.value)),o=this.initializeEmptySubcategory();o.actions=this._produceMap(e,n,i),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.wfrp.petty"),o);let r=a.filter((t=>"petty"!==t.system.lore.value)).reduce(((t,e)=>{let i=e.system.lore.value;return t.hasOwnProperty(i)||(t[i]=[]),t[i].push(e),t}),{});return Object.entries(r).forEach((t=>{let a=this.initializeEmptySubcategory();a.actions=this._produceMap(e,t[1],i),this._combineSubcategoryWithCategory(s,t[0],a)})),s}_getPrayers(t,e){if(!1===get("showReligionCategory"))return;let i="prayer",s=this.initializeEmptyCategory("prayers"),a=t.getItemTypes("prayer"),n=a.filter((t=>"blessing"===t.type.value)),o=this.initializeEmptySubcategory();o.actions=this._produceMap(e,n,i),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.wfrp.blessing"),o);let r=a.filter((t=>"blessing"!==t.type.value)).reduce(((t,e)=>{let i=e.system.type.value;return t.hasOwnProperty(i)||(t[i]=[]),t[i].push(e),t}),{});return Object.entries(r).forEach((t=>{let a=this.initializeEmptySubcategory();a.actions=this._produceMap(e,t[1],i),this._combineSubcategoryWithCategory(s,t[0],a)})),s}_getTalents(t,e){if(!1===get("showTalentsCategory"))return;let i="talent",s=this.initializeEmptyCategory("talents"),a=t.getItemTypes("talent"),n=a.filter((t=>t.rollable?.value)),o=this.initializeEmptySubcategory();o.actions=this._produceMap(e,n,i);let r=a.filter((t=>!t.rollable?.value)),l=this.initializeEmptySubcategory();return l.actions=this._produceMap(e,r,i),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.wfrp.rollable"),o),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.wfrp.unrollable"),l),s}_getTraits(t,e){if(!1===get("showTraitsCategory"))return;let i="trait",s=this.initializeEmptyCategory("traits"),a=t.getItemTypes("trait").filter((t=>t.included)),n=a.filter((t=>t.rollable?.value)),o=this.initializeEmptySubcategory();o.actions=this._produceMap(e,n,i);let r=a.filter((t=>!t.rollable?.value)),l=this.initializeEmptySubcategory();return l.actions=this._produceMap(e,r,i),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.wfrp.rollable"),o),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.wfrp.unrollable"),l),s}_getUtility(t){if(!1===get("showUtilityCategory"))return;let e=this.initializeEmptyCategory("utility"),i="utility",s=this.initializeEmptySubcategory();if(game.combat?.current?.tokenId===t){let e={id:"endTurn",encodedValue:[i,t,"endTurn"].join(this.delimiter),name:this.i18n("tokenActionHud.endTurn")};s.actions.push(e)}const a=this.i18n("tokenActionHud.combat");return this._combineSubcategoryWithCategory(e,a,s),e}_produceMap(t,e,i){return e.map((e=>{let s=[i,t,e.id].join(this.delimiter),a=this._getImage(e);return{name:e.name,encodedValue:s,id:e.id,img:a}})).sort(((t,e)=>t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"})))}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")||e?.includes("systems/wfrp4e/icons/blank.png")?"":e}}class RollHandlerBaseWfrp4e extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a),r={bypass:!!t.shiftKey};if("characteristic"===s)return o.setupCharacteristic(n,r).then((t=>o.basicTest(t)));if(this.isRenderItem())return this.doRenderItem(a,n);let l=o.items.get(n);if(this.rightClick)return l.postItem();switch(s){case"dodge":return this.dodge(o);case"unarmed":return this.unarmed(o);case"stomp":return this.stomp(o);case"improvise":return this.improvise(o);case"weapon":{let t=o.setupWeapon(l,r);if(!l.loading||l.loaded.value)return t.then((t=>o.weaponTest(t)));break}case"spell":return this.castSpell(o,l,r);case"prayer":return o.setupPrayer(l,r).then((t=>o.prayerTest(t)));case"trait":case"talent":return l.rollable?.value?o.setupTrait(l,r).then((t=>o.traitTest(t))):l.postItem();case"skill":return o.setupSkill(l,r).then((t=>o.basicTest(t)));case"utility":(n="endTurn")&&game.combat?.current?.tokenId===a&&await(game.combat?.nextTurn())}}dodge(t){let e=t.getItemTypes("skill").find((t=>t.name==game.i18n.localize("NAME.Dodge")));e?t.setupSkill(e).then((e=>{t.basicTest(e)})):t.setupCharacteristic("ag",{dodge:!0}).then((e=>{t.basicTest(e)}))}unarmed(t){let e=game.wfrp4e.config.systemItems.unarmed;t.setupWeapon(e).then((e=>{t.weaponTest(e)}))}stomp(t){let e=game.wfrp4e.config.systemItems.stomp;t.setupTrait(e).then((e=>{t.traitTest(e)}))}improvise(t){let e=game.wfrp4e.config.systemItems.improv;t.setupWeapon(e).then((e=>{t.weaponTest(e)}))}castSpell(t,e,i){return t.spellDialog?t.spellDialog(e,i):t.sheet.spellDialog(e,i)}}class Wfrp4eSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerWfrp(t,e)}getAvailableRollHandlers(){return{core:"Core WFRP4e"}}doGetRollHandler(t){return new RollHandlerBaseWfrp4e}doRegisterSettings(t,e){!function register$7(t,e){const i=["Characteristics","Skills","Talents","Weapons","Magic","Religion","Traits","Utility"];for(const s of i)game.settings.register(t,`show${s}Category`,{name:game.i18n.localize(`tokenActionHud.settings.show${s}Category.name`),hint:game.i18n.localize(`tokenActionHud.settings.show${s}Category.hint`),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerLancer extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.actor.id;i.actorId=s;let a=t.actor,n=await a.system.derived.mm;if(!a)return i;switch(a.type){case"pilot":this._combineCategoryWithList(i,this.i18n("tokenActionHud.lancer.pilot"),this._pilotCategory(n,s));break;case"mech":this._combineCategoryWithList(i,this.i18n("tokenActionHud.lancer.pilot"),this._pilotCategory(n.Pilot,n.Pilot.RegistryID)),this._combineCategoryWithList(i,this.i18n("tokenActionHud.lancer.mech"),this._mechCategory(n,s)),this._combineCategoryWithList(i,this.i18n("tokenActionHud.weapons"),this._weaponsCategory(n.Loadout.WepMounts,s)),this._combineCategoryWithList(i,this.i18n("tokenActionHud.lancer.systems"),this._systemsCategory(n.Loadout.SysMounts,s));break;case"npc":this._combineCategoryWithList(i,this.i18n("tokenActionHud.lancer.stats"),this._npcBaseCategory(a,s)),this._combineCategoryWithList(i,this.i18n("tokenActionHud.features"),this._npcFeatureCategory(a,s))}return get("showHudTitle")&&(i.hudTitle=t.name),i}_makeAction(t,e,i,s,a){let n=this.initializeEmptyAction();return n.name=t,n.encodedValue=[e,i,s,JSON.stringify(a||{})].join(this.delimiter),n}_makeItemSubCat(t,e,i,s){let a=this.initializeEmptySubcategory();return a.name=t,a.actions=i.filter((t=>{if(null!=t)return t.Type===e})).map((t=>this._makeAction(t.Name,"item",s,t.RegistryID))),a}_makeNPCItemSubCat(t,e,i,s){let a=this.initializeEmptySubcategory();return a.name=t,a.actions=i.items.filter((t=>{if(null!=t)return"npc_feature"===t.type})).filter((t=>t.system.type===e)).map((t=>this._makeAction(t.name,"item",s,t.id))),a}_pilotCategory(t,e){let i=this.initializeEmptyCategory("pilot");return[this._skillsSubCategory(t,e),this._gritSubCategory(e),this._talentsSubCategory(t,e),this._pilotGearSubCategory(t,e),this._pilotWeaponSubCategory(t,e)].forEach((t=>{this._combineSubcategoryWithCategory(i,t.name,t)})),i}_npcBaseCategory(t,e){let i=this.initializeEmptyCategory("mech");return[this._haseSubCategory(e)].forEach((t=>{this._combineSubcategoryWithCategory(i,t.name,t)})),i}_npcFeatureCategory(t,e){let i=this.initializeEmptyCategory("feature");return[this._npcWeaponSubCat(t,e),this._npcTechSubCat(t,e),this._npcReactionSubCat(t,e),this._npcSystemSubCat(t,e),this._npcTraitSubCat(t,e)].forEach((t=>{this._combineSubcategoryWithCategory(i,t.name,t)})),i}_npcWeaponSubCat(t,e){let i=this._makeNPCItemSubCat(this.i18n("tokenActionHud.weapons"),"Weapon",t,e),s=this._makeAction(this.i18n("tokenActionHud.lancer.basicAttack"),"stat",e,"basicattack");return i.actions.push(s),i}_npcTraitSubCat(t,e){return this._makeNPCItemSubCat(this.i18n("tokenActionHud.traits"),"Trait",t,e)}_npcSystemSubCat(t,e){return this._makeNPCItemSubCat(this.i18n("tokenActionHud.lancer.systems"),"System",t,e)}_npcTechSubCat(t,e){let i=this._makeNPCItemSubCat(this.i18n("tokenActionHud.lancer.techs"),"Tech",t,e),s=this._makeAction(this.i18n("tokenActionHud.lancer.techAttack"),"stat",e,"techattack");return i.actions.push(s),i}_npcReactionSubCat(t,e){return this._makeNPCItemSubCat(this.i18n("tokenActionHud.reactions"),"Reaction",t,e)}_skillsSubCategory(t,e){return this._makeItemSubCat(this.i18n("tokenActionHud.lancer.skillTriggers"),"skill",t._skills,e)}_gritSubCategory(t){let e=this.initializeEmptySubcategory();return e.id="grit",e.name=this.i18n("tokenActionHud.lancer.grit"),e.actions=[this._makeAction(this.i18n("tokenActionHud.lancer.grit"),"stat",t,"Pilot.Grit")],e}_talentsSubCategory(t,e){let i=this.initializeEmptySubcategory();i.id="talent",i.name=this.i18n("tokenActionHud.talents");let s=t._talents.filter((t=>{if(null!=t)return"talent"===t.Type})).map((t=>{let i=this.initializeEmptySubcategory();i.name=t.Name;for(let s=0;s<t.CurrentRank;s++){let a={rank:`${s}`},n=this._makeAction(`${this.i18n("tokenActionHud.lancer.rank")} ${s+1}`,"item",e,t.RegistryID,a);i.actions.push(n)}return i}));return this._combineSubcategoryWithCategory,i.subcategories=s,i}_pilotWeaponSubCategory(t,e){return this._makeItemSubCat(this.i18n("tokenActionHud.weapons"),"pilot_weapon",t.Loadout.Weapons,e)}_pilotGearSubCategory(t,e){return this._makeItemSubCat(this.i18n("tokenActionHud.lancer.gear"),"pilot_gear",t.Loadout.Gear,e)}_mechCategory(t,e){let i=this.initializeEmptyCategory("mech");return[this._haseSubCategory(e),this._frameSubCategory(t,e),this._coreBonSubCategory(t,e),this._corePowerSubCategory(t.Loadout.Frame,e)].forEach((t=>{this._combineSubcategoryWithCategory(i,t.name,t)})),i}_haseSubCategory(t){let e=this.initializeEmptySubcategory();e.id="hase",e.name=this.i18n("tokenActionHud.lancer.hase");let i=[{name:this.i18n("tokenActionHud.lancer.hull"),id:"Hull"},{name:this.i18n("tokenActionHud.attribute.agility"),id:"Agi"},{name:this.i18n("tokenActionHud.lancer.systems"),id:"Sys"},{name:this.i18n("tokenActionHud.lancer.engineering"),id:"Eng"}].map((e=>this._makeAction(e.name,"hase",t,e.id)));return e.actions=i,e}_basicSubCategory(t){let e=this.initializeEmptySubcategory();e.id="stat",e.name=this.i18n("tokenActionHud.lancer.basic");let i=[{name:this.i18n("tokenActionHud.lancer.basicAttack"),data:"basicattack"},{name:this.i18n("tokenActionHud.lancer.techAttack"),data:"techattack"}].map((e=>this._makeAction(e.name,"stat",t,e.data)));return e.actions=i,e}_frameSubCategory(t,e){let i=this.initializeEmptySubcategory(),s=["+1","+1d3","+1d6","+1d6 + 4"],a=Math.min(t.OverchargeCount,s.length-1);i.id="frame",i.name=this.i18n("tokenActionHud.lancer.frame");let n=this.i18n("tokenActionHud.lancer.overcharge")+" ("+s[a]+")";return i.actions=[this._makeAction(n,"frame",e,"overcharge"),this._makeAction(this.i18n("tokenActionHud.lancer.stabilize"),"frame",e,"stabilize")],i}_coreBonSubCategory(t,e){let i=this.initializeEmptySubcategory(),s=t.Pilot.CoreBonuses;return i.name="Core Bonuses",i.actions=s.map((i=>{let s={};return s.pilot=t.Pilot.RegistryID,this._makeAction(i.Name,"coreBonus",e,i.RegistryID,s)})),i}_corePowerSubCategory(t,e){let i=this.initializeEmptySubcategory(),s=t.CoreSystem;return i.name=s.Name,"Core Passive"!=s.PassiveName&&i.actions.push(this._makeAction(s.PassiveName,"corePassive",e,"")),s.ActiveName&&i.actions.push(this._makeAction(s.ActiveName,"coreActive",e,"")),i}_weaponsCategory(t,e){let i=this.initializeEmptyCategory();i.id="weapons",i.name=this.i18n("tokenActionHud.weapons");let s=t.map(((t,i)=>{let s=this.initializeEmptySubcategory("Mount_"+i);return s.name=t.MountType,s.actions=t.Slots.filter((t=>null!==t.Weapon)).map((t=>this._makeAction(t.Weapon.Name,"item",e,t.Weapon.RegistryID))),s}));return s=[this._basicSubCategory(e)].concat(s),s.forEach((t=>{this._combineSubcategoryWithCategory(i,t.name,t)})),i}_systemsCategory(t,e){let i=this.initializeEmptyCategory();return i.id="systems",i.name=this.i18n("tokenActionHud.lancer.systems"),t.flatMap((t=>t.System)).map((t=>{let i=this.initializeEmptySubcategory(t.RegistryID);i.name=t.Name;let s=t.Actions.map(((i,s)=>{let a={Type:"Action"};return a.Index=s,this._makeAction(i.Name,"activation",e,t.RegistryID,a)})),a=t.Deployables.map(((i,s)=>{let a={Type:"Deployable"};return a.Index=s,this._makeAction(i.Name,"activation",e,t.RegistryID,a)}));return i.actions=s.concat(a),i})).forEach((t=>{this._combineSubcategoryWithCategory(i,t.name,t)})),i}}class RollHandlerBaseLancer extends RollHandler{constructor(){super()}getActor(t){return game.actors.get(t)}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&4!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=JSON.parse(i[3]);if(this.isRenderItem()&&["item"].includes(s))return this.doRenderItem(a,n);switch(s){case"hase":this._rollHaseMacro(a,n);break;case"stat":"techattack"==n?this._rollTechMacro(a):"basicattack"==n?this._rollBasicAttackMacro():this._rollStatMacro(a,n);break;case"frame":"stabilize"==n?this._promptStabilizeMacro(a):this._rollOverchargeMacro(a);break;case"item":this._rollWeaponOrFeatureMacro(a,n,o);break;case"coreBonus":this._rollCoreBonusMacro(o.pilot,n);break;case"coreActive":this._rollCoreActiveMacro(a);break;case"corePassive":this._rollCorePassiveMacro(a);break;case"activation":this._rollActivationMacro(a,n,o)}}_rollHaseMacro(t,e){game.lancer.prepareStatMacro(t,`mm.${e}`)}_rollStatMacro(t,e){game.lancer.prepareStatMacro(t,`mm.${e}`)}_rollTechMacro(t){game.lancer.prepareTechMacro(t,null)}_rollBasicAttackMacro(){game.lancer.prepareEncodedAttackMacro()}_promptStabilizeMacro(t){game.lancer.stabilizeMacro(t)}_rollOverchargeMacro(t){game.lancer.prepareOverchargeMacro(t)}_rollWeaponOrFeatureMacro(t,e,i){game.lancer.prepareItemMacro(t,e,i)}_rollCoreBonusMacro(t,e){game.lancer.prepareItemMacro(t,e)}_rollCoreActiveMacro(t){game.lancer.prepareCoreActiveMacro(t)}_rollCorePassiveMacro(t){game.lancer.prepareCorePassiveMacro(t)}_rollActivationMacro(t,e,i){game.lancer.prepareActivationMacro(t,e,i.Type,i.Index)}}class LancerSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return console.log("startup"),new ActionHandlerLancer(t,e)}getAvailableRollHandlers(){return{core:"Core Lancer"}}doGetRollHandler(t){return new RollHandlerBaseLancer}doRegisterSettings(t,e){}}class ActionHandlerSwade extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;return a?(i.actorId=a.id,this._addWoundsAndFatigue(i,s,a),this._addStatuses(i,s,a),"character"!==a.type&&"npc"!==a.type||(this._addBennies(i,s,a),this._addAttributes(i,s,a),this._addSkills(i,s,a),this._addEdgesAndHinderances(i,s,a),this._addSpecialAbilities(i,s,a),this._addPowers(i,s,a)),a.type,this._addGear(i,s,a),this._addUtilities(i,s,a),get("showHudTitle")&&(i.hudTitle=t.name),i):i}_addAttributes(t,e,i){if(!1===get("showAttributesCategory"))return;const s=i.system.attributes;if(!s)return;const a="attribute",n=this.initializeEmptySubcategory("attributes");Object.entries(s).forEach((t=>{const i=t[0],s=t[1],o=CONFIG.SWADE.attributes[i];let r;r=get("abbreviateAttributes")?this.i18n(o.short):this.i18n(o.long);const l={name:r,encodedValue:[a,e,i].join(this.delimiter),id:i},c=this._buildDieString(s.die,s["wild-die"]);l.info1=c,n.actions.push(l)}));const o=this.i18n("SWADE.Attributes");let r=this.initializeEmptyCategory("attributes");const l=this.i18n("SWADE.Attributes");this._combineSubcategoryWithCategory(r,l,n);const c=this.i18n("SWADE.Derived"),d=this._getDerivedStatsSubcategory(e,i);this._combineSubcategoryWithCategory(r,c,d),this._combineCategoryWithList(t,o,r)}_getDerivedStatsSubcategory(t,e){const i=this.initializeEmptySubcategory("derivedStats"),s="runningDie",a={name:game.i18n.localize("SWADE.RunningDie"),encodedValue:["runningDie",t,s].join(this.delimiter),id:s},n=e.system.stats.speed.runningDie;return a.info1=`d${n}`,i.actions.push(a),i}_addSkills(t,e,i){if(!1===get("showSkillsCategory"))return;const s=this.initializeEmptyCategory("skills"),a="skill",n=i.items.filter((t=>t.type===a)),o=this.initializeEmptySubcategory("skills");n.forEach((t=>{const i=[a,e,t.id].join(this.delimiter),s={name:t.name,encodedValue:i,id:t.id};let n=this._parseDie(t.system.die,t.system["wild-die"]);s.info1=n,o.actions.push(s)}));const r=this.i18n("SWADE.Skills");this._combineSubcategoryWithCategory(s,r,o),this._combineCategoryWithList(t,r,s)}_addPowers(t,e,i){if(!1===get("showPowersCategory"))return;const s=i.items.filter((t=>"power"===t.type));if(0===s.length)return;const a="powerPoints",n=this.initializeEmptyCategory(a),o=game.settings.get("swade","noPowerPoints"),r=o?Object.entries(i.system.powerPoints).filter((t=>"general"===t[0])):Object.entries(i.system.powerPoints).filter((t=>t[1].value>=0));r.forEach((t=>{const i="general"===t[0]?"":t[0];if(!o&&s.some((t=>t.system.arcane===i))){const i=t[0].charAt(0).toUpperCase()+t[0].slice(1),s=t[1];s.value=s.value??0,s.max=s.max??0,0===r.length&&(n.info1=`${s.value}/${s.max}`),this._addCounterSubcategory(n,e,s,i,a,t[0])}const l=o?s:s.filter((t=>t.system.arcane===i)),c=this._groupPowers(l);Object.entries(c).forEach((t=>{const i=t[0],s=t[1];this._addPowersSubcategory(e,i,s,a,n)}))}));const l=this.i18n("tokenActionHud.powers");this._combineCategoryWithList(t,l,n)}_groupPowers(t){return[...new Set(t.map((t=>t.system.rank)))].reduce(((e,i)=>{let s=i;return""===s&&(s="No rank"),e.hasOwnProperty(i)||(e[s]=[]),e[s].push(...t.filter((t=>t.system.rank===i))),e}),{})}_addGear(t,e,i){if(!1===get("showGearCategory"))return;const s=this.initializeEmptyCategory("gear");let a=i.items;"character"!==i.type&&"vehicle"!==i.type||(a=a.filter((t=>![0,1].includes(t.system.equipStatus))));const n=a.filter((t=>"weapon"===t.type)),o=this.i18n("tokenActionHud.weapons");this._addItemSubcategory(e,o,n,"weapons",s);const r=a.filter((t=>"armor"===t.type)),l=this.i18n("tokenActionHud.armour");this._addItemSubcategory(e,l,r,"armour",s);const c=a.filter((t=>"shield"===t.type)),d=this.i18n("tokenActionHud.swade.shields");this._addItemSubcategory(e,d,c,"shields",s);const u=a.filter((t=>"misc"===t.type||"vehicle"!==i.type&&"gear"===t.type)),h=this.i18n("tokenActionHud.swade.misc");this._addItemSubcategory(e,h,u,"misc",s);const g=a.filter((t=>"vehicle"===i.type&&"gear"===t.type)),m=this.i18n("tokenActionHud.swade.mods");this._addItemSubcategory(e,m,g,"mods",s),this._combineCategoryWithList(t,this.i18n("tokenActionHud.swade.gear"),s)}_addWoundsAndFatigue(t,e,i){if(!1===get("showWoundsFatigueCategory"))return;let s=this.initializeEmptyCategory("wounds");const a=this.i18n("tokenActionHud.swade.wounds");if(this._addCounterSubcategory(s,e,i.system.wounds,a,"wounds"),"vehicle"!==i.type){const t=this.i18n("tokenActionHud.swade.fatigue");this._addCounterSubcategory(s,e,i.system.fatigue,t,"fatigue")}const n="vehicle"===i.type?this.i18n("tokenActionHud.swade.wounds"):this.i18n("tokenActionHud.swade.woundsAndFatigue");this._combineCategoryWithList(t,n,s)}_addCounterSubcategory(t,e,i,s,a,n=null){if(!i||i.max<1&&i.value<1)return;const o=n?`>${n}`:"",r={name:"-",encodedValue:[a,e,`decrease${o}`].join(this.delimiter),id:`${n}_${a}Decrease`,cssClass:"shrink"},l={name:"+",encodedValue:[a,e,`increase${o}`].join(this.delimiter),id:`${n}_${a}Increase`,cssClass:"shrink"},c=this.initializeEmptySubcategory(a);c.info1=`${i.value}/${i.max}`,c.actions.push(r),c.actions.push(l),this._combineSubcategoryWithCategory(t,s,c)}_addEdgesAndHinderances(t,e,i){if(!1===get("showEdgesHindrancesCategory"))return;const s=this.initializeEmptyCategory("edges"),a=i.items.filter((t=>"edge"===t.type)),n=this.i18n("tokenActionHud.swade.edges");this._addItemSubcategory(e,n,a,"edges",s);const o=i.items.filter((t=>"hindrance"===t.type)),r=this.i18n("tokenActionHud.swade.hindrances");this._addItemSubcategory(e,r,o,"hindrances",s),this._combineCategoryWithList(t,this.i18n("tokenActionHud.swade.edgesAndHindrances"),s)}_addSpecialAbilities(t,e,i){if(!1===get("showSpecialAbilitiesCategory"))return;const s=this.initializeEmptyCategory("abilities"),a=i.items.filter((t=>"ability"===t.type)),n=this.i18n("tokenActionHud.abilities");this._addItemSubcategory(e,n,a,"abilities",s),this._combineCategoryWithList(t,this.i18n("tokenActionHud.swade.specialAbilities"),s)}_addPowersSubcategory(t,e,i,s,a){const n=this.initializeEmptySubcategory(s);i.filter((t=>"-"!==t.name)).forEach((e=>{const i=this._buildPowerAction(t,e);n.actions.push(i)})),this._combineSubcategoryWithCategory(a,e,n)}_addItemSubcategory(t,e,i,s,a){const n=this.initializeEmptySubcategory(s);i.filter((t=>"-"!==t.name)).forEach((e=>{const i=this._buildItemAction(t,e);n.actions.push(i)})),this._combineSubcategoryWithCategory(a,e,n)}_addStatuses(t,e,i){if(!1===get("showStatusCategory"))return;const s=this.initializeEmptyCategory("status"),a="status",n=i.system.status,o=this.initializeEmptySubcategory("status");Object.entries(n).forEach((t=>{const i=t[0],s=t[1],n=i.slice(2).split(/(?=[A-Z])/).join(" "),r=n.toLowerCase(),l={name:n,id:n,encodedValue:[a,e,r].join(this.delimiter)};l.cssClass=s?"active":"",o.actions.push(l)}));const r=this.i18n("tokenActionHud.swade.status");this._combineSubcategoryWithCategory(s,r,o),this._combineCategoryWithList(t,r,s)}_addBennies(t,e,i){if(!1===get("showBenniesCategory"))return;const s=i.system.bennies;if(!s)return;const a=this.initializeEmptyCategory("bennies"),n="benny",o=this.i18n("tokenActionHud.swade.bennies"),r=this.i18n("tokenActionHud.swade.spend"),l={name:r,encodedValue:[n,e,"spend"].join(this.delimiter),id:"bennySpend"},c=this.initializeEmptySubcategory(n);c.name=o,c.info1=s.value.toString(),a.info1=s.value.toString(),c.actions.push(l);const d=this.i18n("tokenActionHud.swade.give");if(this._checkGiveBennies(game.user.role)){const t={name:d,encodedValue:[n,e,"give"].join(this.delimiter),id:"bennyGive"};c.actions.push(t)}if(this._combineSubcategoryWithCategory(a,o,c),game.user.isGM){const t=game.user.getFlag("swade","bennies")??0;if(null!==t){const i="gmBenny",s={name:r,encodedValue:[i,e,"spend"].join(this.delimiter),id:"gmBennySpend"},n={name:d,encodedValue:[i,e,"give"].join(this.delimiter),id:"gmBennyGive"},l=this.initializeEmptySubcategory(i);l.actions.push(s),l.actions.push(n);const c=`${this.i18n("tokenActionHud.swade.gm")} ${o}`;l.info2=t.toString(),a.info2=t.toString(),this._combineSubcategoryWithCategory(a,c,l)}}this._combineCategoryWithList(t,o,a)}_checkGiveBennies(t){return t>=get("allowGiveBennies")}_addUtilities(t,e,i){if(!1===get("showUtilityCategory"))return;let s=this.initializeEmptyCategory("utility"),a="utility",n=this.initializeEmptySubcategory();if(game.combat?.current?.tokenId===e){let t={id:"endTurn",encodedValue:[a,e,"endTurn"].join(this.delimiter),name:this.i18n("tokenActionHud.endTurn")};n.actions.push(t)}const o=this.i18n("tokenActionHud.utility"),r=this.i18n("tokenActionHud.combat");this._combineSubcategoryWithCategory(s,r,n),this._combineCategoryWithList(t,o,s)}_parseDie(t,e){let i=this._buildDieString(t);if(!e)return i;let s=this._buildDieString(e);return 0===i.toUpperCase().localeCompare(s.toUpperCase(),void 0,{sensitivity:"base"})?i:`${i}/${s}`}_buildDieString(t){if(!t)return"";let e=`d${t.sides}`;const i=parseInt(t.modifier);if(!t.modifier||0===i)return e;return e+=i>0?`+${i}`:`${i}`,e}_buildItemAction(t,e){const i=e.id,s=e.name,a=["item",t,i].join(this.delimiter),n={name:s,id:i,encodedValue:a};return n.info1=this._getItemQuantity(e),n.info2=this._getItemShots(e),n.img=e.img,n}_getItemQuantity(t){return 1!==t.system.quantity?t.system.quantity:""}_getItemShots(t){const e=t.system.currentShots,i=t.system.shots;if(!e)return;let s="";return 0==e&&0==i||(s+=e),i>0&&(s+=`/${i}`),s}_buildPowerAction(t,e){const i=e.id,s=e.name,a=["item",t,i].join(this.delimiter),n={name:s,id:i,encodedValue:a};return n.info1=this._getPowerPoints(e),n.img=e.img,n}_getPowerPoints(t){const e=t.system.pp;if("special"===e.toString().toLowerCase())return"*";const i=parseInt(e.toString());return NaN===i?"":i}}class RollHandlerBaseSwade extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a);if(this.isRenderItem()&&["item"].includes(s))return this.doRenderItem(a,n);switch(s){case"item":this._rollItem(t,o,n);break;case"status":await this._toggleStatus(t,o,n,a);break;case"benny":this._adjustBennies(t,o,n);break;case"gmBenny":await this._adjustGmBennies(t,o,n);break;case"attribute":this._rollAttribute(t,o,n);break;case"runningDie":o.rollRunningDie();break;case"skill":this._rollSkill(t,o,n);break;case"wounds":case"fatigue":case"powerPoints":await this._adjustAttributes(t,o,s,n);break;case"utility":"endTurn"===n&&game.combat?.current?.tokenId===a&&await(game.combat?.nextTurn())}}_rollItem(t,e,i){super.getItem(e,i).show()}async _toggleStatus(t,e,i,s){const a=e.effects.find((t=>t.getFlag("core","statusId")==i)),n=game.swade.util.getStatusEffectDataById(i);n["flags.core.statusId"]=i,await canvas.tokens.get(s).toggleEffect(n,{active:!a})}_adjustBennies(t,e,i){"spend"===i&&e.spendBenny(),"give"===i&&e.getBenny()}async _adjustGmBennies(t,e,i){let s=game.user;s.isGM&&(s.getFlag("swade","bennies"),"spend"===i&&game.user.spendBenny(),"give"===i&&game.user.getBenny(),Hooks.callAll("forceUpdateTokenActionHUD"))}_rollAttribute(t,e,i){e.rollAttribute(i,{event:t})}_rollSkill(t,e,i){e.rollSkill(i,{event:t})}async _adjustAttributes(t,e,i,s){const a=s.split(">"),n=a[0],o=a.length>0?a[1]:null;let r="powerPoints"===i?e.system[i][o]:e.system[i];if(!r)return;const l=r.value,c=r.max,d=r.min??0;let u;switch(n){case"increase":u=Math.clamped(l+1,d,c);break;case"decrease":u=Math.clamped(l-1,d,c)}let h={data:{}};h.data[i]="powerPoints"===i?{[o]:{value:u}}:{value:u},await e.update(h)}}class RollHandlerBR2SWSwade extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a);if(this.isRenderItem()&&["item"].includes(s))return this.doRenderItem(a,n);switch(s){case"item":this._rollItem(t,o,n,a);break;case"status":await this._toggleStatus(t,o,n,a);break;case"benny":this._adjustBennies(t,o,n);break;case"gmBenny":await this._adjustGmBennies(t,o,n);break;case"attribute":this._rollAttribute(t,o,n,a);break;case"runningDie":o.rollRunningDie();break;case"skill":this._rollSkill(t,o,n,a);break;case"wounds":case"fatigue":case"powerPoints":await this._adjustAttributes(t,o,s,n);break;case"utility":"endTurn"===n&&game.combat?.current?.tokenId===a&&await(game.combat?.nextTurn())}}_rollItem(t,e,i,s){let a;a=!0===t.ctrlKey?game.settings.get("betterrolls-swade2","ctrl_click"):!0===t.altKey?game.settings.get("betterrolls-swade2","alt_click"):!0===t.shiftKey?game.settings.get("betterrolls-swade2","shift_click"):game.settings.get("betterrolls-swade2","click"),"trait"===a?game.brsw.create_item_card_from_id(s,e.id,i).then((t=>{game.brsw.roll_item(t,$(t.data.content),!1)})):"trait_damage"===a?game.brsw.create_item_card_from_id(s,e.id,i).then((t=>{game.brsw.roll_item(t,$(t.data.content),!1,!0)})):"system"===a?game.swade.rollItemMacro(e.items.get(i).name):game.brsw.create_item_card_from_id(s,e.id,i)}async _toggleStatus(t,e,i,s){const a=e.effects.find((t=>t.getFlag("core","statusId")==i)),n=game.swade.util.getStatusEffectDataById(i);n["flags.core.statusId"]=i,await canvas.tokens.get(s).toggleEffect(n,{active:!a})}_adjustBennies(t,e,i){"spend"===i&&e.spendBenny(),"give"===i&&e.getBenny()}async _adjustGmBennies(t,e,i){let s=game.user;s.isGM&&(s.getFlag("swade","bennies"),"spend"===i&&game.user.spendBenny(),"give"===i&&game.user.getBenny(),Hooks.callAll("forceUpdateTokenActionHUD"))}_rollAttribute(t,e,i,s){let a;a=!0===t.ctrlKey?game.settings.get("betterrolls-swade2","ctrl_click"):!0===t.altKey?game.settings.get("betterrolls-swade2","alt_click"):!0===t.shiftKey?game.settings.get("betterrolls-swade2","shift_click"):game.settings.get("betterrolls-swade2","click"),"trait"===a||"trait_damage"===a?game.brsw.create_attribute_card_from_id(s,e.id,i).then((t=>{game.brsw.roll_attribute(t,$(t.data.content),!1)})):"system"===a?e.rollAttribute(i):game.brsw.create_attribute_card_from_id(s,e.id,i)}_rollSkill(t,e,i,s){let a;a=!0===t.ctrlKey?game.settings.get("betterrolls-swade2","ctrl_click"):!0===t.altKey?game.settings.get("betterrolls-swade2","alt_click"):!0===t.shiftKey?game.settings.get("betterrolls-swade2","shift_click"):game.settings.get("betterrolls-swade2","click"),"trait"===a||"trait_damage"===a?game.brsw.create_skill_card_from_id(s,e.id,i).then((t=>{game.brsw.roll_skill(t,$(t.data.content),!1)})):"system"===a?game.swade.rollItemMacro(e.items.get(i).name):game.brsw.create_skill_card_from_id(s,e.id,i)}async _adjustAttributes(t,e,i,s){const a=s.split(">"),n=a[0],o=a.length>0?a[1]:null;let r="powerPoints"===i?e.system[i][o]:e.system[i];if(!r)return;const l=r.value,c=r.max,d=r.min??0;let u;switch(n){case"increase":u=Math.clamped(l+1,d,c);break;case"decrease":u=Math.clamped(l-1,d,c)}let h={data:{}};h.data[i]="powerPoints"===i?{[o]:{value:u}}:{value:u},await e.update(h)}}class SwadeSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerSwade(t,e)}getAvailableRollHandlers(){let t={core:"Core SWADE"};return SystemManager.addHandler(t,"betterrolls-swade2"),t}doGetRollHandler(t){return"betterrolls-swade2"===t?new RollHandlerBR2SWSwade:new RollHandlerBaseSwade}doRegisterSettings(t,e){!function register$6(t,e){game.settings.register(t,"allowGiveBennies",{name:game.i18n.localize("tokenActionHud.swade.settings.allowGiveBennies.name"),hint:game.i18n.localize("tokenActionHud.swade.settings.allowGiveBennies.hint"),scope:"world",config:!0,type:String,choices:{4:game.i18n.localize("tokenActionHud.swade.settings.allowGiveBennies.choices.4"),3:game.i18n.localize("tokenActionHud.swade.settings.allowGiveBennies.choices.3"),2:game.i18n.localize("tokenActionHud.swade.settings.allowGiveBennies.choices.2"),1:game.i18n.localize("tokenActionHud.swade.settings.allowGiveBennies.choices.1")},default:1,onChange:t=>{e(t)}}),game.settings.register(t,"abbreviateAttributes",{name:game.i18n.localize("tokenActionHud.swade.settings.abbreviateAttributes.name"),hint:game.i18n.localize("tokenActionHud.swade.settings.abbreviateAttributes.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}});const i=["WoundsFatigue","Status","Bennies","Attributes","Skills","EdgesHindrances","SpecialAbilities","Powers","Gear","Utility"];for(const s of i)game.settings.register(t,`show${s}Category`,{name:game.i18n.localize(`tokenActionHud.settings.show${s}Category.name`),hint:game.i18n.localize(`tokenActionHud.settings.show${s}Category.hint`),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerStarWarsFFG extends ActionHandler{constructor(t,e){super(t,e),this.filterManager.createOrGetFilter("skills")}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;i.actorId=a.id;let n=this._getItemsList(a,s,"weapon");this._combineCategoryWithList(i,this.i18n("tokenActionHud.weapons"),n);let o=this._getItemsList(a,s,"forcepower");this._combineCategoryWithList(i,this.i18n("SWFFG.ForcePower"),o);const r=a.system;return r.skilltypes.forEach((t=>{let e=this._getSkills(t,r,s);this._combineCategoryWithList(i,t.label,e)})),game.user.isGM&&this._combineCategoryWithList(i,"utility",this._getGMList(e)),get("showHudTitle")&&(i.hudTitle=t.name),i}_getGMList(t){let e=this.initializeEmptyCategory("utility"),i=this.initializeEmptySubcategory();return i.actions=[{name:"Destiny Pool Init",encodedValue:"gm|destiny|destiny",id:"gm_destiny"}],this._combineSubcategoryWithCategory(e,"GM",i),e}_getItemsList(t,e,i){let s=this.initializeEmptyCategory(i),a=this.initializeEmptySubcategory(),n=t.items.filter((t=>t.type===i));return a.actions=this._produceItemMap(e,n,i),this._combineSubcategoryWithCategory(s,"",a),s}_getSkills(t,e,i){let s=this.initializeEmptyCategory("skills");const a=Object.keys(e.skills).filter((i=>e.skills[i].type===t.type)).sort(((t,e)=>{let i=0;return t.toLowerCase()>e.toLowerCase()?i=1:t.toLowerCase()<e.toLowerCase()&&(i=-1),i}));Logger.debug(a);let n=this.initializeEmptySubcategory();return n.actions=this._produceSkillMap(i,e,a,"skill"),this._combineSubcategoryWithCategory(s,"",n),s}_produceItemMap(t,e,i){return e.map((e=>{let s=[i,t,e.id].join(this.delimiter);return{name:e.name,encodedValue:s,id:e.id}}))}_produceSkillMap(t,e,i,s){return i.map((i=>{let a=[s,t,i].join(this.delimiter);return{name:e.skills[i].label,encodedValue:a,id:i}}))}}class RollHandlerBaseStarWarsFFG extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a);switch(s){case"gm":if("destiny"===n)return this._rollDestiny();case"weapon":return game.ffg.DiceHelpers.rollItem(n,o.id);case"skill":return this._rollSkill(o,n,t);case"forcepower":return this._rollForcePower(o,n)}}_rollForcePower(t,e){let i=t.items.get(e);i||(i=game.items.get(e)),i||(i=ImportHelpers.findCompendiumEntityById("Item",e));const s=t.system.stats.forcePool.max-t.system.stats.forcePool.value;if(s>0){let e=t.sheet.getData();const a=new DicePoolFFG({force:s});game.ffg.DiceHelpers.displayRollDialog(e,a,`${game.i18n.localize("SWFFG.Rolling")} ${i.name}`,i.name,i)}}_rollDestiny(){game.settings.set("starwarsffg","dPoolLight",0),game.settings.set("starwarsffg","dPoolDark",0);const t=`<button class="ffg-destiny-roll">${game.i18n.localize("SWFFG.DestinyPoolRoll")}</button>`;new Map([...game.settings.settings].filter((([t,e])=>e.key.includes("destinyrollers")))).forEach((t=>{game.settings.set(t.module,t.key,void 0)})),CONFIG.FFG.DestinyGM=game.user.id,ChatMessage.create({user:game.user.id,content:t})}_rollSkill(t,e,i){let s=2;i.ctrlKey&&!i.shiftKey?s=3:!i.ctrlKey&&i.shiftKey&&(s=1);const a=t.system.skills[e],n=t.system.characteristics[a.characteristic];game.ffg.DiceHelpers.rollSkillDirect(a,n,s,t)}}class StarWarsFFGSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerStarWarsFFG(t,e)}getAvailableRollHandlers(){return{core:"Core starwarsffg"}}doGetRollHandler(t){return new RollHandlerBaseStarWarsFFG}doRegisterSettings(t,e){}}class ActionHandlerT20 extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(i),i;if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;i.actorId=a.id;let n=this._getItemList(a,s),o=this._getSpellsList(a,s),r=this._getFeatsList(a,s),l=this._getAbilityList(a,s),c=this._getSkillsList(a.system.pericias,s),d=this._getConditionsList(a,s),u=this.i18n("tokenActionHud.inventory"),h=this.i18n("tokenActionHud.spells"),g=this.i18n("tokenActionHud.features"),m=this.i18n("tokenActionHud.abilities"),y=this.i18n("tokenActionHud.skills"),p=this.i18n("tokenActionHud.conditions");return this._combineCategoryWithList(i,u,n),this._combineCategoryWithList(i,h,o),this._combineCategoryWithList(i,g,r),this._combineCategoryWithList(i,m,l),this._combineCategoryWithList(i,y,c),this._combineCategoryWithList(i,p,d),get("showHudTitle")&&(i.hudTitle=t.name),i}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["npc","character"];canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.type)));const i=t.tokenId;this._addMultiSkills(t,i);let s=this.i18n("tokenActionHud.abilities");this._addMultiAbilities(t,i,"atributos",s,"atributo")}_getItemList(t,e){let i,s=this._filterLongerActions(t.items.filter((t=>t.system.qtd>0))),a=this._sortByItemSort(s),n="item";i=a.filter((t=>"consumivel"!==t.type));let o=this._getActiveEquipment(i),r=o.filter((t=>"arma"==t.type)).map((i=>this._buildEquipmentItem(e,t,n,i))),l=this.initializeEmptySubcategory();l.actions=r;let c=o.filter((t=>"equip"==t.type)).map((i=>this._buildEquipmentItem(e,t,n,i))),d=this.initializeEmptySubcategory();d.actions=c;let u=o.filter((t=>"arma"!=t.type&&"equip"!=t.type)).map((i=>this._buildEquipmentItem(e,t,n,i))),h=this.initializeEmptySubcategory();h.actions=u;let g=this._getActiveEquipment(a.filter((t=>"consumivel"==t.type))),m=this._filterExpendedItems(g).map((i=>this._buildEquipmentItem(e,t,n,i))),y=this.initializeEmptySubcategory();y.actions=m;let p=s.filter((t=>"tool"===t.type)).map((i=>this._buildEquipmentItem(e,t,n,i))),b=this.initializeEmptySubcategory();b.actions=p;let f=this.i18n("tokenActionHud.weapons"),k=this.i18n("tokenActionHud.equipment"),_=this.i18n("tokenActionHud.other"),C=this.i18n("tokenActionHud.consumables"),A=this.i18n("tokenActionHud.tools"),S=this.initializeEmptyCategory("inventory");return this._combineSubcategoryWithCategory(S,f,l),this._combineSubcategoryWithCategory(S,k,d),this._combineSubcategoryWithCategory(S,_,h),this._combineSubcategoryWithCategory(S,C,y),this._combineSubcategoryWithCategory(S,A,b),S}_getActiveEquipment(t){const e=Object.keys(game.tormenta20.config.listaAtivacao|{}).filter((t=>"none"!==t)),i=["poder","magia","consumivel"];return t.filter((t=>{if(!i.includes(t.type))return!0;return!!t.system.ativacao&&e.includes(t.system.ativacao.execucao)}))}_getSpellsList(t,e){let i=this._filterLongerActions(t.items.filter((t=>"magia"===t.type)));i=this._filterExpendedItems(i);let s=this._sortSpellsByLevel(i);return this._categoriseSpells(t,e,s)}_sortSpellsByLevel(t){let e=Object.values(t);return e.sort(((t,e)=>t.system.circulo===e.system.circulo?t.name.toUpperCase().localeCompare(e.name.toUpperCase(),void 0,{sensitivity:"base"}):t.system.circulo-e.system.circulo)),e}_categoriseSpells(t,e,i){const s=this.initializeEmptySubcategory(),a=this.initializeEmptySubcategory();i.reduce(function(i,s){let n=s.system.preparada;var o,r=s.system.circulo;n||(o=`${this.i18n("tokenActionHud.level")} ${r}`);let l=this._buildItem(e,t,"magia",s),c=a.subcategories.find((t=>t.name===o));return c||(c=this.initializeEmptySubcategory()),c.actions.push(l),a.subcategories.indexOf(c)<0&&this._combineSubcategoryWithCategory(a,o,c),i}.bind(this),{});let n=this.initializeEmptyCategory("magias"),o=this.i18n("tokenActionHud.powers"),r=this.i18n("tokenActionHud.books");return this._combineSubcategoryWithCategory(n,o,s),this._combineSubcategoryWithCategory(n,r,a),n}_addSpellInfo(t,e){let i=t.system.duracao;e.info1="",e.info2="",e.info3="","sust"===i?.unidade&&(e.info1+="S")}_getFeatsList(t,e){let i=this._filterLongerActions(t.items.filter((t=>"poder"==t.type))),s=this._sortByItemSort(i);return this._categoriseFeats(e,t,s)}_categoriseFeats(t,e,i){let s=this.initializeEmptySubcategory(),a=this.initializeEmptySubcategory();this.initializeEmptySubcategory(),this.initializeEmptySubcategory(),i.reduce(function(i,n){const o=n.system.ativacao.execucao;let r=this._buildEquipmentItem(t,e,"poder",n);o&&""!==o&&"Livre"!==o?s.actions.push(r):a.actions.push(r)}.bind(this),{});let n=this.initializeEmptyCategory("poderes"),o=this.i18n("tokenActionHud.active");this._combineSubcategoryWithCategory(n,o,s);let r=this.i18n("tokenActionHud.passive");return this._combineSubcategoryWithCategory(n,r,a),n}_getSkillsList(t,e){let i=this.initializeEmptyCategory("pericia"),s="pericia",a=Object.entries(t).filter((t=>Object.keys(game.tormenta20.config.pericias).includes(t[0]))).map((i=>{try{let a=i[0],n=game.tormenta20.config.pericias[a]??i[1].label??i[1].name;n=n.charAt(0).toUpperCase()+n.slice(1);let o=[s,e,i[0]].join(this.delimiter),r=this._getProficiencyIcon(t[a].treinado);return{name:n,id:i[0],encodedValue:o,icon:r}}catch(t){return Logger.error(i),null}})).filter((t=>!!t)),n=this.initializeEmptySubcategory();n.actions=a;let o=this.i18n("tokenActionHud.skills");return this._combineSubcategoryWithCategory(i,o,n),i}_addMultiSkills(t,e){let i=this.initializeEmptyCategory("pericia"),s="pericia",a=Object.entries(game.tormenta20.config.pericias).map((t=>{let i=t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let a=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:a}})),n=this.initializeEmptySubcategory();n.actions=a;let o=this.i18n("tokenActionHud.skills");this._combineSubcategoryWithCategory(i,o,n),this._combineCategoryWithList(t,o,i,!0)}_getAbilityList(t,e){const i="atributo";let s=this.initializeEmptyCategory("atributos"),a=this.initializeEmptySubcategory();const n=this.i18n("tokenActionHud.abilities"),o=t.system.atributos;let r=Object.entries(game.tormenta20.config.atributos).map((t=>{if(0===o[t[0]].value)return;let s=t[1];s=s.charAt(0).toUpperCase()+s.slice(1);let a=[i,e,t[0]].join(this.delimiter);return{name:s,id:t[0],encodedValue:a,icon:""}}));return a.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(s,n,a),s}_addMultiAbilities(t,e,i,s,a){let n=this.initializeEmptyCategory(i),o=Object.entries(game.tormenta20.config.atributos).map((t=>{let i=t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let s=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:s}})),r=this.initializeEmptySubcategory();r.actions=o,this._combineSubcategoryWithCategory(n,s,r),this._combineCategoryWithList(t,s,n,!0)}_getEffectsList(t,e){let i=this.initializeEmptyCategory("effects");return this._addEffectsSubcategories(t,e,i),i}_getConditionsList(t,e){let i=this.initializeEmptyCategory("conditions");return this._addConditionsSubcategory(t,e,i),i}_addEffectsSubcategories(t,e,i){const s="effect",a=t.effects.entries;let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();a.forEach((t=>{const i=t.system.label,a=[s,e,t.id].join(this.delimiter),r=t.system.disabled?"":"active",l=t.system.icon;let c={name:i,id:t.id,encodedValue:a,img:l,cssClass:r};t.isTemporary?n.actions.push(c):o.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.temporary"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.passive"),o)}_addMultiConditions(t,e){const i=this.initializeEmptyCategory("conditions"),s="condition",a=CONFIG.statusEffects.filter((t=>""!==t.id)),n=canvas.tokens.controlled.filter((t=>!!t.actor)).map((t=>t.actor));if(!a)return;let o=this.initializeEmptySubcategory();a.forEach((t=>{const i=this.i18n(t.label),a=[s,e,t.id].join(this.delimiter),r=n.every((e=>e.effects.entries.some((e=>e.flags.core?.statusId===t.id))))?"active":"",l=t.icon,c={name:i,id:t.id,encodedValue:a,img:l,cssClass:r};o.actions.push(c)}));const r=this.i18n("tokenActionHud.conditions");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i)}_addConditionsSubcategory(t,e,i){const s="condition",a=CONFIG.statusEffects.filter((t=>""!==t.id));if(!a)return;let n=this.initializeEmptySubcategory();a.forEach((i=>{const a=this.i18n(i.label),o=[s,e,i.id].join(this.delimiter),r=t.effects.some((t=>t.flags.core?.statusId===i.id))?"active":"",l=i.icon,c={name:a,id:i.id,encodedValue:o,img:l,cssClass:r};n.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.conditions"),n)}_addCombatSubcategory(t,e,i){let s=this.initializeEmptySubcategory();const a=game.combat;let n,o;a&&(n=a.combatants.find((t=>t.tokenId===i)),o=n?.initiative);let r={id:"rollInitiative",encodedValue:[t,i,"initiative"].join(this.delimiter),name:this.i18n("tokenActionHud.rollInitiative")};if(o&&(r.info1=o),r.cssClass=o?"active":"",s.actions.push(r),game.combat?.current?.tokenId===i){let e={id:"endTurn",encodedValue:[t,i,"endTurn"].join(this.delimiter),name:this.i18n("tokenActionHud.endTurn")};s.actions.push(e)}this._combineSubcategoryWithCategory(e,this.i18n("tokenActionHud.combat"),s)}_addMultiCombatSubcategory(t,e,i){let s=this.initializeEmptySubcategory();const a=game.combat;let n,o={id:"rollInitiative",encodedValue:[t,e,"initiative"].join(this.delimiter),name:this.i18n("tokenActionHud.rollInitiative")};if(a){n=canvas.tokens.controlled.map((t=>t.id)).map((t=>a.combatants.find((e=>e.tokenId===t)))).every((t=>!!t?.initiative))}o.cssClass=n?"active":"",s.actions.push(o),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.combat"),s)}_buildEquipmentItem(t,e,i,s){let a=this._buildItem(t,e,i,s);return this._addItemInfo(e,s,a),a}_buildItem(t,e,i,s){let a=[i,t,s.id].join(this.delimiter),n=this._getImage(s),o=this._getActionIcon(s.system?.ativacao?.execucao);return{name:s.name,id:s.id,encodedValue:a,img:n,icon:o}}_addItemInfo(t,e,i){i.info1=this._getQuantityData(e),i.info2="",i.info3=""}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getQuantityData(t){let e="",i=t.system.qtd;return i>1&&(e=i),e}_filterLongerActions(t){return t}_filterNonpreparedSpells(t){return t.filter((t=>t.system.preparada))}_filterExpendedItems(t){return t.filter((t=>{let e=t.system.uses;return!e||!(e.max>0&&!e.value)}))}_sortByItemSort(t){let e=Object.values(t);return e.sort(((t,e)=>t.sort-e.sort)),e}_getProficiencyIcon(t){return{0:"",1:'<i class="fas fa-check"></i>'}[t]}_getActionIcon(t){return{movimento:'<i class="fas fa-plus"></i>',reacao:'<i class="fas fa-bolt"></i>',livre:'<i class="far fa-circle"></i>',completa:'<i class="fas fa-star"></i>',duasRodadas:'<i class="fas fa-hourglass-start"></i>',verTexto:'<i class="fas fa-book"></i>'}[t]}}class RollHandlerBaseT20 extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2];if("multi"===a)for(let e of canvas.tokens.controlled){let i=e.id;await this._handleMacros(t,s,i,n)}else await this._handleMacros(t,s,a,n)}async _handleMacros(t,e,i,s){switch(e){case"atributo":this.rollAbilityMacro(t,i,s);break;case"pericia":this.rollSkillMacro(t,i,s);break;case"item":case"magia":case"poder":this.isRenderItem()?this.doRenderItem(i,s):this.rollItemMacro(t,i,s);break;case"condition":await this.toggleCondition(t,i,s)}}rollAbilityMacro(t,e,i){super.getActor(e).rollAtributo(i)}rollSkillMacro(t,e,i){super.getActor(e).rollPericia(i)}rollItemMacro(t,e,i){let s=super.getActor(e);return super.getItem(s,i).roll()}async performInitiativeMacro(t){let e=super.getActor(t);await e.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHUD")}async toggleEffect(t,e,i){const s=super.getActor(e).effects.entries.find((t=>t.id===i));if(!s)return;const a=s.flags.core?.statusId;a?await this.toggleCondition(t,e,a):(await s.update({disabled:!s.disabled}),Hooks.callAll("forceUpdateTokenActionHUD"))}async toggleCondition(t,e,i){const s=super.getToken(e),a=this.isRightClick(t),n=this.findCondition(i);n&&(a?await s.toggleEffect(n,{overlay:!0}):await s.toggleEffect(n),Hooks.callAll("forceUpdateTokenActionHUD"))}findCondition(t){return CONFIG.statusEffects.find((e=>e.id===t))}}class Tormenta20SystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerT20(t,e)}getAvailableRollHandlers(){return{core:"Tormenta20"}}doGetRollHandler(t){let e;return e=new RollHandlerBaseT20,e}doRegisterSettings(t,e){}}class ActionHandlerSymbaroum extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;i.actorId=a.id,a.type;let n=this._getMysticalPowers(a,s),o=this._getTraits(a,s),r=this._getWeapons(a,s),l=this._getArmors(a,s),c=this._getAbilities(a,s),d=this._getAttributes(a,s);return this._combineCategoryWithList(i,this.i18n("tokenActionHud.symbaroum.mysticalPowers"),n),this._combineCategoryWithList(i,this.i18n("tokenActionHud.traits"),o),game.settings.get("symbaroum","combatAutomation")||this._combineCategoryWithList(i,this.i18n("tokenActionHud.armour"),l),this._combineCategoryWithList(i,this.i18n("tokenActionHud.weapons"),r),this._combineCategoryWithList(i,this.i18n("tokenActionHud.symbaroum.abilities"),c),this._combineCategoryWithList(i,this.i18n("tokenActionHud.attributes"),d),get("showHudTitle")&&(i.hudTitle=t.name),i}_getMysticalPowers(t,e){let i=t.items.filter((t=>"mysticalPower"===t.type&&t.system?.hasScript)),s=this.initializeEmptyCategory("actorPowers"),a=this.initializeEmptySubcategory();return a.actions=this._produceMap(e,i,"mysticalPower"),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.roll"),a),s}_getTraits(t,e){let i=t.items.filter((t=>"trait"===t.type&&t.system?.hasScript)),s=this.initializeEmptyCategory("actorsTraits"),a=this.initializeEmptySubcategory();return a.actions=this._produceMap(e,i,"trait"),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.roll"),a),s}_getWeapons(t,e){let i=t.items.filter((t=>"weapon"===t.type&&"active"===t.system?.state)),s=this.initializeEmptyCategory("actorWeapons"),a=this.initializeEmptySubcategory();return a.actions=this._produceMap(e,i,"weapon"),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.roll"),a),s}_getArmors(t,e){let i=this.initializeEmptyCategory("actorArmors"),s=this.initializeEmptySubcategory();const a=t.system.combat.id;let n=[];return n.push(t.items.get(a)),s.actions=this._produceMap(e,n,"armor"),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.roll"),s),i}_getAbilities(t,e){let i=t.items.filter((t=>"ability"===t.data?.type&&t.system?.script)),s=this.initializeEmptyCategory("actorAbilities"),a=this.initializeEmptySubcategory();return a.actions=this._produceMap(e,i,"ability"),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.roll"),a),s}_getAttributes(t,e){let i=this.initializeEmptyCategory("attributes"),s=Object.entries(t.system.attributes),a=this.initializeEmptySubcategory();return a.actions=s.map((t=>{let i=["attribute",e,t[0]].join(this.delimiter);return{name:game.i18n.localize(t[1].label),encodedValue:i,id:t[0]}})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.attributes"),a),i}_produceMap(t,e,i){return e.map((e=>{let s=[i,t,e.id].join(this.delimiter),a=this._getImage(e);return{name:e.name,encodedValue:s,id:e.id,img:a}}))}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("systems/symbaroum/asset/image/trait.png")?"":e}}class RollHandlerBaseSymbaroum extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a);switch(s){case"weapon":this._handleWeapon(s,t,o,n);break;case"armor":this._handleArmor(s,t,o,n);break;case"ability":this._handleAbility(s,t,o,n);break;case"mysticalPower":this._handleMysticalPowers(s,t,o,n);break;case"trait":this._handleTraits(s,t,o,n);break;case"attribute":this._handleAttributes(s,t,o,n)}}_handleWeapon(t,e,i,s){let a=i.system.weapons.filter((t=>t.id===s));i.rollWeapon(a[0])}_handleArmor(t,e,i,s){i.rollArmor()}_handleAbility(t,e,i,s){let a=i.items.filter((t=>t.id===s));i.usePower(a[0])}_handleMysticalPowers(t,e,i,s){let a=i.items.filter((t=>t.id===s));i.usePower(a[0])}_handleTraits(t,e,i,s){let a=i.items.filter((t=>t.id===s));i.usePower(a[0])}_handleAttributes(t,e,i,s){i.rollAttribute(s)}}class SymbaroumSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return console.log("startup"),new ActionHandlerSymbaroum(t,e)}getAvailableRollHandlers(){return{core:"Core Symbaroum"}}doGetRollHandler(t){return new RollHandlerBaseSymbaroum}doRegisterSettings(t,e){}}class ActionHandlerAlienrpg extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i={},s={},a={},n={},o={},r={},l={},c={},d={},u={},h={},g=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(g),g;if(!t)return g;let m=t.id;g.tokenId=m;let y=t.actor;if(!y)return g;let p=y.type;if(!["character","synthetic","creature"].includes(p))return g;switch(g.actorId=y.id,"character"===p||"synthetic"===p?(i=this._getAttributes(y,m),s=this._getSkills(y,m),a=this._getWeaponsList(y,m),n=this._getItemsList(y,m),o=this._getTalentsList(y,m),r=this._getAgendaList(y,m),l=this._getConsumablesList(y,m),c=this._getPowerList(y,m),d=this._getConditionsList(y,m),u=this._getUtilityList(y,m)):(i=this._getCreatureAttributes(y,m),h=this._getAttackList(y,m),u=this._getUtilityList(y,m)),y.type){case"character":this._combineCategoryWithList(g,this.i18n("tokenActionHud.attributes"),i),this._combineCategoryWithList(g,this.i18n("tokenActionHud.skills"),s),this._combineCategoryWithList(g,this.i18n("tokenActionHud.weapons"),a),this._combineCategoryWithList(g,this.i18n("tokenActionHud.inventory"),n),this._combineCategoryWithList(g,this.i18n("tokenActionHud.talents"),o),this._combineCategoryWithList(g,this.i18n("tokenActionHud.alienRpg.agenda"),r),this._combineCategoryWithList(g,this.i18n("tokenActionHud.alienRpg.consumables"),l),this._combineCategoryWithList(g,this.i18n("tokenActionHud.alienRpg.power"),c),this._combineCategoryWithList(g,this.i18n("tokenActionHud.alienRpg.conditions"),d),this._combineCategoryWithList(g,this.i18n("tokenActionHud.utility"),u),this._setFilterSuggestions(y),get("showHudTitle")&&(g.hudTitle=t.name);break;case"synthetic":this._combineCategoryWithList(g,this.i18n("tokenActionHud.attributes"),i),this._combineCategoryWithList(g,this.i18n("tokenActionHud.skills"),s),this._combineCategoryWithList(g,this.i18n("tokenActionHud.weapons"),a),this._combineCategoryWithList(g,this.i18n("tokenActionHud.inventory"),n),this._combineCategoryWithList(g,this.i18n("tokenActionHud.talents"),o),this._combineCategoryWithList(g,this.i18n("tokenActionHud.alienRpg.agenda"),r),this._combineCategoryWithList(g,this.i18n("tokenActionHud.alienRpg.power"),c),this._combineCategoryWithList(g,this.i18n("tokenActionHud.utility"),u),this._setFilterSuggestions(y),get("showHudTitle")&&(g.hudTitle=t.name);break;case"creature":this._combineCategoryWithList(g,this.i18n("tokenActionHud.attributes"),i),this._combineCategoryWithList(g,this.i18n("tokenActionHud.attack"),h),this._combineCategoryWithList(g,this.i18n("tokenActionHud.utility"),u),this._setFilterSuggestions(y),get("showHudTitle")&&(g.hudTitle=t.name)}return g}_getWeaponsList(t,e){let i="weapon",s=this.initializeEmptyCategory("items"),a=this.initializeEmptySubcategory();return a.actions=this._produceMap(e,t.items.filter((t=>t.type==i)),i),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.weapons"),a),s}_getItemsList(t,e){let i=this.initializeEmptyCategory("items"),s=["item","armor"],a=(t.items??[]).filter((t=>s.includes(t.type))).sort(this._foundrySort),n=a.filter((t=>"armor"===t.type)),o=this._buildItemActions(e,"armor",n),r=this.initializeEmptySubcategory();r.actions=o;let l=a.filter((t=>"item"===t.type)),c=this._buildItemActions(e,"item",l),d=this.initializeEmptySubcategory();return d.actions=c,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.armour"),r),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.equipment"),d),i}_getTalentsList(t,e){let i=this.initializeEmptyCategory("items"),s=["talent"],a=(t.items??[]).filter((t=>s.includes(t.type))).sort(this._foundrySort).filter((t=>"talent"===t.type)),n=this._buildItemActions(e,"item",a),o=this.initializeEmptySubcategory();return o.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.talents"),o),i}_getAgendaList(t,e){let i=this.initializeEmptyCategory("items"),s=["agenda"],a=(t.items??[]).filter((t=>s.includes(t.type))).sort(this._foundrySort).filter((t=>"agenda"===t.type)),n=this._buildItemActions(e,"item",a),o=this.initializeEmptySubcategory();return o.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.alienRpg.agenda"),o),i}_getConsumablesList(t,e){let i=this.initializeEmptyCategory("consumables"),s=this.initializeEmptySubcategory();this.initializeEmptySubcategory();let a="consumables",n=Object.entries(t.system.consumables);n.splice(1,1);let o=n.map((t=>{let i=this.i18n("tokenActionHud.alienRpg."+t[0]),s=t[0],n=[a,e,s,i].join(this.delimiter);return{name:i,encodedValue:n,id:s}}));return s.actions=this._produceMap(e,o,a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.alienRpg.consumables"),s),i}_getPowerList(t,e){let i=this.initializeEmptyCategory("power");this.initializeEmptySubcategory();let s=this.initializeEmptySubcategory(),a="power",n=["item"],o=(t.items??[]).filter((t=>n.includes(t.type))).sort(this._foundrySort).filter((t=>t.system.totalPower>0)).map((t=>{let i=t.name,s=t._id,n=[a,e,i,s].join(this.delimiter);return{name:i,encodedValue:n,id:s}}));return s.actions=this._produceMap(e,o,a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.alienRpg.power"),s),i}_buildItemActions(t,e,i,s=!1){let a=this._produceMap(t,i,e,s);return a.forEach((t=>this._addItemInfo(i.find((e=>e.id===t.id)),t))),a}_addItemInfo(t,e){e.info1=this._getQuantityData(t)}_getQuantityData(t){let e="",i=t.system.quantity?.value;return i>1&&(e=i),e}_getAttributes(t,e){let i=this.initializeEmptyCategory("attributes"),s=this.initializeEmptySubcategory(),a="attribute",n=Object.entries(t.system.attributes).map((t=>{let i=this.i18n("tokenActionHud.alienRpg."+t[0]),s=t[0];return{name:i,encodedValue:[a,e,s].join(this.delimiter),id:s}}));return s.actions=this._produceMap(e,n,a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.attributes"),s),i}_getCreatureAttributes(t,e){let i=this.initializeEmptyCategory("attributes"),s=this.initializeEmptySubcategory(),a=this.initializeEmptySubcategory(),n="creatureattribute",o=Object.entries(t.system.attributes).map((t=>{let i=this.i18n("tokenActionHud.alienRpg."+t[0]),s=t[0];return{name:i,encodedValue:[n,e,s].join(this.delimiter),id:s}})),r=Object.entries(t.system.general);r.splice(2,3);let l=r.map((t=>{let i=this.i18n("tokenActionHud.alienRpg."+t[0]),s=t[0];return{name:i,encodedValue:[n,e,s].join(this.delimiter),id:s}}));return s.actions=this._produceMap(e,o,n),a.actions=this._produceMap(e,l,n),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.attributes"),s),this._combineSubcategoryWithCategory(i,"",a),i}_getSkills(t,e){let i=this.initializeEmptyCategory("skills"),s=this.initializeEmptySubcategory(),a="skill",n=Object.entries(t.system.skills).map((t=>{let i=this.i18n("tokenActionHud.alienRpg."+t[0]),s=t[0];return{name:i,encodedValue:[a,e,s].join(this.delimiter),id:s}}));return s.actions=this._produceMap(e,n,a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.skills"),s),i}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["monster","character"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.type)));this._addMultiUtilities(t,t.tokenId,i)}_getAttackList(t,e){let i=this.initializeEmptyCategory("attack"),s=this.initializeEmptySubcategory();if("creature"===t.type){let t=this.initializeEmptySubcategory(),s=[],a=["creatureAttack",e,"creatureAttack",""].join(this.delimiter);s={id:"creatureAttack",name:this.i18n("tokenActionHud.alienRpg.creatureAttack"),encodedValue:a},t.actions.push(s);let n=[],o=["acidSplash",e,"acidSplash",""].join(this.delimiter);n={id:"acidSplash",name:this.i18n("tokenActionHud.alienRpg.acidSplash"),encodedValue:o},t.actions.push(n),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.alienRpg.acidSplash"),t)}return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.attack"),s),i}_getUtilityList(t,e){let i=this.initializeEmptyCategory("utility"),s=this.initializeEmptySubcategory(),a=this.initializeEmptySubcategory(),n=[],o=0;switch(t.type){case"character":o=t.system.header?.health,o&&n.push(this._getHeaderActions(e,"health",this.i18n("tokenActionHud.alienRpg.health"),o.value,"10")),a.actions=n;let s=t.system.header?.stress;s&&n.push(this._getHeaderActions(e,"stress",this.i18n("tokenActionHud.alienRpg.stresspoints"),s.value,"10")),a.actions=n;let r=[],l=["rollStress",e,"rollStress",""].join(this.delimiter);r={id:"rollStress",name:this.i18n("tokenActionHud.alienRpg.rollStress"),encodedValue:l},a.actions.push(r);let c=[],d=["rollCrit",e,"rollCrit",""].join(this.delimiter);c={id:"rollCrit",name:this.i18n("tokenActionHud.alienRpg.rollCrit"),encodedValue:d},a.actions.push(c),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.alienRpg.health"),a);break;case"creature":o=t.system.header?.health,o&&n.push(this._getHeaderActions(e,"health",this.i18n("tokenActionHud.alienRpg.health"),o.value,"10")),a.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.alienRpg.health"),a);break;case"synthetic":o=t.system.header?.health,o&&n.push(this._getHeaderActions(e,"health",this.i18n("tokenActionHud.alienRpg.health"),o.value,"10")),a.actions=n;let u=[],h=["rollCrit",e,"rollCrit",""].join(this.delimiter);if(u={id:"rollCrit",name:this.i18n("tokenActionHud.alienRpg.rollCrit"),encodedValue:h},a.actions.push(u),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.alienRpg.health"),a),t.system.header.synthstress){let t=[],i=["rollStress",e,"rollStress",0].join(this.delimiter);t={id:"rollStress",name:this.i18n("tokenActionHud.alienRpg.rollStress"),encodedValue:i},a.actions.push(t)}}return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.utility"),s),i}_getConditionsList(t,e){let i=this.initializeEmptyCategory("conditions"),s=this.initializeEmptySubcategory(),a="conditions";if("character"===t.type){let s=this.initializeEmptySubcategory(),n=[];n={id:"toggleStarving",encodedValue:[a,e,"toggleStarving",""].join(this.delimiter),name:this.i18n("tokenActionHud.alienRpg.starving")},n.cssClass=t.system.general.starving.value?"active":"",s.actions.push(n),n={id:"toggleDehydrated",encodedValue:[a,e,"toggleDehydrated",""].join(this.delimiter),name:this.i18n("tokenActionHud.alienRpg.dehydrated")},n.cssClass=t.system.general.dehydrated.value?"active":"",s.actions.push(n),n={id:"toggleExhausted",encodedValue:[a,e,"toggleExhausted",""].join(this.delimiter),name:this.i18n("tokenActionHud.alienRpg.exhausted")},n.cssClass=t.system.general.exhausted.value?"active":"",s.actions.push(n),n={id:"toggleFreezing",encodedValue:[a,e,"toggleFreezing",""].join(this.delimiter),name:this.i18n("tokenActionHud.alienRpg.freezing")},n.cssClass=t.system.general.freezing.value?"active":"",s.actions.push(n),n={id:"togglePanic",encodedValue:[a,e,"togglePanic",""].join(this.delimiter),name:this.i18n("tokenActionHud.alienRpg.panic")},n.cssClass=t.system.general.panic.value?"active":"",s.actions.push(n),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.alienRpg.conditions"),s)}return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.utility"),s),i}_getHeaderActions(t,e,i,s,a){let n=i.slugify({replacement:"_",strict:!0}),o={name:i,encodedValue:[e,t,n,s].join(this.delimiter),id:n};return o.info1=`${s}/${a}`,o}_addMultiUtilities(t,e,i){let s=this.initializeEmptyCategory("utility"),a=this.initializeEmptySubcategory();this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.utility"),a),this._combineCategoryWithList(t,this.i18n("tokenActionHud.utility"),s)}_setFilterSuggestions(t,e){let i=e?.map((t=>({id:t._id,value:t.name})));i?.length>0&&this.filterManager.setSuggestions(t,i)}_filterElements(t,e){let i=this.filterManager.getFilteredNames(t),s=e.filter((t=>!!t));return i.length>0&&(s=this.filterManager.isBlocklist(t)?e.filter((t=>!i.includes(t.name))):e.filter((t=>i.includes(t.name)))),s}_produceMap(t,e,i){return e.map((e=>{let s=[i,t,e.id,e.name.toLowerCase()].join(this.delimiter),a=this._getImage(e),n={name:e.name,encodedValue:s,id:e.id,img:a};return"talent"===i&&(n.info2=this._getUsesData(e)),n}))}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getUsesData(t){let e="",i=t.system.uses;return i&&(i.max||i.value)?(e=i.value??0,i.max>0&&(e+=`/${i.max}`),e):e}_foundrySort(t,e){return t?.sort||e?.sort?t.sort-e.sort:0}}class RollHandlerBaseAlienrpg extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");4!=i.length&&super.throwInvalidValueErr();let s,a=i[0],n=i[1],o=i[2],r=i[3],l=super.getActor(n);l&&(s=l.type);let c=o?l.items.get(o):null;if(["item","armor"].includes(a)&&this.isRenderItem())return this.doRenderItem(n,o);if("multi"===n)"utility"===a&&o.includes("toggle")?this.performMultiToggleUtilityMacro(o):canvas.tokens.controlled.forEach((e=>{let i=e.id;this._handleMacros(t,a,i,o,r)}));else{if(!["utility"].includes(a))switch(s){case"character":case"creature":case"synthetic":await this._handleUniqueActionsChar(a,t,n,l,o)}let e=[];switch(a){case"attribute":e={roll:l.system.attributes[o].value,label:l.system.attributes[o].label},"click"===t.type?l.rollAbility(l,e):l.rollAbilityMod(l,e);break;case"creatureattribute":switch(o){case"mobility":case"observation":e={roll:l.system.general[o].value,label:l.system.general[o].label};break;default:let t=r[0].toUpperCase()+r.substring(1);e={roll:l.system.attributes[o].value,label:[t]}}"click"===t.type?l.rollAbility(l,e):l.rollAbilityMod(l,e);break;case"skill":e={roll:l.system.skills[o].mod,label:l.system.skills[o].label},"click"===t.type?l.rollAbility(l,e):l.rollAbilityMod(l,e);break;case"weapon":"click"===t.type?l.nowRollItem(c):l.rollItemMod(c);break;case"item":this._rollItem(l,n,o,a);break;case"armor":e={roll:l.system.general.armor.value,spbutt:"armor"},l.rollAbility(l,e);break;case"consumables":const i="ALIENRPG."+(r[0].toUpperCase()+r.substring(1)),s=game.i18n.localize(i)+" "+game.i18n.localize("ALIENRPG.Supply");l.consumablesCheck(l,o,s);break;case"power":const d="ALIENRPG."+(a[0].toUpperCase()+a.substring(1)),u=game.i18n.localize(d)+" "+game.i18n.localize("ALIENRPG.Supply");l.consumablesCheck(l,a,u,o);break;case"conditions":this.performConditionMacro(t,n,o);break;case"utility":this.performUtilityMacro(t,n,o)}}}async _handleUniqueActionsChar(t,e,i,s,a){let n=0;switch(t){case"stress":await this._adjustAttribute(e,s,"stress","value",a);break;case"rollStress":n="character"===s.type?{panicroll:s.system.header.stress}:{panicroll:{value:0,label:"Stress"}},"click"===e.type?s.rollAbility(s,n):s.rollAbilityMod(s,n);break;case"health":await this._adjustAttribute(e,s,"health","value",a);break;case"creatureAttack":let t={atttype:s.system.rTables};s.creatureAttackRoll(s,t);break;case"acidSplash":let i={roll:s.system.general.acidSplash.value,label:s.system.general.acidSplash.label};s.creatureAcidRoll(s,i);break;case"rollCrit":s.rollCrit(s.type)}}async _adjustAttribute(t,e,i,s,a){let n=e.system.header[i][s];if(this.rightClick){if(n<=0)return;n--}else{if(n>="10")return;n++}let o={data:{header:{[i]:{[s]:n}}}};await e.update(o)}async toggleConditionState(t,e,i,s,a){let n=e.system.general[i][s];if(this.rightClick){if(n<=0)return;n--,"panic"===i&&e.checkAndEndPanic(e)}else{if(n>="1")return;n++,"panic"===i&&e.checkAndEndPanic(e)}let o={data:{general:{[i]:{[s]:n}}}};await e.update(o)}async performUtilityMacro(t,e,i){super.getActor(e);let s=super.getToken(e);switch(i){case"toggleVisibility":s.toggleVisibility();break;case"toggleCombat":s.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"endTurn":game.combat?.current?.tokenId===e&&await(game.combat?.nextTurn())}}async performMultiToggleUtilityMacro(t){if("toggleVisibility"===t){const t=canvas.tokens.controlled.every((t=>!t.document.hidden));canvas.tokens.controlled.forEach((e=>{(t||e.document.hidden)&&e.toggleVisibility()}))}if("toggleCombat"===t){const t=canvas.tokens.controlled.every((t=>t.inCombat));for(let e of canvas.tokens.controlled)t?await e.toggleCombat():e.inCombat||await e.toggleCombat();Hooks.callAll("forceUpdateTokenActionHUD")}}performConditionMacro(t,e,i){let s=super.getActor(e);switch(super.getToken(e),i){case"toggleStarving":this.toggleConditionState(t,s,"starving","value");break;case"toggleDehydrated":this.toggleConditionState(t,s,"dehydrated","value");break;case"toggleExhausted":this.toggleConditionState(t,s,"exhausted","value");break;case"toggleFreezing":this.toggleConditionState(t,s,"freezing","value");break;case"togglePanic":this.toggleConditionState(t,s,"panic","value")}}_rollItem(t,e,i,s){t.items.get(i);if(["item"].includes(s))return this.doRenderItem(e,i);console.warn("armor roll")}}class AlienrpgSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerAlienrpg(t,e)}getAvailableRollHandlers(){return{core:"Core AlienRPG"}}doGetRollHandler(t){return new RollHandlerBaseAlienrpg}doRegisterSettings(t,e){}}class ActionHandlerOD6S extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;i.tokenId=t.id;let s=t.actor;if(!s)return i;if("container"===s.type)return i;if(i.actorId=s.id,"vehicle"!==s.type&&"starship"!==s.type){let t=this._buildCombatActionsCategory(s,i.tokenId),e=this._buildVehicleCategory(s,i.tokenId),a=this._buildAttributesCategory(s,i.tokenId,"attributes"),n=this._buildSkillsCategory(s,i.tokenId,"skills");this._combineCategoryWithList(i,game.i18n.localize("OD6S.COMBAT"),t),this._combineCategoryWithList(i,game.i18n.localize("OD6S.VEHICLE"),e),this._combineCategoryWithList(i,game.i18n.localize("OD6S.ATTRIBUTES"),a),this._combineCategoryWithList(i,game.i18n.localize("OD6S.SKILLS"),n)}if(isNewerVersion(game.system.version,"0.2.4")&&("vehicle"===s.type||"starship"===s.type)&&s.system.crewmembers.length>0)for(let t of s.system.crewmembers){let e=await game.od6s.getActorFromUuid(t.uuid);if(e.testUserPermission(game.user,"OWNER")){let t=this._buildVehicleCategory(e,e.uuid,"crew");this._combineCategoryWithList(i,e.name,t)}}return i}_buildCombatActionsCategory(t,e){let i="action",s=this.initializeEmptyCategory("combatactions"),a=t.items;const n=["pr","er"];let o=[];for(let s of n){let a=game.i18n.localize(t.system[s].label),n=[i,e,s].join(this.delimiter);o.push({name:a,id:s,encodedValue:n})}let r=this.initializeEmptySubcategory();r.actions=o,this._combineSubcategoryWithCategory(s,game.i18n.localize("OD6S.RESISTANCE"),r);let l=a.filter((t=>"weapon"===t.type&&t.system.equipped.value)).sort(((t,e)=>t.name.localeCompare(e.name))),c=a.filter((t=>"weapon"===t.type&&"Melee"===t.system.subtype&&t.system.equipped.value)).sort(((t,e)=>t.name.localeCompare(e.name))).valueOf(),d=this._produceMap(e,l,i),u=this.initializeEmptySubcategory();u.actions=d,this._combineSubcategoryWithCategory(s,game.i18n.localize("OD6S.WEAPONS"),u);let h=[];for(let t in game.od6s.config.actions)if(game.od6s.config.actions[t].rollable){let s=game.i18n.localize(game.od6s.config.actions[t].name),a=[i,e,game.od6s.config.actions[t].type].join(this.delimiter);if(h.push({name:s,id:t,encodedValue:a}),s===game.i18n.localize("OD6S.ACTION_PARRY"))for(let t=0;t<c.length;t++){const i=game.i18n.localize("OD6S.ACTION_PARRY")+" ("+c[t].system.name+")",s=["parry",e,c[t].id].join(this.delimiter);h.push({name:i,encodedValue:s,id:c[t].id})}}let g=this.initializeEmptySubcategory();return g.actions=h,this._combineSubcategoryWithCategory(s,game.i18n.localize("OD6S.ACTIONS"),g),s}_buildVehicleCategory(t,e,i){let s;s="crew"===i?"crew":"action";let a=this.initializeEmptyCategory("vehicleactions");if(t.getFlag("od6s","crew")){if(isNewerVersion(game.system.version,"0.1.14")){let i,n=[];i="vehicle"===t.system.vehicle.type?game.i18n.localize(game.od6s.config.vehicleToughnessName):game.i18n.localize(game.od6s.config.starshipToughnessName);let o=[s,e,"vehicletoughness"].join(this.delimiter);if(n.push({name:i,id:"vehicletoughness",encodedValue:o}),t.system.vehicle.shields.value>0)for(let i in t.system.vehicle.shields.arcs){let a=game.i18n.localize(t.system.vehicle.shields.arcs[i].label)+" "+game.i18n.localize("OD6S.SHIELDS"),o=[s,e,"vehicleshields"+i].join(this.delimiter);n.push({name:a,id:"vehicletoughness",encodedValue:o})}let r=this.initializeEmptySubcategory();r.actions=n,this._combineSubcategoryWithCategory(a,game.i18n.localize("OD6S.RESISTANCE"),r)}let i=this.initializeEmptySubcategory();i.actions=this._produceMap(e,t.system.vehicle.vehicle_weapons.filter((t=>t.system.equipped.value)),s),this._combineSubcategoryWithCategory(a,game.i18n.localize("OD6S.VEHICLE_WEAPON"),i);let n=[];for(let i in game.od6s.config.vehicle_actions)if(game.od6s.config.vehicle_actions[i].rollable){let a="";if("sensors"===i){if(game.settings.get("od6s","sensors"))for(let o in t.system.vehicle.sensors.types){a=game.i18n.localize(game.od6s.config.vehicle_actions[i].name)+": "+game.i18n.localize(t.system.vehicle.sensors.types[o].label);let r=[s,e,game.od6s.config.vehicle_actions[i].type+o].join(this.delimiter);n.push({name:a,id:i,encodedValue:r})}}else{a=game.i18n.localize(game.od6s.config.vehicle_actions[i].name);let t=[s,e,game.od6s.config.vehicle_actions[i].type].join(this.delimiter);n.push({name:a,id:i,encodedValue:t})}}let o=this.initializeEmptySubcategory();o.actions=n,this._combineSubcategoryWithCategory(a,game.i18n.localize("OD6S.VEHICLE_ACTIONS"),o)}return a}_buildAttributesCategory(t,e,i){let s="attribute",a=this.initializeEmptyCategory("attributes"),n=t.system.attributes,o=Object.entries(n).map((t=>{if(0===t[1].score)return;let i=game.od6s.config.attributes[t[0]].name,a=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:a}})),r=this.initializeEmptySubcategory();return r.actions=o.filter((t=>!!t)),this._combineSubcategoryWithCategory(a,i,r),a}_buildSkillsCategory(t,e,i){let s=this.initializeEmptyCategory(i),a=t.items.filter((t=>"skill"===t.type||"specialization"===t.type));a.sort(((t,e)=>t.name.localeCompare(e.name)));let n=this._produceMap(e,a,"skill"),o=this.initializeEmptySubcategory();return o.actions=n,this._combineSubcategoryWithCategory(s,i,o),s}_produceMap(t,e,i){return e.filter((t=>!!t)).map((e=>{let s=[i,t,e.id].join(this.delimiter);return{name:e.name,encodedValue:s,id:e.id}}))}}class RollHandlerCoreOD6S extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s,a=i[0],n=i[1],o=i[2];switch("crew"!==a&&(s=super.getActor(n)),a){case"action":s.rollAction(o);break;case"item":this.rollItemMacro(t,s,o);break;case"parry":this.rollItemMacro(t,s,o,!0);break;case"attribute":s.rollAttribute(o);break;case"skill":this.rollItemMacro(t,s,o);case"crew":s=await game.od6s.getActorFromUuid(n),s.rollAction(o)}}rollItemMacro(t,e,i,s=!1){e.items.find((t=>t.id===i)).roll(s)}}class OD6SSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerOD6S(t,e)}getAvailableRollHandlers(){return{core:"Core OD6S"}}doGetRollHandler(t){return new RollHandlerCoreOD6S}doRegisterSettings(t,e){}}class ActionHandlerCthack extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;if("character"!=a.type)return i;i.actorId=a.id;let n=this._getSaves(a,s),o=this._getAttributes(a,s),r=this._getItemList(a,s),l=this._getAbilities(a,s);return this._combineCategoryWithList(i,this.i18n("tokenActionHud.saves"),n),this._combineCategoryWithList(i,this.i18n("tokenActionHud.attributes"),o),this._combineCategoryWithList(i,this.i18n("tokenActionHud.equipment"),r),this._combineCategoryWithList(i,this.i18n("tokenActionHud.features"),l),get("showHudTitle")&&(i.hudTitle=t.name),i}_getSaves(t,e){let i=this.initializeEmptyCategory("saves"),s=this.initializeEmptySubcategory(),a=Object.entries(t.system.saves);return s.actions=a.map((t=>{const i=t[0];return{name:game.cthack.config.saves[i],encodedValue:["save",e,t[0]].join(this.delimiter),id:t[0]}})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.saves"),s),i}_getAttributes(t,e){let i=this.initializeEmptyCategory("attributes"),s=this.initializeEmptySubcategory(),a=t.getAvailableAttributes();return s.actions=a.map((t=>{const i=t[0];let s;s="miscellaneous"===i&&""!==game.settings.get("cthack","MiscellaneousResource")?game.settings.get("cthack","MiscellaneousResource"):game.cthack.config.attributes[i];let a="resource";return"armedDamage"!==i&&"unarmedDamage"!==i||(a="damage"),{name:s,encodedValue:[a,e,t[0]].join(this.delimiter),id:t[0]}})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.attributes"),s),i}_getItemList(t,e){let i=t.items.filter((t=>"weapon"===t.type)).map((i=>this._buildEquipmentItem(e,t,"weapon",i))),s=this.initializeEmptySubcategory();s.actions=i;let a=t.items.filter((t=>"item"===t.type)).map((i=>this._buildEquipmentItem(e,t,"item",i))),n=this.initializeEmptySubcategory();n.actions=a;let o=this.i18n("tokenActionHud.weapons"),r=this.i18n("tokenActionHud.equipment"),l=this.initializeEmptyCategory("inventory");return this._combineSubcategoryWithCategory(l,o,s),this._combineSubcategoryWithCategory(l,r,n),l}_getAbilities(t,e){let i=t.items.filter((t=>"ability"===t.type)).map((i=>this._buildEquipmentItem(e,t,"ability",i))),s=this.initializeEmptySubcategory();s.actions=i;let a=this.i18n("tokenActionHud.features"),n=this.initializeEmptyCategory("inventory");return this._combineSubcategoryWithCategory(n,a,s),n}_produceMap(t,e,i){return e.filter((t=>!!t)).map((e=>{let s=[i,t,e._id].join(this.delimiter);return{name:e.name,encodedValue:s,id:e._id}}))}_buildEquipmentItem(t,e,i,s){return this._buildItem(t,e,i,s)}_buildItem(t,e,i,s){let a=[i,t,s.id].join(this.delimiter),n=this._getImage(s),o=this._getIcon(s);return{name:s.name,id:s.id,encodedValue:a,img:n,icon:o}}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getIcon(t){return"ability"===t.type&&"Permanent"!==t.system.uses?.per?t.system.uses.value>0?'<i class="fas fa-check"></i>':'<i class="fas fa-times"></i>':""}}class RollHandlerBaseCthack extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a);switch(s){case"save":this._handleSaves(s,t,o,n);break;case"resource":this._handleResources(s,t,o,n);break;case"damage":this._handleDamages(s,t,o,n);break;case"weapon":this.isRenderItem()?this.doRenderItem(a,n):this._handleWeapon(s,t,o,n);break;case"item":this.isRenderItem()?this.doRenderItem(a,n):this._handleItem(s,t,o,n);break;case"ability":this.isRenderItem()?this.doRenderItem(a,n):this._handleAbility(s,t,o,n)}}_handleSaves(t,e,i,s){i.rollSave(s)}_handleResources(t,e,i,s){i.rollResource(s)}_handleDamages(t,e,i,s){i.rollDamageRoll(s)}_handleWeapon(t,e,i,s){let a=i.items.get(s);if(this.isShift(e))i.rollMaterial(a);else{let t=0;if(game.user.targets.size>0){const e=[...game.user.targets][0];"opponent"==e.actor.type&&(t=e.actor.system.malus)}t<0?""===a.system.range?i.rollSave("str",{modifier:t}):i.rollSave("dex",{modifier:t}):""===a.system.range?i.rollSave("str"):i.rollSave("dex")}}_handleItem(t,e,i,s){let a=i.items.get(s);i.rollMaterial(a)}_handleAbility(t,e,i,s){let a=i.items.get(s);a.system.uses.value>0?i.useAbility(a):i.resetAbility(a)}}class CthackSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerCthack(t,e)}getAvailableRollHandlers(){return{core:"Core Cthack"}}doGetRollHandler(t){return new RollHandlerBaseCthack}doRegisterSettings(t,e){}}class ActionHandlerKg extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;i.actorId=a.id;let n=a.type;if("enemy"===n){let t=this._getEnemyTalents(a,s);this._combineCategoryWithList(i,this.i18n("tokenActionHud.attack"),t)}else if("character"===n){let t=this._getMainStat(a,s),e=this._getSubStat(a,s),n=this._getSpiritBurn(a,s),o=this._getTalents(a,s),r=this._getItems(a,s);this._combineCategoryWithList(i,this.i18n("tokenActionHud.kamigakari.mainStats"),t),this._combineCategoryWithList(i,this.i18n("tokenActionHud.kamigakari.subStats"),e),this._combineCategoryWithList(i,this.i18n("tokenActionHud.kamigakari.spiritBurn"),n),this._combineCategoryWithList(i,this.i18n("tokenActionHud.talents"),o),this._combineCategoryWithList(i,this.i18n("tokenActionHud.kamigakari.items"),r)}return i}_getMainStat(t,e){let i=this.initializeEmptyCategory("mainStat"),s=Object.entries(t.system.attributes).filter((t=>void 0!==t[1]?.add&&void 0===t[1]?.base)).map((t=>({id:t[0],name:t[1].label}))),a=this._produceMap(e,s,"stat"),n=this.initializeEmptySubcategory();return n.actions=a,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.mainStats"),n),i}_getSubStat(t,e){let i=this.initializeEmptyCategory("subStat"),s=Object.entries(t.system.attributes).filter((t=>void 0===t[1]?.add&&void 0!==t[1]?.label)).map((t=>({id:t[0],name:t[1].label}))),a=this._produceMap(e,s,"stat"),n=this.initializeEmptySubcategory();return n.actions=a,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.subStats"),n),i}_getSpiritBurn(t,e){let i=this.initializeEmptyCategory("spiritBurn"),s=[{id:"transcend",name:this.i18n("tokenActionHud.kamigakari.transcend")},{id:"vitalIgnition",name:this.i18n("tokenActionHud.kamigakari.vitalIgnition")},{id:"conceptDestruction",name:this.i18n("tokenActionHud.kamigakari.conceptDestruction")}],a=this._produceMap(e,s,"burn"),n=this.initializeEmptySubcategory();return n.actions=a,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.spiritBurn"),n),i}_getTalents(t,e){let i=this.initializeEmptyCategory("talent"),s=this._getTalentsByTiming(t,e,"Start"),a=this._getTalentsByTiming(t,e,"Prep"),n=this._getTalentsByTiming(t,e,"Attack"),o=this._getTalentsByTiming(t,e,"Defense"),r=this._getTalentsByTiming(t,e,"End"),l=this._getTalentsByTiming(t,e,"Constant"),c=this._getTalentsByTiming(t,e,"Free");return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.start"),s),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.prep"),a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.attack"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.free"),c),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.defense"),o),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.end"),r),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.constant"),l),i}_getEnemyTalents(t,e){let i=this.initializeEmptyCategory("talent"),s=this._getTalentsByTiming(t,e,"Start"),a=this._getTalentsByTiming(t,e,"Prep"),n=this._getTalentsByManyTiming(t,e,["Attack","Melee","Physical","Ranged","Magical"]),o=this._getTalentsByTiming(t,e,"Defense"),r=this._getTalentsByTiming(t,e,"End"),l=this._getTalentsByTiming(t,e,"Constant"),c=this._getTalentsByTiming(t,e,"Free");return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.start"),s),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.prep"),a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.attack"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.free"),c),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.defense"),o),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.end"),r),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.constant"),l),i}_getTalentsByManyTiming(t,e,i){let s=t.items.filter((t=>i.includes(t.system.timing))),a=this._produceMap(e,s,"item"),n=this.initializeEmptySubcategory();return n.actions=a,n}_getTalentsByTiming(t,e,i){let s=t.items.filter((t=>t.system.timing===i)),a=this._produceMap(e,s,"item"),n=this.initializeEmptySubcategory();return n.actions=a,n}_getItems(t,e){let i=this.initializeEmptyCategory("item"),s=this._getItemByType(t,e,"equipment"),a=this._getItemByType(t,e,"sacraments"),n=this._getItemByType(t,e,"consumables");return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.equipment"),s),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.sacraments"),a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.kamigakari.consumables"),n),i}_getItemByType(t,e,i){let s=t.items.filter((t=>t.system.class===i||t.type==i)),a=this._produceMap(e,s,"item"),n=this.initializeEmptySubcategory();return n.actions=a,n}_produceMap(t,e,i){return e.filter((t=>!!t)).map((e=>{let s=[i,t,e.id].join(this.delimiter),a={name:e.name,encodedValue:s,id:e.id};return"item"==i&&void 0!==e.system.quantity&&(a.name=e.name+" X "+e.system.quantity),a}))}}class RollHandlerBaseKg extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=t.ctrlKey,s=e.split("|");3!=s.length&&super.throwInvalidValueErr();let a=s[0],n=s[1],o=s[2],r=super.getActor(n),l=r.type;if("character"===l)switch(a){case"stat":r._rollDice(o,i);break;case"burn":"transcend"===o?r._transcend():"vitalIgnition"===o?r._vitalIgnition():"conceptDestruction"===o&&r._conceptDestruction();break;case"talent":case"item":r._echoItemDescription(o)}else if("enemy"===l&&"item"===a)r._echoItemDescription(o)}}class KamigakariSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerKg(t,e)}getAvailableRollHandlers(){return{core:"Core Kamigakari"}}doGetRollHandler(t){return new RollHandlerBaseKg}doRegisterSettings(t,e){}}class TagmarActionHandler extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;if("Inventario"==a.type)return i;i.actorId=a.id;let n=this._buildCombateCategory(a,s);this._combineCategoryWithList(i,"Combate",n);let o=this._buildHabilidadesCategory(a,s);this._combineCategoryWithList(i,"Habilidades",o);let r=this._buildTestesCategory(a,s);return this._combineCategoryWithList(i,"Testes",r),i}_buildTestesCategory(t,e){let i=this.initializeEmptyCategory("testes");i.name="Testes";let s=this._produceMap(e,[{name:"Intelecto",id:"INT"},{name:"Aura",id:"AUR"},{name:"Carisma",id:"CAR"},{name:"Força",id:"FOR"},{name:"Físico",id:"FIS"},{name:"Agilidade",id:"AGI"},{name:"Percepção",id:"PER"}],"att"),a=this.initializeEmptySubcategory();a.actions=s,this._combineSubcategoryWithCategory(i,"Atributos",a);let n=this._produceMap(e,[{name:"R. Física",id:"Física"},{name:"R. Magía",id:"Magía"}],"resist"),o=this.initializeEmptySubcategory();if(o.actions=n,this._combineSubcategoryWithCategory(i,"Resistência",o),"NPC"==t.type){let t=this._produceMap(e,[{name:"Moral",id:"Moral"}],"moral"),s=this.initializeEmptySubcategory();s.actions=t,this._combineSubcategoryWithCategory(i,"Moral",s)}return i}_buildHabilidadesCategory(t,e){let i=this.initializeEmptyCategory("habilidades");i.name="Habilidades";let s=t.items.filter((t=>"Habilidade"===t.type));s.sort((function(t,e){return t.name.localeCompare(e.name)}));let a=this._produceMap(e,s,"item"),n=this.initializeEmptySubcategory();return n.actions=a,this._combineSubcategoryWithCategory(i,"Habilidades",n),i}_buildCombateCategory(t,e){let i=this.initializeEmptyCategory("combate");i.name="Combate";let s="item",a=t.items,n=a.filter((t=>"Combate"===t.type));n.sort((function(t,e){return t.name.localeCompare(e.name)}));let o=this._produceMap(e,n,s),r=this.initializeEmptySubcategory();r.actions=o,this._combineSubcategoryWithCategory(i,"Ataques",r);let l=a.filter((t=>"TecnicasCombate"===t.type));l.sort((function(t,e){return t.name.localeCompare(e.name)}));let c=this._produceMap(e,l,s),d=this.initializeEmptySubcategory();return d.actions=c,this._combineSubcategoryWithCategory(i,"Técnicas de Combate",d),i}_produceMap(t,e,i){return e.filter((t=>!!t)).map((e=>{let s=[i,t,e.id].join(this.delimiter);return{name:e.name,encodedValue:s,id:e.id}}))}}class TagmarHandler extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a);switch(s){case"item":this.rollItemMacro(t,o,n);break;case"att":this.rollAtt(t,o,n);break;case"resist":this._dialogResistencia(t,o,n);break;case"moral":this.rollMoral(t,o,n)}}rollMoral(t,e,i){e._rollTeste({name:"Moral"})}_dialogResistencia(t,e,i){let s,a=!1;new Dialog({title:"Informe a força de ataque.",content:'\n        <div class="mediaeval">\n            <label for="forca-ataque">Força de Ataque:</label>\n            <input type="number" name="forca-ataque" id="forca-ataque" value="1" style="width: 60px; text-align: center;"/>\n        </div>',buttons:{Rolar:{icon:'<i class="fas fa-dice-d20"></i>',label:"Rolar Teste",callback:t=>{s=t.find("#forca-ataque").val(),s&&(s=parseInt(s),a=!0)}},Cancelar:{icon:'<i class="fas fa-times"></i>',label:"Cancelar"}},default:"Cancelar",close:t=>{a&&e._rollTeste({name:"Resistencia",id:i,f_ataque:s})}}).render(!0)}rollAtt(t,e,i){e._rollTeste({name:"Atributo",id:i})}rollItemMacro(t,e,i){e.items.find((t=>t.id===i)).rollTagmarItem()}}class TagmarSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new TagmarActionHandler(t,e)}getAvailableRollHandlers(){return{core:"Tagmar RPG"}}doGetRollHandler(t){let e;return e=new TagmarHandler,e}doRegisterSettings(t,e){}}class ActionHandlerDs4 extends ActionHandler{doBuildActionList(t,e){return t?this._buildSingleTokenList(t):e?this._buildMultipleTokenList():this.initializeEmptyActionList()}_buildSingleTokenList(t){const e=this.initializeEmptyActionList();if(e.tokenId=t?.id,e.actorId=t?.actor?.id,!e.tokenId||!e.actorId)return e;get("showHudTitle")&&(e.hudTitle=t.name);return this._buildSingleTokenCategories(t).forEach((t=>{this._combineCategoryWithList(e,t.name,t)})),e}_buildSingleTokenCategories(t){const e=t.id,i=t.actor;return[this._buildChecksCategory(e,i),this._buildInventoryCategory(e,i),this._buildSpellsCategory(e,i)].filter((t=>!!t))}_buildChecksCategory(t,e){const i=this.initializeEmptyCategory("checks"),s=this.i18n("DS4.Checks");i.name=s;const a=this.initializeEmptySubcategory(),n=!!e&&get("displayCheckTargetNumbers");return a.actions=Object.entries(CONFIG.DS4.i18n.checks).map((([i,s])=>({id:i,name:n?`${s} (${e.system.checks[i]})`:s,encodedValue:["check",t,i].join(this.delimiter),img:CONFIG.DS4.icons.checks[i]}))),this._combineSubcategoryWithCategory(i,s,a),i}_buildInventoryCategory(t,e){const i=this.initializeEmptyCategory("inventory"),s=this.i18n("DS4.HeadingInventory");i.name=s;const a=e.items.filter((t=>t.system.equipped)).sort(((t,e)=>t.sort-e.sort)),n=this.initializeEmptySubcategory();return n.actions=a.filter((t=>"weapon"===t.type)).map((e=>this._buildItemAction(e,t))),this._combineSubcategoryWithCategory(i,this.i18n("DS4.ItemTypeWeaponPlural"),n),i}_buildSpellsCategory(t,e){const i=this.initializeEmptyCategory("spells");i.name=this.i18n("DS4.HeadingSpells");const s=e.items.filter((t=>t.system.equipped)).sort(((t,e)=>t.sort-e.sort)),a=this.initializeEmptySubcategory();return a.actions=s.filter((t=>"spell"===t.type)).map((e=>this._buildItemAction(e,t))),this._combineSubcategoryWithCategory(i,this.i18n("DS4.ItemTypeSpellPlural"),a),i}_buildItemAction(t,e){return{id:t.id,name:t.name,encodedValue:[t.type,e,t.id].join(this.delimiter),img:t.img}}_buildMultipleTokenList(){const t=this.initializeEmptyActionList();return this._buildMultipleTokenCategories().forEach((e=>{this._combineCategoryWithList(t,e.name,e)})),t}_buildMultipleTokenCategories(){return[this._buildChecksCategory("multi")].filter((t=>!!t))}}class RollHandlerBaseDs4 extends RollHandler{async doHandleActionEvent(t,e){const i=e.split("|");3!=i.length&&super.throwInvalidValueErr();const s=i[0],a=i[1],n=i[2];if("multi"===a)for(const e of canvas.tokens.controlled)await this._handleMacros(t,s,e.id,n);else await this._handleMacros(t,s,a,n)}async _handleMacros(t,e,i,s){switch(e){case"check":await this._rollCheckMacro(t,i,s);break;case"weapon":case"spell":this.isRenderItem()?this.doRenderItem(i,s):this._rollItemMacro(t,i,s)}}async _rollCheckMacro(t,e,i){const s=super.getToken(e),a=s?.actor;await a.rollCheck(i,s.document)}async _rollItemMacro(t,e,i){const s=super.getActor(e);return super.getItem(s,i).roll()}}class Ds4SystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerDs4(t,e)}getAvailableRollHandlers(){return{core:"Core DS4"}}doGetRollHandler(t){return new RollHandlerBaseDs4}doRegisterSettings(t,e){!function register$5(t,e){game.settings.register(t,"displayCheckTargetNumbers",{name:game.i18n.localize("tokenActionHud.ds4.settings.displayCheckTargetNumbers.name"),hint:game.i18n.localize("tokenActionHud.ds4.settings.displayCheckTargetNumbers.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerCo extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;let n=a.type;if("character"!=n&&"npc"!=n)return i;i.actorId=a.id;let o=this._getCharacteristics(a,s),r=this._getCombat(a,s),l=this._getItemsList(a,s),c=this._getCapacities(a,s);return this._combineCategoryWithList(i,this.i18n("tokenActionHud.characteristics"),o),this._combineCategoryWithList(i,this.i18n("tokenActionHud.co.combat"),r),this._combineCategoryWithList(i,this.i18n("tokenActionHud.inventory"),l),this._combineCategoryWithList(i,this.i18n("tokenActionHud.co.capacities"),c),get("showHudTitle")&&(i.hudTitle=t.name),i}_getCharacteristics(t,e){let i=this.initializeEmptyCategory("characteristics"),s=this.initializeEmptySubcategory(),a=Object.entries(t.system.stats);s.actions=a.map((t=>{const i=t[0];return{name:"cof"===game.system.id?game.cof.config.stats[i]:game.coc.config.stats[i],encodedValue:["stat",e,t[0]].join(this.delimiter),id:t[0]}})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.characteristics"),s);let n=this.initializeEmptySubcategory(),o=Object.entries(t.system.attacks);return n.actions=o.map((t=>{const i=t[0];return{name:"cof"===game.system.id?game.cof.config.skills[i]:game.coc.config.skills[i],encodedValue:["skill",e,t[0]].join(this.delimiter),id:t[0]}})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.co.attacks"),n),i}_getCombat(t,e){let i=this.initializeEmptyCategory("combat"),s=this.initializeEmptySubcategory(),a=t.items.filter((t=>"item"===t.type&&("melee"===t.system.subtype||"ranged"===t.system.subtype)&&t.system.worn));s.actions=a.map((i=>this._buildEquipmentItem(e,t,"weapon",i))),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.weapons"),s);let n=this.initializeEmptySubcategory(),o=t.items.filter((t=>"item"===t.type&&"spell"===t.system.subtype&&(t.system.properties.weapon||t.system.properties.activable)));return n.actions=o.map((i=>this._buildEquipmentItem(e,t,"spell",i))),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.spells"),n),i}_getItemsList(t,e){let i=this.initializeEmptyCategory("inventory"),s=t.items.filter((t=>"item"===t.type&&("melee"===t.system.subtype||"ranged"===t.system.subtype))).map((i=>this._buildEquipmentItem(e,t,"item",i))),a=this.initializeEmptySubcategory();a.actions=s,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.weapons"),a);let n=t.items.filter((t=>"item"===t.type&&("armor"===t.system.subtype||"shield"===t.system.subtype))).map((i=>this._buildEquipmentItem(e,t,"item",i))),o=this.initializeEmptySubcategory();o.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.co.protections"),o);let r=t.items.filter((t=>"item"===t.type&&"spell"!==t.system.subtype&&t.system.properties.consumable&&t.system.qty>0)).map((i=>this._buildEquipmentItem(e,t,"item",i))),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.consumables"),l);let c=t.items.filter((t=>"item"===t.type&&"spell"===t.system.subtype)).map((i=>this._buildEquipmentItem(e,t,"item",i))),d=this.initializeEmptySubcategory();d.actions=c,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.spells"),d);let u=t.items.filter((t=>"item"===t.type&&"armor"!==t.system.subtype&&"shield"!==t.system.subtype&&"melee"!==t.system.subtype&&"ranged"!==t.system.subtype&&"spell"!==t.system.subtype&&!t.system.properties.consumable)).map((i=>this._buildEquipmentItem(e,t,"item",i))),h=this.initializeEmptySubcategory();return h.actions=u,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.equipment"),h),i}_getCapacities(t,e){let i=this.initializeEmptyCategory("capacities"),s=t.items.filter((t=>"capacity"===t.type)).map((i=>this._buildEquipmentItem(e,t,"capacity",i))),a=this.initializeEmptySubcategory();return a.actions=s,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.co.capacities"),a),i}_buildEquipmentItem(t,e,i,s){let a=this._buildItem(t,e,i,s);return this._addItemInfo(e,s,a),a}_buildItem(t,e,i,s){let a=[i,t,s.id].join(this.delimiter),n=this._getImage(s),o=this._getIcon(s);return{name:s.name,id:s.id,encodedValue:a,img:n,icon:o}}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_getIcon(t){return"item"===t.type&&t.system.worn?'<i class="fas fa-shield-alt"></i>':"capacity"===t.type&&t.system.activable?t.system.buff?t.system.properties.buff.activated?'<i class="fas fa-times"></i>':'<i class="fas fa-check"></i>':t.system.limitedUsage?t.system.properties.limitedUsage.use>0?'<i class="fas fa-check"></i>':"":'<i class="fas fa-check"></i>':""}_addItemInfo(t,e,i){i.info1=this._getQuantityData(e)}_getQuantityData(t){let e="";if("item"===t.type){const i=t.system.properties.consumable,s=t.system.qty;i?s>0&&(e=s):s>1&&(e=s)}return"capacity"===t.type&&t.system.activable&&t.system.limitedUsage&&(e+=t.system.properties.limitedUsage.use+"/"+t.system.properties.limitedUsage.maxUse),e}_buildCapacityItem(t,e,i,s){return this._buildItem(t,e,i,s)}}class RollHandlerBaseCo extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a);switch(s){case"stat":this._handleStats(s,t,o,n);break;case"skill":this._handleSkills(s,t,o,n);break;case"weapon":this._handleWeapon(s,t,o,n);break;case"spell":this._handleSpell(s,t,o,n);break;case"item":this.isRenderItem()?this.doRenderItem(a,n):this._handleItem(s,t,o,n);break;case"capacity":this.isRenderItem()?this.doRenderItem(a,n):this._handleCapacity(s,t,o,n)}}_handleStats(t,e,i,s){this.isRightClick(e)?i.rollStat(s,{dialog:!1}):i.rollStat(s)}_handleSkills(t,e,i,s){this.isRightClick(e)?i.rollStat(s,{dialog:!1}):i.rollStat(s)}_handleWeapon(t,e,i,s){let a=i.items.get(s);this.isShift(e)?i.rollWeapon(a,{dmgOnly:!0}):i.rollWeapon(a)}_handleSpell(t,e,i,s){let a=i.items.get(s);a.system.properties.consumable?i.consumeItem(a):this.isShift(e)?i.rollWeapon(a,{dmgOnly:!0}):i.rollWeapon(a)}_handleItem(t,e,i,s){let a=i.items.get(s);a.system.properties.equipable&&i.toggleEquipItem(a,this.isShift(e)),a.system.properties.consumable&&i.consumeItem(a)}_handleCapacity(t,e,i,s){let a=i.items.get(s);i.activateCapacity(a)}}class CoSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerCo(t,e)}getAvailableRollHandlers(){return{core:"Core CO"}}doGetRollHandler(t){return new RollHandlerBaseCo}doRegisterSettings(t,e){}}class ActionHandlerForbiddenlands extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i={},s={},a={},n={},o={},r={},l={},c={},d={},u={},h=this.initializeEmptyActionList();if(e)return this._buildMultipleTokenList(h),h;if(!t)return h;let g=t.id;h.tokenId=g;let m=t.actor;if(!m)return h;let y=m.type;if(!["character","monster"].includes(y))return h;switch(h.actorId=m.id,"character"===y?(i=this._getAttributes(m,g),s=this._getSkills(m,g),a=this._getWeaponsList(m,g),n=this._getItemsList(m,g),o=this._getTalentsList(m,g),r=this._getSpellsList(m,g),l=this._getConsumablesList(m,g),c=this._getConditionsList(m,g)):"monster"==y&&(i=this._getAttributes(m,g),s=this._getSkills(m,g),o=this._getMonsterTalentsList(m,g),d=this._getAttacksList(m,g)),u=this._getUtilityList(g),m.type){case"character":this._combineCategoryWithList(h,this.i18n("tokenActionHud.attributes"),i),this._combineCategoryWithList(h,this.i18n("tokenActionHud.skills"),s),this._combineCategoryWithList(h,this.i18n("tokenActionHud.weapons"),a),this._combineCategoryWithList(h,this.i18n("tokenActionHud.inventory"),n),this._combineCategoryWithList(h,this.i18n("tokenActionHud.talents"),o),this._combineCategoryWithList(h,this.i18n("tokenActionHud.spells"),r),this._combineCategoryWithList(h,this.i18n("tokenActionHud.forbiddenLands.consumables"),l),this._combineCategoryWithList(h,this.i18n("tokenActionHud.forbiddenLands.conditions"),c),this._setFilterSuggestions(m),get("showHudTitle")&&(h.hudTitle=t.name);break;case"monster":this._combineCategoryWithList(h,this.i18n("tokenActionHud.attributes"),i),this._combineCategoryWithList(h,this.i18n("tokenActionHud.skills"),s),this._combineCategoryWithList(h,this.i18n("tokenActionHud.talents"),o),this._combineCategoryWithList(h,this.i18n("tokenActionHud.attack"),d),this._setFilterSuggestions(m),get("showHudTitle")&&(h.hudTitle=t.name)}return this._combineCategoryWithList(h,this.i18n("tokenActionHud.utility"),u),h}_getWeaponsList(t,e){if(!1===get("showWeaponsCategory"))return;let i="weapon",s=this.initializeEmptyCategory("items"),a=this.initializeEmptySubcategory();return a.actions=this._produceMap(e,t.items.filter((t=>t.type==i)),i),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.weapons"),a),s}_getItemsList(t,e){if(!1===get("showInventoryCategory"))return;let i=this.initializeEmptyCategory("items"),s=["item","armor"],a=(t.items??[]).filter((t=>s.includes(t.type))).sort(this._foundrySort),n=a.filter((t=>"armor"===t.type)),o=this._buildItemActions(e,"armor",n),r=this.initializeEmptySubcategory();r.actions=o;let l=a.filter((t=>"item"===t.type)),c=this._buildItemActions(e,"item",l),d=this.initializeEmptySubcategory();return d.actions=c,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.armour"),r),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.equipment"),d),i}_getTalentsList(t,e){if(!1===get("showTalentsCategory"))return;let i=this.initializeEmptyCategory("items"),s=["talent"],a=(t.items??[]).filter((t=>s.includes(t.type))).sort(this._foundrySort).filter((t=>"talent"===t.type)),n=this._buildItemActions(e,"item",a),o=this.initializeEmptySubcategory();return o.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.talents"),o),i}_getSpellsList(t,e){if(!1===get("showSpellsCategory"))return;let i=this.initializeEmptyCategory("items"),s=["spell"],a=(t.items??[]).filter((t=>s.includes(t.type))).sort(this._foundrySort).filter((t=>"spell"===t.type)),n=this._buildItemActions(e,"item",a),o=this.initializeEmptySubcategory();return o.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.spells"),o),i}_getConsumablesList(t,e){if(!1===get("showConsumablesCategory"))return;let i=this.initializeEmptyCategory("consumables"),s=this.initializeEmptySubcategory();this.initializeEmptySubcategory();let a="consumables",n=Object.entries(t.system.consumable).map((t=>{let i=this.i18n("tokenActionHud.forbiddenLands."+t[0]),s=t[0],n=[a,e,s,i].join(this.delimiter);return{name:i,encodedValue:n,id:s}}));return s.actions=this._produceMap(e,n,a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.forbiddenLands.consumables"),s),i}_buildItemActions(t,e,i,s=!1){let a=this._produceMap(t,i,e,s);return a.forEach((t=>this._addItemInfo(i.find((e=>e.id===t.id)),t))),a}_addItemInfo(t,e){e.info1=this._getQuantityData(t)}_getQuantityData(t){let e="",i=t.system.quantity?.value;return i>1&&(e=i),e}_getSkills(t,e){if(!1===get("showSkillsCategory"))return;let i=this.initializeEmptyCategory("skills"),s=this.initializeEmptySubcategory(),a="skill",n=Object.entries(t.system.skill).map((t=>{let i=this.i18n("tokenActionHud.forbiddenLands."+t[0]),s=t[0];return{name:i,encodedValue:[a,e,s].join(this.delimiter),id:s}}));return s.actions=this._produceMap(e,n,a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.skills"),s),i}_getAttributes(t,e){if(!1===get("showAttributesCategory"))return;let i=this.initializeEmptyCategory("attributes"),s=this.initializeEmptySubcategory(),a="attribute",n=Object.entries(t.system.attribute).map((t=>{let i=this.i18n("tokenActionHud.forbiddenLands."+t[0]),s=t[0];return{name:i,encodedValue:[a,e,s].join(this.delimiter),id:s}}));return s.actions=this._produceMap(e,n,a),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.attributes"),s),i}_getMonsterTalentsList(t,e){let i=this.initializeEmptyCategory("items"),s=["monsterTalent"],a=(t.items??[]).filter((t=>s.includes(t.type))).sort(this._foundrySort).filter((t=>"monsterTalent"===t.type)),n=this._buildItemActions(e,"item",a),o=this.initializeEmptySubcategory();return o.actions=n,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.talents"),o),i}_getAttacksList(t,e){if(!1===get("showAttacksCategory"))return;let i=this.initializeEmptyCategory("attacks"),s=this.initializeEmptySubcategory(),a=["monsterAttack"],n=(t.items??[]).filter((t=>a.includes(t.type))).sort(this._foundrySort).filter((t=>"monsterAttack"===t.type)),o=this._buildItemActions(e,"monsterAttack",n);return s.actions=o,this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.attacks"),s),i}_buildMultipleTokenList(t){t.tokenId="multi",t.actorId="multi";const e=["monster","character"];canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.type)))}_getConditionsList(t,e){if(!1===get("showConditionsCategory"))return;let i=this.initializeEmptyCategory("conditions"),s=this.initializeEmptySubcategory(),a="conditions";if("character"===t.type){let s=this.initializeEmptySubcategory(),n=[];n={id:"toggleHungry",encodedValue:[a,e,"toggleHungry",""].join(this.delimiter),name:this.i18n("CONDITION.HUNGRY")},n.cssClass=t.system.condition.hungry.value?"active":"",s.actions.push(n),n={id:"toggleThirsty",encodedValue:[a,e,"toggleThirsty",""].join(this.delimiter),name:this.i18n("CONDITION.THIRSTY")},n.cssClass=t.system.condition.thirsty.value?"active":"",s.actions.push(n),n={id:"toggleCold",encodedValue:[a,e,"toggleCold",""].join(this.delimiter),name:this.i18n("CONDITION.COLD")},n.cssClass=t.system.condition.cold.value?"active":"",s.actions.push(n),n={id:"toggleSleepy",encodedValue:[a,e,"toggleSleepy",""].join(this.delimiter),name:this.i18n("CONDITION.SLEEPY")},n.cssClass=t.system.condition.sleepy.value?"active":"",s.actions.push(n),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.forbiddenLands.conditions"),s)}return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.utility"),s),i}_getUtilityList(t){if(!1===get("showUtilityCategory"))return;let e=this.initializeEmptyCategory("utility"),i=this.initializeEmptySubcategory(),s="utility";if(game.combat?.current?.tokenId===t){let e={id:"endTurn",encodedValue:[s,t,"endTurn",""].join(this.delimiter),name:this.i18n("tokenActionHud.endTurn")};i.actions.push(e)}return this._combineSubcategoryWithCategory(e,this.i18n("tokenActionHud.combat"),i),e}_setFilterSuggestions(t,e){let i=e?.map((t=>({id:t.id,value:t.name})));i?.length>0&&this.filterManager.setSuggestions(t,i)}_filterElements(t,e){let i=this.filterManager.getFilteredNames(t),s=e.filter((t=>!!t));return i.length>0&&(s=this.filterManager.isBlocklist(t)?e.filter((t=>!i.includes(t.name))):e.filter((t=>i.includes(t.name)))),s}_produceMap(t,e,i){return e.map((e=>{let s=[i,t,e.id,e.name.toLowerCase()].join(this.delimiter),a=this._getImage(e);return{name:e.name,encodedValue:s,id:e.id,img:a}}))}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_foundrySort(t,e){return t?.sort||e?.sort?t.sort-e.sort:0}}class RollHandlerBaseForbiddenlands extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");4!=i.length&&super.throwInvalidValueErr();let s,a=i[0],n=i[1],o=i[2],r=i[3],l=super.getActor(n);l&&(s=l.type),o&&l.items.get(o);if(["item","armor"].includes(a)&&this.isRenderItem())return this.doRenderItem(n,o);if("multi"===n)"utility"===a&&o.includes("toggle")?this.performMultiToggleUtilityMacro(o):canvas.tokens.controlled.forEach((e=>{let i=e.id;this._handleMacros(t,a,i,o,r)}));else{if(!["utility"].includes(a))switch(s){case"character":case"monster":await this._handleUniqueActionsChar(a,t,l,o)}switch(a){case"attribute":"click"===t.type&&l.sheet.rollAttribute(o);break;case"skill":"click"===t.type&&l.sheet.rollSkill(o);break;case"weapon":"click"===t.type&&l.sheet.rollGear(o);break;case"item":l.items.get(o).sendToChat();break;case"armor":l.sheet.rollSpecificArmor(o);break;case"power":l.sheet.rollSpell(o);break;case"conditions":this.performConditionMacro(t,n,o);break;case"consumables":this.performConsumableMacro(n,o);break;case"utility":this.performUtilityMacro(t,n,o)}}}async _handleUniqueActionsChar(t,e,i,s){switch(t){case"stress":await this._adjustAttribute(e,i,"stress","value",s);break;case"health":await this._adjustAttribute(e,i,"health","value",s);break;case"monsterAttack":i.sheet.rollSpecificAttack(s)}}async _adjustAttribute(t,e,i,s,a){let n=e.system.header[i][s];if(this.rightClick){if(n<=0)return;n--}else{if(n>="10")return;n++}let o={data:{header:{[i]:{[s]:n}}}};await e.update(o)}async toggleConditionState(t,e){t.toggleCondition(e)}async performUtilityMacro(t,e,i){super.getActor(e);let s=super.getToken(e);switch(i){case"toggleVisibility":s.toggleVisibility();break;case"toggleCombat":s.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"endTurn":game.combat?.current?.tokenId===e&&await(game.combat?.nextTurn())}}async performMultiToggleUtilityMacro(t){if("toggleVisibility"===t){const t=canvas.tokens.controlled.every((t=>!t.document.hidden));canvas.tokens.controlled.forEach((e=>{(t||e.document.hidden)&&e.toggleVisibility()}))}if("toggleCombat"===t){const t=canvas.tokens.controlled.every((t=>t.inCombat));for(let e of canvas.tokens.controlled)t?await e.toggleCombat():e.inCombat||await e.toggleCombat();Hooks.callAll("forceUpdateTokenActionHUD")}}performConditionMacro(t,e,i){let s=super.getActor(e);switch(super.getToken(e),i){case"toggleHungry":this.toggleConditionState(s,"hungry");break;case"toggleThirsty":this.toggleConditionState(s,"thirsty");break;case"toggleCold":this.toggleConditionState(s,"cold");break;case"toggleSleepy":this.toggleConditionState(s,"sleepy")}}performConsumableMacro(t,e){let i=super.getActor(t);i&&i.sheet.rollConsumable(e)}_rollItem(t,e,i,s){t.items.get(i);if(["item"].includes(s))return this.doRenderItem(e,i);console.warn("armor roll")}}class ForbiddenLandsSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerForbiddenlands(t,e)}getAvailableRollHandlers(){return{core:"Core Forbidden Lands"}}doGetRollHandler(t){return new RollHandlerBaseForbiddenlands}doRegisterSettings(t,e){!function register$4(t,e){const i=["Attributes","Skills","Attacks","Weapons","Inventory","Talents","Spells","Consumables","Conditions","Utility"];for(const s of i)game.settings.register(t,`show${s}Category`,{name:game.i18n.localize(`tokenActionHud.settings.show${s}Category.name`),hint:game.i18n.localize(`tokenActionHud.settings.show${s}Category.hint`),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerDnD4e extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){return t?this._buildSingleTokenList(t):e?this._buildMultipleTokenList():this.initializeEmptyActionList()}buildUpgradeAnnouncement(){const t=this.initializeEmptyActionList(),e=this.initializeEmptyCategory("blank");return e.name="You must upgrade 4E System to at least 0.2.62",t.categories.push(e),t}async _buildSingleTokenList(t){if(!game.dnd4eBeta.tokenBarHooks)return this.buildUpgradeAnnouncement();const e=this.initializeEmptyActionList();if(e.tokenId=t?.id,e.actorId=t?.actor?.id,!e.tokenId||!e.actorId)return e;get("showHudTitle")&&(e.hudTitle=t.name);return(await this._buildCategories(t)).flat().filter((t=>t)).forEach((t=>{this._combineCategoryWithList(e,t.name,t)})),e}_buildCategories(t){return[this._buildAbilitiesCategory(t),this._buildSkillsCategory(t),this._buildPowersCategory(t),this._buildFeaturesCategory(t),this._buildItemsCategory(t),this._buildConditionsCategory(t),this._buildUtilityCategory(t)]}_buildAbilitiesCategory(t){if(!1===get("showAbilitiesCategory"))return;const e=t.actor.system.abilities;return this._getAbilityList(t.id,e,"abilities",this.i18n("tokenActionHud.abilities"),"ability")}_buildMultipleTokenList(){if(!game.dnd4eBeta.tokenBarHooks)return this.buildUpgradeAnnouncement();const t=this.initializeEmptyActionList();t.tokenId="multi",t.actorId="multi";const e=["Player Character","NPC"];let i=canvas.tokens.controlled.map((t=>t.actor)).filter((t=>e.includes(t.type)));const s=t.tokenId;this._addMultiSkills(t,s);let a=this.i18n("tokenActionHud.abilities");return this._addMultiAbilities(t,s,"abilities",a,"ability"),get("showConditionsCategory")&&this._addMultiConditions(t,s),this._addMultiUtilities(t,s,i),t}_buildFeaturesCategory(t){if(!1===get("showFeaturesCategory"))return;const e=t.actor,i=t.id;let s=this.initializeEmptyCategory("Features");s.name=this.i18n("DND4EBETA.Features");const a={raceFeats:{label:"DND4EBETA.FeatRace",items:[],dataset:{type:"raceFeats"}},classFeats:{label:"DND4EBETA.FeatClass",items:[],dataset:{type:"classFeats"}},pathFeats:{label:"DND4EBETA.FeatPath",items:[],dataset:{type:"pathFeats"}},destinyFeats:{label:"DND4EBETA.FeatDestiny",items:[],dataset:{type:"destinyFeats"}},feat:{label:"DND4EBETA.FeatLevel",items:[],dataset:{type:"feat"}},ritual:{label:"DND4EBETA.FeatRitual",items:[],dataset:{type:"ritual"}}};return e.items.forEach((t=>{Object.keys(a).includes(t.type)&&a[t.type].items.push(t)})),Object.entries(a).map((t=>{const a=this._buildFeatureSubCategory(e,t[1].items,i);this._combineSubcategoryWithCategory(s,this.i18n(t[1].label),a)})),s}_buildFeatureSubCategory(t,e,i){const s="feature",a=this.initializeEmptySubcategory();return e.forEach((t=>{const e=[s,i,t.id].join(this.delimiter),n={name:t.name,id:t.id,encodedValue:e,img:this._getImage(t)};a.actions.push(n)})),a}_buildItemsCategory(t){if(!1===get("showInventoryCategory"))return;const e=t.actor,i=t.id;let s=this.initializeEmptyCategory("Inventory");s.name=this.i18n("DND4EBETA.Inventory");const a={};get("equipmentCategoryList").split(",").forEach((t=>{t.trim()&&(a[t.trim()]=!0)}));const n={weapon:{label:"DND4EBETA.ItemTypeWeaponPl",items:[]},equipment:{label:"DND4EBETA.ItemTypeEquipmentPl",items:[]},consumable:{label:"DND4EBETA.ItemTypeConsumablePl",items:[],subcategories:{},subcategoryField:"consumableType"},tool:{label:"DND4EBETA.ItemTypeToolPl",items:[]},backpack:{label:"DND4EBETA.ItemTypeContainerPl",items:[]},loot:{label:"DND4EBETA.ItemTypeLootPl",items:[]}};Object.entries(game.dnd4eBeta.config.consumableTypes).forEach((t=>{const e={label:t[1],items:[]};n.consumable.subcategories[t[0]]=e})),e.items.forEach((t=>{if(Object.keys(n).includes(t.type)){const e=n[t.type];if(e.subcategories&&e.subcategoryField&&t.system[e.subcategoryField]){const i=t.system[e.subcategoryField];if(e.subcategories[i])return void e.subcategories[i].items.push(t)}e.items.push(t)}}));const o=0===Object.keys(a).length;return Object.entries(n).map((t=>{if(o||a[t[0]]){const n=this._buildItemSubCategory(e,t[1].items,i,t[1].subcategories,a);this._combineSubcategoryWithCategory(s,this.i18n(t[1].label),n)}})),s}_buildItemSubCategory(t,e,i,s,a){const n="inventory",o=this.initializeEmptySubcategory();if(e.forEach((t=>{const e=[n,i,t.id].join(this.delimiter),s={name:t.name,id:t.id,encodedValue:e,img:this._getImage(t)};get("hideUnequippedInventory")&&!t.system.equipped||get("hideQuantityZero")&&t.system.quantity<1||o.actions.push(s)})),s){const e=0===Object.keys(a).length;Object.entries(s).map((s=>{if(e||a[s[0]]){const e=this._buildItemSubCategory(t,s[1].items,i,s[1].subcategories,a);this._combineSubcategoryWithCategory(o,this.i18n(s[1].label),e)}}))}return o}_buildPowersCategory(t){if(!1===get("showPowersCategory"))return;const e=t.actor,i=t.id;let s=e.items.filter((t=>"power"===t.type)),a=this.initializeEmptyCategory("Powers");a.name=this.i18n("DND4EBETA.Powers");let n=e.system.powerGroupTypes;n||(e.system.powerGroupTypes="usage",n="usage");const o=game.dnd4eBeta.tokenBarHooks.generatePowerGroups(e);let r="useType";switch(n){case"action":r="actionType";break;case"type":r="powerType"}return o.other||(o.other={label:"DND4EBETA.Other",items:[],dataset:{type:"other"}}),s.forEach((t=>{const e=t.system[r];o[e]?o[e].items.push(t):o.other.items.push(t)})),Object.entries(o).map((t=>{const s=this._buildPowerSubCategory(e,t[1].items,i);this._combineSubcategoryWithCategory(a,this.i18n(t[1].label),s)})),a}_buildPowerSubCategory(t,e,i){const s="power",a=this.initializeEmptySubcategory();let n=e;get("hideUsedPowers")?n=n.filter((e=>"recharge"===e.system.useType||game.dnd4eBeta.tokenBarHooks.isPowerAvailable(t,e))):n.forEach((e=>{game.dnd4eBeta.tokenBarHooks.isPowerAvailable(t,e)}));const o=get("forcePowerColours");return n.forEach((t=>{const e=[s,i,t.id].join(this.delimiter),n={name:t.name,id:t.id,encodedValue:e,img:this._getImage(t)};o&&(n.cssClass=`force-ability-usage--${t.system.useType}`),a.actions.push(n)})),a}_buildSkillsCategory(t){if(!1===get("showSkillsCategory"))return;const e=t.actor;if("vehicle"===e.type)return;const i=e.system.skills;let s=this.initializeEmptyCategory("skills");s.name=this.i18n("tokenActionHud.skills");let a="skill",n=get("abbreviateSkills"),o=Object.entries(i).map((e=>{try{let s=e[0],o=n?s:game.dnd4eBeta.config.skills[s];o=o.charAt(0).toUpperCase()+o.slice(1);let r=[a,t.id,e[0]].join(this.delimiter),l=this._getProficiencyIcon(i[s].value);return{name:o,id:e[0],encodedValue:r,icon:l}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)),r=this.initializeEmptySubcategory();r.actions=o;let l=this.i18n("tokenActionHud.skills");return this._combineSubcategoryWithCategory(s,l,r),s}_addMultiSkills(t,e){let i=this.initializeEmptyCategory("skills"),s="skill",a=get("abbreviateSkills"),n=Object.entries(game.dnd4eBeta.config.skills).map((t=>{let i=a?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let n=[s,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:n}})),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("tokenActionHud.skills");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i,!0)}_getAbilityList(t,e,i,s,a){let n=this.initializeEmptyCategory(i);n.name=s;let o=get("abbreviateSkills"),r=Object.entries(game.dnd4eBeta.config.abilities).map((s=>{if(0===e[s[0]].value)return;let n=o?s[0]:s[1];n=n.charAt(0).toUpperCase()+n.slice(1);let r,l=[a,t,s[0]].join(this.delimiter);return r="checks"===i?"":this._getProficiencyIcon(e[s[0]].proficient),{name:n,id:s[0],encodedValue:l,icon:r}})),l=this.initializeEmptySubcategory();return l.actions=r.filter((t=>!!t)),this._combineSubcategoryWithCategory(n,s,l),n}_addMultiAbilities(t,e,i,s,a){let n=this.initializeEmptyCategory(i),o=get("abbreviateSkills"),r=Object.entries(game.dnd4eBeta.config.abilities).map((t=>{let i=o?t[0]:t[1];i=i.charAt(0).toUpperCase()+i.slice(1);let s=[a,e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:s}})),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(n,s,l),this._combineCategoryWithList(t,s,n,!0)}_buildUtilityCategory(t){if(!1===get("showUtilityCategory"))return;const e=t.actor;let i=this.initializeEmptyCategory("utility");i.name=this.i18n("tokenActionHud.utility");let s="utility",a=this.initializeEmptySubcategory();this._addCombatSubcategory(s,i,t.id);let n=[s,t.id,"healDialog"].join(this.delimiter);a.actions.push({id:"heal",encodedValue:n,name:this.i18n("DND4EBETA.Healing")});let o=[s,t.id,"save"].join(this.delimiter);a.actions.push({id:"save",encodedValue:o,name:this.i18n("DND4EBETA.SavingThrow")});let r=[s,t.id,"saveDialog"].join(this.delimiter);if(a.actions.push({id:"saveDialog",encodedValue:r,name:this.i18n("Show Save Dialog")}),game.dnd4eBeta.tokenBarHooks.version>=2){(!get("hideUsedPowers")||e.system.actionpoints?.value>0)&&a.actions.push({id:"actionPoint",encodedValue:[s,t.id,"actionPoint"].join(this.delimiter),name:this.i18n("DND4EBETA.ActionPointUse")});(!get("hideUsedPowers")||!e.system.details?.secondwind)&&a.actions.push({id:"secondWind",encodedValue:[s,t.id,"secondWind"].join(this.delimiter),name:this.i18n("DND4EBETA.SecondWind")}),a.actions.push({id:"deathSave",encodedValue:[s,t.id,"deathSave"].join(this.delimiter),name:this.i18n("DND4EBETA.DeathSavingThrow")})}return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.utility"),a),i}_buildEffectsCategory(t){if(!1===get("showEffectsCategory"))return;let e=this.initializeEmptyCategory("effects");return e.name=this.i18n("tokenActionHud.effects"),this._addEffectsSubcategories(t.actor,t.id,e),e}_buildConditionsCategory(t){if(!1===get("showConditionsCategory"))return;let e=this.initializeEmptyCategory("conditions");return e.name=this.i18n("tokenActionHud.conditions"),this._addConditionsSubcategory(t.actor,t.id,e),e}_addEffectsSubcategories(t,e,i){const s="effect",a="find"in t.effects.entries?t.effects.entries:t.effects;let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();a.forEach((t=>{const i=t.label,a=[s,e,t.id].join(this.delimiter),r=t.disabled?"":"active",l=t.icon;let c={name:i,id:t.id,encodedValue:a,img:l,cssClass:r};t.isTemporary?n.actions.push(c):o.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.temporary"),n),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.passive"),o)}_addMultiConditions(t,e){const i=this.initializeEmptyCategory("conditions"),s="condition",a=CONFIG.statusEffects.filter((t=>""!==t.id)),n=canvas.tokens.controlled.filter((t=>!!t.actor)).map((t=>t.actor));if(!a)return;let o=this.initializeEmptySubcategory();a.forEach((t=>{const i=this.i18n(t.label),a=[s,e,t.id].join(this.delimiter),r=n.every((e=>{("some"in e.effects.entries?e.effects.entries:e.effects).some((e=>e.flags.core?.statusId===t.id))}))?"active":"",l=t.icon,c={name:i,id:t.id,encodedValue:a,img:l,cssClass:r};o.actions.push(c)}));const r=this.i18n("tokenActionHud.conditions");this._combineSubcategoryWithCategory(i,r,o),this._combineCategoryWithList(t,r,i)}_addConditionsSubcategory(t,e,i){const s="condition",a=CONFIG.statusEffects.filter((t=>""!==t.id));if(!a)return;let n=this.initializeEmptySubcategory();a.forEach((i=>{const a=this.i18n(i.label),o=[s,e,i.id].join(this.delimiter),r=("some"in t.effects.entries?t.effects.entries:t.effects).some((t=>t.flags.core?.statusId===i.id))?"active":"",l=i.icon,c={name:a,id:i.id,encodedValue:o,img:l,cssClass:r};n.actions.push(c)})),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.conditions"),n)}_addCombatSubcategory(t,e,i){let s=this.initializeEmptySubcategory();const a=game.combat;let n,o;a&&(n=a.combatants.find((t=>t.tokenId===i)),o=n?.initiative);let r={id:"rollInitiative",encodedValue:[t,i,"initiative"].join(this.delimiter),name:this.i18n("tokenActionHud.rollInitiative")};if(o&&(r.info1=o),r.cssClass=o?"active":"",s.actions.push(r),game.combat?.current?.tokenId===i){let e={id:"endTurn",encodedValue:[t,i,"endTurn"].join(this.delimiter),name:this.i18n("tokenActionHud.endTurn")};s.actions.push(e)}this._combineSubcategoryWithCategory(e,this.i18n("tokenActionHud.combat"),s)}_addMultiCombatSubcategory(t,e,i){let s=this.initializeEmptySubcategory();const a=game.combat;let n,o={id:"rollInitiative",encodedValue:[t,e,"initiative"].join(this.delimiter),name:this.i18n("tokenActionHud.rollInitiative")};if(a){n=canvas.tokens.controlled.map((t=>t.id)).map((t=>a.combatants.find((e=>e.tokenId===t)))).every((t=>!!t?.initiative))}o.cssClass=n?"active":"",s.actions.push(o),this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.combat"),s)}_addMultiUtilities(t,e,i){let s=this.initializeEmptyCategory("utility"),a="utility";this._addMultiCombatSubcategory(a,e,s);let n=this.initializeEmptySubcategory(),o=this.initializeEmptySubcategory();if(i.every((t=>"character"===t.type))){let t=[a,e,"shortRest"].join(this.delimiter);n.actions.push({id:"shortRest",encodedValue:t,name:this.i18n("tokenActionHud.shortRest")});let s=[a,e,"longRest"].join(this.delimiter);n.actions.push({id:"longRest",encodedValue:s,name:this.i18n("tokenActionHud.longRest")});let r={id:"inspiration",encodedValue:[a,e,"inspiration"].join(this.delimiter),name:this.i18n("tokenActionHud.inspiration")};r.cssClass=i.every((t=>t.system.attributes?.inspiration))?"active":"",o.actions.push(r)}this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.rests"),n),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.utility"),o),this._combineCategoryWithList(t,this.i18n("tokenActionHud.utility"),s)}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}_filterExpendedItems(t){return get("showEmptyItems")?t:t.filter((t=>{let e=t.system.uses;return!e||!(e.max>0&&!e.value)}))}_getProficiencyIcon(t){return{0:"",.5:'<i class="fas fa-adjust"></i>',5:'<i class="fas fa-check"></i>',8:'<i class="fas fa-check-double"></i>'}[t]}}class RollHandlerBaseDnD4e extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!==i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2];if("multi"===a)for(let e of canvas.tokens.controlled){let i=e.id;await this._handleMacros(t,s,i,n)}else await this._handleMacros(t,s,a,n)}async _handleMacros(t,e,i,s){switch(e){case"ability":this.rollAbilityMacro(t,i,s);break;case"skill":this.rollSkillMacro(t,i,s);break;case"feature":case"inventory":this.isRenderItem()?this.doRenderItem(i,s):this.rollItemMacro(t,i,s);break;case"power":this.isRenderItem()?this.doRenderItem(i,s):this.rollPowerMacro(t,i,s);break;case"utility":await this.performUtilityMacro(t,i,s);break;case"effect":await this.toggleEffect(t,i,s);break;case"condition":await this.toggleCondition(t,i,s)}}rollAbilityMacro(t,e,i){const s=super.getActor(e);return game.dnd4eBeta.tokenBarHooks.rollAbility(s,i,t)}rollSkillMacro(t,e,i){const s=super.getActor(e);return game.dnd4eBeta.tokenBarHooks.rollSkill(s,i,t)}rollItemMacro(t,e,i){let s=super.getActor(e),a=super.getItem(s,i);return game.dnd4eBeta.tokenBarHooks.rollItem(s,a,t)}rollPowerMacro(t,e,i){let s=super.getActor(e),a=super.getItem(s,i);return this.needsRecharge(s,a)?(t.currentTarget={closest:t=>({dataset:{itemId:i}})},void game.dnd4eBeta.tokenBarHooks.rechargePower(s,a,t)):game.dnd4eBeta.tokenBarHooks.rollPower(s,a,t)}needsRecharge(t,e){return"recharge"===e.system.useType&&!game.dnd4eBeta.tokenBarHooks.isPowerAvailable(t,e)}async performUtilityMacro(t,e,i){let s=super.getActor(e),a=super.getToken(e);switch(i){case"toggleCombat":a.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHUD");break;case"toggleVisibility":a.toggleVisibility();break;case"saveDialog":game.dnd4eBeta.tokenBarHooks.saveDialog(s,t);break;case"save":game.dnd4eBeta.tokenBarHooks.quickSave(s,t);break;case"healDialog":game.dnd4eBeta.tokenBarHooks.healDialog(s,t);break;case"initiative":await this.performInitiativeMacro(e,t);break;case"actionPoint":game.dnd4eBeta.tokenBarHooks.actionPoint(s,t);break;case"secondWind":game.dnd4eBeta.tokenBarHooks.secondWind(s,t);break;case"deathSave":game.dnd4eBeta.tokenBarHooks.deathSave(s,t);break;case"endTurn":game.combat?.current?.tokenId===e&&await(game.combat?.nextTurn())}}async performInitiativeMacro(t,e){let i=super.getActor(t);await i.rollInitiative({createCombatants:!0,event:e}),Hooks.callAll("forceUpdateTokenActionHUD")}async toggleEffect(t,e,i){const s=super.getActor(e),a=("find"in s.effects.entries?s.effects.entries:s.effects).find((t=>t.id===i));if(!a)return;const n=a.flags.core?.statusId;n?await this.toggleCondition(t,e,n):(await a.update({disabled:!a.disabled}),Hooks.callAll("forceUpdateTokenActionHUD"))}async toggleCondition(t,e,i){const s=super.getToken(e),a=this.isRightClick(t);if(i.includes("combat-utility-belt.")&&game.cub&&!a){const t=this.findCondition(i)?.label;if(!t)return;game.cub.hasCondition(t,s)?await game.cub.removeCondition(t,s):await game.cub.addCondition(t,s)}else{const t=this.findCondition(i);if(!t)return;a?await s.toggleEffect(t,{overlay:!0}):await s.toggleEffect(t)}Hooks.callAll("forceUpdateTokenActionHUD")}findCondition(t){return CONFIG.statusEffects.find((e=>e.id===t))}}class DnD4eSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerDnD4e(t,e)}getAvailableRollHandlers(){return{core:"Core dnd4e"}}doGetRollHandler(t){return new RollHandlerBaseDnD4e}doRegisterSettings(t,e){!function register$3(t,e){const i=["Abilities","Skills","Powers","Features","Inventory","Conditions","Utility"];for(const s of i)game.settings.register(t,`show${s}Category`,{name:game.i18n.localize(`tokenActionHud.settings.show${s}Category.name`),hint:game.i18n.localize(`tokenActionHud.settings.show${s}Category.hint`),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}});game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenActionHud.rotv.settings.abbreviateSkills.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"hideUsedPowers",{name:game.i18n.localize("tokenActionHud.dnd4e.settings.hideUsedPowers.name"),hint:game.i18n.localize("tokenActionHud.dnd4e.settings.hideUsedPowers.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"forcePowerColours",{name:game.i18n.localize("tokenActionHud.dnd4e.settings.forcePowerColours.name"),hint:game.i18n.localize("tokenActionHud.dnd4e.settings.forcePowerColours.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"hideUnequippedInventory",{name:game.i18n.localize("tokenActionHud.dnd4e.settings.hideUnequippedInventory.name"),hint:game.i18n.localize("tokenActionHud.dnd4e.settings.hideUnequippedInventory.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"hideQuantityZero",{name:game.i18n.localize("tokenActionHud.dnd4e.settings.hideQuantityZero.name"),hint:game.i18n.localize("tokenActionHud.dnd4e.settings.hideQuantityZero.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"equipmentCategoryList",{name:game.i18n.localize("tokenActionHud.dnd4e.settings.equipmentCategoryList.name"),hint:game.i18n.localize("tokenActionHud.dnd4e.settings.equipmentCategoryList.hint"),scope:"client",config:!0,type:String,default:"consumable, tool, alchemical, potion, poison, food, scroll, trinket",onChange:t=>{e(t)}})}(t,e)}}class ActionHandlerED4e extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){return t?this._buildSingleTokenList(t):e?this._buildMultipleTokenList():this.initializeEmptyActionList()}async _buildSingleTokenList(t){const e=this.initializeEmptyActionList();if(e.tokenId=t?.id,e.actorId=t?.actor?.id,!e.tokenId||!e.actorId)return e;get("showHudTitle")&&(e.hudTitle=t.name);return(await this._buildCategories(t)).flat().filter((t=>t)).forEach((t=>{this._combineCategoryWithList(e,t.name,t)})),e}_buildCategories(t){let e=this._buildGeneralCategory(t),i=this._buildFavoritesCategory(t),s=this._buildTalentsCategory(t),a=this._buildMatrixCategory(t),n=this._buildSkillsCategory(t),o=this._buildItemsCategory(t);return[e,i,s,a,n,this._buildAttacksCategory(t),this._buildCreaturePowersCategory(t),this._buildCreatureManeuversCategory(t),o,this._buildCombatCategory(t)]}_buildGeneralCategory(t){if(!get("showGeneral"))return;const e=t.actor,i=0===["creature"].indexOf(e.type);let s=["earthdawn.d.dexterity","earthdawn.s.strength","earthdawn.t.toughness","earthdawn.p.perception","earthdawn.w.willpower","earthdawn.c.charisma"].map((e=>({name:this.i18n(e),id:null,encodedValue:["attribute",t.id,e].join(this.delimiter)}))).filter((t=>!!t)),a=this.initializeEmptySubcategory();a.actions=s;let n=this.initializeEmptySubcategory();n.actions=[{name:this.i18n("earthdawn.r.recovery"),id:null,encodedValue:["recovery",t.id,"recovery"].join(this.delimiter)}],i||n.actions.push({name:this.i18n("earthdawn.n.newDay"),id:null,encodedValue:["newday",t.id,"newday"].join(this.delimiter)},{name:this.i18n("earthdawn.h.halfMagic"),id:null,encodedValue:["halfmagic",t.id,"halfmagic"].join(this.delimiter)});const o={"earthdawn.u.useKarma":"usekarma"};let r=["earthdawn.u.useKarma"].map((i=>({name:this.i18n(i),id:null,encodedValue:["toggle",t.id,o[i]].join(this.delimiter),cssClass:"true"===e.data.usekarma?"active":""}))).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),l=this.initializeEmptySubcategory();l.actions=r;let c=this.initializeEmptyCategory("general");return c.name=this.i18n("tokenActionHud.general"),this._combineSubcategoryWithCategory(c,this.i18n("earthdawn.a.attributes"),a),this._combineSubcategoryWithCategory(c,this.i18n("earthdawn.o.other"),n),i||this._combineSubcategoryWithCategory(c,this.i18n("tokenActionHud.ed4e.systems"),l),c}_buildFavoritesCategory(t){if(!get("showFavorites"))return;const e=t.actor;if(["pc","npc"].indexOf(e.type)<0)return;const i=e.items.filter((t=>"true"===t.system.favorite));let s=this.initializeEmptyCategory("favorites");s.name=this.i18n("earthdawn.h.hotlist");let a=i.map((e=>{try{let i=e.id,s=e.type.toLowerCase(),a=e.name;e.system.hasOwnProperty("ranks")&&(a+=" ("+e.system.ranks+")");let n=[s,t.id,i].join(this.delimiter);return{name:a,id:i,encodedValue:n}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),n=this.initializeEmptySubcategory();n.actions=a;let o=this.i18n("earthdawn.h.hotlist");return this._combineSubcategoryWithCategory(s,o,n),s}_buildTalentsCategory(t){if(!get("showTalents"))return;const e=t.actor;if(["pc","npc"].indexOf(e.type)<0)return;const i=e.items.filter((t=>"talent"===t.type));let s=this.initializeEmptyCategory("talents");s.name=this.i18n("earthdawn.t.talents");let a="talent",n=i.map((e=>{try{let i=e.id,s=e.name+" ("+e.system.ranks+")",n=[a,t.id,i].join(this.delimiter);return{name:s,id:i,encodedValue:n}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("earthdawn.t.talents");return this._combineSubcategoryWithCategory(s,r,o),s}_buildMatrixCategory(t){if(!get("showMatrices")||!t.actor.items.find((t=>"spellmatrix"===t.type)))return;const e=t.actor;if(["pc","npc"].indexOf(e.type)<0)return;const i=e.items.filter((t=>"spellmatrix"===t.type));if(i.length<1)return;let s=this.initializeEmptyCategory("matrix");return s.name=this.i18n("earthdawn.m.matrixes"),i.forEach((e=>{try{let i=this.initializeEmptySubcategory(),a=e.id;i.actions=[{name:this.i18n("earthdawn.a.attune"),id:a,encodedValue:["matrixAttune",t.id,a].join(this.delimiter)},{name:this.i18n("earthdawn.m.matrixWeaveRed"),id:a,encodedValue:["matrixWeave",t.id,a].join(this.delimiter)},{name:this.i18n("earthdawn.m.matrixCastRed"),id:a,encodedValue:["matrixCast",t.id,a].join(this.delimiter)},{name:this.i18n("earthdawn.m.matrixClearRed"),id:a,encodedValue:["matrixClear",t.id,a].join(this.delimiter)}];let n=e.system.currentspell?`${e.system.currentspell} (${e.system.totalthreads}/${e.system.threadsrequired})`:e.name;this._combineSubcategoryWithCategory(s,n,i)}catch(t){throw Logger.error(e),t}})),s}_buildSkillsCategory(t){if(!get("showSkills"))return;const e=t.actor;if(["pc","npc"].indexOf(e.type)<0)return;const i=e.items.filter((t=>"skill"===t.type));let s=this.initializeEmptyCategory("skills");s.name=this.i18n("earthdawn.s.skills");let a="skill",n=i.map((e=>{try{let i=e.id,s=e.name+" ("+e.system.ranks+")",n=[a,t.id,i].join(this.delimiter);return{name:s,id:i,encodedValue:n}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("earthdawn.s.skills");return this._combineSubcategoryWithCategory(s,r,o),s}_buildItemsCategory(t){if(!get("showInventory"))return;const e=t.actor,i=t.id;if(["pc","npc"].indexOf(e.type)<0)return;let s="inventory",a=e.items.filter((t=>["weapon","armor","shield","equipment"].indexOf(t.type)>-1)),n=a.filter((t=>"weapon"===t.type)).map((t=>this._buildItem(i,e,s,t))).sort(((t,e)=>t.name.localeCompare(e.name))),o=this.initializeEmptySubcategory();o.actions=n;let r=a.filter((t=>"armor"===t.type)).map((t=>this._buildItem(i,e,s,t))).sort(((t,e)=>t.name.localeCompare(e.name))),l=this.initializeEmptySubcategory();l.actions=r;let c=a.filter((t=>"shield"===t.type)).map((t=>this._buildItem(i,e,s,t))).sort(((t,e)=>t.name.localeCompare(e.name))),d=this.initializeEmptySubcategory();d.actions=c;let u=a.filter((t=>"equipment"===t.type)).map((t=>this._buildItem(i,e,s,t))).sort(((t,e)=>t.name.localeCompare(e.name))),h=this.initializeEmptySubcategory();h.actions=u;let g=this.i18n("earthdawn.w.weapons"),m=this.i18n("earthdawn.a.armors"),y=this.i18n("earthdawn.s.shields"),p=this.i18n("earthdawn.e.equipment"),b=this.initializeEmptyCategory("inventory");return b.name=this.i18n("earthdawn.i.inventory"),this._combineSubcategoryWithCategory(b,g,o),this._combineSubcategoryWithCategory(b,m,l),this._combineSubcategoryWithCategory(b,y,d),this._combineSubcategoryWithCategory(b,p,h),b}_buildItem(t,e,i,s){const a=s.id??s._id;let n=[i,t,a].join(this.delimiter),o=this._getImage(s),r={name:s.name,id:a,encodedValue:n,img:o};return["weapon","armor","shield"].indexOf(s.type)>=0&&(r.cssClass=!0===s.system.worn?"active":""),r}_buildCombatCategory(t){if(!get("showCombat"))return;let e=t.actor,i=this.initializeEmptyCategory("combat");i.name=this.i18n("earthdawn.c.combat");let s=e.items.filter((t=>"weapon"===t.type&&t.system.worn)).map((i=>this._buildItem(t.id,e,"weaponAttack",i))).sort(((t,e)=>t.name.localeCompare(e.name))),a=this.initializeEmptySubcategory();a.actions=s,this._combineSubcategoryWithCategory(i,`${this.i18n("earthdawn.w.weapons")} ${this.i18n("earthdawn.a.attack")}`,a);const n={"earthdawn.c.combatOptionsAggressive":"tactics.aggressive","earthdawn.c.combatOptionsDefensive":"tactics.defensive","earthdawn.c.combatModifierHarried":"tactics.harried","earthdawn.c.combatModifierKnockedDown":"tactics.knockeddown"};let o=["earthdawn.c.combatOptionsAggressive","earthdawn.c.combatOptionsDefensive","earthdawn.c.combatModifierHarried","earthdawn.c.combatModifierKnockedDown"].map((i=>({name:this.i18n(i),id:null,encodedValue:["toggle",t.id,n[i]].join(this.delimiter),cssClass:!0===e.system.tactics[n[i].split(".")[1]]?"active":""}))).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),r=this.initializeEmptySubcategory();r.actions=o,this._combineSubcategoryWithCategory(i,`${this.i18n("earthdawn.o.option")} & ${this.i18n("earthdawn.m.modifier")}`,r);let l=this.initializeEmptySubcategory();return l.actions=[{name:this.i18n("earthdawn.t.takeDamage"),id:null,encodedValue:["takedamage",t.id,"takedamage"].join(this.delimiter)},{name:this.i18n("earthdawn.c.combatOptionsKnockdownTest"),id:null,encodedValue:["knockdowntest",t.id,"knockdowntest"].join(this.delimiter)},{name:this.i18n("earthdawn.c.combatOptionsJumpUp"),id:null,encodedValue:["jumpup",t.id,"jumpup"].join(this.delimiter)}],this._combineSubcategoryWithCategory(i,this.i18n("earthdawn.a.actions"),l),i}_buildAttacksCategory(t){const e=t.actor;if(["creature"].indexOf(e.type)<0)return;const i=e.items.filter((t=>"Attack"===t.system.powerType));let s=this.initializeEmptyCategory("attacks");s.name=this.i18n("earthdawn.a.attacks");let a="attack",n=i.map((e=>{try{let i=e.id,s=e.name,n=[a,t.id,i].join(this.delimiter);return{name:s,id:i,encodedValue:n}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("earthdawn.a.attack");return this._combineSubcategoryWithCategory(s,r,o),s}_buildCreaturePowersCategory(t){const e=t.actor;if(["creature"].indexOf(e.type)<0)return;const i=e.items.filter((t=>"Power"===t.system.powerType));let s=this.initializeEmptyCategory("powers");s.name=this.i18n("earthdawn.p.powers");let a="power",n=i.map((e=>{try{let i=e.id,s=e.name,n=[a,t.id,i].join(this.delimiter);return{name:s,id:i,encodedValue:n}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("earthdawn.p.power");return this._combineSubcategoryWithCategory(s,r,o),s}_buildCreatureManeuversCategory(t){const e=t.actor;if(["creature"].indexOf(e.type)<0)return;const i=e.items.filter((t=>"Maneuver"===t.system.powerType));let s=this.initializeEmptyCategory("maneuvers");s.name=this.i18n("earthdawn.m.maneuvers");let a="maneuver",n=i.map((e=>{try{let i=e.id,s=e.name,n=[a,t.id,i].join(this.delimiter);return{name:s,id:i,encodedValue:n}}catch(t){return Logger.error(e),null}})).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name))),o=this.initializeEmptySubcategory();o.actions=n;let r=this.i18n("earthdawn.m.maneuver");return this._combineSubcategoryWithCategory(s,r,o),s}_getEntityData(t){return t}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("icons/svg/mystery-man.svg")?"":e}}class RollHandlerBaseED4e extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!==i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2];if("multi"===a)for(let e of canvas.tokens.controlled){let i=e.id;await this._handleMacros(t,s,i,n)}else await this._handleMacros(t,s,a,n)}async _handleMacros(t,e,i,s){let a=super.getActor(i);switch(e){case"skill":case"talent":this.rollTalentMacro(t,i,s);break;case"attack":case"power":case"maneuver":this.handleCreatureActionMacro(t,i,s);break;case"inventory":this.rollInventoryMacro(t,i,s);break;case"toggle":this.toggleDataProperty(t,i,s);break;case"attribute":this.rollAttributeMacro(t,i,s);break;case"recovery":a.recoveryTest();break;case"newday":a.newDay();break;case"halfmagic":a.halfMagic();break;case"matrixAttune":a.attuneMatrix(a.items.get(s));break;case"matrixWeave":a.weaveThread(a.items.get(s));break;case"matrixCast":a.castSpell(a.items.get(s));break;case"matrixClear":a.clearMatrix(a.items.get(s));break;case"weaponAttack":a.rollPrep({weaponID:s,rolltype:"attack"});break;case"takedamage":this.takeDamage(a);break;case"knockdowntest":a.knockdownTest({});break;case"jumpup":a.jumpUpTest()}}rollAttributeMacro(t,e,i){super.getActor(e).rollPrep({attribute:`${i.split(".").slice(-1)}Step`,name:i})}rollTalentMacro(t,e,i){super.getActor(e).rollPrep({talentID:i})}rollInventoryMacro(t,e,i){const s=super.getActor(e).items.get(i);"equipment"===s.type?s.sheet.render(!0):["weapon","armor","shield"].indexOf(s.type)>=0?this.toggleItemWornProperty(t,e,i):Logger.error(s.type," is not a valid actionId for rolling an inventory item")}toggleDataProperty(t,e,i){const s=super.getActor(e);if(i.includes("tactics")){const t=i.split(".")[1];s.update({data:{tactics:{[t]:!s.system.tactics[t]}}})}else{const t=s.data[i];let e="string"===typeof t?this._toggleBooleanString(t):!t;s.update({data:{[i]:e}})}}toggleItemWornProperty(t,e,i){const s=super.getActor(e).items.get(i),a=s.system.worn;let n="string"===typeof a?this._toggleBooleanString(a):!a;s.update({data:{worn:n}})}_toggleBooleanString(t){return t.toLowerCase().includes("true")?"false":t.toLowerCase().includes("false")?"true":"false"}handleCreatureActionMacro(t,e,i){const s=super.getActor(e),a=s.items.get(i);if(0!==a.system.attackstep){const t=0,e=a.system.strain?a.system.strain:0,n=0;let o="Attack"===a.system.powerType?"attack":a.system.attackstep>0?"test":"";const r={itemID:i,steps:a.system.attackstep,talent:a.name,strain:e,type:o,karma:n,modifier:t};s.NPCtest(r)}else s.items.get(i).sheet.render(!0)}async takeDamage(t){let e=await new Promise((t=>{new Dialog({title:this.i18n("earthdawn.t.takeDamage"),content:`\n          <div style="float: left">\n              <label>${this.i18n("earthdawn.d.damage")}: </label>\n              <input id="damage_box" value=0 autofocus/>\n          </div>\n          <div>\n              <label>${this.i18n("earthdawn.t.type")}: </label>\n              <select id="type_box">\n                <option value="physical">Physical</option>\n                <option value="mystic">Mystic</option>\n              </select>\n          </div>\n          <div>\n            <label>${this.i18n("earthdawn.i.ignoreArmor")}?</label>\n            <input type="checkbox" id="ignore_box"/>\n          </div>`,buttons:{ok:{label:this.i18n("earthdawn.o.ok"),callback:e=>{t({damage:e.find("#damage_box").val(),type:e.find("#type_box").val(),ignore:e.find("#ignore_box:checked")})}}},default:"ok"}).render(!0)}));e.ignorearmor=e.ignore.length>0,await t.takeDamage(e)}}class ED4eSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerED4e(t,e)}doGetRollHandler(t){return new RollHandlerBaseED4e}doRegisterSettings(t,e){!function register$2(t,e){game.settings.register(t,"showGeneral",{name:"Show General",hint:"Display category for general rolls like Attributes, Half-Magic or Recovery",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showFavorites",{name:"Show Favorites",hint:"Display category for items marked as favorites",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showTalents",{name:"Show Talents",hint:"Display category for all talents",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showSkills",{name:"Show Skills",hint:"Display category for all skills",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showMatrices",{name:"Show Matrices",hint:"Display category for all spell matrices",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showInventory",{name:"Show Inventory",hint:"Display category for weapons and equipment",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showStatusToggle",{name:"Show Status Toggle",hint:"Display category for toggling system use and conditions",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showCombat",{name:"Show Combat",hint:"Display category for combat (Weapons, Matrices, Favorites, etc.",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}(t,e)}getAvailableRollHandlers(){return{core:"Core Earthdawn 4e"}}}class ActionHandlerGURPS extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!GURPS)return i;if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;return a?(i.actorId=a.id,this._combineCategoryWithList(i,this.i18n("tokenActionHud.attributes"),this._attributes(a,s)),this._combineCategoryWithList(i,this.i18n("tokenActionHud.defenses"),this._defenses(a,s)),Object.keys(a.system.melee).length>0&&this._melee(i,this.i18n("tokenActionHud.melee"),a,s),Object.keys(a.system.ranged).length>0&&this._ranged(i,this.i18n("tokenActionHud.ranged"),a,s),Object.keys(a.system.skills).length>0&&this._addToList(i,this.i18n("tokenActionHud.skills"),a,s,"skills","Sk"),Object.keys(a.system.spells).length>0&&this._addToList(i,this.i18n("tokenActionHud.spells"),a,s,"spells","Sp"),this._advantages(i,a,s),this._equipment(i,a,s),this._addQuickNotes(i,a,s),get("showManeuvers")&&game.combats.combats.find((t=>t.isActive&&!!t.getCombatantByToken(s)))&&this._combineCategoryWithList(i,this.i18n("GURPS.setManeuver"),this._maneuvers(a,s)),this._combineCategoryWithList(i,this.i18n("GURPS.modifierPosture"),this._postures(a,s)),get("showHudTitle")&&(i.hudTitle=t.name),i):i}_advantages(t,e,i){let s=!1,a=this.initializeEmptyCategory("ads");GURPS.recurselist(e.system.ads,((t,e,n)=>{let o=this.initializeEmptySubcategory();this._addNoteOTFs(o,i,t.name+" "+t.notes)&&(s=!0,this._combineSubcategoryWithCategory(a,t.name,o))})),s&&this._combineCategoryWithList(t,this.i18n("GURPS.advantages"),a)}_equipment(t,e,i){let s=!1,a=this.initializeEmptyCategory("eqt");GURPS.recurselist(e.system.equipment.carried,((t,e,n)=>{let o=this.initializeEmptySubcategory();this._addNoteOTFs(o,i,t.name+" "+t.notes)&&(s=!0,this._combineSubcategoryWithCategory(a,t.name,o))})),GURPS.recurselist(e.system.equipment.other,((t,e,n)=>{let o=this.initializeEmptySubcategory();this._addNoteOTFs(o,i,t.name+" "+t.notes)&&(s=!0,this._combineSubcategoryWithCategory(a,t.name,o))})),s&&this._combineCategoryWithList(t,this.i18n("GURPS.equipment"),a)}_addQuickNotes(t,e,i){let s=this.initializeEmptyCategory("qn"),a=this.initializeEmptySubcategory();this._addNoteOTFs(a,i,e.system.additionalresources.qnotes)&&this._combineSubcategoryWithCategory(s,"",a),this._combineCategoryWithList(t,this.i18n("GURPS.quicknotes"),s)}_ranged(t,e,i,s){let a=get("maxListSize"),n=0,o=0,r="ranged",l=this.initializeEmptyCategory(r);GURPS.recurselist(i.system.ranged,((i,c,d)=>{let u=this.initializeEmptySubcategory(),h='"';i.name.includes(h)&&(h="'");let g=i.mode?" ("+i.mode+")":"",m=i.name+g;if(u.actions.push({name:this.i18n("tokenActionHud.attack")+" ("+i.level+")",encodedValue:["otf",s,"R:"+h+m+h].join(this.delimiter)}),!isNaN(parseInt(i.acc))){let t=(i.acc>=0?"+":"")+ +i.acc;u.actions.push({name:this.i18n("tokenActionHud.gurps.addAcc")+" ("+t+")",encodedValue:["otf",s,t+" "+m+" "+this.i18n("GURPS.acc")].join(this.delimiter)})}u.actions.push({name:this.i18n("tokenActionHud.damage")+" ("+i.damage+")",encodedValue:["dam",s,"D:"+h+m+h].join(this.delimiter)}),this._addNoteOTFs(u,s,m+" "+i.notes),this._combineSubcategoryWithCategory(l,m,u),++n>=a&&(n=0,o++,this._combineCategoryWithList(t,e+(o>1?"-"+o:""),l),l=this.initializeEmptyCategory(r+o))})),n>0&&(o++,this._combineCategoryWithList(t,e+(o>1?"-"+o:""),l))}_addToList(t,e,i,s,a,n){let o=get("maxListSize"),r=0,l=0,c=this.initializeEmptyCategory(a);GURPS.recurselist(i.system[a],((i,d,u)=>{if(i.level>0){let d=this.initializeEmptySubcategory(),u='"';i.name.includes(u)&&(u="'"),d.actions.push({name:i.name+" ("+i.level+")",encodedValue:["otf",s,n+":"+u+i.name+u].join(this.delimiter)}),this._addNoteOTFs(d,s,i.name+" "+i.notes),this._combineSubcategoryWithCategory(c,"",d),++r>=o&&(r=0,l++,this._combineCategoryWithList(t,e+(l>1?"-"+l:""),c),c=this.initializeEmptyCategory(a+l))}})),r>0&&(l++,this._combineCategoryWithList(t,e+(l>1?"-"+l:""),c))}_addNoteOTFs(t,e,i){let s=!1;return i&&GURPS.gurpslink(i,!1,!0).forEach((i=>{s=!0,t.actions.push({name:i.text,useRawHtmlName:!0,encodedValue:["otf",e,i.action.orig].join(this.delimiter)})})),s}_melee(t,e,i,s){let a=get("maxListSize"),n=0,o=0,r="melee",l=this.initializeEmptyCategory(r);GURPS.recurselist(i.system.melee,((i,c,d)=>{let u=this.initializeEmptySubcategory(),h='"';i.name.includes(h)&&(h="'");let g=i.mode?" ("+i.mode+")":"",m=i.name+g;u.actions.push({name:this.i18n("tokenActionHud.attack")+" ("+i.level+")",encodedValue:["otf",s,"M:"+h+m+h].join(this.delimiter)}),isNaN(parseInt(i.parry))||u.actions.push({name:this.i18n("GURPS.parry")+" ("+i.parry+")",encodedValue:["otf",s,"P:"+h+m+h].join(this.delimiter)}),isNaN(parseInt(i.block))||u.actions.push({name:this.i18n("GURPS.block")+" ("+i.block+")",encodedValue:["otf",s,"B:"+h+m+h].join(this.delimiter)}),u.actions.push({name:this.i18n("tokenActionHud.damage")+" ("+i.damage+")",encodedValue:["dam",s,"D:"+h+m+h].join(this.delimiter)}),this._addNoteOTFs(u,s,i.name+" "+i.notes),this._combineSubcategoryWithCategory(l,m,u),++n>=a&&(n=0,o++,this._combineCategoryWithList(t,e+(o>1?"-"+o:""),l),l=this.initializeEmptyCategory(r+o))})),n>0&&(o++,this._combineCategoryWithList(t,e+(o>1?"-"+o:""),l))}_maneuvers(t,e){let i=this.initializeEmptyCategory("maneuvers"),s=this.initializeEmptySubcategory();return Object.values(GURPS.Maneuvers.getAll()).forEach((t=>{let i=this.i18n(t.data.label);s.actions.push({name:i,encodedValue:["otf",e,"/man "+i].join(this.delimiter),img:t.icon})})),this._combineSubcategoryWithCategory(i,"",s),i}_postures(t,e){let i=this.initializeEmptyCategory("postures"),s=this.initializeEmptySubcategory(),a={...GURPS.StatusEffect.getAllPostures()};return a[GURPS.StatusEffectStanding]={id:GURPS.StatusEffectStanding,label:GURPS.StatusEffectStandingLabel,icon:"icons/svg/invisible.svg"},Object.values(a).forEach((t=>{s.actions.push({name:this.i18n(t.label),encodedValue:["otf",e,"/st + "+t.id].join(this.delimiter),img:t.icon})})),this._combineSubcategoryWithCategory(i,"",s),i}_defenses(t,e){let i=this.initializeEmptyCategory("defenses"),s=this._addDefense(e,this.i18n("GURPS.dodge")+" ("+t.system.currentdodge+")","DODGE");return this._addDefense(e,this.i18n("tokenActionHud.gurps.retreatDodge")+" ("+(t.system.currentdodge+3)+")","DODGE +3 "+this.i18n("GURPS.modifierDodgeRetreat"),s),this._combineSubcategoryWithCategory(i,"",s),t.system.equippedparry&&(s=this._addDefense(e,this.i18n("GURPS.parry")+" ("+t.system.equippedparry+")","PARRY"),t.system.equippedparryisfencing?this._addDefense(e,this.i18n("tokenActionHud.gurps.retreatParryFencing")+" ("+(t.system.equippedparry+3)+")","PARRY +3 fencing retreat",s):this._addDefense(e,this.i18n("tokenActionHud.gurps.retreatParry")+" ("+(t.system.equippedparry+1)+")","PARRY +1 retreating",s),this._combineSubcategoryWithCategory(i,"",s)),t.system.equippedblock&&(s=this._addDefense(e,this.i18n("GURPS.block")+" ("+t.system.equippedblock+")","BLOCK"),this._addDefense(e,this.i18n("tokenActionHud.gurps.retreatBlock")+" ("+(t.system.equippedblock+1)+")","BLOCK +1 retreating",s),this._combineSubcategoryWithCategory(i,"",s)),i}_addDefense(t,e,i,s){return s||(s=this.initializeEmptySubcategory()),s.actions.push({name:e,encodedValue:["otf",t,i].join(this.delimiter)}),s}_attributes(t,e){let i=this.initializeEmptyCategory("attributes"),s=this.initializeEmptySubcategory();s.actions.push({name:this.i18n("GURPS.attributesHPNAME")+" + 1",encodedValue:["otf",e,"/hp +1"].join(this.delimiter)}),s.actions.push({name:this.i18n("GURPS.attributesHPNAME")+" - 1",encodedValue:["otf",e,"/hp -1"].join(this.delimiter)}),s.actions.push({name:this.i18n("GURPS.attributesFPNAME")+" + 1",encodedValue:["otf",e,"/fp +1"].join(this.delimiter)}),s.actions.push({name:this.i18n("GURPS.attributesFPNAME")+" - 1",encodedValue:["otf",e,"/fp -1"].join(this.delimiter)}),this._combineSubcategoryWithCategory(i,"",s);for(let a in t.system.attributes){let n=t.system.attributes[a].value;if(n>0){let t=this.i18n(`GURPS.attributes${a}`)+" ("+n+")";s=this.initializeEmptySubcategory(),s.actions.push({name:t,encodedValue:["otf",e,a].join(this.delimiter)}),s.actions.push({name:this.i18n("tokenActionHud.gurps.blindRoll")+" "+t,encodedValue:["otf",e,"!"+a].join(this.delimiter)}),this._combineSubcategoryWithCategory(i,this.i18n(`GURPS.attributes${a}NAME`),s)}}for(let a of["vision","hearing","tastesmell","touch"]){s=this.initializeEmptySubcategory();let n=this.i18n(`GURPS.${a}`)+" ("+t.system[a]+")";s.actions.push({name:n,encodedValue:["otf",e,a].join(this.delimiter)}),s.actions.push({name:this.i18n("tokenActionHud.gurps.blindRoll")+" "+n,encodedValue:["otf",e,"!"+a].join(this.delimiter)}),this._combineSubcategoryWithCategory(i,this.i18n(`GURPS.${a}`),s)}let a=!1;s=this.initializeEmptySubcategory();for(let i in t.system.reactions){let n=t.system.reactions[i];a=!0;let o=n.modifier>=0?"+":"",r=n.situation?" "+n.situation:"",l=o+n.modifier+r;this._addNoteOTFs(s,e,"["+l+"]")}a&&this._combineSubcategoryWithCategory(i,this.i18n("GURPS.reaction"),s),a=!1,s=this.initializeEmptySubcategory();for(let i in t.system.conditionalmods){let n=t.system.conditionalmods[i];a=!0;let o=n.modifier>=0?"+":"",r=n.situation?" "+n.situation:"",l=o+n.modifier+r;this._addNoteOTFs(s,e,"["+l+"]")}return a&&this._combineSubcategoryWithCategory(i,this.i18n("GURPS.conditionalMods"),s),i}}class RollHandlerBaseGURPS extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!==i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a);if("multi"===a)for(let e of canvas.tokens.controlled)o=super.getActor(e.id),await this._handleMacros(t,s,o,n);else await this._handleMacros(t,s,o,n)}async _handleMacros(t,e,i,s){switch(e){case"otf":this.executeOTF(t,i,s);break;case"dam":this.executeOTF(t,i,s,!0)}}async executeOTF(t,e,i,s=!1){if(s&&this.isRightClick(t)){let s=GURPS.parselink(i);s.action.calcOnly=!0;let a=await GURPS.performAction(s.action,e),n={...t};n.preventDefault=()=>{},n.currentTarget={...n.currentTarget},n.currentTarget.innerText=a,GURPS.resolveDamageRoll(n,e,a,"",game.user.isGM,!0)}else{let t=GURPS.LastActor;GURPS.SetLastActor(e),GURPS.executeOTF(i).then((e=>GURPS.SetLastActor(t)))}}}class GURPSSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerGURPS(t,e)}doGetRollHandler(t){return new RollHandlerBaseGURPS}doRegisterSettings(t,e){!function register$1(t,e){game.settings.register(t,"showManeuvers",{name:"Show Maneuvers",hint:"Display 'Set Maneuver' button when in combat",scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"maxListSize",{name:"Max Skill/Spell list size",hint:"Split the Skill/Spell lists into multiple columns if they exceeed this length (minimum 10).  You may want to adjust this based on the HUD Scale and your screen size.",scope:"client",config:!0,type:Number,default:20,onChange:i=>{(isNaN(i)||i<10)&&(i=10,game.settings.set(t,"maxListSize",i)),e(i)}})}(t,e)}getAvailableRollHandlers(){return{core:"Core GURPS"}}}class ActionHandlerSpace1889 extends ActionHandler{constructor(t,e){super(t,e)}doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;return a?(i.actorId=a.id,this._combineCategoryWithList(i,this.i18n("tokenActionHud.attributes"),this._abilities(a,s)),this._combineCategoryWithList(i,this.i18n("tokenActionHud.skills"),this._skills(a,s)),null!=a.system.talents.find((t=>t.system.isRollable))&&this._combineCategoryWithList(i,this.i18n("tokenActionHud.talents"),this._talants(a,s)),"vehicle"==a.type&&this._combineCategoryWithList(i,this.i18n("SPACE1889.VehicleManoeuvre"),this._manoeuvre(a,s)),this._combineCategoryWithList(i,this.i18n("tokenActionHud.attack"),this._attacks(a,s)),this._combineCategoryWithList(i,this.i18n("tokenActionHud.defenses"),this._defenses(a,s)),this._combineCategoryWithList(i,this.i18n("tokenActionHud.damage"),this._damage(a,s)),get("showHudTitle")&&(i.hudTitle=t.name),i):i}_defenses(t,e){let i=this.initializeEmptyCategory("defenses");const s="defense";let a=this._addEntry(e,this.i18n("SPACE1889.SecondaryAttributeDef")+" ("+t.system.secondaries.defense.total+")","defense",s);return["creature","vehicle"].includes(t.type)||(this._addEntry(e,this.i18n("SPACE1889.Block")+" ("+t.system.block.value+")","block",s,a),this._addEntry(e,this.i18n("SPACE1889.Parry")+" ("+t.system.parry.value+")","parry",s,a),this._addEntry(e,this.i18n("SPACE1889.Evasion")+" ("+t.system.evasion.value+")","evasion",s,a)),"vehicle"!=t.type&&this._addEntry(e,this.i18n("SPACE1889.ActiveDefense")+" ("+t.system.secondaries.defense.activeTotal+")","activeDefense",s,a),this._addEntry(e,this.i18n("SPACE1889.PassiveDefense")+" ("+t.system.secondaries.defense.passiveTotal+")","passiveDefense",s,a),this._addEntry(e,this.i18n("SPACE1889.TalentVolleAbwehr")+" ("+(t.system.secondaries.defense.total+4)+")","totalDefense",s,a),this._combineSubcategoryWithCategory(i,this.i18n("SPACE1889.SecondaryAttributeDef"),a),i}_addEntry(t,e,i,s,a){return a||(a=this.initializeEmptySubcategory()),a.actions.push({name:e,encodedValue:[s,t,i].join(this.delimiter)}),a}_skills(t,e){let i=this.initializeEmptyCategory("skills"),s=this.initializeEmptySubcategory();for(const i of t.system.skills){this._addEntry(e,i.system.label+" ("+i.system.rating.toString()+")",i.system.id,"skill",s);for(const a of t.system.speciSkills)a.system.underlyingSkillId==i.system.id&&this._addEntry(e,a.system.label+" ("+a.system.rating.toString()+")",a.system.id,"specialization",s)}return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.skills"),s),i}_attacks(t,e){let i=this.initializeEmptyCategory("attacks"),s=this.initializeEmptySubcategory();for(const i of t.system.weapons)this._addEntry(e,i.name+" ("+i.system.attack.toString()+")",i.system.id,"weapon",s);return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.attack"),s),i}_talants(t,e){let i=this.initializeEmptyCategory("talents"),s=this.initializeEmptySubcategory();for(const i of t.system.talents)i.system.isRollable&&this._addEntry(e,i.system.label,i.system.id,"talent",s);return this._combineSubcategoryWithCategory(i,this.i18n("tokenActionHud.talents"),s),i}_manoeuvre(t,e){let i=this.initializeEmptyCategory("manoeuvre"),s=this.initializeEmptySubcategory();if("vehicle"==t.type){let t=Object.entries(game.space1889.config.vehicleManoeuvres).map((t=>{let i=this.i18n(t[1]),s=["manoeuvre",e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:s}}));s.actions=t.filter((t=>!!t))}return this._combineSubcategoryWithCategory(i,this.i18n("SPACE1889.VehicleManoeuvre"),s),i}_damage(t,e){let i=this.initializeEmptyCategory("damage"),s=this._addEntry(e,this.i18n("SPACE1889.Lethal"),"lethal","damage");return this._addEntry(e,this.i18n("SPACE1889.NonLethal"),"nonLethal","damage",s),this._combineSubcategoryWithCategory(i,this.i18n("SPACE1889.AddDamage"),s),i}_abilities(t,e){let i=this.initializeEmptyCategory("abilities"),s=this.initializeEmptySubcategory();const a=t.system.abilities;if(null!=a&&"vehicle"!=t.type){let i=Object.entries(game.space1889.config.abilities).map((t=>{if(0===a[t[0]].value)return;let i=this.i18n(t[1])+"("+a[t[0]].total?.toString()+")",s=["primary",e,t[0]].join(this.delimiter);return{name:i,id:t[0],encodedValue:s}}));s.actions=i.filter((t=>!!t)),this._addEntry(e,this.i18n("SPACE1889.SecondaryAttributePer")+" ("+t.system.secondaries.perception.total?.toString()+")","perception","secondary",s)}return this._combineSubcategoryWithCategory(i,this.i18n("SPACE1889.AbilityPl"),s),i}}class RollHandlerBaseSpace1889 extends RollHandler{constructor(){super()}async doHandleActionEvent(t,e){let i=e.split("|");3!==i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a);if("multi"===a)for(let e of canvas.tokens.controlled)o=super.getActor(e.id),await this._handleMacros(t,s,o,n);else await this._handleMacros(t,s,o,n)}async _handleMacros(t,e,i,s){switch(e){case"primary":this.executePrimary(t,i,s);break;case"secondary":this.executeSecondary(t,i,s);break;case"skill":this.executeSkill(t,i,s);break;case"specialization":this.executeSpecialization(t,i,s);break;case"talent":this.executeTalent(t,i,s);break;case"weapon":this.executeWeapon(t,i,s);break;case"manoeuvre":this.executeManoeuvre(t,i,s);break;case"defense":this.executeDefense(t,i,s);break;case"damage":this.executeDamage(i,s)}}executePrimary(t,e,i){e.rollPrimary(i,t)}executeSecondary(t,e,i){e.rollSecondary(i,t)}executeSkill(t,e,i){e.rollSkill(i,t)}executeSpecialization(t,e,i){e.rollSpecialization(i,t)}executeTalent(t,e,i){e.rollTalent(i,t)}executeManoeuvre(t,e,i){e.rollManoeuvre(i,t)}executeWeapon(t,e,i){e.rollAttack(i,t)}executeDefense(t,e,i){e.rollDefense(i,t)}executeDamage(t,e){t.addDamage(e)}}class Space1889SystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerSpace1889(t,e)}doGetRollHandler(t){return new RollHandlerBaseSpace1889}doRegisterSettings(t,e){!function register(t,e){game.settings.register(t,"maxListSize",{name:"Max Skill/Spell list size",hint:"Split the Skill/Spell lists into multiple columns if they exceeed this length (minimum 10).  You may want to adjust this based on the HUD Scale and your screen size.",scope:"client",config:!0,type:Number,default:20,onChange:i=>{i<10&&(i=10,game.settings.set(t,"maxListSize",i)),e(i)}})}(t,e)}getAvailableRollHandlers(){return{core:"Core Space1889"}}}class ActionHandlerCoC7 extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;if(!["character","npc","creature"].includes(a.type))return i;i.actorId=a.id;let n=this._getActions(a,s),o=this._getSkills(a,s);return this._combineCategoryWithList(i,this.i18n("tokenActionHud.actions"),n),this._combineCategoryWithList(i,this.i18n("tokenActionHud.skills"),o),get("showHudTitle")&&(i.hudTitle=t.name),i}_getActions(t,e){let i=this.initializeEmptyCategory("actions"),s=this.initializeEmptySubcategory(),a=this.initializeEmptySubcategory(),n=this.initializeEmptySubcategory();for(let i in t.system.characteristics)s.actions.push({name:this.i18n(t.system.characteristics[i].label),encodedValue:["characteristic",e,i].join(this.delimiter)});t.system.attribs.lck.value&&s.actions.push({name:t.system.attribs.lck.label,encodedValue:["attribute",e,"lck"].join(this.delimiter)}),t.system.attribs.san.value&&s.actions.push({name:t.system.attribs.san.label,encodedValue:["attribute",e,"san"].join(this.delimiter)}),s.actions.length&&s.actions.sort(((t,e)=>t.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase().localeCompare(e.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase()))),this._combineSubcategoryWithCategory(i,this.i18n("CoC7.Entities."+t.type.charAt(0).toUpperCase()+t.type.slice(1)),s);for(let i of t.items)"weapon"===i.type&&(i.system.properties?.rngd?n.actions.push({name:i.name,encodedValue:["weapon",e,i.id].join(this.delimiter)}):a.actions.push({name:i.name,encodedValue:["weapon",e,i.id].join(this.delimiter)}));return a.actions.length&&(a.actions.sort(((t,e)=>t.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase().localeCompare(e.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase()))),this._combineSubcategoryWithCategory(i,this.i18n("CoC7.MeleeWeapons"),a)),n.actions.length&&(n.actions.sort(((t,e)=>t.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase().localeCompare(e.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase()))),this._combineSubcategoryWithCategory(i,this.i18n("CoC7.RangeWeapons"),n)),i}_getSkills(t,e){let i=this.initializeEmptyCategory("skills"),s=this.initializeEmptySubcategory();for(let i of t.items)"skill"===i.type&&s.actions.push({name:i.name,encodedValue:["skill",e,i.name].join(this.delimiter)});return s.actions.length&&s.actions.sort(((t,e)=>t.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase().localeCompare(e.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLocaleLowerCase()))),this._combineSubcategoryWithCategory(i,this.i18n("CoC7.Entities."+t.type.charAt(0).toUpperCase()+t.type.slice(1)),s),i}}class RollHandlerBaseCoC7 extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){console.log("doHandleActionEvent",t,e);let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a);switch(s){case"characteristic":o.characteristicCheck(n,t.shiftKey);break;case"attribute":o.attributeCheck(n,t.shiftKey);break;case"weapon":o.weaponCheck({id:n},t.shiftKey);break;case"skill":o.skillCheck({name:n},t.shiftKey)}}}class CoC7SystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerCoC7(t,e)}getAvailableRollHandlers(){return{core:"Core CoC7"}}doGetRollHandler(t){return new RollHandlerBaseCoC7}doRegisterSettings(t,e){}}class ActionHandlerCypherSystem extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;if("pc"!==a.type)return i;let n=this._getPools(a,s),o=this._getSkills(a,s),r=this._getCombat(a,s),l=this._getAbilities(a,s);return this._combineCategoryWithList(i,this.i18n("tokenActionHud.pools"),n),this._combineCategoryWithList(i,this.i18n("tokenActionHud.skills"),o),this._combineCategoryWithList(i,this.i18n("tokenActionHud.combat"),r),this._combineCategoryWithList(i,this.i18n("tokenActionHud.abilities"),l),get("showHudTitle")&&(i.hudTitle=t.name),i}_getPools(t,e){let i=this.initializeEmptyCategory("pools"),s=this.initializeEmptySubcategory();this.initializeEmptySubcategory(),this.initializeEmptySubcategory();for(const t of["might","speed","intellect"])s.actions.push({name:this.i18n(`CYPHERSYSTEM.${t.capitalize()}`),encodedValue:["pool",e,t.capitalize()].join(this.delimiter)});return this._combineSubcategoryWithCategory(i,this.i18n(`ACTOR.Type${t.type.capitalize()}`),s),i}_getCombat(t,e){let i=this.initializeEmptyCategory("combat"),s=this.initializeEmptySubcategory();for(const i of t.items.filter((t=>"attack"===t.type)))s.actions.push({name:i.name,encodedValue:["attack",e,i.id].join(this.delimiter)});return this._combineSubcategoryWithCategory(i,this.i18n(`ACTOR.Type${t.type.capitalize()}`),s),i}createList(t,e,i,s,a,n){let o=this.initializeEmptySubcategory();for(const t of e.items.filter((t=>t.type===s&&t.system.settings.general.sorting===a)))o.actions.push({name:t.name,encodedValue:[s,i,t.id].join(this.delimiter)});o.actions.length&&this._combineSubcategoryWithCategory(t,this.i18n(n),o)}_getSkills(t,e){let i=this.initializeEmptyCategory("skills");const s={Skill:t.system.settings.skills.labelCategory1||"CYPHERSYSTEM.Skills",SkillTwo:t.system.settings.skills.labelCategory2||"CYPHERSYSTEM.SkillCategoryTwo",SkillThree:t.system.settings.skills.labelCategory3||"CYPHERSYSTEM.SkillCategoryThree",SkillFour:t.system.settings.skills.labelCategory4||"CYPHERSYSTEM.SkillCategoryFour"};for(const a of Object.keys(s))this.createList(i,t,e,"skill",a,s[a]);return i}_getAbilities(t,e){let i=this.initializeEmptyCategory("abilities");const s={Ability:t.system.settings.abilities.labelCategory1||"CYPHERSYSTEM.Abilities",AbilityTwo:t.system.settings.abilities.labelCategory2||"CYPHERSYSTEM.AbilityCategoryTwo",AbilityThree:t.system.settings.abilities.labelCategory3||"CYPHERSYSTEM.AbilityCategoryThree",AbilityFour:t.system.settings.abilities.labelCategory4||"CYPHERSYSTEM.AbilityCategoryFour",Spell:"CYPHERSYSTEM.Spells"};for(const a of Object.keys(s))this.createList(i,t,e,"ability",a,s[a]);return i}}class RollHandlerBaseCypherSystem extends RollHandler{doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a);switch(s){case"pool":game.cyphersystem.rollEngineMain({actorUuid:o.uuid,pool:n});break;case"attack":case"skill":game.cyphersystem.itemRollMacro(o,n,"","","","","","","","","","","","",!1,"");break;case"ability":game.cyphersystem.itemRollMacro(o,n,"","","","","","","","","","","","",!0,"")}}}class CypherSystemSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerCypherSystem(t,e)}getAvailableRollHandlers(){return{core:"Core Cypher System"}}doGetRollHandler(t){return new RollHandlerBaseCypherSystem}doRegisterSettings(t,e){}}class ActionHandlerCleenmain extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;i.actorId=a.id,a.type;let n=this._getWeapons(a,s),o=this._getSkills(a,s);return this._combineCategoryWithList(i,this.i18n("tokenActionHud.skills"),o),this._combineCategoryWithList(i,this.i18n("tokenActionHud.weapons"),n),get("showHudTitle")&&(i.hudTitle=t.name),i}_getSkills(t,e){let i=t.items.filter((t=>"skill"==t.type)).sort((function(t,e){return t.name.localeCompare(e.name)})),s=this.initializeEmptyCategory("actorSkills"),a=this.initializeEmptySubcategory();return a.actions=this._produceMap(e,i,"skill"),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.roll"),a),s}_getWeapons(t,e){let i=t.items.filter((t=>"weapon"===t.type)),s=this.initializeEmptyCategory("actorWeapons"),a=this.initializeEmptySubcategory();return a.actions=this._produceMap(e,i,"weapon"),this._combineSubcategoryWithCategory(s,this.i18n("tokenActionHud.roll"),a),s}_produceMap(t,e,i){return e.map((e=>{let s=[i,t,e.id].join(this.delimiter),a=this._getImage(e);return{name:e.name,encodedValue:s,id:e.id,img:a}}))}_getImage(t){let e="";return get("showIcons")&&(e=t.img??""),e?.includes("systems/cleenmain/assets/image/default.png")?"":e}}class RollHandlerBaseCleenmain extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();let s=i[0],a=i[1],n=i[2],o=super.getActor(a);switch(s){case"weapon":this._handleWeapon(s,t,o,n);break;case"skill":this._handleSkill(s,t,o,n)}}_handleWeapon(t,e,i,s){return i.check(s,"weapon-attack")}_handleSkill(t,e,i,s){return i.check(s,"skill")}}class CleenmainSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return console.log("startup"),new ActionHandlerCleenmain(t,e)}getAvailableRollHandlers(){return{core:"Core Cle en main"}}doGetRollHandler(t){return new RollHandlerBaseCleenmain}doRegisterSettings(t,e){}}class ActionHandlerSWN extends ActionHandler{constructor(t,e){super(t,e)}async doBuildActionList(t,e){let i=this.initializeEmptyActionList();if(!t)return i;let s=t.id;i.tokenId=s;let a=t.actor;if(!a)return i;i.actorId=a.id;let n=this._buildInventoryCategory(a,s);this._combineCategoryWithList(i,this.i18n("tokenActionHud.inventory"),n);let o=this._buildSkillsCategory(a,s);this._combineCategoryWithList(i,this.i18n("tokenActionHud.skills"),o);let r=this._buildAbilitiesCategory(a,s);this._combineCategoryWithList(i,this.i18n("tokenActionHud.abilities"),r);let l=this._buildShipCategory(a,s);return this._combineCategoryWithList(i,this.i18n("ship"),l),i}_buildInventoryCategory(t,e){let i=this.initializeEmptyCategory("inventory"),s="item",a=t.items,n=a.filter((t=>"weapon"===t.type&&"readied"===t.system.location)),o=this._produceMap(e,n,s),r=this.initializeEmptySubcategory();r.actions=o,this._combineSubcategoryWithCategory(i,"weapons",r);let l=a.filter((t=>"item"===t.type&&"readied"===t.system.location)),c=this._produceMap(e,l,s),d=this.initializeEmptySubcategory("misc");return d.actions=c,this._combineSubcategoryWithCategory(i,"misc",d),i}_buildSkillsCategory(t,e){let i=this.initializeEmptyCategory("skills"),s=t.items.filter((t=>"skill"===t.type)),a=this._produceMap(e,s,"skill"),n=this.initializeEmptySubcategory();return n.actions=a,this._combineSubcategoryWithCategory(i,"skills",n),i}_buildAbilitiesCategory(t,e){let i=this.initializeEmptyCategory("focus"),s=t.items.filter((t=>"cyberware"===t.type)),a=this._produceMap(e,s,"cyberware"),n=this.initializeEmptySubcategory();n.actions=a,this._combineSubcategoryWithCategory(i,"cyberware",n);let o=t.items.filter((t=>"focus"===t.type)),r=this._produceMap(e,o,"focus"),l=this.initializeEmptySubcategory();l.actions=r,this._combineSubcategoryWithCategory(i,"focus",l);let c=t.items.filter((t=>"power"===t.type)),d=this._produceMap(e,c,"power"),u=this.initializeEmptySubcategory();return u.actions=d,this._combineSubcategoryWithCategory(i,"powers",u),i}_buildShipCategory(t,e){let i=this.initializeEmptyCategory("shipFitting"),s=t.items.filter((t=>"shipWeapon"===t.type)),a=this._produceMap(e,s,"shipWeapon"),n=this.initializeEmptySubcategory();n.actions=a,this._combineSubcategoryWithCategory(i,"Weapons",n);let o=t.items.filter((t=>"shipFitting"===t.type)),r=this._produceMap(e,o,"shipFitting"),l=this.initializeEmptySubcategory();return l.actions=r,this._combineSubcategoryWithCategory(i,"Fittings",l),i}_produceMap(t,e,i){return e.filter((t=>!!t)).map((e=>{let s=[i,t,e.id].join(this.delimiter);return{name:e.name,encodedValue:s,id:e.id}}))}}class RollHandlerBaseSWN extends RollHandler{constructor(){super()}doHandleActionEvent(t,e){let i=e.split("|");3!=i.length&&super.throwInvalidValueErr();i[0];let s=i[1],a=i[2],n=super.getActor(s);this.rollItemMacro(t,n,a)}rollItemMacro(t,e,i){e.items.get(i).roll()}}class SWNSystemManager extends SystemManager{constructor(t){super(t)}doGetActionHandler(t,e){return new ActionHandlerSWN(t,e)}getAvailableRollHandlers(){return{core:"Core Star Without Number"}}doGetRollHandler(t){return new RollHandlerBaseSWN}doRegisterSettings(t,e){}}const r="token-action-hud-rotv";let l;function sendHudToBottom(){game.tokenActionHUD&&(game.tokenActionHUD.element[0].style.zIndex=0)}Hooks.on("init",(()=>{!function registerHandlerbars(){Handlebars.registerHelper("cap",(function(t){return!t||t.length<1?"":t[0].toUpperCase()+t.slice(1)})),Handlebars.registerHelper("ifCond",(function(t,e,i,s){switch(e){case"==":return t==i?s.fn(this):s.inverse(this);case"===":return t===i?s.fn(this):s.inverse(this);case"!=":return t!=i?s.fn(this):s.inverse(this);case"!==":return t!==i?s.fn(this):s.inverse(this);case"<":return t<i?s.fn(this):s.inverse(this);case"<=":return t<=i?s.fn(this):s.inverse(this);case">":return t>i?s.fn(this):s.inverse(this);case">=":return t>=i?s.fn(this):s.inverse(this);case"&&":return t&&i?s.fn(this):s.inverse(this);case"||":return t||i?s.fn(this):s.inverse(this);default:return s.inverse(this)}})),Handlebars.registerHelper("activeText",(function(t){return get("activeCssAsText")?t.fn(this):t.inverse(this)})),loadTemplates(["modules/token-action-hud-rotv/templates/category.hbs","modules/token-action-hud-rotv/templates/subcategory.hbs","modules/token-action-hud-rotv/templates/actionSet.hbs","modules/token-action-hud-rotv/templates/action.hbs","modules/token-action-hud-rotv/templates/tagdialog.hbs"])}(),game.modules.get("token-action-hud-rotv").api={},game.settings.register(r,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1});const t={alienrpg:"alienrpg","blades-in-the-dark":"blades-in-the-dark",cleenmain:"cleenmain",coc:"coc",CoC7:"CoC7",cof:"cof",cthack:"cthack",cyphersystem:"cyphersystem",D35E:"D35E",dnd4e:"dnd4e",rotv:"rotv",demonlord:"demonlord",ds4:"ds4",dungeonworld:"dungeonworld",earthdawn4e:"earthdawn4e","forbidden-lands":"forbidden-lands",gurps:"gurps",kamigakari:"kamigakari",lancer:"lancer",od6s:"od6s",pf1:"pf1",pf2e:"pf2e",sfrpg:"sfrpg",space1889:"space1889",starwarsffg:"starwarsffg",sw5e:"sw5e",swade:"swade",swnr:"swnr",symbaroum:"symbaroum",tagmar:"tagmar",tagmar_rpg:"tagmar_rpg",tormenta20:"tormenta20",wfrp4e:"wfrp4e"};Hooks.call("preCreateTAHSystemManager",t);const e=t[game.system.id];e||console.error("Token Action HUD: System not supported"),l=class SystemManagerFactory{static create(t,e){switch(t){case"blades-in-the-dark":return new BitDSystemManager(e);case"cyphersystem":return new CypherSystemSystemManager(e);case"demonlord":return new DemonlordSystemManager(e);case"rotv":return new RotVSystemManager(e);case"dungeonworld":return new DungeonWorldSystemManager(e);case"pf1":return new Pf1SystemManager(e);case"D35E":return new D35ESystemManager(e);case"od6s":return new OD6SSystemManager(e);case"pf2e":return new Pf2eSystemManager(e);case"sfrpg":return new SfrpgSystemManager(e);case"sw5e":return new SW5eSystemManager(e);case"wfrp4e":return new Wfrp4eSystemManager(e);case"lancer":return new LancerSystemManager(e);case"swade":return new SwadeSystemManager(e);case"starwarsffg":return new StarWarsFFGSystemManager(e);case"tormenta20":return new Tormenta20SystemManager(e);case"symbaroum":return new SymbaroumSystemManager(e);case"alienrpg":return new AlienrpgSystemManager(e);case"cthack":return new CthackSystemManager(e);case"kamigakari":return new KamigakariSystemManager(e);case"tagmar":case"tagmar_rpg":return new TagmarSystemManager(e);case"ds4":return new Ds4SystemManager(e);case"cof":case"coc":return new CoSystemManager(e);case"forbidden-lands":return new ForbiddenLandsSystemManager(e);case"dnd4e":return new DnD4eSystemManager(e);case"earthdawn4e":return new ED4eSystemManager(e);case"gurps":return new GURPSSystemManager(e);case"space1889":return new Space1889SystemManager(e);case"CoC7":return new CoC7SystemManager(e);case"cleenmain":return new CleenmainSystemManager(e);case"swnr":return new SWNSystemManager(e)}}}.create(e,r),l.registerSettings(),switchCSS(game.settings.get(l.appName,"style"))})),Hooks.on("renderSceneNavigation",((t,e)=>{e.find("li.scene.nav-item").contextmenu((t=>{sendHudToBottom()}))})),Hooks.on("renderHotbar",((t,e)=>{e.find("li.macro").contextmenu((t=>{sendHudToBottom()}))})),Hooks.once("ready",(async()=>{if(game.user.isGM&&!game.modules.get("lib-themer")?.active&&!game.modules.get("color-picker")?.active&&!game.modules.get("colorsettings")?.active){!1===game.settings.get(r,"startup")&&(ui.notifications.notify("Token Action HUD: To set colors within this module's settings, install and enable one of the following 'Color Picker', 'Color Settings' or 'libThemer' modules."),game.settings.set(r,"startup",!0))}})),Hooks.on("canvasReady",(async()=>{let t=game.user;if(!t)throw new Error("Token Action HUD | No user found.");game.tokenActionHUD||(game.tokenActionHUD=new TokenActionHUD(l),await game.tokenActionHUD.init(t)),game.tokenActionHUD.setTokensReference(canvas.tokens),Hooks.on("controlToken",((t,e)=>{game.tokenActionHUD.update()})),Hooks.on("updateToken",((t,e,i,s,a)=>{i.hasOwnProperty("y")||i.hasOwnProperty("x")||game.tokenActionHUD.validTokenChange(e)&&game.tokenActionHUD.update()})),Hooks.on("deleteToken",((t,e,i,s)=>{game.tokenActionHUD.validTokenChange(e)&&game.tokenActionHUD.update()})),Hooks.on("hoverToken",((t,e)=>{game.tokenActionHUD.validTokenHover(t,e)&&game.tokenActionHUD.update()})),Hooks.on("updateActor",(t=>{game.tokenActionHUD.validActorOrItemUpdate(t)&&game.tokenActionHUD.update()})),Hooks.on("deleteActor",(t=>{game.tokenActionHUD.validActorOrItemUpdate(t)&&game.tokenActionHUD.update()})),Hooks.on("deleteItem",(t=>{let e=t.actor;game.tokenActionHUD.validActorOrItemUpdate(e)&&game.tokenActionHUD.update()})),Hooks.on("createItem",(t=>{let e=t.actor;game.tokenActionHUD.validActorOrItemUpdate(e)&&game.tokenActionHUD.update()})),Hooks.on("updateItem",(t=>{let e=t.actor;game.tokenActionHUD.validActorOrItemUpdate(e)&&game.tokenActionHUD.update()})),Hooks.on("renderTokenActionHUD",(()=>{game.tokenActionHUD.applySettings(),game.tokenActionHUD.trySetPos()})),Hooks.on("renderCompendium",((t,e)=>{let i=t?.metadata;game.tokenActionHUD.isLinkedCompendium(`${i?.package}.${i?.name}`)&&game.tokenActionHUD.update()})),Hooks.on("deleteCompendium",((t,e)=>{let i=t?.metadata;game.tokenActionHUD.isLinkedCompendium(`${i?.package}.${i?.name}`)&&game.tokenActionHUD.update()})),Hooks.on("createCombat",(t=>{game.tokenActionHUD.update()})),Hooks.on("deleteCombat",(t=>{game.tokenActionHUD.update()})),Hooks.on("updateCombat",(t=>{game.tokenActionHUD.update()})),Hooks.on("updateCombatant",((t,e)=>{game.tokenActionHUD.update()})),Hooks.on("forceUpdateTokenActionHUD",(()=>{game.tokenActionHUD.update()})),Hooks.on("createActiveEffect",(()=>{game.tokenActionHUD.update()})),Hooks.on("deleteActiveEffect",(()=>{game.tokenActionHUD.update()})),game.tokenActionHUD.update()}))}));
