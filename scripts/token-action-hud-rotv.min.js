const e={ID:"token-action-hud-rotv"},t={ID:"token-action-hud-core"},s="1.5",i={ability:"ROTV.Ability",check:"tokenActionHud.rotv.check",condition:"tokenActionHud.rotv.condition",counter:"tokenActionHud.rotv.counter",effect:"ROTV.Effect",exhaustion:"ROTV.Exhaustion",feature:"ITEM.TypeFeat",item:"tokenActionHud.rotv.item",save:"ROTV.ActionSave",skill:"tokenActionHud.rotv.skill",spell:"ITEM.TypeSpell",utility:"ROTV.ActionUtil"},n={bonus:"fas fa-plus",crew:"fas fa-users",day:"fas fa-hourglass-end",hour:"fas fa-hourglass-half",lair:"fas fa-home",minute:"fas fa-hourglass-start",legendary:"fas fas fa-dragon",reaction:"fas fa-bolt",special:"fas fa-star"},a="systems/rotv/icons/svg/statuses/concentrating.svg",o={blind:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.0b8N4FymGGfbZGpJ"},blinded:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.0b8N4FymGGfbZGpJ"},"Convenient Effect: Blinded":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.0b8N4FymGGfbZGpJ"},charmed:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.zZaEBrKkr66OWJvD"},"Convenient Effect: Charmed":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.zZaEBrKkr66OWJvD"},deaf:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.6G8JSjhn701cBITY"},deafened:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.6G8JSjhn701cBITY"},"Convenient Effect: Deafened":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.6G8JSjhn701cBITY"},fear:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.oreoyaFKnvZCrgij"},"Convenient Effect: Frightened":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.oreoyaFKnvZCrgij"},frightened:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.oreoyaFKnvZCrgij"},grappled:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.gYDAhd02ryUmtwZn"},"Convenient Effect: Grappled":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.gYDAhd02ryUmtwZn"},incapacitated:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.TpkZgLfxCmSndmpb"},"Convenient Effect: Incapacitated":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.TpkZgLfxCmSndmpb"},invisible:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.3UU5GCTVeRDbZy9u"},"Convenient Effect: Invisible":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.3UU5GCTVeRDbZy9u"},paralysis:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.xnSV5hLJIMaTABXP"},paralyzed:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.xnSV5hLJIMaTABXP"},"Convenient Effect: Paralyzed":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.xnSV5hLJIMaTABXP"},petrified:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.xaNDaW6NwQTgHSmi"},"Convenient Effect: Petrified":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.xaNDaW6NwQTgHSmi"},poison:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.lq3TRI6ZlED8ABMx"},poisoned:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.lq3TRI6ZlED8ABMx"},"Convenient Effect: Poisoned":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.lq3TRI6ZlED8ABMx"},prone:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.y0TkcdyoZlOTmAFT"},"Convenient Effect: Prone":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.y0TkcdyoZlOTmAFT"},restrain:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.cSVcyZyNe2iG1fIc"},restrained:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.cSVcyZyNe2iG1fIc"},"Convenient Effect: Restrained":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.cSVcyZyNe2iG1fIc"},stun:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.ZyZMUwA2rboh4ObS"},stunned:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.ZyZMUwA2rboh4ObS"},"Convenient Effect: Stunned":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.ZyZMUwA2rboh4ObS"},unconscious:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.UWw13ISmMxDzmwbd"},"Convenient Effect: Unconscious":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.UWw13ISmMxDzmwbd"},exhaustion:{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.cspWveykstnu3Zcv"},"Convenient Effect: Exhaustion 1":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.cspWveykstnu3Zcv"},"Convenient Effect: Exhaustion 2":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.cspWveykstnu3Zcv"},"Convenient Effect: Exhaustion 3":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.cspWveykstnu3Zcv"},"Convenient Effect: Exhaustion 4":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.cspWveykstnu3Zcv"},"Convenient Effect: Exhaustion 5":{uuid:"Compendium.rotv.rules.JournalEntry.w7eitkpD7QQTB6j0.JournalEntryPage.cspWveykstnu3Zcv"}},l={_1stLevelSpells:{id:"1st-level-spells",name:"tokenActionHud.rotv.1stLevelSpells",type:"system"},_2ndLevelSpells:{id:"2nd-level-spells",name:"tokenActionHud.rotv.2ndLevelSpells",type:"system"},_3rdLevelSpells:{id:"3rd-level-spells",name:"tokenActionHud.rotv.3rdLevelSpells",type:"system"},_4thLevelSpells:{id:"4th-level-spells",name:"tokenActionHud.rotv.4thLevelSpells",type:"system"},_5thLevelSpells:{id:"5th-level-spells",name:"tokenActionHud.rotv.5thLevelSpells",type:"system"},_6thLevelSpells:{id:"6th-level-spells",name:"tokenActionHud.rotv.6thLevelSpells",type:"system"},_7thLevelSpells:{id:"7th-level-spells",name:"tokenActionHud.rotv.7thLevelSpells",type:"system"},_8thLevelSpells:{id:"8th-level-spells",name:"tokenActionHud.rotv.8thLevelSpells",type:"system"},_9thLevelSpells:{id:"9th-level-spells",name:"tokenActionHud.rotv.9thLevelSpells",type:"system"},abilities:{id:"abilities",name:"tokenActionHud.rotv.abilities",type:"system"},actions:{id:"actions",name:"ROTV.ActionPl",type:"system"},activeFeatures:{id:"active-features",name:"tokenActionHud.rotv.activeFeatures",type:"system"},artificerInfusions:{id:"artificer-infusions",name:"tokenActionHud.rotv.artificerInfusions",type:"system"},atWillSpells:{id:"at-will-spells",name:"tokenActionHud.rotv.atWillSpells",type:"system"},backgroundFeatures:{id:"background-features",name:"tokenActionHud.rotv.backgroundFeatures",type:"system"},bonusActions:{id:"bonus-actions",name:"tokenActionHud.rotv.bonusActions",type:"system"},cantrips:{id:"cantrips",name:"tokenActionHud.rotv.cantrips",type:"system"},channelDivinity:{id:"channel-divinity",name:"tokenActionHud.rotv.channelDivinity",type:"system"},checks:{id:"checks",name:"tokenActionHud.rotv.checks",type:"system"},classFeatures:{id:"class-features",name:"tokenActionHud.rotv.classFeatures",type:"system"},combat:{id:"combat",name:"tokenActionHud.combat",type:"system"},conditions:{id:"conditions",name:"tokenActionHud.rotv.conditions",type:"system"},consumables:{id:"consumables",name:"ITEM.TypeConsumablePl",type:"system"},containers:{id:"containers",name:"ITEM.TypeContainerPl",type:"system"},counters:{id:"counters",name:"tokenActionHud.rotv.counters",type:"system"},crewActions:{id:"crew-actions",name:"tokenActionHud.rotv.crewActions",type:"system"},defensiveTactics:{id:"defensive-tactics",name:"tokenActionHud.rotv.defensiveTactics",type:"system"},eldritchInvocations:{id:"eldritch-invocations",name:"tokenActionHud.rotv.eldritchInvocations",type:"system"},elementalDisciplines:{id:"elemental-disciplines",name:"tokenActionHud.rotv.elementalDisciplines",type:"system"},equipment:{id:"equipment",name:"ITEM.TypeEquipmentPl",type:"system"},equipped:{id:"equipped",name:"ROTV.Equipped",type:"system"},exhaustion:{id:"exhaustion",name:"ROTV.Exhaustion",type:"system"},feats:{id:"feats",name:"tokenActionHud.rotv.feats",type:"system"},fightingStyles:{id:"fighting-styles",name:"tokenActionHud.rotv.fightingStyles",type:"system"},huntersPrey:{id:"hunters-prey",name:"tokenActionHud.rotv.huntersPrey",type:"system"},innateSpells:{id:"innate-spells",name:"tokenActionHud.rotv.innateSpells",type:"system"},kiAbilities:{id:"ki-abilities",name:"tokenActionHud.rotv.kiAbilities",type:"system"},lairActions:{id:"lair-actions",name:"tokenActionHud.rotv.lairActions",type:"system"},legendaryActions:{id:"legendary-actions",name:"tokenActionHud.rotv.legendaryActions",type:"system"},loot:{id:"loot",name:"ITEM.TypeLootPl",type:"system"},maneuvers:{id:"maneuvers",name:"tokenActionHud.rotv.maneuvers",type:"system"},metamagicOptions:{id:"metamagic-options",name:"tokenActionHud.rotv.metamagicOptions",type:"system"},monsterFeatures:{id:"monster-features",name:"tokenActionHud.rotv.monsterFeatures",type:"system"},multiattacks:{id:"multiattacks",name:"tokenActionHud.rotv.multiattacks",type:"system"},otherActions:{id:"other-actions",name:"tokenActionHud.rotv.otherActions",type:"system"},pactBoons:{id:"pact-boons",name:"tokenActionHud.rotv.pactBoons",type:"system"},pactSpells:{id:"pact-spells",name:"tokenActionHud.rotv.pactSpells",type:"system"},passiveEffects:{id:"passive-effects",name:"ROTV.EffectPassive",type:"system"},passiveFeatures:{id:"passive-features",name:"tokenActionHud.rotv.passiveFeatures",type:"system"},psionicPowers:{id:"psionic-powers",name:"tokenActionHud.rotv.psionicPowers",type:"system"},raceFeatures:{id:"race-features",name:"tokenActionHud.rotv.raceFeatures",type:"system"},reactions:{id:"reactions",name:"ROTV.ReactionPl",type:"system"},rests:{id:"rests",name:"tokenActionHud.rotv.rests",type:"system"},runes:{id:"runes",name:"tokenActionHud.rotv.runes",type:"system"},saves:{id:"saves",name:"ROTV.ClassSaves",type:"system"},skills:{id:"skills",name:"tokenActionHud.rotv.skills",type:"system"},superiorHuntersDefense:{id:"superior-hunters-defense",name:"tokenActionHud.rotv.superiorHuntersDefense",type:"system"},temporaryEffects:{id:"temporary-effects",name:"ROTV.EffectTemporary",type:"system"},token:{id:"token",name:"tokenActionHud.token",type:"system"},tools:{id:"tools",name:"ITEM.TypeToolPl",type:"system"},unequipped:{id:"unequipped",name:"ROTV.Unequipped",type:"system"},utility:{id:"utility",name:"tokenActionHud.utility",type:"system"},weapons:{id:"weapons",name:"ITEM.TypeWeaponPl",type:"system"}},r="fas fa-sun",c={.5:"fas fa-adjust",1:"fas fa-check",2:"fas fa-check-double"},p={common:"tokenActionHud.rotv.common",uncommon:"tokenActionHud.rotv.uncommon",rare:"tokenActionHud.rotv.rare",veryRare:"tokenActionHud.rotv.veryRare",legendary:"tokenActionHud.rotv.legendary",artifact:"tokenActionHud.rotv.artifact"},u="fas fa-circle-r",d={ada:"ROTV.WeaponPropertiesAda",amm:"ROTV.WeaponPropertiesAmm",fin:"ROTV.WeaponPropertiesFin",fir:"ROTV.WeaponPropertiesFir",foc:"ROTV.WeaponPropertiesFoc",hvy:"ROTV.WeaponPropertiesHvy",lgt:"ROTV.WeaponPropertiesLgt",lod:"ROTV.WeaponPropertiesLod",mgc:"ROTV.WeaponPropertiesMgc",rch:"ROTV.WeaponPropertiesRch",rel:"ROTV.WeaponPropertiesRel",ret:"ROTV.WeaponPropertiesRet",sil:"ROTV.WeaponPropertiesSil",spc:"ROTV.WeaponPropertiesSpc",thr:"ROTV.WeaponPropertiesThr",two:"ROTV.WeaponPropertiesTwo",ver:"ROTV.WeaponPropertiesVer"};let m=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{m=class Utils{static getSetting(s,i=null){let n=i??null;try{n=game.settings.get(e.ID,s)}catch{t.api.Logger.debug(`Setting '${s}' not found`)}return n}static async setSetting(s,i){try{i=await game.settings.set(e.ID,s,i),t.api.Logger.debug(`Setting '${s}' set to '${i}'`)}catch{t.api.Logger.debug(`Setting '${s}' not found`)}}}}));let y=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{y=class ActionHandler extends e.api.ActionHandler{actors=null;tokens=null;actorType=null;items=null;abbreviateSkills=null;displaySpellInfo=null;showItemsWithoutActivationCosts=null;showUnchargedItems=null;showUnequippedItems=null;showUnpreparedSpells=null;activationgroupIds=null;featuregroupIds=null;inventorygroupIds=null;spellgroupIds=null;featureActions=null;inventoryActions=null;spellActions=null;systemVersion=game.rotv.version;async buildSystemActions(t){if(this.actors=this.actor?[this.actor]:this.#e(),this.tokens=this.token?[this.token]:this.#t(),this.actorType=this.actor?.type,this.actor){let t=this.actor.items;t=this.#s(t),t=e.api.Utils.sortItemsByName(t),this.items=t}this.abbreviateSkills=m.getSetting("abbreviateSkills"),this.displaySpellInfo=m.getSetting("displaySpellInfo"),this.showItemsWithoutActivationCosts=m.getSetting("showItemsWithoutActivationCosts"),this.showUnchargedItems=m.getSetting("showUnchargedItems"),this.showUnequippedItems=m.getSetting("showUnequippedItems"),"npc"!==this.actorType||this.showUnequippedItems||(this.showUnequippedItems=m.getSetting("showUnequippedItemsNpcs")),this.showUnpreparedSpells=m.getSetting("showUnpreparedSpells"),this.activationgroupIds=["actions","bonus-actions","crew-actions","lair-actions","legendary-actions","reactions","other-actions"],this.featuregroupIds=["active-features","passive-features","background-features","class-features","feats","monster-features","race-features","artificer-infusions","channel-divinity","defensive-tactics","eldritch-invocations","elemental-disciplines","fighting-styles","hunters-prey","ki-abilities","maneuvers","metamagic-options","multiattacks","pact-boons","psionic-powers","runes","superior-hunters-defense"],this.spellgroupIds=["cantrips","1st-level-spells","2nd-level-spells","3rd-level-spells","4th-level-spells","5th-level-spells","6th-level-spells","7th-level-spells","8th-level-spells","9th-level-spells","at-will-spells","innate-spells","pact-spells"],"character"===this.actorType||"npc"===this.actorType?(this.inventorygroupIds=["equipped","consumables","containers","equipment","loot","tools","weapons","unequipped"],await this.#i()):"vehicle"===this.actorType?(this.inventorygroupIds=["consumables","equipment","tools","weapons"],await this.#n()):this.actor||await this.#a()}async#i(){await Promise.all([this.#o(),this.#l(),this.#r(),this.#c(),this.#p()]),this.#u("ability","abilities"),this.#u("check","checks"),this.#u("save","saves"),this.#d(),this.#m(),this.#y(),this.#h(),this.#v(),this.#g()}async#n(){await Promise.all([this.#o(),this.#l(),this.#r(),this.#c()]),this.#u("ability","abilities"),this.#u("check","checks"),this.#u("save","saves"),this.#d(),this.#g()}async#a(){this.#u("ability","abilities"),this.#u("check","checks"),this.#u("save","saves"),this.#d(),await this.#o(),this.#h(),this.#v(),this.#g()}#u(t,s){const n=this.actor?this.actor.system.abilities:CONFIG.ROTV.abilities;if(0===n.length)return;const a=Object.entries(n).filter((e=>0!==n[e[0]].value)).map((([a,o])=>{const l=`${t}-${a}`,r=a.charAt(0).toUpperCase()+a.slice(1),c=this.systemVersion>="2.2"?CONFIG.ROTV.abilities[a].label:CONFIG.ROTV.abilities[a],p=this.abbreviateSkills?r:c,u=`${`${e.api.Utils.i18n(i[t])}: `??""}${c}`,d=[t,a].join(this.delimiter),m="checks"!==s?this.#f(n[a].proficient):"",y="saves"!==s?o?.mod:"saves"===s?o?.save:"";return{id:l,name:p,encodedValue:d,icon1:m,info1:this.actor?{text:e.api.Utils.getModifier(y)}:null,info2:this.actor&&"abilities"===s?{text:`(${e.api.Utils.getModifier(o?.save)})`}:null,listName:u}})),o={id:s,type:"system"};this.addActions(a,o)}async buildActivations(e){const{groupData:t,actionData:s,actionType:i="item"}=e,n=new Map,a={action:"actions",bonus:"bonus-actions",crew:"crew-actions",lair:"lair-actions",legendary:"legendary-actions",reaction:"reactions",reactiondamage:"reactions",reactionmanual:"reactions",other:"other-actions"};for(const[e,t]of s){const s=t.system?.activation?.type,i=a[Object.keys(a).includes(s)?s:"other"];n.has(i)||n.set(i,new Map),n.get(i).set(e,t)}for(const e of this.activationgroupIds){if(!n.has(e))continue;const s={...t,id:`${e}+${t.id}`,type:"system-derived"};["equipped","unequipped"].includes(t.id)&&(s.defaultSelected=!1);const a={id:e,type:"system"};await this.addGroup(s,a),"spell"===i&&this.addGroupInfo(s);const o=n.get(e);await this.buildActions({groupData:s,actionData:o,actionType:i})}}#d(){const t="utility",s={initiative:{id:"initiative",name:e.api.Utils.i18n("tokenActionHud.rotv.rollInitiative")},endTurn:{id:"endTurn",name:e.api.Utils.i18n("tokenActionHud.endTurn")}};game.combat?.current?.tokenId!==this.token?.id&&delete s.endTurn;const n=Object.entries(s).map((s=>{const n=s[1].id,a=s[1].name,o=`${`${e.api.Utils.i18n(i[t])}: `??""}${a}`,l=[t,n].join(this.delimiter),r={};let c="";if("initiative"===s[0]&&game.combat){const t=e.api.Utils.getControlledTokens(),s=t?.map((e=>e.id)),i=game.combat.combatants.filter((e=>s.includes(e.tokenId)));if(1===i.length){const e=i[0].initiative;r.class="tah-spotlight",r.text=e}c=`toggle${i.length>0&&i.every((e=>e?.initiative))?" active":""}`}return{id:n,name:a,encodedValue:l,info1:r,cssClass:c,listName:o}}));this.addActions(n,{id:"combat",type:"system"})}async#o(){if(0===this.tokens?.length)return;const t="condition",s=CONFIG.statusEffects.filter((e=>""!==e.id));if(0===s.length)return;const n=await Promise.all(s.map((async s=>{const n=s.id,a=e.api.Utils.i18n(s.label)??s.name,o=`${`${e.api.Utils.i18n(i[t])}: `??""}${a}`,l=[t,n].join(this.delimiter),r=`toggle${this.actors.every((e=>game.version.startsWith("11")?e.effects.some((e=>e.statuses.some((e=>e===n))&&!e?.disabled)):e.effects.some((e=>e.flags?.core?.statusId===n&&!e?.disabled))))?" active":""}`,c=e.api.Utils.getImage(s),p=await this.#b(n,a),u=await this.#k(p);return{id:n,name:a,encodedValue:l,img:c,cssClass:r,listName:o,tooltip:u}})));this.addActions(n,{id:"conditions",type:"system"})}async#m(){if("character"!==this.actorType)return;const t="counter";let s=[];if(e.api.Utils.isModuleActive("rotv-custom-counters")){if("character"!==this.actorType)return;s=Object.entries(game.settings.get("rotv-custom-counters","characterCounters")).filter((([e,t])=>t.visible)).map((([e,t])=>(t.key=e,t)))}else s=[{name:e.api.Utils.i18n("ROTV.DeathSave"),type:"successFailure",system:!0,visible:!0,key:"death-saves"},{name:e.api.Utils.i18n("ROTV.Exhaustion"),type:"number",system:!0,visible:!0,key:"exhaustion"},{name:e.api.Utils.i18n("ROTV.Inspiration"),type:"checkbox",system:!0,visible:!0,key:"inspiration"}];const n=s.map((s=>{const n=s.key,a=s.name,o=`${`${e.api.Utils.i18n(i[t])}: `??""}${a}`,l=s.system?n:encodeURIComponent(`${n}>${s.type}`),r=[t,l].join(this.delimiter);let c="",p="",u="",d="";if(s.system)switch(n){case"exhaustion":c=this.actor.system.attributes.exhaustion>0?" active":"",p=`toggle${c}`,u=e.api.Utils.getImage("modules/token-action-hud-rotv/icons/exhaustion.svg"),d={text:this.actor.system.attributes.exhaustion};break;case"death-saves":u=e.api.Utils.getImage("modules/token-action-hud-rotv/icons/death-saves.svg"),d={text:`${this.actor.system.attributes.death.success}/${this.actor.system.attributes.death.failure}`};break;case"inspiration":c=this.actor.system.attributes.inspiration?" active":"",p=`toggle${c}`,u=e.api.Utils.getImage("modules/token-action-hud-rotv/icons/inspiration.svg")}else{const e=this.actor.getFlag("rotv-custom-counters",n);switch(s.type){case"checkbox":c=e?" active":"",p=`toggle${c}`;break;case"number":c=e>0?" active":"",p=`toggle${c}`,d={text:e};break;case"successFailure":d={text:`${e?.success??0}/${e?.failure??0}`}}}return{id:n,name:a,listName:o,encodedValue:r,cssClass:p,img:u,info1:d}}));this.addActions(n,{id:"counters",type:"system"})}async#l(){const e="effect",t=new Map;for(const e of this.actor.allApplicableEffects())t.set(e.id,e);if(0===t.size)return;const s=new Map,i=new Map;for(const[e,n]of t.entries()){if(n.isSuppressed||!1===n.parent?.system?.identified&&!game.user.isGM)continue;n.isTemporary?i.set(e,n):s.set(e,n)}await Promise.all([this.buildActions({groupData:{id:"passive-effects",type:"system"},actionData:s,actionType:e}),this.buildActions({groupData:{id:"temporary-effects",type:"system"},actionData:i,actionType:e})])}#y(){if(0===this.actors.length)return;if(!this.actors.every((e=>"character"===e.type)))return;const t="exhaustion",s="exhaustion",n=e.api.Utils.i18n("ROTV.Exhaustion"),a=`${`${e.api.Utils.i18n(i[t])}: `??""}${n}`,o=[t,s].join(this.delimiter),l=e.api.Utils.getImage("modules/token-action-hud-rotv/icons/exhaustion.svg"),r={text:this.actor.system.attributes.exhaustion};let c="";c=`toggle${this.actor.system.attributes.exhaustion>0?" active":""}`;const p=[{cssClass:c,id:s,name:n,encodedValue:o,img:l,info1:r,listName:a}];this.addActions(p,{id:"exhaustion",type:"system"})}async#r(){const t=new Map;for(const[e,s]of this.items){"feat"===s.type&&t.set(e,s)}if(0===t.size)return;const s=new Map,i=[{type:"background",groupId:"background-features"},{type:"class",groupId:"class-features"},{type:"monster",groupId:"monster-features"},{type:"race",groupId:"race-features"},{type:"feats",groupId:"feats"}],n=[{type:"artificerInfusion",groupId:"artificer-infusions"},{type:"channelDivinity",groupId:"channel-divinity"},{type:"defensiveTactic",groupId:"defensive-tactics"},{type:"eldritchInvocation",groupId:"eldritch-invocations"},{type:"elementalDiscipline",groupId:"elemental-disciplines"},{type:"fightingStyle",groupId:"fighting-styles"},{type:"huntersPrey",groupId:"hunters-prey"},{type:"ki",groupId:"ki-abilities"},{type:"maneuver",groupId:"maneuvers"},{type:"metamagic",groupId:"metamagic-options"},{type:"multiattack",groupId:"multiattacks"},{type:"pact",groupId:"pact-boons"},{type:"psionicPower",groupId:"psionic-powers"},{type:"rune",groupId:"runes"},{type:"superiorHuntersDefense",groupId:"superior-hunters-defense"}];for(const[e,a]of t){const t=a.system.activation?.type,o=a.system.type.value,l=a.system.type?.subtype;t&&(s.has("active-features")||s.set("active-features",new Map),s.get("active-features").set(e,a)),t&&""!==t||(s.has("passive-features")||s.set("passive-features",new Map),s.get("passive-features").set(e,a));for(const t of i){const i=t.groupId;t.type===o&&(s.has(i)||s.set(i,new Map),s.get(i).set(e,a))}for(const t of n){const i=t.groupId;l&&t.type===l&&(s.has(i)||s.set(i,new Map),s.get(i).set(e,a))}}const a={"active-features":e.api.Utils.i18n("tokenActionHud.rotv.activeFeatures"),"passive-features":e.api.Utils.i18n("tokenActionHud.rotv.passiveFeatures")};for(const e of this.featuregroupIds){if(!s.has(e))continue;const t={groupData:{id:e,name:a[e]??"",type:"system"},actionData:s.get(e),actionType:"feature"};await this.buildActions(t),a[e]&&await this.buildActivations(t)}}async#c(){if(0===this.items.size)return;const t=new Map;for(const[e,s]of this.items){const i=s.system.equipped,n=s.system?.quantity>0,a=this.#A(s),o=this.#I(s),l=this.#w(s),r=s.type;n&&a&&(i&&(t.has("equipped")||t.set("equipped",new Map),t.get("equipped").set(e,s)),i||(t.has("unequipped")||t.set("unequipped",new Map),t.get("unequipped").set(e,s)),o&&"consumable"===r&&(t.has("consumables")||t.set("consumables",new Map),t.get("consumables").set(e,s)),l&&("container"===r&&(t.has("containers")||t.set("containers",new Map),t.get("containers").set(e,s)),"equipment"===r&&(t.has("equipment")||t.set("equipment",new Map),t.get("equipment").set(e,s)),"loot"===r&&(t.has("loot")||t.set("loot",new Map),t.get("loot").set(e,s)),"tool"===r&&(t.has("tools")||t.set("tools",new Map),t.get("tools").set(e,s)),"weapon"===r&&(t.has("weapons")||t.set("weapons",new Map),t.get("weapons").set(e,s))))}const s={equipped:e.api.Utils.i18n("ROTV.Equipped"),unequipped:e.api.Utils.i18n("ROTV.Unequipped"),consumables:e.api.Utils.i18n("ITEM.TypeConsumablePl"),containers:e.api.Utils.i18n("ITEM.TypeContainerPl"),equipment:e.api.Utils.i18n("ITEM.TypeEquipmentPl"),loot:e.api.Utils.i18n("ITEM.TypeLootPl"),tools:e.api.Utils.i18n("ITEM.TypeToolPl"),weapons:e.api.Utils.i18n("ITEM.TypeWeaponPl")};for(const e of this.inventorygroupIds){if(!t.has(e))continue;const i={groupData:{id:e,name:s[e],type:"system"},actionData:t.get(e)};await this.buildActions(i),this.activationgroupIds&&await this.buildActivations(i)}}#h(){if(0===this.actors.length)return;if(!this.actors.every((e=>"character"===e.type)))return;const t="utility",s={shortRest:{name:e.api.Utils.i18n("ROTV.ShortRest")},longRest:{name:e.api.Utils.i18n("ROTV.LongRest")}},n=Object.entries(s).map((s=>{const n=s[0],a=s[1].name,o=`${`${e.api.Utils.i18n(i[t])}: `??""}${a}`,l=[t,n].join(this.delimiter);return{id:n,name:a,encodedValue:l,listName:o}}));this.addActions(n,{id:"rests",type:"system"})}#v(){const t="skill",s=this.actor?this.actor.system.skills:CONFIG.ROTV.skills;if(0===s.length)return;const n=Object.entries(s).map((n=>{try{const a=n[0],o=a.charAt(0).toUpperCase()+a.slice(1),l=this.abbreviateSkills?o:CONFIG.ROTV.skills[a].label,r=`${`${e.api.Utils.i18n(i[t])}: `??""}${CONFIG.ROTV.skills[a].label}`,c=[t,a].join(this.delimiter),p=this.#f(s[a].value),u=s[a].total;return{id:a,name:l,encodedValue:c,icon1:p,info1:this.actor?{text:u||0===u?`${u>=0?"+":""}${u}`:""}:"",listName:r}}catch(t){return e.api.Logger.error(n),null}})).filter((e=>!!e));this.addActions(n,{id:"skills",type:"system"})}async#p(){const t=new Map;for(const[e,s]of this.items){if("spell"===s.type){const i=this.#I(s),n=this.#T(s);if(i&&n){switch(s.system.preparation.mode){case"atwill":t.has("at-will-spells")||t.set("at-will-spells",new Map),t.get("at-will-spells").set(e,s);break;case"innate":t.has("innate-spells")||t.set("innate-spells",new Map),t.get("innate-spells").set(e,s);break;case"pact":t.has("pact-spells")||t.set("pact-spells",new Map),t.get("pact-spells").set(e,s);break;default:switch(s.system.level){case 0:t.has("cantrips")||t.set("cantrips",new Map),t.get("cantrips").set(e,s);break;case 1:t.has("1st-level-spells")||t.set("1st-level-spells",new Map),t.get("1st-level-spells").set(e,s);break;case 2:t.has("2nd-level-spells")||t.set("2nd-level-spells",new Map),t.get("2nd-level-spells").set(e,s);break;case 3:t.has("3rd-level-spells")||t.set("3rd-level-spells",new Map),t.get("3rd-level-spells").set(e,s);break;case 4:t.has("4th-level-spells")||t.set("4th-level-spells",new Map),t.get("4th-level-spells").set(e,s);break;case 5:t.has("5th-level-spells")||t.set("5th-level-spells",new Map),t.get("5th-level-spells").set(e,s);break;case 6:t.has("6th-level-spells")||t.set("6th-level-spells",new Map),t.get("6th-level-spells").set(e,s);break;case 7:t.has("7th-level-spells")||t.set("7th-level-spells",new Map),t.get("7th-level-spells").set(e,s);break;case 8:t.has("8th-level-spells")||t.set("8th-level-spells",new Map),t.get("8th-level-spells").set(e,s);break;case 9:t.has("9th-level-spells")||t.set("9th-level-spells",new Map),t.get("9th-level-spells").set(e,s)}}}}}const s=Object.entries(this.actor.system.spells).reverse();let i=null;const n=[];let a=this.showUnchargedItems,o=this.showUnchargedItems;for(const[e,t]of s){const s=t.value>0,l=t.max>0,r=t.level>0;"pact"===e&&(!o&&s&&l&&r&&(o=!0),r||(o=!1),t.slotAvailable=o,i=[e,t]),e.startsWith("spell")&&"spell0"!==e?(!a&&s&&l&&(a=!0),t.slotAvailable=a,n.push([e,t])):s&&(t.slotsAvailable=!0,n.push(e,t))}if(i[1].slotAvailable){const e=n.findIndex((e=>e[0]==="spell"+i[1].level));n[e][1].slotsAvailable=!0}const l={"1st-level-spells":{spellMode:1,name:e.api.Utils.i18n("tokenActionHud.rotv.1stLevelSpells")},"2nd-level-spells":{spellMode:2,name:e.api.Utils.i18n("tokenActionHud.rotv.2ndLevelSpells")},"3rd-level-spells":{spellMode:3,name:e.api.Utils.i18n("tokenActionHud.rotv.3rdLevelSpells")},"4th-level-spells":{spellMode:4,name:e.api.Utils.i18n("tokenActionHud.rotv.4thLevelSpells")},"5th-level-spells":{spellMode:5,name:e.api.Utils.i18n("tokenActionHud.rotv.5thLevelSpells")},"6th-level-spells":{spellMode:6,name:e.api.Utils.i18n("tokenActionHud.rotv.6thLevelSpells")},"7th-level-spells":{spellMode:7,name:e.api.Utils.i18n("tokenActionHud.rotv.7thLevelSpells")},"8th-level-spells":{spellMode:8,name:e.api.Utils.i18n("tokenActionHud.rotv.8thLevelSpells")},"9th-level-spells":{spellMode:9,name:e.api.Utils.i18n("tokenActionHud.rotv.9thLevelSpells")},"at-will-spells":{spellMode:"atwill",name:e.api.Utils.i18n("tokenActionHud.rotv.atWillSpells")},cantrips:{spellMode:0,name:e.api.Utils.i18n("tokenActionHud.rotv.cantrips")},"innate-spells":{spellMode:"innate",name:e.api.Utils.i18n("tokenActionHud.rotv.innateSpells")},"pact-spells":{spellMode:"pact",name:e.api.Utils.i18n("tokenActionHud.rotv.pactSpells")}},r=["1","2","3","4","5","6","7","8","9","pact"];for(const e of this.spellgroupIds){const s=l[e].spellMode,a=l[e].name;if(!t.has(e))continue;const o="pact"===s?i[1]:n.find((e=>e[0]===`spell${s}`))?.[1],c=o?.value,p=o?.max,u=o?.slotAvailable;if(!u&&r.includes(s))continue;const d={};d.info1={class:"tah-spotlight",text:p>=0?`${c}/${p}`:""};const m={id:e,name:a,type:"system",info:d};this.addGroupInfo(m);const y={groupData:m,actionData:t.get(e),actionType:"spell"};await this.buildActions(y),this.activationgroupIds&&await this.buildActivations(y)}}#g(){if(0===this.actors.length)return;if(!this.actors.every((e=>"character"===e.type)))return;const t="utility",s={deathSave:{name:e.api.Utils.i18n("ROTV.DeathSave")},inspiration:{name:e.api.Utils.i18n("ROTV.Inspiration")}};(!this.actor||this.actor.system.attributes.hp.value>0)&&delete s.deathSave;const n=Object.entries(s).map((s=>{const n=s[0],a=s[1].name,o=`${`${e.api.Utils.i18n(i[t])}: `??""}${a}`,l=[t,n].join(this.delimiter);let r="";if("inspiration"===s[0]){r=`toggle${this.actors.every((e=>e.system.attributes?.inspiration))?" active":""}`}return{id:n,name:a,encodedValue:l,cssClass:r,listName:o}}));this.addActions(n,{id:"utility",type:"system"})}async buildActions(e,t){const{actionData:s,groupData:i,actionType:n}=e;if(0===s.size)return;if(!("string"==typeof i?i:i?.id))return;const a=await Promise.all([...s].map((async e=>await this.#E(n,e[1]))));this.addActions(a,i)}async#E(t="item",s){const n=s.id??s._id;let a=s?.name??s?.label;s?.system?.recharge&&!s?.system?.recharge?.charged&&s?.system?.recharge?.value&&(a+=` (${e.api.Utils.i18n("ROTV.Recharge")})`);const o=`${`${e.api.Utils.i18n(i[t])}: `??""}${a}`;let l="";if(Object.hasOwn(s,"disabled")){l=`toggle${s.disabled?"":" active"}`}const r=[t,n].join(this.delimiter),c=e.api.Utils.getImage(s),p=this.#S(s?.system?.activation?.type),u=this.#U(s),d=this.#C(s),m=this.#H(s),y=m?.info1,h=m?.info2,v=m?.info3,g=await this.#$(s);return{id:n,name:a,encodedValue:r,cssClass:l,img:c,icon1:p,icon2:u,icon3:d,info1:y,info2:h,info3:v,listName:o,tooltip:await this.#k(g)}}#A(e){if(this.showItemsWithoutActivationCosts)return!0;const t=Object.keys(CONFIG.ROTV.abilityActivationTypes).filter((e=>"none"!==e)),s=e.system.activation,i=s?.type;return!!(s&&t.includes(i)||"tool"===e.type)}#w(e){const t=e.type;if(this.showUnequippedItems&&!["consumable","spell","feat"].includes(t))return!0;return!(!e.system.equipped||"consumable"===t)}#I(e){if(this.showUnchargedItems)return!0;return!!e.system.uses}#T(e){if("character"!==this.actorType&&this.showUnequippedItems)return!0;const t=e.system.preparation.prepared;if(this.showUnpreparedSpells)return!0;const s=e.system.level,i=Object.keys(CONFIG.ROTV.spellPreparationModes).filter((e=>"prepared"!==e)),n=e.system.preparation.mode;return!(0!==s&&!i.includes(n)&&!t)}#H(e){const t="spell"===e.type?this.#R(e):this.#O(e),s=this.#D(e),i=this.#P(e);return{info1:t,info2:{text:`${s.text??""} ${i.text??""}`,title:"Uses and consume"},info3:this.#M(e)}}#R(t){if(!this.displaySpellInfo)return null;const s={text:""},i=[],n=t.system?.properties;return[["vocal","ROTV.ComponentVerbal"],["somatic","ROTV.ComponentSomatic"],["material","ROTV.ComponentMaterial"]].forEach((t=>{n?.has(t[0])&&(i.push(e.api.Utils.i18n(t[1])),s.text+=e.api.Utils.i18n(`${t[1]}Abbr`))})),n?.has("ritual")&&(i.push(`[${e.api.Utils.i18n("ROTV.Ritual")}]`),s.text+=` [${e.api.Utils.i18n("ROTV.RitualAbbr")}]`),s.title=i.join(", "),s}#e(){const t=["character","npc"],s=e.api.Utils.getControlledTokens(),i=s?.filter((e=>e.actor)).map((e=>e.actor));return i.every((e=>t.includes(e.type)))?i:[]}#t(){const t=["character","npc"],s=e.api.Utils.getControlledTokens(),i=s?.filter((e=>e.actor)).map((e=>e.actor));return i.every((e=>t.includes(e.type)))?s:[]}#O(t){const s=t?.system?.quantity??0;return{text:s>1?s+" left":"",title:`${e.api.Utils.i18n("ROTV.Quantity")}: ${s}`}}#D(t,s,i){const n=t?.system?.uses;if(n?.per&&(s||n?.prompt)&&(n.value>0||n.max>0)){const t=e.api.Utils.i18n("ROTV.of"),a="charges"===n.per?"":` ${e.api.Utils.i18n("ROTV.per")}`,o=CONFIG.ROTV.limitedUsePeriods[n.per]?.label??n.per,l=void 0!==i?i:n.amount,r=`${l>1?`${l} ${t} `:""}${n.value??"0"}${n.max>0?`/${n.max} charges`:""}`;return{text:r,title:`${r}${a} ${o}${s?` (${t} ${s})`:""}`}}return{}}#P(t){const s=t?.system?.consume?.target,i=t?.system?.consume?.type,n=t?.system?.consume?.amount;if(!s||!i||s===t.id)return{};if("attribute"===i){const e=s.substr(0,s.lastIndexOf(".")),t=foundry.utils.getProperty(this.actor.system,e);if(t){const e=`${t.value??"0"}${t.max?`/${t.max} mag`:""}`;return{text:e,title:`${e} ${t.label??""}`}}}else{const t=this.actor.items?.get(s);if(t&&"charges"===i)return this.#D(t,t.name,n);if(t?.system?.quantity){const s=`${n>1?`${n} ${e.api.Utils.i18n("ROTV.of")} `:""}${t.system.quantity}`;return{text:s,title:`${s} ${t.name}`}}}return{}}#M(e){let t=e?.system?.range?.value;return t>1?{text:t+" sq.",title:"range"}:{}}#s(e){if(m.getSetting("showSlowActions"))return e;const t=["minute","hour","day"],s=new Map;for(const[i,n]of e.entries()){const e=n.system?.activation?.type;t.includes(e)||s.set(i,n)}return s}#f(e){const t=CONFIG.ROTV.proficiencyLevels[e]??"",s=c[e];if(s)return`<i class="${s}" title="${t}"></i>`}#S(e){const t=CONFIG.ROTV.abilityActivationTypes[e]??"",s=n[e];if(s)return`<i class="${s}" title="${t}"></i>`}#C(t){if("spell"!==t?.type||!this.displaySpellInfo||!t.system?.properties?.has("concentration"))return null;const s=e.api.Utils.i18n("ROTV.Scroll.RequiresConcentration");return`<rotv-icon src="${a}" title="${s}">`}#U(t){if("spell"!==t?.type||!this.showUnpreparedSpells)return null;const s=t.system.level,i=t.system.preparation.mode,n=t.system.preparation.prepared,a=n?r:`${r} tah-icon-disabled`,o="always"===i?e.api.Utils.i18n("ROTV.SpellPrepAlways"):n?e.api.Utils.i18n("ROTV.SpellPrepared"):e.api.Utils.i18n("ROTV.SpellUnprepared");return"prepared"!==i&&"always"!==i||0===s?null:`<i class="${a}" title="${o}"></i>`}async#$(e){if("none"===this.tooltipsSetting)return"";const t=e?.name??"";if("nameOnly"===this.tooltipsSetting)return t;const s=!1===e.system?.identified,i="string"==typeof e?.system?.description?e?.system?.description:(s?e?.system?.unidentified?.description:e?.system?.description?.value)??"";let n,a,o,l;return s||(n=e?.modifiers??null,a=[...e.system?.chatProperties??[],...e.system?.equippableItemCardProperties??[],...e.system?.activatedEffectCardProperties??[]].filter((e=>e)),o=s?null:e?.rarity??null,l="weapon"===e?.type?this.#V(e?.system?.properties):null),{name:t,description:i,modifiers:n,properties:a,rarity:o,traits:l}}async#b(e,t){if("none"===this.tooltipsSetting)return"";if("nameOnly"===this.tooltipsSetting)return t;const s=o[e]&&o[e]?.uuid?await fromUuid(o[e].uuid):null;return{name:t,description:s?.text?.content??"",relativeTo:s}}async#k(t){if("none"===this.tooltipsSetting)return"";if("string"==typeof t)return t;const s=e.api.Utils.i18n(t.name);if("nameOnly"===this.tooltipsSetting)return s;const i=`<h3>${s}</h3>`,n=t.relativeTo??this.actor,a=t?.descriptionLocalised??await TextEditor.enrichHTML(e.api.Utils.i18n(t?.description??""),{async:!0,relativeTo:n,secrets:!0}),o=t?.rarity?`<span class="tah-tag ${t.rarity}">${e.api.Utils.i18n(p[t.rarity])}</span>`:"",l=t?.properties?`<div class="tah-properties">${t.properties.map((t=>`<span class="tah-property">${e.api.Utils.i18n(t)}</span>`)).join("")}</div>`:"",r=t?.traits?t.traits.map((t=>`<span class="tah-tag">${e.api.Utils.i18n(t.label??t)}</span>`)).join(""):"",c=t?.traits2?t.traits2.map((t=>`<span class="tah-tag tah-tag-secondary">${e.api.Utils.i18n(t.label??t)}</span>`)).join(""):"",u=t?.traitsAlt?t.traitsAlt.map((t=>`<span class="tah-tag tah-tag-alt">${e.api.Utils.i18n(t.label)}</span>`)).join(""):"",d=t?.modifiers?`<div class="tah-tags">${t.modifiers.filter((e=>e.enabled)).map((t=>`<span class="tah-tag tah-tag-transparent">${e.api.Utils.i18n(t.label)} ${`${t.modifier>=0?"+":""}${t.modifier??""}`}</span>`)).join("")}</div>`:"",m=[o,r,c,u].join(""),y=m?`<div class="tah-tags">${m}</div>`:"";return a||y||d?`<div>${i}${y||d?`<div class="tah-tags-wrapper">${y}${d}</div>`:""}${a}${l}</div>`:s}#V(t){return t?Object.entries(t).filter((([e,t])=>t&&d[e])).map((([t,s])=>e.api.Utils.i18n(d[t]))):null}}}));let h=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{const t=l;Object.values(t).forEach((t=>{t.name=e.api.Utils.i18n(t.name),t.listName=`Group: ${e.api.Utils.i18n(t.name)}`}));const s=Object.values(t);h={layout:[{nestId:"inventory",id:"inventory",name:e.api.Utils.i18n("ROTV.Inventory"),groups:[{...t.weapons,nestId:"inventory_weapons"},{...t.equipment,nestId:"inventory_equipment"},{...t.consumables,nestId:"inventory_consumables"},{...t.tools,nestId:"inventory_tools"},{...t.containers,nestId:"inventory_containers"},{...t.loot,nestId:"inventory_loot"}]},{nestId:"features",id:"features",name:e.api.Utils.i18n("ROTV.Features"),groups:[{...t.activeFeatures,nestId:"features_active-features"},{...t.passiveFeatures,nestId:"features_passive-features"}]},{nestId:"spells",id:"spells",name:e.api.Utils.i18n("ITEM.TypeSpellPl"),groups:[{...t.atWillSpells,nestId:"spells_at-will-spells"},{...t.innateSpells,nestId:"spells_innate-spells"},{...t.pactSpells,nestId:"spells_pact-spells"},{...t.cantrips,nestId:"spells_cantrips"},{...t._1stLevelSpells,nestId:"spells_1st-level-spells"},{...t._2ndLevelSpells,nestId:"spells_2nd-level-spells"},{...t._3rdLevelSpells,nestId:"spells_3rd-level-spells"},{...t._4thLevelSpells,nestId:"spells_4th-level-spells"},{...t._5thLevelSpells,nestId:"spells_5th-level-spells"},{...t._6thLevelSpells,nestId:"spells_6th-level-spells"},{...t._7thLevelSpells,nestId:"spells_7th-level-spells"},{...t._8thLevelSpells,nestId:"spells_8th-level-spells"},{...t._9thLevelSpells,nestId:"spells_9th-level-spells"}]},{nestId:"attributes",id:"attributes",name:e.api.Utils.i18n("ROTV.Attributes"),groups:[{...t.abilities,nestId:"attributes_abilities"},{...t.skills,nestId:"attributes_skills"}]},{nestId:"effects",id:"effects",name:e.api.Utils.i18n("ROTV.Effects"),groups:[{...t.temporaryEffects,nestId:"effects_temporary-effects"},{...t.passiveEffects,nestId:"effects_passive-effects"},{...t.conditions,nestId:"effects_conditions"}]},{nestId:"utility",id:"utility",name:e.api.Utils.i18n("tokenActionHud.utility"),groups:[{...t.combat,nestId:"utility_combat"},{...t.token,nestId:"utility_token"},{...t.rests,nestId:"utility_rests"},{...t.utility,nestId:"utility_utility"}]}],groups:s}}));let v=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{v=class MagicItemActionHandlerExtender extends e.api.ActionHandlerExtender{constructor(e){super(),this.actionHandler=e,this.actor=null}async extendActionHandler(){if(this.actor=this.actionHandler.actor,!this.actor)return;const t=await MagicItems.actor(this.actor.id);if(!t)return;const s=t.items??[];if(0===s.length)return;const i={id:"magic-items",type:"system"};s.forEach((t=>{if(t.attuned&&!this._isItemAttuned(t))return;if(t.equipped&&!this._isItemEquipped(t))return;const s={id:`magic-items_${t.id}`,name:t.name,type:"system-derived",info1:`${t.uses}/${t.charges}`};this.actionHandler.addGroup(s,i);const n=t.ownedEntries.map((s=>{const i=s.item,n=i.id;return{id:n,name:i.name,encodedValue:["magicItem",`${t.id}>${n}`].join("|"),img:e.api.Utils.getImage(i),info1:i.consumption,info2:i.baseLevel?`${e.api.Utils.i18n("ROTV.AbbreviationLevel")} ${i.baseLevel}`:"",selected:!0}}));this.actionHandler.addActions(n,s)}))}_isItemEquipped(e){return e.item.system.equipped}_isItemAttuned(e){return e.item.system.attunment!==(CONFIG.ROTV.attunementTypes?.REQUIRED??1)}}}));let g=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{g=class RollHandler extends e.api.RollHandler{async handleActionClick(t,s){const[i,n]=s.split("|");if(this.actor)await this.#J(t,i,this.actor,this.token,n);else for(const s of e.api.Utils.getControlledTokens()){const e=s.actor;await this.#J(t,i,e,s,n)}}async#J(e,t,s,i,n){switch(t){case"ability":this.#x(e,s,n);break;case"check":this.#Q(e,s,n);break;case"save":this.#j(e,s,n);break;case"condition":if(!i)return;await this.#q(e,s,i,n);break;case"counter":await this.#B(e,s,n);break;case"effect":await this.#F(e,s,n);break;case"exhaustion":await this.#_(e,s);break;case"feature":case"item":case"spell":case"weapon":this.isRenderItem()?this.renderItem(s,n):this.#L(e,s,n);break;case"magicItem":await this.#W(s,n);break;case"skill":this.#N(e,s,n);break;case"utility":await this.#G(e,s,i,n)}}async#B(e,t,s){switch(s){case"death-saves":this.#Z(e,t);break;case"exhaustion":await this.#_(e,t);break;case"inspiration":await this.#z(t);break;default:await this.#K(e,t,s)}}async#_(e,t){const s=this.isRightClick(e),i=t.system.attributes.exhaustion,n=s?i-1:i+1;n>=0&&t.update({"system.attributes.exhaustion":n})}async#z(e){const t=!e.system.attributes.inspiration;e.update({"system.attributes.inspiration":t})}async#K(t,s,i){if(!e.api.Utils.isModuleActive("rotv-custom-counters"))return;const[n,a]=decodeURIComponent(i).split(">"),o=this.isRightClick(t),l=this.isCtrl(t);let r=s.getFlag("rotv-custom-counters",n);switch(a){case"checkbox":await s.setFlag("rotv-custom-counters",n,!r);break;case"number":r=r??0,o?r>0&&await s.setFlag("rotv-custom-counters",n,r-1):await s.setFlag("rotv-custom-counters",n,r+1);break;case"successFailure":r=r??{},r.success=r?.success??0,r.failure=r?.failure??0,o?l?r?.failure>0&&await s.setFlag("rotv-custom-counters",`${n}.failure`,r.failure-1):r?.success>0&&await s.setFlag("rotv-custom-counters",`${n}.success`,r.success-1):l?await s.setFlag("rotv-custom-counters",`${n}.failure`,r.failure+1):await s.setFlag("rotv-custom-counters",`${n}.success`,r.success+1)}}#x(e,t,s){t&&t.system?.abilities&&t.rollAbility(s,{event:e})}#j(e,t,s){t&&t.system?.abilities&&t.rollAbilitySave(s,{event:e})}#Q(e,t,s){t&&t.system?.abilities&&t.rollAbilityTest(s,{event:e})}#Z(e,t){t.rollDeathSave({event:e})}async#W(e,t){const s=t.split(">"),i=s[0],n=s[1];(await MagicItems.actor(e.id)).roll(i,n),Hooks.callAll("forceUpdateTokenActionHud")}#N(e,t,s){t&&t.system?.skills&&t.rollSkill(s,{event:e})}#L(t,s,i){const n=e.api.Utils.getItem(s,i);if(!this.#Y(n))return n.use({event:t});n.rollRecharge()}#Y(e){return e.system.recharge&&!e.system.recharge.charged&&e.system.recharge.value}async#G(e,t,s,i){switch(i){case"deathSave":this.#Z(e,t);break;case"endTurn":if(!s)break;game.combat?.current?.tokenId===s.id&&await(game.combat?.nextTurn());break;case"initiative":await this.#X(t);break;case"inspiration":await this.#z(t);break;case"longRest":t.longRest();break;case"shortRest":t.shortRest()}Hooks.callAll("forceUpdateTokenActionHud")}async#X(e){e&&(await e.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHud"))}async#q(e,t,s,i){if(!s)return;const n=this.isRightClick(e),a=CONFIG.statusEffects.find((e=>e.id===i)),o=a?.flags?Object.hasOwn(a.flags,"dfreds-convenient-effects")?a.flags["dfreds-convenient-effects"].isConvenient:null:i.startsWith("Convenient Effect");if(game.dfreds&&o)n?await game.dfreds.effectInterface.toggleEffect(a.name??a.label,{overlay:!0}):await game.dfreds.effectInterface.toggleEffect(a.name??a.label);else{const e=this.#ee(i);if(!e)return;const a=this.#te(t,i);a?.disabled&&await a.delete(),n?await s.toggleEffect(e,{overlay:!0}):await s.toggleEffect(e)}Hooks.callAll("forceUpdateTokenActionHud")}#ee(e){return CONFIG.statusEffects.find((t=>t.id===e))}#te(e,t){return game.version.startsWith("11")?e.effects.find((e=>e.statuses.every((e=>e===t)))):e.effects.find((e=>e.flags?.core?.statusId===t))}async#F(e,t,s){let i=("find"in t.effects.entries?t.effects.entries:t.effects).find((e=>e.id===s)),n=!0;if(!i){n=!1;for(const e of t.allApplicableEffects())e.id===s&&(i=e)}if(!i)return;this.isRightClick(e)&&n?await i.delete():await i.update({disabled:!i.disabled}),Hooks.callAll("forceUpdateTokenActionHud")}async handleActionHover(t,s){const[i,n]=s.split("|");if(!["feature","item","spell","weapon","magicItem"].includes(i))return;const a=e.api.Utils.getItem(this.actor,n);switch(t.type){case"mouseenter":case"mouseover":Hooks.call("tokenActionHudSystemActionHoverOn",t,a);break;case"mouseleave":case"mouseout":Hooks.call("tokenActionHudSystemActionHoverOff",t,a)}}}}));class RollHandlerObsidian extends g{_rollAbilityTest(e,t){OBSIDIAN.Items.roll(super.actor,{roll:"abl",abl:t})}_rollAbilitySave(e,t){OBSIDIAN.Items.roll(super.actor,{roll:"save",save:t})}_rollSkill(e,t){OBSIDIAN.Items.roll(super.actor,{roll:"skl",skl:t})}_useItem(e,t){OBSIDIAN.Items.roll(super.actor,{roll:"item",id:t})}}function register(t){game.settings.register(e.ID,"abbreviateSkills",{name:game.i18n.localize("tokenActionHud.rotv.settings.abbreviateSkills.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showSlowActions",{name:game.i18n.localize("tokenActionHud.rotv.settings.showSlowActions.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showSlowActions.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{t(e)}}),game.settings.register(e.ID,"displaySpellInfo",{name:game.i18n.localize("tokenActionHud.rotv.settings.displaySpellInfo.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.displaySpellInfo.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showUnchargedItems",{name:game.i18n.localize("tokenActionHud.rotv.settings.showUnchargedItems.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showUnchargedItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showUnequippedItems",{name:game.i18n.localize("tokenActionHud.rotv.settings.showUnequippedItems.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showUnequippedItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showUnequippedItemsNpcs",{name:game.i18n.localize("tokenActionHud.rotv.settings.showUnequippedItemsNpcs.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showUnequippedItemsNpcs.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showUnpreparedSpells",{name:game.i18n.localize("tokenActionHud.rotv.settings.showUnpreparedSpells.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showUnpreparedSpells.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showItemsWithoutActivationCosts",{name:game.i18n.localize("tokenActionHud.rotv.settings.showItemsWithoutActivationCosts.name"),hint:game.i18n.localize("tokenActionHud.rotv.settings.showItemsWithoutActivationCosts.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}})}let f=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{f=class SystemManager extends e.api.SystemManager{getActionHandler(){const t=new y;return(e.api.Utils.isModuleActive("magic-items-2")||e.api.Utils.isModuleActive("magicitems"))&&t.addActionHandlerExtender(new v(t)),t}getAvailableRollHandlers(){let t="Core RotVRotV";e.api.Utils.isModuleActive("midi-qol")&&(t+=` [supports ${e.api.Utils.getModuleTitle("midi-qol")}]`);const s={core:t};return e.api.SystemManager.addHandler(s,"obsidian"),s}getRollHandler(e){let t;if("obsidian"===e)t=new RollHandlerObsidian;else t=new g;return t}registerSettings(e){register(e)}async registerDefaults(){const t=h;if(game.modules.get("magicitems")?.active||game.modules.get("magic-items-2")?.active){const s=e.api.Utils.i18n("tokenActionHud.rotv.magicItems");t.groups.push({id:"magic-items",name:s,listName:`Group: ${s}`,type:"system"}),t.groups.sort(((e,t)=>e.id.localeCompare(t.id)))}return t}}})),Hooks.on("tokenActionHudCoreApiReady",(async()=>{const t=game.modules.get(e.ID);t.api={requiredCoreModuleVersion:"1.5",SystemManager:f},Hooks.call("tokenActionHudSystemReady",t)}));export{i as ACTION_TYPE,n as ACTIVATION_TYPE_ICON,y as ActionHandler,a as CONCENTRATION_ICON,o as CONDITION,t as CORE_MODULE,h as DEFAULTS,l as GROUP,e as MODULE,v as MagicItemActionHandlerExtender,r as PREPARED_ICON,c as PROFICIENCY_LEVEL_ICON,p as RARITY,s as REQUIRED_CORE_MODULE_VERSION,u as RITUAL_ICON,g as RollHandler,RollHandlerObsidian,f as SystemManager,m as Utils,d as WEAPON_PROPERTY,register};
//# sourceMappingURL=token-action-hud-rotv.min.js.map
